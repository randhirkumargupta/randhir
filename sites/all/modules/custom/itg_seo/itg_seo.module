<?php

/**
 * Implementation of hook_menu().
 * 
 * {@inheritdoc}
 */
function itg_seo_menu() {
  $items['itg-access-denied'] = array(
      'title' => t('Access Denied'),
      'page callback' => 'itg_seo_access_denied',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['itg-not-found'] = array(
      'title' => t('Not Found'),
      'page callback' => 'itg_seo_not_found',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Call template file for access denied page
 * 
 * @return array
 */
function itg_seo_access_denied() {

  return theme('itg_seo_access_denied');
}

/**
 * Call template file for not found page
 * 
 * @return array
 */
function itg_seo_not_found() {
  if (function_exists(itg_seo_latest_headlines)) {
    $latest_headlines = itg_seo_latest_headlines();
  }
  return theme('itg_seo_not_found', array('data' => $latest_headlines));
}

/**
 * Implements hook_theme().
 *
 * {@inheritdoc}.
 */
function itg_seo_theme() {
  $themes = array(
      'itg_seo_access_denied' => array(
          'template' => 'itg-seo-access-denied',
          'path' => drupal_get_path('module', 'itg_seo') . '/templates',
      ),
      'itg_seo_not_found' => array(
          'template' => 'itg-seo-not-found',
          'path' => drupal_get_path('module', 'itg_seo') . '/templates',
          'variables' => array('data' => NULL),
      ),
  );

  return $themes;
}

/**
 * Implements hook_form_alter().
 * {@inheritdoc}
 */
function itg_seo_form_alter(&$form, &$form_state, $form_id) {
  global $user;
  // Extra meta tags element hide from form
  if ($form_id == 'mega_review_critic_node_form' || $form_id == 'story_node_form' || $form_id == 'itg_celebrity_profile_node_form' || $form_id == 'blog_node_form' || $form_id == 'podcast_node_form' || $form_id == 'videogallery_node_form' || $form_id == 'photogallery_node_form' || $form_id == 'breaking_news_node_form' || $form_id == 'reporter_node_form' || $form_id == 'recipe_node_form' || $form_id == 'cooking_tips_node_form' || $form_id == 'food_news_node_form' || $form_id == 'astro_node_form' || $form_id == 'live_tv_integration_node_form' || $form_id == 'ask_an_expert_node_form' || $form_id == 'event_configurations_node_form' || $form_id == 'event_backend_node_form' || $form_id == 'issue_node_form' || $form_id == 'supplement_node_form' || $form_id == 'newsletter_node_form' || $form_id == 'magazine_node_form' || $form_id == 'heighlights_node_form' || $form_id == 'survey_node_form' || $form_id == 'quiz_node_form' || $form_id == 'page_node_form' || $form_id == 'poll_node_form' || $form_id == 'sponsor_node_form'
  ) {
    if (!array_key_exists(ADMINISTRATOR, $user->roles)) {
      $form['#after_build'][] = 'itg_meta_tags_extra_element_hide';
    }
  }
  // Hide extra metatags on taxonomies.
  if ($form_id == 'taxonomy_form_term' &&
          ($form['#vocabulary']->machine_name == 'category_management' ||
          $form['#vocabulary']->machine_name == 'movies')) {
    if (!array_key_exists(ADMINISTRATOR, $user->roles)) {
      $form['#after_build'][] = 'itg_meta_tags_extra_element_hide';
    }
  }


  if ($form_id == 'syndication_client_node_form' || $form_id == 'syndication_rule_node_form' || $form_id == 'syndication_feed_from_pattern_node_form' || $form_id == 'ads_management_node_form' || $form_id == 'task_idea_allocation_tracking_node_form' || $form_id == 'ugc_node_form' || $form_id == 'notification_node_form'
  ) {
    //$form['additional_settings']['#access'] = FALSE;
    $form['#after_build'][] = 'itg_additional_settings_element_hide';
  }
}

/**
 * Extra meta tags element hide from form
 * @param array $form
 * @param array $form_state
 * @return array
 */
function itg_meta_tags_extra_element_hide($form, &$form_state) {
  if (isset($form['#vocabulary']->machine_name) && $form['#vocabulary']->machine_name == 'movies') {
    unset($form['relations']['#title']);
    unset($form['metatags']['#title']);
    unset($form['metatags']['#title']);
  }
  drupal_add_js(drupal_get_path('module', 'itg_common') . '/js/itg_metatags.js');
  unset($form['additional_settings']['group']['#groups']['additional_settings'][5]['#description']);
  unset($form['metatags']['intro_text']['#markup']);

  // Add code after metatag updation
  unset($form['metatags'][LANGUAGE_NONE]['basic']['#title']);
  unset($form['metatags'][LANGUAGE_NONE]['basic']['#description']);

  $form['path']['pathauto']['#title'] = t('Generate automatic Sef URL');

  $arr_seo_heading_not_req = array('event_backend_node_form', 'issue_node_form', 'supplement_node_form', 'magazine_node_form', 'survey_node_form', 'quiz_node_form');
  if (!in_array($form['#form_id'], $arr_seo_heading_not_req)) {
    $form['path']['#prefix'] = '<h2 class="story-title">' . t('SEO Meta Tags') . '</h2>';
  }

  return $form;
}

/**
 * Implements 
 * itg_seo_latest_headlines()
 */
function itg_seo_latest_headlines() {
  $query = db_select('node', 'n')
          ->fields('n', array('title', 'nid'))
          ->condition('n.status', 1)
          ->condition('n.type', 'story')
          ->range(0, 4)
          ->orderBy('n.created', 'DESC');
  $result = $query->execute()->fetchAll();
  $headlines = array();
  foreach ($result as $key => $val) {
    $headlines[$val->nid] = $val->title;
  }
  return $headlines;
}

/**
 * Extra meta tags element hide from form
 * @param array $form
 * @param array $form_state
 * @return array
 */
function itg_additional_settings_element_hide($form, &$form_state, $form_id) {
  global $user;
  if ($user->uid != '1') {
    drupal_add_js('jQuery(document).ready(function() {
              jQuery(".vertical-tabs-list").hide();
              jQuery(".form-item-menu-enabled").hide();
              jQuery(".form-item-path-alias").hide();              
              jQuery(".form-item-path-pathauto").hide();  
            });', array('type' => 'inline', 'scope' => 'footer'));
  }
  return $form;
}


/**
 * Returms a front end breadcrumb view 
 * @param int $id
 * @param text $entity_type
 * @param text $type
 * @param object $entity_object
 */
function frontend_breadcrumb_display($id = NULL, $entity_object = NULL, $single_url = NULL) {

  $section_link = l('News', '<front>');
  //for Magazine Story
  if (!empty($entity_object->type) 
          && $entity_object->type == 'story' 
          && !empty($entity_object->field_story_select_magazine[LANGUAGE_NONE][0]['target_id'])) {
    $section_link .= ' / ' . l('Magazine', 'calendar/0/0/magazine.html');    
  }

  if (!empty($id)) {
    $section_tids = taxonomy_get_parents_all($id);
    $section_tids = array_reverse($section_tids); 
    foreach ($section_tids as $chunks) {
      $section_link .= ' / ' . l($chunks->name, drupal_get_path_alias('taxonomy/term/' . $chunks->tid));
    }
  }  

  if (!empty($entity_object->type) && $entity_object->type == 'story') {
    $section_link .= ' / ' . t($entity_object->title);
  } else if (!empty($entity_object->type) && $entity_object->type == 'videogallery') {
    $section_link .= ' / Video > ' . t($entity_object->title);
  } else if (!empty($entity_object->type) && $entity_object->type == 'photo') {
    $section_link .= ' / Gallery > ' . t($entity_object->title);
  } else if (!empty($entity_object->type) && $entity_object->type == 'podcast') {
    $section_link .= ' / '.l("Podcast", "podcasts-listing").' > ' . t($entity_object->title);
  } else if (!empty($entity_object->type) && $entity_object->type == 'poll') {
    $section_link .= ' / Poll';
  } else if (!empty($entity_object->type) && $entity_object->type == 'blog') {
    $section_link .= ' / Blog > ' . t($entity_object->title);
  } else if (!empty($entity_object->type) && $entity_object->type == 'reporter') {
    $section_link .= ' / '.l("Anchors", "anchors-list").' > ' . t($entity_object->title);
  } else if (!empty($entity_object->type)) {
      $section_link .= ' / ' . t($entity_object->title);
  } else if (!empty($single_url)) {
      $section_link .= ' / ' . t($single_url);
  }

  return $section_link;
}

