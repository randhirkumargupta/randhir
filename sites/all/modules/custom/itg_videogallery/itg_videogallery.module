<?php

/**
 * @file
 * ITG Videogallery module.
 *
 * Provides customizations and functions for Video Gallery.I  
 *
 */
define('FTP_URL_VIDEO', variable_get('dailymotion_ftp_url'));
define('LOCAL_VIDEO_DIR', variable_get('local_s3_video_folder'));
define('FOLDER_FTP_ROOT', variable_get('ftp_root_folder'));

/**
 * Implements hook_menu().
 * {@inheritdoc}
 */
function itg_videogallery_menu() {
  $items['dailymotion/config'] = array(
    'title' => 'Dailymotion Configuration',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('itg_videogallery_configuration_form'),
    'access arguments' => array('authorized user dailymotion credin'),
    'type' => MENU_CALLBACK,
  );

  $items['dailymotion/ftp/config'] = array(
    'title' => 'Ftp Configuration',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('itg_videogallery_ftp_video_form'),
    'access arguments' => array('authorized user ftp credin'),
    'file' => 'includes/itg_videogallery.inc',
  );

  $items['dailymotion/s3/config'] = array(
    'title' => 'AWS S3 For Dailymotion Configuration',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('itg_videogallery_s3_video_form'),
    'access arguments' => array('authorized user ftp credin'),
    'file' => 'includes/itg_videogallery.inc',
  );
  
  $items['file-itgt-video'] = array(
     'type' => MENU_CALLBACK,
    'page callback' => 'itg_videogallery_push_itg_video',
     'access arguments' => array('access content'),
    'file' => 'includes/itg_videogallery_itg_video_file.inc',
  );
 $items['internal-video-play'] = array(
    'page callback' => 'itg_videogallery_internal_video_play',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['dailymotion-ftp-videos-post'] = array(
    'page callback' => 'itg_videogallery_ajax_ftp_video',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );


  $items['dailymotion-ftp-template'] = array(
    'page callback' => 'itg_videogallery_ftp_template',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['dailymotion-img'] = array(
    'page callback' => 'itg_videogallery_thumb_url',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['dailymotion-image'] = array(
    'page callback' => 'itg_videogallery_thumb_assign',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['embeded-video/%'] = array(
    'page callback' => 'itg_videogallery_dm_embed',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  ); 
  $items['dailymotion-video-play'] = array(
    'page callback' => 'itg_videogallery_dailymotion_video_play',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  
  $items['getvideoplayer'] = array(
    'page callback' => 'itg_videogallery_getvideoplayer',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['getvideoplayer-migrated'] = array(
    'page callback' => 'itg_videogallery_getvideoplayer_migrated',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['solr-video-make-fid'] = array(
    'page callback' => 'itg_videogallery_solr_video_insert_in_for_fid',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['dailymotion-bitrate'] = array(
    'page callback' => 'itg_videogallery_video_bitrate',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['check-s3'] = array(
    'page callback' => 'itg_videogallery_s3_file_to_dm',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['move-ftp'] = array(
    'page callback' => 'itg_videogallery_move_ftp_videos',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['video-delete-parent'] = array(
    'page callback' => 'itg_videogallery_remove_video_id_parent_site_delete_or_unpublish',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['daily-motion-video-dashboard'] = array(
    'title' => 'Daily Motion Video Dashboard',
    'description' => 'Daily Motion Video Dashboard',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('daily_motion_video_dashboard'),
    'access arguments' => array('access content'),
      //'access arguments' => array('daily motion video dashboard perm')
  );

  $items['delete_daily_motion_video/%'] = array(
    'title' => 'Daily Motion Video Dashboard Video Delete',
    'description' => 'Daily Motion Video Dashboard Video Delete',
    'page callback' => 'delete_daily_motion_video_callback',
    'access arguments' => array('access content'),
  );

  $items['get-file-details'] = array(
    'page callback' => 'itg_videogallery_get_file_details',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

   $items['itg-dfp-tags-setting'] = array (
		   'page callback'		=>	'drupal_get_form',
		   'title'				=>	'DFP Tags Configuration ', 
		   'page arguments' => array('itg_videogallery_dfp_tags_setting_form'),
       'access arguments' => array('authorized user ftp credin'),
       'file' => 'includes/itg_videogallery.inc',
		    'type'				=>	MENU_NORMAL_ITEM
		   );
   
   $items['itg-dfp-tags-list'] = array(
    'title' => 'DFP Tags List',
    'description' => 'DFP Tags List',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('itg_videogallery_dfp_tags_list'),
    'access arguments' => array('authorized user ftp credin'),
       'file' => 'includes/itg_videogallery.inc',
		    'type'				=>	MENU_NORMAL_ITEM
		   );


  
  $items['itg-video-watch-later-refresh/%'] = array(
    'title' => 'videogallery watch later block refresh',
    'description' => 'videogallery watch later block refresh',
    'page callback' => 'itg_video_watch_later_refresh',
    'access arguments' => array('access content'),
    'file' => 'includes/itg_video_watch_later_refresh.helper.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_block_info()
 * {@inheritdoc}
 */
function itg_videogallery_block_info() {
  $blocks['videogallery_tab_form_block'] = array(
    'info' => t('Video Gallery Form Tab Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['videogallery_menu_video_block'] = array(
    'info' => t('Video landing page menu'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['itg_videogallery_tab_realted'] = array(
    'info' => t('Video header related content'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['itg_videogallery_menu_content'] = array(
    'info' => t('Video landing Link page menu'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['itg_other_videogallery_section'] = array(
    'info' => t('Other Video Gallery from primary Category'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['itg_trending_videos_widget_tab'] = array(
    'info' => t('Trending videos for video tab'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implements hook_block_view()
 * {@inheritdoc}
 */
function itg_videogallery_block_view($delta = '') {
  global $user;
  $block = array();
  $data = '';
  switch ($delta) {
    case 'videogallery_tab_form_block':
      $block['content'] = theme('videogallery_tab_form_block', array('data' => $data));
      break;
    case 'videogallery_menu_video_block':
      $block['content'] = theme('videogallery_menu_video_block', array('data' => $data));
      break;
    case 'itg_videogallery_tab_realted':
      $block['content'] = get_header_tab_related_video_block_content();
      break;
    case 'itg_videogallery_menu_content':
      if (arg(0) == 'node' && is_numeric(arg(1)) && !arg(2)) {
        $node = menu_get_object();
        if ($node->type == 'videogallery') {
          $block['content'] = theme('itg_videogallery_menu_content_theme', array('data' => $data));
        }
        else {
          $block['content'] = '';
        }
      }
      else {
        $block['content'] = '';
      }
      break;
    case 'itg_other_videogallery_section':
      if (arg(0) == 'node' && is_numeric(arg(1)) && !arg(2)) {
        $node = menu_get_object();
        if ($node->type == 'videogallery') {
          drupal_add_js(drupal_get_path('module', 'itg_videogallery') . '/js/itg_videogallery_front.js', array('weight' => 1, 'scope' => 'footer'));
          $block['content'] = _get_other_videos_from_primary_category();
        }
        else {
          $block['content'] = '';
        }
      }
      else {
        $block['content'] = '';
      }
      break;
    // Trending videos ordering reordering widget case
    case 'itg_trending_videos_widget_tab':
      $info['widget'] = 'trending_videos_widget';
      $info['order'] = 'ASC';
      $info['max_limit'] = 3;
      $info['min_limit'] = 3;
      $data = itg_widget_get_widget_data_data($info);
      $block['content'] = theme("trending_videos_tab", array("data" => $data));
      break;
  }

  return $block;
}

/**
 * Implements hook_theme().
 * {@inheritdoc}
 */
function itg_videogallery_theme($existing, $type, $theme, $path) {
  $themes = array(
    'videogallery_tab_form_block' => array(
      'template' => 'videogallery-form-tab-template',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'videogallery_node_form' => array(
      'arguments' => array('form' => NULL),
      'template' => 'videogallery-node-form',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'render element' => 'form',
    ),
    'itg_videogallery_browse_form' => array(
      'arguments' => array('form' => NULL),
      'template' => 'videogallery-file-form',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'render element' => 'form',
    ),
    'videogallery_menu_video_block' => array(
      'template' => 'videogallery-menu-landing-template',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'itg_dailymotion_ftp_template' => array(
      'template' => 'itg-dailymotion-ftp-template',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'itg_videogallery_dm_embed' => array(
      'template' => 'itg-dailymotion-dm-embeded',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'itg_videogallery_dailymotion_video_play' => array(
      'template' => 'itg-dailymotion-dailymotion-video-play',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'itg_videogallery_internal_video_play' => array(
      'template' => 'itg-dailymotion-internal-video-play',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'itg_videogallery_getvideoplayer' => array(
      'template' => 'itg-dailymotion-getvideoplayer',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'itg_videogallery_menu_content_theme' => array(
      'template' => 'videogallery-link-menu-landing-template',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'trending_videos_tab' => array(
      'template' => 'trending-videos-tab',
      'path' => drupal_get_path('module', 'itg_videogallery') . '/templates'
    )
  );
  return $themes;
}

/**
 * Implemets hook_form_alter().
 * @param array $form
 * @param array $form_state
 * @param string $form_id
 */
function itg_videogallery_form_alter(&$form, &$form_state, $form_id) {
  global $user, $base_url;
  switch ($form_id) {
    case 'itg_widgets_custom_variables':
      $form['tid_videos'] = array(
        '#type' => 'textfield',
        '#title' => 'Tid of video section',
        '#default_value' => variable_get('tid_videos'),
        '#size' => 20,
        '#maxlength' => 20,
      );
      break;
    case 'videogallery_node_form':
      $arg = arg(2);
      $form['field_story_expert_description']['und'][0]['#format'] = 'full_html';

      // checked comment box by default
      if (!isset($form['#node']->nid)) {
        $form['field_video_configurations'][LANGUAGE_NONE]['#default_value'] = array('comment_box');
      }
      if(isset($form['#entity']->field_story_source_type)) {
      if ($form['#entity']->field_story_source_type[LANGUAGE_NONE][0]['value'] != 'migrated') {
        foreach ($form['field_video_upload']['und'] as $delta => $field) {
          if (is_numeric($delta)) {
            if ($arg == 'edit') {
              $video_fid = $form['field_video_upload']['und'][$delta]['field_videogallery_video_upload']['und'][0]['#default_value']['fid'];
              $file_exist = itg_videogallery_check_file_manage_fid($video_fid);
              if (empty($file_exist) || $video_fid < 1) {
                unset($form['field_video_upload']['und'][$delta]);
              }
            }
            $video_fid = $form['field_video_upload']['und'][$delta]['field_videogallery_video_upload']['und'][0]['#default_value']['fid'];
            if (arg(1) == 'ajax' && $form_state['values']['nid'] > 0) {
              if ($video_fid == "" || $video_fid == 0) {
                // unset($form['field_video_upload']['und'][$delta]);
              }
            }
          }
        }
       }
      }
      if ($user->uid != 1) {
        unset($form['field_video_configurations']['und']['#options']['comment']);
      }
      unset($form['actions']['preview_changes']);
      $form['field_story_expert_name']['#access'] = FALSE;
      $form['field_story_syndication']['und']['#title'] = NULL;
      if (arg(1) == 'add') {
        drupal_set_title(t('Upload Video'));
      }
      else {
        drupal_set_title(t('Edit Upload Video'));
      }
      $form['#after_build'][] = 'itg_videogallery_after_build';
      $form['#validate'][] = 'itg_videogallery_custom_validate';
      $form['actions']['cancel'] = array(
        '#markup' => l(t('Cancel'), 'manage-videogallery', array('attributes' => array('class' => 'button'))),
        '#weight' => 20,
      );
      $form['field_video_duration']['#attributes'] = array('style' => 'display:none;');
      $form['field_video_upload'][LANGUAGE_NONE][0]['#upload_validators']['itg_custom_field_validate'] = array(1, 2);
      $form['field_video_upload']['#prefix'] = '<div class="ftp_browse_field"><label for="edit-field-upload-video-und-0-upload">Video <span title="This field is required." class="form-required">*</span></label><span class="browse-ftp-click">' . l(t('Browse Video'), 'dailymotion-ftp-template', array('query' => array('width' => '80%', 'height' => '80%', 'iframe' => TRUE, 'input_filed' => 'edit-field-upload-video-und-0-upload', 'file_filed_name' => 'field_upload_video[und][0][fid]'), 'attributes' => array('class' => array('colorbox-load', 'browse-ftp-click')))) . '</span><div class="description">Allowed file extension MP4.</div></div>';
      $form['actions']['submit']['#submit'][] = 'itg_videogallery_submit_status_message';
      array_unshift($form['actions']['submit']['#submit'], 'itg_videogallery_custom_submit');
// Add accept file
      $form['field_video_upload'][LANGUAGE_NONE][0]['#process'][] = 'itg_videogallery_managed_file_process_accept_attribute';
      break;
  }
}

/**
 * Processes a filed_video upload element to add the accept attribute.
 *
 * Add the allowed extensions as an 'accept' attribute to the file_managed element.
 */
function itg_videogallery_managed_file_process_accept_attribute($element, &$form_state, $form) {

  if ($form['#form_id'] == 'videogallery_node_form') {
    if (!empty($element['#upload_validators']['file_validate_extensions']) && !isset($element['upload']['#attributes']['accept'])) {
      $extensions = explode(' ', $element['#upload_validators']['file_validate_extensions'][0]);
      $element['upload']['#attributes']['accept'] = '.' . implode(',.', $extensions);
    }
  }
  return $element;
}

/**
 * Implements function for validate image
 * @param array $field
 * @return array
 */
function itg_custom_field_validate($field) {
  $val = itg_video_check_exist_file($field->filename);
  $field->destination = $val;
  $errors = array();
  return $errors;
}

/**
 * This function use for if file exist or not in file_manage
 * * Implements function for validate image
 * @param int $fid
 * @return array
 */
function itg_videogallery_check_file_manage_fid($fid) {
  $query = db_select('file_managed', 'fm');
  $query->fields('fm');
  $query->condition('fid', $fid, '=');
  $results = $query->execute()->fetchAll();
  return $results;
}

/**
 * Implements function check exist filename
 * @param array $form
 * @param array $form_state
 * @return string
 */
function itg_video_check_exist_file($filename) {
  $query = db_select('file_managed', 'fm');
  $query->condition('filename', $filename, '=');
  $query->fields('fm');
  $query->orderBy('fm.fid', 'DESC');
  $query->range(0, 1);
  $results = $query->execute()->fetchAll();
  if (!isset($results[0])) {
    $res = 'public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/' . $filename;
    return $res;
  }
  else {
    $result = explode('public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/', $results[0]->uri);
    $path_info = pathinfo($results[0]->filename);
    $extension = $path_info['extension'];
    $file_name = $path_info['filename'];
    $result_num = explode($file_name . '_', $result[1]);
    $num_file_id = explode('.' . $extension, $result_num[1]);
    if (is_numeric($num_file_id[0]) && isset($num_file_id[0])) {
      $value = $num_file_id[0] + 1;
      $value = '_' . $value;
    }
    else {
      $value = '_0';
    }
    $file_info = pathinfo($filename);
    $res = 'public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/' . $file_info['filename'] . $value . '.' . $extension;
    return $res;
  }
}

/**
 * Implements custom submit for move video on dailymotion.
 * @param array $form
 * @param array $form_state
 */
function itg_videogallery_custom_submit($form, &$form_state) {
  global $user;
  $filedir = ITG_IMAGE_FOLDER . 'video/' . date('Ym');
  if (!file_exists(file_default_scheme() . '://' . $filedir)) {
    mkdir(file_default_scheme() . '://' . $filedir, 0777, TRUE);
  }
  chmod(file_default_scheme() . '://' . $filedir, 0777, TRUE);
  foreach ($form_state['values']['field_story_itg_tags'][LANGUAGE_NONE] as $tags) {
    $tag[] = $tags['name'];
  }
  $request_destination = $_REQUEST['destination'];

  if ($request_destination == 'published-video') {
    $redirect_path .= "?field_story_syndication_value_op=all";
    $form_state['redirect'] = $redirect_path;
  }
// code insert image in custom table
  $node_id = $form_state['node']->nid;
  $fids = array();
  $thumg_to_crop = "";
  foreach ($form_state['values']['field_video_upload']['und'] as $videofields) {
    if ((int) $videofields['field_videogallery_video_upload']['und'][0]['fid'] != 0) {
      $query = db_select('itg_solr_video_info', 'drd');
      $query->fields('drd', array('solr_video_thumb', 'solr_video_duration'));
      $query->condition('fid', $videofields['field_videogallery_video_upload']['und'][0]['fid'], '=');
      $video_image = $query->execute()->fetchAll();
      if (!empty($video_image[0]->solr_video_thumb)) {
        $thumg_to_crop = $video_image[0]->solr_video_thumb;
        $slor_video_duration = $video_image[0]->solr_video_duration;
        break;
      }
    }
  }
  $tag_value = implode(', ', $tag);
  $tags_value = trim($tag_value, ",");
// assign image in field after resize
  if ($form_state['values']['field_story_extra_large_image'][LANGUAGE_NONE][0]['fid'] == 0 || $form_state['values']['field_story_large_image'][LANGUAGE_NONE][0]['fid'] == 0 || $form_state['values']['field_story_medium_image'][LANGUAGE_NONE][0]['fid'] == 0 || $form_state['values']['field_story_small_image'][LANGUAGE_NONE][0]['fid'] == 0 || $form_state['values']['field_story_extra_small_image'][LANGUAGE_NONE][0]['fid'] == 0) {
    $image_url = $thumg_to_crop;
    if (!empty($image_url)) {

      $imagedata = file_get_contents($image_url);
      $image_url = 'itg' . time() . end(explode('/', $image_url));
      $image_extension = end(explode('.', $image_url));
      $file_data_temp = file_save_data($imagedata, file_default_scheme() . '://' . $image_url);
    }
    if (!empty($file_data_temp)) {
// This code for resize all images 
      if ($form_state['values']['field_story_extra_large_image'][LANGUAGE_NONE][0]['fid'] == 0) {
        $file_image = file_load($file_data_temp->fid);
        $image = image_load($file_image->uri);
        $filepath = file_default_scheme() . '://' . $filedir;
        if (!empty($image)) {
          $scaled = image_scale_and_crop($image, EXTRA_LARGE_IMAGE_WIDTH, EXTRA_LARGE_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $form_state['values']['field_story_extra_large_image'][LANGUAGE_NONE][0]['fid'] = $file->fid;
        }
      }

      if ($form_state['values']['field_story_large_image'][LANGUAGE_NONE][0]['fid'] == 0) {
        $file_image = file_load($file_data_temp->fid);
        $image = image_load($file_image->uri);
        $filepath = file_default_scheme() . '://' . $filedir;
        if (!empty($image)) {
          $scaled = image_scale_and_crop($image, LARGE_IMAGE_WIDTH, LARGE_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $form_state['values']['field_story_large_image'][LANGUAGE_NONE][0]['fid'] = $file->fid;
        }
      }

      if ($form_state['values']['field_story_large_image'][LANGUAGE_NONE][0]['fid'] == 0) {
        $file_image = file_load($file_data_temp->fid);
        $image = image_load($file_image->uri);
        $filepath = file_default_scheme() . '://' . $filedir;
        if (!empty($image)) {
          $scaled = image_scale_and_crop($image, LARGE_IMAGE_WIDTH, LARGE_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $form_state['values']['field_story_large_image'][LANGUAGE_NONE][0]['fid'] = $file->fid;
        }
      }
      if ($form_state['values']['field_story_medium_image'][LANGUAGE_NONE][0]['fid'] == 0) {
        $file_image = file_load($file_data_temp->fid);
        $image = image_load($file_image->uri);
        if (!empty($image)) {
          $filepath = file_default_scheme() . '://' . $filedir;
          $scaled = image_scale_and_crop($image, MEDIUM_IMAGE_WIDTH, MEDIUM_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $form_state['values']['field_story_medium_image'][LANGUAGE_NONE][0]['fid'] = $file->fid;
        }
      }
      if ($form_state['values']['field_story_small_image'][LANGUAGE_NONE][0]['fid'] == 0) {
        $file_image = file_load($file_data_temp->fid);
        $image = image_load($file_image->uri);
        if (!empty($image)) {
          $filepath = file_default_scheme() . '://' . $filedir;
          $scaled = image_scale_and_crop($image, SMALL_IMAGE_WIDTH, SMALL_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $form_state['values']['field_story_small_image'][LANGUAGE_NONE][0]['fid'] = $file->fid;
        }
      }
      if ($form_state['values']['field_story_extra_small_image'][LANGUAGE_NONE][0]['fid'] == 0) {
        $file_image = file_load($file_data_temp->fid);
        $image = image_load($file_image->uri);
        if (!empty($image)) {
          $filepath = file_default_scheme() . '://' . $filedir;
          $scaled = image_scale_and_crop($image, EXTRA_SMALL_IMAGE_WIDTH, EXTRA_SMALL_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $form_state['values']['field_story_extra_small_image'][LANGUAGE_NONE][0]['fid'] = $file->fid;
        }
      }
    }
  }
  if ($_GET['destination'] == 'published-video') {
    unset($_GET['destination']);
    $redirect_path = 'published-video?field_story_syndication_value_op=all';
    $_GET['destination'] = $redirect_path;
  }
// here first video duration assign
  if (empty($form_state['values']['field_video_duration'][LANGUAGE_NONE][0]['value'])) {

    if ($vid_result['video_duration'] != '0') {
      $form_state['values']['field_video_duration'][LANGUAGE_NONE][0]['value'] = $slor_video_duration;
    }
  }
  if ($node_id != "") {
// for update on DM
    $extralarge_image_fid = $form_state['values']['field_story_extra_large_image'][LANGUAGE_NONE][0]['fid'];
    $main_fids = array();
    $draft_msg_flag = 0;
    $video_desc = strip_tags($form_state['values']['field_story_expert_description'][LANGUAGE_NONE][0]['value']);
// start loop of videos field collection
    foreach ($form_state['values']['field_video_upload']['und'] as $keys => $videofields) {

      if ((int) $videofields['field_videogallery_video_upload']['und'][0]['fid'] != 0) {

        $video_image = itg_videogallery_get_video_info_by_fid($videofields['field_videogallery_video_upload']['und'][0]['fid']);
        $main_fids[] = $videofields['field_videogallery_video_upload']['und'][0]['fid'];
        if (!empty($video_image)) {
          if($video_image[0]->video_repo_type != 'INTERNAL') {
          if ($video_image[0]->property == VIDEO_PROPERTY) {
            $private_status = $videofields['field_video_private']['und'][0]['value'];
            $video_title = $videofields['field_video_title']['und'][0]['value'];
            $video_thumb_fid = $videofields['field_video_thumbnail']['und'][0]['fid'];
            $exclude_ads = $videofields['field_include_ads']['und'][0]['value'];
            if ($video_thumb_fid == 0 || empty($video_thumb_fid)) {
              $video_thumb_fid = $extralarge_image_fid;
            }
            // Update tags,image title on DM
              itg_videogallery_update_tags_video_private($tag_value, $video_image[0]->solr_video_id, $private_status, $video_desc, $video_title, $video_thumb_fid, $exclude_ads);
             }
          
          // Update embed code of this video.
           itg_videogallery_update_embedcode_url($video_image[0]->solr_video_id);
          }
          $file_video = $video_image;
// this function use for delete itg_solr_delete_vide nid
          itg_videogallery_delele_node_reuse_video($file_video[0]->solr_video_id);
          if ($form_state['node']->status == 1) {
            $num_updated = db_update('dailymotion_response_details') // Table name no longer needs {}
                ->fields(array(
                  'dailymotion_published' => 1,
                  'is_replace' => 0,
                  'node_is_save_draft' => 0
                ))
                ->condition('video_id', $file_video[0]->solr_video_id, '=')
                ->execute();
            itg_videogallery_update_video_info_solr($file_video[0]->solr_video_id);
          }

// update nid in video
          $is_node_draft = 0;
          if ($form_state['node']->status == 0) {
            $is_node_draft = 1;
          }
          $num_updated = db_update('itg_solr_video_info') // Table name no longer needs {}
              ->fields(array(
                'nid' => $node_id,
                'is_node_draft' => $is_node_draft,
              ))
              ->condition('fid', $videofields['field_videogallery_video_upload']['und'][0]['fid'], '=')
              ->execute();
        }
      }
    }

//    if ($form_state['node']->status == 0) {
//      
//      drupal_set_message('The video is not published. It will auto published once it published on Daily motion.');
//    }
// check loavl upaod file
    $is_loacl = 0;
    try {
      if ($form_state['values']['field_story_facebook_video'][LANGUAGE_NONE][0]['fid'] != 0) {
        itg_videogallery_update_node_id_for_video_fid($node_id, $form_state['values']['field_story_facebook_video'][LANGUAGE_NONE][0]['fid']);
      }
      if ($form_state['values']['field_story_twitter_video'][LANGUAGE_NONE][0]['fid'] != 0) {
        itg_videogallery_update_node_id_for_video_fid($node_id, $form_state['values']['field_story_twitter_video'][LANGUAGE_NONE][0]['fid']);
      }
      itg_videogallery_node_publish_video_to_unpublish($node_id, $main_fids);
    }
    catch (Exception $e) {
      watchdog_exception('video fid delete', $e);
    }
  }
}

/**
 * This function use for mark node remove video unpublish
 */
function itg_videogallery_node_publish_to_unpublish($nid) {
  $unp_videos = array();
// delete deleted video info form itg_solr_video_info
  $query = db_select('itg_solr_video_info', 'drd')
      ->fields('drd', array('solr_video_id', 'property', 'fid' , 'video_repo_type'));
  $query->condition('nid', $nid);
  $result = $query->execute()->fetchAll();

  $query = db_delete('itg_solr_video_info');
  $query->condition('nid', $nid);
  $query->condition('content_type', 'video_gallery', '=');
  $query->execute();
  $node = node_load($nid);
  foreach ($node->field_video_upload[LANGUAGE_NONE] as $key => $value) {
    // Build array of field collection values.
    $field_collection_item_values[] = $value['value'];
    // Unset them.  
    unset($node->field_video_upload[LANGUAGE_NONE][$key]);
  }
  entity_delete_multiple('field_collection_item', $field_collection_item_values);
  field_attach_update('node', $node);

  foreach ($result as $un_video) {
    if ($un_video->property == VIDEO_PROPERTY && $un_video->video_repo_type != 'INTERNAL') {
      $api = itg_videogallery_dailymotion_api();
      $api->post('/video/' . $un_video->solr_video_id . '?private=true');
    }
    $unp_videos[] = $un_video->solr_video_id;

    $deleted = db_delete('file_managed')
        ->condition('fid', $un_video->fid)
        ->execute();
  }
  if (!empty($unp_videos)) {

    try {
      db_update('dailymotion_response_details') // Table name no longer needs {}
          ->fields(array(
            'dailymotion_published' => 0,
            'is_draft' => 0,
            'is_replace' => 1,
            'nid' => 0,
          ))
          ->condition('video_id', $unp_videos, 'IN')
          ->execute();
    }
    catch (Exception $e) {
      watchdog_exception('video fid delete', $e);
    }
  }
  foreach ($result as $un_video) {
    if ($un_video->property == VIDEO_PROPERTY) {
      itg_videogallery_update_video_info_solr($un_video->solr_video_id);
    }
  }
}

/**
 * This function use for mark node remove video unpublish
 */
function itg_videogallery_node_publish_video_to_unpublish($nid, $main_fids) {
  $unp_videos = array();
// delete deleted video info form itg_solr_video_info
  $query = db_update('itg_solr_video_info')
      ->fields(array('is_delete' => 1));
  $query->condition('fid', $main_fids, 'NOT IN');
  $query->condition('nid', $nid);
  $query->condition('content_type', 'video_gallery', '=');
  $query->execute();
  $query = db_select('itg_solr_video_info', 'drd')
      ->fields('drd', array('solr_video_id', 'property'));
  $query->condition('fid', $main_fids, 'NOT IN');
  $query->condition('nid', $nid);
  $result = $query->execute()->fetchAll();

  foreach ($result as $un_video) {
    if ($un_video->property == VIDEO_PROPERTY) {
      $api = itg_videogallery_dailymotion_api();
      $api->post('/video/' . $un_video->solr_video_id . '?private=true');
    }
    $unp_videos[] = $un_video->solr_video_id;
  }
  if (!empty($unp_videos)) {

    try {
      db_update('dailymotion_response_details') // Table name no longer needs {}
          ->fields(array(
            'dailymotion_published' => 0,
            'is_replace' => 1,
          ))
          ->condition('video_id', $unp_videos, 'IN')
          ->execute();
    }
    catch (Exception $e) {
      watchdog_exception('video fid delete', $e);
    }
  }
  foreach ($result as $un_video) {
    if ($un_video->property == VIDEO_PROPERTY) {
      itg_videogallery_update_video_info_solr($un_video->solr_video_id);
    }
  }
}

/**
 * impliment hook node insert
 */
function itg_videogallery_node_insert($node) {
  if ($node->type == 'story') {
    itg_videogallery_save_story_video_data($node->body['und'][0]['value'], $node->nid);
  }

  // Here Check node type not migrated
  if ($node->field_story_source_type[LANGUAGE_NONE][0]['value'] != 'migrated') {
    switch ($node->type) {
      case 'videogallery':
        $node_id = $node->nid;
        foreach ($node->field_story_itg_tags[LANGUAGE_NONE] as $tags) {
          $tag[] = $tags['name'];
        }
        $tag_value = implode(', ', $tag);
        $tags_value = trim($tag_value, ",");
        // get Extra large image fid for update on DM
        $extralarge_image_fid = $node->field_story_extra_large_image[LANGUAGE_NONE][0]['fid'];
        $draft_msg_flag = 0;
        $video_desc = strip_tags($node->field_story_expert_description[LANGUAGE_NONE][0]['value']);
        foreach ($node->field_video_upload['und'] as $keys => $videofields) {
          $video_details = entity_load('field_collection_item', array($videofields['value']));
          $priv_status = $video_details[$videofields['value']]->field_video_private[LANGUAGE_NONE][0]['value'];
          $video_title = $video_details[$videofields['value']]->field_video_title[LANGUAGE_NONE][0]['value'];
          $video_thumb_fid = $video_details[$videofields['value']]->field_video_thumbnail[LANGUAGE_NONE][0]['fid'];
          $exclude_ads = $video_details[$videofields['value']]->field_video_private[LANGUAGE_NONE][0]['value'];
          if ($video_thumb_fid == 0 || empty($video_thumb_fid)) {
            $video_thumb_fid = $extralarge_image_fid;
          }
          foreach ($video_details[$videofields['value']]->field_videogallery_video_upload as $filed_val) {

            $fids = $filed_val[0]['fid'];
          }

          if ((int) $fids != 0) {
            $video_image = itg_videogallery_get_video_info_by_fid($fids);
            if (empty($video_image)) {
              $video_fid = $fids;
              $file_details = file_load($fids);
              $real_path = drupal_realpath($file_details->uri);
              if (file_exists($file_details->uri)) {
                if ($real_path == "") {
                  $real_path = file_create_url($file_details->uri);
                }
                $draft_msg_flag = 1;
                // use for upload local video to DM
                itg_videogallery_send_local_video_to_dailymotion($real_path, $file_details, $video_fid, $tags_value, $node_id, 'is_draft', $priv_status);
                if ($node->field_op_flag[LANGUAGE_NONE][0]['value'] == 'draft') {
                  $file_video = itg_videogallery_get_video_info_by_fid($fids);
                  $num_updated = db_update('dailymotion_response_details') // Table name no longer needs {}
                      ->fields(array(
                        'dailymotion_published' => 1,
                        'is_replace' => 0,
                        'node_is_save_draft' => 1,
                      ))
                      ->condition('video_id', $file_video[0]->solr_video_id, '=')
                      ->execute();
                }
              }
            }
            else {
              $file_video = $video_image;
              if($file_video[0]->video_repo_type != 'INTERNAL') {
              if ($file_video[0]->property == VIDEO_PROPERTY) {
                // Upadte image ,tags,title On DM 
                itg_videogallery_update_tags_video_private($tag_value, $file_video[0]->solr_video_id, $priv_status, $video_desc, $video_title, $video_thumb_fid, $exclude_ads);
              }
              // Update embed code for this vidoe in table
              itg_videogallery_update_embedcode_url($file_video[0]->solr_video_id);
              }
              if ($node->status != 0) {
                  $num_updated = db_update('dailymotion_response_details') // Table name no longer needs {}
                    ->fields(array(
                      'dailymotion_published' => 1,
                      'is_replace' => 0,
                      'node_is_save_draft' => 0
                    ))
                    ->condition('video_id', $file_video[0]->solr_video_id, '=')
                    ->execute();
                // Upadte video is publish on solr
                itg_videogallery_update_video_info_solr($file_video[0]->solr_video_id);
              }

              $getnode = itg_videogallery_get_node_by_title($file_video[0]->solr_video_id);
              if (!empty($getnode)) {
                node_delete($getnode[0]->nid);
              }

// update nid in video
              $is_node_draft = 0;
              if ($node->status == 0 && $draft_msg_flag == 1) {
                $is_node_draft = 1;
              }
              $num_updated = db_update('itg_solr_video_info') // Table name no longer needs {}
                  ->fields(array(
                    'nid' => $node_id,
                    'is_node_draft' => $is_node_draft,
                  ))
                  ->condition('fid', $fids, '=')
                  ->execute();
            }
          }
          
           if ($node->status == 0 && $draft_msg_flag == 1 && $node->field_op_flag[LANGUAGE_NONE][0]['value'] != 'draft') {
                   $num_updated = db_update('dailymotion_response_details') // Table name no longer needs {}
                    ->fields(array(
                      'dailymotion_published' => 0,
                      'is_draft' => 1,
                      'nid' => $node_id,
                      'node_is_save_draft' => 1
                    ))
                    ->condition('video_id', $file_video[0]->solr_video_id, '=')
                    ->execute();
                // Upadte video is publish on solr
                itg_videogallery_update_video_info_solr($file_video[0]->solr_video_id);
        }
        }
        if ($node->status == 0 && $draft_msg_flag == 1 && $node->field_op_flag[LANGUAGE_NONE][0]['value'] != 'draft') {
          drupal_set_message(t('The video is not published. It will auto published once it published on Daily motion.'));
        }
        if ($node->field_story_facebook_video[LANGUAGE_NONE][0]['fid'] != 0) {
          itg_videogallery_update_node_id_for_video_fid($node_id, $node->field_story_facebook_video[LANGUAGE_NONE][0]['fid'], $is_node_draft);
        }
        if ($node->field_story_twitter_video[LANGUAGE_NONE][0]['fid'] != 0) {
          itg_videogallery_update_node_id_for_video_fid($node_id, $node->field_story_twitter_video[LANGUAGE_NONE][0]['fid'], $is_node_draft);
        }
        break;
    }
  }

  if ($node->field_story_source_type[LANGUAGE_NONE][0]['value'] == 'UGC') {
    $_REQUEST['destination'] = 'ugc-inqueue-content';
  }
}

/**
 * This function use for upadet node id in itg_solr_video_info table after by fid when node is update and insert
 */
function itg_videogallery_update_node_id_for_video_fid($node_id, $fids, $is_node_draft) {
  $num_updated = db_update('itg_solr_video_info') // Table name no longer needs {}
      ->fields(array(
        'nid' => $node_id,
        'is_node_draft' => $is_node_draft,
      ))
      ->condition('fid', $fids, '=')
      ->execute();
}

/**
 * Function use for upload local video to dailymotion
 */
function itg_videogallery_send_local_video_to_dailymotion($real_path, $file_details, $video_fid, $tags_value, $node_id, $is_draft = NULL, $is_private = NULL) {

  $response = itg_videogallery_dailymotion($real_path, $file_details->uri, $video_fid, $tags_value, $node_id, $is_private);
// Perform playlist and tags when new video create.
  $response_result['video_id'] = $response['id'];
  $response_result['fid'] = $response['fid'];
  if (!empty($response_result['video_id'])) {
    $duration = "";
    if ($response['duration'] < 3600) {
      $duration = gmdate("i:s", $response['duration']);
    }
    else {
      $duration = gmdate("H:i:s", $response['duration']);
    }
    $nid = db_insert('dailymotion_response_details')
        ->fields(array(
          'title' => $response['title'],
          'channel' => $response['channel'],
          'video_type' => 'DM',
          'fid' => $response['fid'],
          'tags' => $response['tags'],
          'video_id' => $response['id'],
          'nid' => $node_id,
          'upload_time' => REQUEST_TIME,
          'video_duration' => $duration,
          'dailymotion_published' => 1,
          'video_size' => $file_details->filesize,
          'is_draft' => ($is_draft) ? 1 : 0,
          'type' => 'local',
          'name' => $file_details->filename,
        ))
        ->execute();
    db_insert('itg_solr_video_info')
        ->fields(array(
          'fid' => $response['fid'],
          'solr_video_id' => $response['id'],
          'nid' => $node_id,
          'property' => VIDEO_PROPERTY,
          'content_type' => 'video_gallery',
          'solr_video_duration' => $duration,
          'solr_video_size' => $file_details->filesize,
          'solr_video_thumb' => "",
        ))
        ->execute();
    itg_videogallery_update_embedcode_url($response['id']);
  }
}

/**
 * Implements function for dailymotion api
 * @return object
 */
function itg_videogallery_dailymotion_api() {
  require_once 'includes/Dailymotion.php';
  $user_name = variable_get('dailymotion_username', '');
  $password = variable_get('dailymotion_password', '');
  $api_key = variable_get('dailymotion_apikey', '');
  $api_secret = variable_get('dailymotion_secretkey', '');

  try {
    $api = new Dailymotion();
    $scopes = array(
      'userinfo',
      'feed',
      'manage_videos',
      'manage_subtitles',
      'read',
      'write',
      'delete',
    );
    $api->setGrantType(
        Dailymotion::GRANT_TYPE_PASSWORD, $api_key, $api_secret, $scopes, array(
      'username' => $user_name,
      'password' => $password,
        )
    );
  }
  catch (Exception $e) {
    if ($e->getMessage() == "Missing API key") {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_set_message(t('Please enter API Key.'), 'error');
      drupal_goto('dailymotion/config');
    }
    else {
      drupal_set_message($e->getMessage(), 'error');
    }
  }
  return $api;
}

function itg_videogallery_clean_string($string) {
  $string = str_replace(' ', ' ', $string);
  $string = preg_replace('/[^A-Za-z0-9\-ığşçöüÖÇŞİıĞ]/', ' ', $string);

  return preg_replace('/-+/', '-', $string);
}

/**
 * Implements function for remove video from playlist
 */
function itg_videogallery_update_tags_video_private($tags_value, $video_id, $private, $video_desc = "", $video_title = "", $video_thumb_fid = "", $exclue_ads = "") {
  if ($video_thumb_fid) {
    $image_load = file_load($video_thumb_fid);
    $image_url = file_create_url($image_load->uri);
  }
  if ($private == 'Yes') {
    $private = 'true';
  }
  else {
    $private = 'false';
  }
  if (strtolower($exclue_ads) == 'yes') {
    $exclude_ads_flag = 'true';
  }
  else {
    $exclude_ads_flag = 'false';
  }

  $video_desc = itg_videogallery_clean_string($video_desc);
  $video_title = itg_videogallery_clean_string($video_title);
  $api = itg_videogallery_dailymotion_api();
  if($video_title != "") {
    $update_field = array('title' => $video_title);
    itg_videogallery_update_dailymotion_table_by_videoid($update_field , $video_id );
  }
// Tags assign to node and thumbnail
  if (!empty($tags_value) && !empty($video_title)) {
    $api->post('/video/' . $video_id . '?tags=' . $tags_value . '&private=' . $private . '&title=' . $video_title . '&description=' . $video_desc . '&advertising_instream_blocked=' . $exclude_ads_flag);
  }
  elseif (empty($tags_value) && !empty($video_title)) {
    $api->post('/video/' . $video_id . '?private=' . $private . '&title=' . $video_title . '&description=' . $video_desc . '&advertising_instream_blocked=' . $exclude_ads_flag);
  }
  elseif (!empty($tags_value) && empty($video_title)) {
    $api->post('/video/' . $video_id . '?tags=' . $tags_value . '&private=' . $private . '&description=' . $video_desc);
  }
  else {
    $api->post('/video/' . $video_id . '?private=' . $private);
  }
  if ($image_url != "") {
    $api->post('/video/' . $video_id . '?thumbnail_url=' . $image_url);
  }
  $thumb_url = $api->get(
      '/video/' . $video_id, array('fields' => array('thumbnail_720_url'))
  );

  $image_url = $thumb_url['thumbnail_720_url'];
  $num_updated = db_update('itg_solr_video_info') // Table name no longer needs {}
      ->fields(array(
        'solr_video_thumb' => $image_url
      ))
      ->condition('solr_video_id', $video_id, '=')
      ->execute();
}

/**
 * Function use update dailymotion_response_details data by video id
 * @param array $data
 * @param sting $video_id
 */
function itg_videogallery_update_dailymotion_table_by_videoid($data,$video_id)
{
    $num_updated = db_update('dailymotion_response_details') 
           ->fields($data)
           ->condition('video_id', $video_id, '=')
           ->execute();
}

/**
 * Implements dailymotion video edit function
 * @param array $vid_res_result
 * @param array $playlist_name
 * @param array $tags_value
 * @param int $node_id
 */
function itg_videogallery_edit_dailymotion($vid_res_result, $playlist_name, $node_id) {
  $video_id = $vid_res_result['video_id'];
  $fid = $vid_res_result['fid'];
  $api = itg_videogallery_dailymotion_api();
// create playlist
  foreach ($playlist_name as $name) {
// local saved playlist check
    $exist_playlist = itg_videogallery_get_playlist_id($name);
    if ($exist_playlist[0]->pid == '') {
      try {
        $result = $api->post(
            '/me/playlists', array(
          'name' => $name,
            )
        );
// Insert data in dailymotion_playlist_details table
        db_insert('dailymotion_playlist_details')
            ->fields(array(
              'pid' => $result['id'],
              'playlist_name' => $result['name'],
              'node_id' => $node_id,
              'video_id' => $video_id,
            ))->execute();
        $api->post('/playlist/' . $result['id'] . '/videos/' . $video_id);
      }
      catch (Exception $e) {
        if ($e->getCode() == 500) {
          $playlists = $api->get(
              '/me/playlists', array('limit' => 100, 'fields' => array('id', 'name'))
          );
          foreach ($playlists['list'] as $p_value) {
            $play[$p_value['name']] = $p_value['id'];
          }
          db_insert('dailymotion_playlist_details')
              ->fields(array(
                'pid' => $play[$name],
                'playlist_name' => $name,
                'node_id' => $node_id,
                'video_id' => $video_id,
              ))->execute();
          $playlist_id = itg_videogallery_get_playlist_id($name);
          $api->post('/playlist/' . $playlist_id[0]->pid . '/videos/' . $video_id);
        }
      }
    }
    else {
      $playlist_id = itg_videogallery_get_playlist_id($name);
      $api->post('/playlist/' . $playlist_id[0]->pid . '/videos/' . $video_id);
    }
  }
}

/**
 * This function use for chane video privat or public
 */
function itg_videogallery_video_private_public($videid, $status) {
  $api = itg_videogallery_dailymotion_api();
  $api->post('/video/' . $videid . '?private=' . $status);
  itg_videogallery_update_embedcode_url($videid);
}

/**
 * This function use for update embed url
 */
function itg_videogallery_update_embedcode_url($video_id) {
  $api = itg_videogallery_dailymotion_api();
  $thumb_url = $api->get(
      '/video/' . $video_id, array('fields' => array('embed_url'))
  );
  $embed_id = "";
  if ($thumb_url['embed_url']) {
    $embed_id = end(explode('/', $thumb_url['embed_url']));
  }
  $query = db_update('itg_solr_video_info')
      ->fields(array('video_embedded_url' => $embed_id));
  $query->condition('solr_video_id', $video_id);
  $query->execute();
}

/**
 * Implement dailymotion api call
 * @param string $real_path
 * @param int $key
 * @param string $uri
 * @param int $fid
 * @return array
 */
function itg_videogallery_dailymotion($real_path, $uri, $fid, $tags_value, $node_id, $is_private = NULL) {
  $api = itg_videogallery_dailymotion_api();
  if ($is_private == 'Yes') {
    $is_private = 'true';
  }
  else {
    $is_private = 'false';
  }
  try {
    if (itg_videogallery_check_ftp_video($fid)) {
      $ftp_file = explode('/' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/', $real_path);
      $uri = 'public://dailymotion-ftp/' . $ftp_file[1];
      $url = FTP_URL_VIDEO . $ftp_file[1];
    }
    elseif (strpos($real_path, '/s3fs') === FALSE) {

      $url = $api->uploadFile($real_path);
    }
    else {
      $url = $real_path;
    }
    $file_name = $ftp_file[1];
    if ($ftp_file[1] == "") {
      $file_name = file_load($fid);
      $file_name = $file_name->filename;
    }
// $url = $real_path;
    $result = $api->post(
        '/me/videos', array(
      'url' => $url,
      'title' => $file_name,
      'tags' => $tags_value,
      'channel' => 'tv',
      'private' => $is_private,
      'published' => TRUE,
        )
    );
    itg_videogallery_update_embedcode_url($result['id']);
    $playlist_id = variable_get('video_property');
//  $resp = $api->post('/playlist/' . $playlist_id . '/videos/' . $result['id']);
    $dur = $api->get(
        '/video/' . $result['id'], array('fields' => array('duration'))
    );
    $result['duration'] = $dur['duration'];
    ftp_close($connection_id);
    $a = new Dailymotion();
    $a->logout();
    $result['fid'] = $fid;
    $result['tags'] = $tags_value;
  }
  catch (Exception $e) {

    if ($e->getMessage() == "This `client_id' doesn't exist.") {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_set_message(t('API Key is wrong.'), 'error');
      drupal_goto('dailymotion/config');
    }
    elseif ($e->getMessage() == "Invalid `client_secret'") {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_set_message(t('Secret Key is wrong.'), 'error');
      drupal_goto('dailymotion/config');
    }
    elseif ($e->getCode() == 6) {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_set_message(t('There is some issue with internet connection.'), 'error');
      drupal_goto('node/' . $node_id . '/edit', array('query' => array('destination' => 'manage-videogallery')));
    }
    elseif ($e->getCode() == 400) {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_get_messages();
      drupal_set_message(t('Do not use space in FTP filename. Please remove and again upload file without space in file name.'), 'error');
      drupal_goto('node/' . $node_id . '/edit', array('query' => array('destination' => 'manage-videogallery')));
    }
    else {
      drupal_set_message($e->getMessage(), 'error');
    }
  }
  return $result;
}

/**
 * Implements function for custom validate.
 * @param array $form
 * @param array $form_state
 */
function itg_videogallery_custom_validate($form, &$form_state) {
//schedule date & expiry date validation
  $is_migrate_validate = 0;
  $current_time = time();
  $schedule_date = strtotime($form_state['values']['field_story_schedule_date_time'][LANGUAGE_NONE][0]['value']);
  $expiry_date = strtotime($form_state['values']['field_story_expiry_date'][LANGUAGE_NONE][0]['value']);
  if (isset($expiry_date) && ($schedule_date > $expiry_date)) {
    form_set_error('field_story_expiry_date', t("Expiry date should be greater then schedule start date"));
  }

  if ($expiry_date < $current_time) {
    form_set_error('field_story_expiry_date', t("Expiry date should be greater from now."));
  }
  foreach ($form_state['values']['field_video_upload']['und'] as $videofields) {

    if ((int) $videofields['field_videogallery_video_upload']['und'][0]['fid'] != 0) {
      $fids[] = (int) $videofields['field_videogallery_video_upload']['und'][0]['fid'];
    }
  }

  foreach ($form_state['values']['field_video_upload']['und'] as $videofields) {
    if ($videofields['field_migrated_video_url']['und'][0]['value'] != "" && $videofields != 'Add another item') {

      $is_migrate_validate = 1;
    }
  }
  if ($form_state['values']['field_story_source_type'][LANGUAGE_NONE][0]['value'] != 'migrated') {
    if (empty($fids)) {
      form_set_error('field_video_upload', t("Please select video."));
    }
  }

  if ($is_migrate_validate == 1 && !empty($fids)) {
    form_set_error('field_video_upload', t("Please Remove Migrated Video Url."));
  }
  if ($is_migrate_validate == 0) {
    if (!in_array($form_state['values']['field_story_source_type'][LANGUAGE_NONE][0]['value'], array('UGC', 'OCTOPUS'))) {
      $form_state['values']['field_story_source_type'][LANGUAGE_NONE][0]['value'] = "videogallery";
    }
    // Setting source type if request occured from Octopus rundown  
    if (isset($_GET['octopus_ref']) && !empty($_GET['octopus_ref'])) {
      $form_state['values']['field_story_source_type'][LANGUAGE_NONE][0]['value'] = "OCTOPUS";
    }
  }
}

/**
 * After build for story form.
 * {@inheritdoc}
 */
function itg_videogallery_after_build($form, &$form_state) {
  $arg = arg(2);
  global $user, $base_url;
  // apply button for editor and siteadmin role
  if (array_key_exists(EDITOR, $user->roles) || array_key_exists(SITE_ADMIN, $user->roles) || array_key_exists(SECTION_EDITOR_ANCHOR, $user->roles) || array_key_exists(COPY_EDITOR, $user->roles)) {
    if (!empty($form['nid']['#value']) && arg(2) == 'edit' && $form['#node']->type == 'videogallery' && $form['#node']->status == '1') {
      $form['actions']['itg_custom_apply_video_button'] = array(
        '#type' => 'submit',
        '#value' => t('Apply'),
        '#id' => 'btn-apply',
        '#submit' => array('node_form_submit', 'itg_videogallery_submit_status_message'),
        '#weight' => -8,
      );
    }
  }
  if ($form_state['values']['field_story_source_type'][LANGUAGE_NONE][0]['value'] != 'migrated') {
    foreach ($form['field_video_upload']['und'] as $delta => $field) {
      if (is_numeric($delta)) {
        unset($form['field_video_upload']['und'][$delta]['field_migrated_video_url']);
        unset($form['field_multi_bitrate']);
        unset($form['field_noindex_nofollow']);
        $video_fid = $form['field_video_upload']['und'][$delta]['field_videogallery_video_upload']['und'][0]['#default_value']['fid'];

        if (arg(1) == 'ajax' && $form_state['values']['nid'] > 0) {
          if ($video_fid == "" || $video_fid == 0) {
            //unset($form['field_video_upload']['und'][$delta]);
          }
        }
      }
    }
  }

  if ($form_state['values']['field_story_source_type'][LANGUAGE_NONE][0]['value'] == 'migrated') {
    foreach ($form['field_video_upload']['und'] as $delta => $field) {
      if (is_numeric($delta)) {
        $video_url = $form['field_video_upload']['und'][$delta]['field_migrated_video_url']['und'][0]['value']['#default_value'];
        $video_fid = $form['field_video_upload']['und'][$delta]['field_videogallery_video_upload']['und'][0]['#default_value']['fid'];
        if (!empty($video_url)) {
          unset($form['field_video_upload']['und'][$delta]['field_include_ads']);
          unset($form['field_video_upload']['und'][$delta]['field_video_private']);
          unset($form['field_video_upload']['und'][$delta]['field_video_title']);
          unset($form['field_video_upload']['und'][$delta]['field_videogallery_video_upload']);
          unset($form['field_video_upload']['und'][$delta]['field_video_thumbnail']);
        }
        
        if ($video_fid != "") {
          unset($form['field_video_upload']['und'][$delta]['field_migrated_video_url']);
        }
      }
    }
  }
  else {
    foreach ($form['field_video_upload']['und'] as $delta => $field) {
      if (is_numeric($delta)) {
        if ($arg == 'edit') {
          $video_fid = $form['field_video_upload']['und'][$delta]['field_videogallery_video_upload']['und'][0]['#default_value']['fid'];
          $file_exist = itg_videogallery_check_file_manage_fid($video_fid);
          if (empty($file_exist) || $video_fid < 1) {
            //$form['field_video_upload']['und'][$delta]['#access'] = FALSE;
            // unset($form['field_video_upload']['und'][$delta]);
          }
        }
      }
    }
  }
  $form['original_image_fids'] = array(
    '#type' => 'hidden',
    '#value' => isset($form_state['input']['original_image_fids']) ? $form_state['input']['original_image_fids'] : '',
    '#attributes' => array('id' => 'original_image_fids', 'name' => 'original_image_fids'),
  );
  if (!isset($form['#node']->nid)) {
// hide remove button of first field on add form 
    drupal_add_js('jQuery(document).ready(function() {
              jQuery("#edit-field-story-reporter-und-0-remove-button").hide();              
              jQuery("#edit-field-video-anchor-und-0-remove-button").hide();
            });', array('type' => 'inline', 'scope' => 'footer'));
  }


  $settings = array();
  $settings['base_url'] = $base_url;
  $settings['uid'] = $user->uid;
  drupal_add_js(array('itg_videogallery' => array('settings' => $settings)), array('type' => 'setting'));
  drupal_add_js(drupal_get_path('module', 'itg_videogallery') . '/js/itg_videogallery.js', array('weight' => 1, 'scope' => 'footer'));
  return $form;
}

/**
 * Implements hook_form_FORMID_alter().
 * {@inheritdoc}
 */
function itg_videogallery_form_videogallery_node_form_alter(&$form, &$form_state, $form_id) {
  global $base_url, $user;
// code for story expiry date field show and hide
  $form['field_story_expiry_date']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_expires[und][Yes]"]' => array('checked' => TRUE),
    )
  );

// code for Comment Question field hide and show
  $form['field_story_comment_question']['#states'] = array(
    'visible' => array(
      ':input[name="field_video_configurations[und][comment_box]"]' => array('checked' => TRUE),
    )
  );

  $form['field_story_posted_by_twitter']['#default_value'] = $user->mail;
  $form['field_story_posted_by_instagram']['#default_value'] = $user->mail;
}

/**
 * Implement hook_form_FORM_ID_alter().
 * {@inheritdoc}
 */
function itg_videogallery_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  $form_id_arr = array('views-exposed-form-manage-videogallery-page', 'views-exposed-form-videogallery-management-page', 'views-exposed-form-videogallery-management-page-1', 'views-exposed-form-videogallery-management-page-2', 'views-exposed-form-videogallery-management-page-3', 'views-exposed-form-videogallery-management-page-5', 'views-exposed-form-videogallery-management-page-6', 'views-exposed-form-videogallery-management-page-7', 'views-exposed-form-videogallery-management-page-4', 'views-exposed-form-videogallery-management-page-10');
  if (in_array($form['#id'], $form_id_arr)) {
    $form['title']['#autocomplete_path'] = 'content-title-list/videogallery/autocomplete';
    $form['title']['#attributes'] = array('placeholder' => t('Title'));
    $form['nid']['#autocomplete_path'] = 'content-nid-list/videogallery/autocomplete';
    $form['nid']['#attributes'] = array('placeholder' => t('Video Id'));
  }
}

/**
 * Implement hook_views_pre_render().
 * {@inheritdoc}
 */
function itg_videogallery_views_pre_render(&$view) {
  if ($view->name == "manage_videogallery" || $view->name == "videogallery_management") {
    if (!isset($_POST['views_bulk_operations'])) {
      $header_content_video = '<span class="count">Count(' . $view->total_rows . ')&nbsp;</span>';
      $header_content_video .= l(t('Upload Video'), 'node/add/videogallery', array('query' => array('destination' => arg(0))));
      $view->attachment_before = $header_content_video;
    }
  }
  if ($view->name == "video_list_of_category" && $view->current_display == 'block_4') {
    if (isset($view->args[0])) {
      $cat_name = itg_videogallery_get_tname($view->args[0]);
      $header_content_video = '<div class="other_video_category"><h3><span>Other Videos from ' . $cat_name . '</span></h3></div>';
      $view->attachment_before = $header_content_video;
    }else{
      $header_content_video = '<div class="other_video_category"><h3><span>Other Videos from category</span></h3></div>';
      $view->attachment_before = $header_content_video;
    }
  }
}

/**
 * Implements submit function for bolt video title in msg.
 * @param array $form
 * @param array $form_state
 */
function itg_videogallery_submit_status_message(&$form, $form_state) {
  if ($form_state['input']['op'] == 'Apply') {
    if ($form_state['node']->status == '1') {
      /* Assign video to widget */
      if (is_array($form['#node']->field_video_assign_to_widget[LANGUAGE_NONE])) {
        $previous_video_assign = $form['#node']->field_video_assign_to_widget[LANGUAGE_NONE];
      }
      else {
        $previous_video_assign = '';
      }

      // for story assign to widget
      if (function_exists('itg_video_assign_to_widget')) {
        $video_widget = $form_state['input']['field_video_assign_to_widget'][LANGUAGE_NONE];
        $primary_category = $form_state['input']['itg_primary_category'];
        if (is_array($video_widget) && count($video_widget) > 0) {
          itg_video_assign_to_widget($form_state['values']['nid'], $video_widget, $primary_category, $previous_video_assign);
        }
      }
      /* Assign video to widget */
      $redirect_path = 'node/' . $form_state['values']['nid'] . '/edit?destination=' . $_GET['destination'];
      $_GET['destination'] = $redirect_path;
      drupal_goto('node/' . $form_state['values']['nid'] . '/edit');
    }
  }
  $workbench_current_state = $form_state['node']->workbench_moderation_state_new;
  $node_type = ucfirst($form_state['node']->type);
  $node_type = str_replace("_", " ", $node_type);
  $title = ucfirst($form_state['node']->title);

  if (isset($_SESSION['messages']['status'])) {
    unset($_SESSION['messages']['status']);
  }
  $request_destination = $_REQUEST['destination'];
  $redirect_path = $_REQUEST['destination'];

  if ($request_destination == 'published-video') {
    $redirect_path .= "?field_story_syndication_value_op=all";
    itg_custom_message($node_type, $workbench_current_state, arg(1), $title, $redirect_path);
  }

  if ($form_state['input']['op'] != 'Save as Draft') {
    itg_custom_message($node_type, $workbench_current_state, arg(1), $title, $redirect_path);
  }
}

/**
 * Impelements form for configuration.
 * {@inheritdoc}
 */
function itg_videogallery_configuration_form($form) {
  $form['dailymotion_username'] = array(
    '#type' => 'textfield',
    '#title' => t('Dailymotion Username'),
    '#default_value' => variable_get('dailymotion_username'),
    '#required' => TRUE,
  );
  $form['dailymotion_password'] = array(
    '#type' => 'textfield',
    '#title' => t('Dailymotion Password'),
    '#default_value' => variable_get('dailymotion_password', ''),
    '#required' => TRUE,
  );
  $form['dailymotion_playlist_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Dailymotion Playlist Id'),
    '#default_value' => variable_get('dailymotion_playlist_id', ''),
    '#required' => TRUE,
  );
  $form['dailymotion_apikey'] = array(
    '#type' => 'textfield',
    '#title' => t('Api Key'),
    '#default_value' => variable_get('dailymotion_apikey', ''),
    '#required' => TRUE,
  );
  $form['dailymotion_secretkey'] = array(
    '#type' => 'textfield',
    '#title' => t('Secret Key'),
    '#default_value' => variable_get('dailymotion_secretkey', ''),
    '#required' => TRUE,
  );

  $form['video_property'] = array(
    '#type' => 'textfield',
    '#title' => t('Property'),
    '#default_value' => variable_get('video_property'),
    '#required' => TRUE,
  );

  return system_settings_form($form);
}

/**
 * This function use for remove video iframe form story body
 */
function itg_videogallery_save_story_video_data($story_body, $nid) {
  global $base_url;
  preg_match_all('/src="([^"]+)"/', $story_body, $match);
  $video_url = $match[1];
  if (!empty($video_url)) {
    // Here delete videos from table
    db_delete('itg_story_body_videos')
        ->condition('nid', $nid)
        ->execute();
    foreach ($video_url as $video_value) {
      $post_check = strpos($video_value, '/embeded-video/');
      $post_video_node = strpos($video_value, '/embed/');
      $post_video_node_video = strpos($video_value, '/video/');
      if ($post_check !== FALSE) {
        $vid_id = end(explode('/', $video_value));
        $vid_id = explode('?', $vid_id);
        db_insert('itg_story_body_videos')
            ->fields(array(
              'is_node' => 0,
              'video_id' => $vid_id[0],
              'url' => $video_value,
              'nid' => $nid,
            ))->execute();
      }
      if ($post_video_node !== FALSE && $post_video_node_video !== FALSE) {
        $vid_id = end(explode('/', $video_value));
        $node_id = base64_decode($vid_id);
        db_insert('itg_story_body_videos')
            ->fields(array(
              'is_node' => 1,
              'video_id' => $vid_id,
              'url' => $video_value,
              'nid' => $nid,
            ))->execute();
        //$node_data = itg_videogallery_get_node_status($node_id);
      }
    }
  }
}

/**
 * This function use for remove video iframe form story body
 */
function itg_videogallery_remove_delete_video_form_body_html_body($story_body) {
  global $base_url;
  preg_match_all('/src="([^"]+)"/', $story_body, $match);
  $video_url = $match[1];
  if (!empty($video_url)) {
    foreach ($video_url as $video_value) {
      $post_check = strpos($video_value, $base_url . '/embeded-video/');
      $post_video_node = strpos($video_value, '/embed/');
      $post_video_node_video = strpos($video_value, '/video/');
      if ($post_check !== FALSE) {
        $vid_id = end(explode('/', $video_value));
        $vid_id = explode('?', $vid_id);
        $check_video = itg_videogallery_check_video_url($vid_id[0]);
        if ($check_video) {
          drupal_add_js('jQuery(document).ready(function() {                  
            jQuery("#video_frame_' . $vid_id[0] . '").remove();
          });', array('type' => 'inline', 'scope' => 'footer'));
        }
      }
      if ($post_video_node !== FALSE && $post_video_node_video !== FALSE) {
        $vid_id = end(explode('/', $video_value));
        $node_id = base64_decode($vid_id);
        $node_data = itg_videogallery_get_node_status($node_id);
        if ($node_data == 0) {
          drupal_add_js('jQuery(document).ready(function() {                  
            jQuery(".video_node_' . $vid_id . '").remove();
          });', array('type' => 'inline', 'scope' => 'footer'));
        }
      }
    }
  }
}

/**
 * This function check this video is delete or note 
 */
function itg_videogallery_check_video_url($vid) {
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('is_delete'));
  $query->condition('solr_video_id', $vid, '=');
  $video_data = $query->execute()->fetchAll();
  if (empty($video_data)) {
    return TRUE;
  }
  elseif (!empty($video_data)) {
    foreach ($video_data as $dvideo) {
      if ($dvideo->is_delete == 1) {
        return TRUE;
        break;
      }
    }
  }
  else {
    return FALSE;
  }
}

/**
 * Implement itg_clone_story_data
 * @param int $keyword
 * @param string $type
 */
function itg_videogallery_getsolr_data() {
  if (function_exists('apachesolr_server_status')) {
    $ping = apachesolr_server_status(variable_get('solr_server_url'));
  }
  if ($ping) {
    $solr = apachesolr_get_solr();
    if (function_exists('itg_apache_solr_get_site_hash')) {
      $hash = itg_apache_solr_get_site_hash();
    }
    $all_video_ids = array();
    $hashvalue = implode(' OR ', array_keys($hash));
    $str = 'hash:(' . $hashvalue . ')';
    $query = apachesolr_drupal_query("custom");
    $query->addParam('rows', '10000'); // How many rows of result to display default it is 10.
    $query->addParam('qf', 'label'); // Only search in title
//The bundle which you want to search
    $query->replaceParam("fq", '(' . $str . ')');
    $query->addFilter("bundle", "itg_delete_solr_video");
    $query->setSolrsort('sort_label', 'asc');
    $resp_search = $query->search();
    $all_data = $resp_search->response->docs;
    if (!empty($all_data)) {
      foreach ($all_data as $datasolr) {
        $all_video_ids[] = $datasolr->label;
      }
    }
    return array_reverse($all_video_ids);
  }
}

/**
 * Implement itg_clone_story_data
 * @param int $keyword
 * @param string $type
 */
function itg_videogallery_getsolr_data_publish($all_property = NULL) {
  if (function_exists('apachesolr_server_status')) {
    $ping = apachesolr_server_status(variable_get('solr_server_url'));
  }
  if ($ping) {
    $solr = apachesolr_get_solr();
    if (function_exists('itg_apache_solr_get_site_hash')) {
      $hash = itg_apache_solr_get_site_hash();
    }
//  $all_video_ids = array();
    $hashvalue = implode(' OR ', array_keys($hash));
    $str = 'hash:(' . $hashvalue . ')';
    $str_pub = 'sm_field_video_used:(0)';
    $str = $str . ' AND ' . $str_pub;
    $query = apachesolr_drupal_query("custom");
    $query->addParam('rows', '100000'); // How many rows of result to display default it is 10.
    $query->addParam('qf', 'label'); // Only search in title
    //$query->addParam('qf', 'label');
//The bundle which you want to search
    $query->replaceParam("fq", '(' . $str . ')');
    $query->addFilter("bundle", "itg_solr_video");
    $query->setSolrsort('sort_label', 'asc');
    $resp_search = $query->search();

    $all_data = $resp_search->response->docs;
    if (!empty($all_data)) {
      foreach ($all_data as $datasolr) {
        if ($all_property == 'ALL') {
          $all_video_ids[] = $datasolr->sm_field_video_id[0];
        }
        else {
          if ($datasolr->sm_field_property[0] != VIDEO_PROPERTY) {
            $all_video_ids[] = $datasolr->sm_field_video_id[0];
          }
        }
      }
    }
    return $all_video_ids;
  }
}

/**
 * Implement itg_clone_story_data
 * @param int $keyword
 * @param string $type
 */
function itg_videogallery_getsolr_data_unpublish() {
  if (function_exists('apachesolr_server_status')) {
    $ping = apachesolr_server_status(variable_get('solr_server_url'));
  }
  if ($ping) {
    $solr = apachesolr_get_solr();
    if (function_exists('itg_apache_solr_get_site_hash')) {
      $hash = itg_apache_solr_get_site_hash();
    }
//  $all_video_ids = array();
    $hashvalue = implode(' OR ', array_keys($hash));
    $str = 'hash:(' . $hashvalue . ')';
    $str_pub = 'sm_field_video_used:(0)';
    $str = $str . ' AND ' . $str_pub;
    $query = apachesolr_drupal_query("custom");
    $query->addParam('rows', '100000'); // How many rows of result to display default it is 10.
    $query->addParam('qf', 'label'); // Only search in title
    //$query->addParam('qf', 'label');
//The bundle which you want to search
    $query->replaceParam("fq", '(' . $str . ')');
    $query->addFilter("bundle", "itg_solr_video");
    $query->setSolrsort('sort_label', 'asc');
    $resp_search = $query->search();

    $all_data = $resp_search->response->docs;
    if (!empty($all_data)) {
      foreach ($all_data as $datasolr) {
        $all_video_ids['unpubliash_video_id'][] = $datasolr->sm_field_video_id[0];
        if ($datasolr->sm_field_is_replace[0] == 1) {
          $all_video_ids['replace_video'][] = $datasolr->sm_field_video_id[0];
        }
      }
    }
    return $all_video_ids;
  }
}

/**
 * This function use for removed parent deleted video
 * 
 */
function itg_videogallery_remove_video_id_parent_site_delete_or_unpublish() {
  // Here remove unpublish video iframe.
  $query = db_select('itg_story_body_videos', 'isbv');
  $query->fields('isbv');
  $query->condition('is_node', '1');
  $video_data = $query->execute()->fetchAll();
  if (isset($video_data) && !empty($video_data)) {
    foreach ($video_data as $story_body_video) {
      $nid = $story_body_video->nid;
      $main_video_nid = base64_decode($story_body_video->video_id);
      $node_data = itg_videogallery_get_node_status($main_video_nid);
      if ($node_data == 0) {
        $node = node_load($nid);
        $node_body = $node->body['und'][0]['value'];
        preg_match_all('/src="([^"]+)"/', $node_body, $match);
        $video_url = $match[1];
        if (!empty($video_url)) {
          foreach ($video_url as $video_value) {
            $post_check = strpos($video_value, '/embed/' . $story_body_video->video_id);
            if ($post_check) {
              $ifreame = '<iframe allowfullscreen="" frameborder="0" height="480" src="' . $story_body_video->url . '" width="648"></iframe>';
              $html = str_replace($ifreame, "", $node_body);
              $node->body['und'][0]['value'] = $html;
              field_attach_update('node', $node);
              // delete video.
               $url = drupal_get_path_alias('node/' . $nid);
              if (function_exists('itg_akamai_clear_url')) {
                $url = drupal_get_path_alias('node/' . $nid);
                itg_akamai_clear_url($url);
              }
              db_delete('itg_story_body_videos')
                  ->condition('id', $story_body_video->id)
                  ->execute();
            }
          }
        }
      }
    }
  }
  
  
  $solr_data = itg_videogallery_getsolr_data_unpublish();
  $unpublish_video_id = $solr_data['unpubliash_video_id'];
  $unpublish_replace_id = $solr_data['replace_video'];
  $solr_data_deleted = itg_videogallery_getsolr_data();
  
  //  Here node dekete and unpublish
  if (!empty($solr_data_deleted)) {
    $query = db_select('itg_solr_video_info', 'drd');
    $query->fields('drd', array('fid', 'nid', 'solr_video_id', 'id', 'property', 'content_type'));
    $query->condition('solr_video_id', $solr_data_deleted, 'IN');
    $video_data = $query->execute()->fetchAll();
    if (!empty($video_data)) {
      $node_by_video = array();
      foreach ($video_data as $data_delete) {
        $node_by_videop['fid'][$data_delete->nid][] = $data_delete->fid;
        $node_by_videop['video_id'][$data_delete->nid][] = $data_delete->solr_video_id;
        if ($data_delete->content_type == 'video_gallery') {
          $node_by_videop['nid'][$data_delete->nid][] = $data_delete->nid;
          $node_by_videop['content_type'][$data_delete->nid] = $data_delete->content_type;
        }
      }

      foreach ($node_by_videop['fid'] as $nkey => $fids) {
        foreach ($fids as $nky => $vide_fid) {
          try {
            $getnode = itg_videogallery_get_node_by_title($vide_fid);
            if (!empty($getnode)) {
              node_delete($getnode[0]->nid);
            }

            $deleted = db_delete('file_managed')
                ->condition('fid', $vide_fid)
                ->execute();
            $deleted = db_delete('itg_solr_video_info')
                ->condition('fid', $vide_fid, ' = ')
                ->execute();
          }
          catch (Exception $e) {
            watchdog_exception('file manage delete', $e);
          }
        }
      }
      foreach ($node_by_videop['nid'] as $key => $nid) {
        $query = db_select('itg_solr_video_info', 'drd');
        $query->fields('drd', array('fid'));
        $query->condition('nid', $nid, 'IN');
        $query->condition('content_type', 'video_gallery', '=');
        $video_data = $query->execute()->fetchAll();
        if (count($video_data) <= 0) {
          $node_data = node_load($nid[0]);
          if (!empty($node_data)) {
            $node_data->status = 0;
            node_save($node_data);
          }
        }
      }
    }
  }

  $video_data = "";
  // Here corne for CK Editor.
  if (!empty($unpublish_video_id)) {
    $query = db_select('itg_story_body_videos', 'isbv');
    $query->fields('isbv');
    $query->condition('video_id', $unpublish_video_id, 'IN');
    $query->condition('is_node', '0');
    $video_data = $query->execute()->fetchAll();
    if (isset($video_data) && !empty($video_data)) {
      foreach ($video_data as $story_body_video) {
        $nid = $story_body_video->nid;
        $node = node_load($nid);
        $node_body = $node->body['und'][0]['value'];
        preg_match_all('/src="([^"]+)"/', $node_body, $match);
        $video_url = $match[1];
        if (!empty($video_url)) {
          foreach ($video_url as $video_value) {
            $post_check = strpos($video_value, '/embeded-video/' . $story_body_video->video_id);
            if ($post_check) {
              $ifreame = '<iframe allowfullscreen="" class="video_data" frameborder="0" id="video_frame_' . $story_body_video->video_id . '" scrolling="no" src="' . FRONT_URL_VIDEO . '/embeded-video/' . $story_body_video->video_id . '"></iframe>';
              $video_id = "$story_body_video->video_id";
              $html = str_replace($ifreame, "", $node_body);
              $node->body['und'][0]['value'] = $html;
              field_attach_update('node', $node);
              if (function_exists('itg_akamai_clear_url')) {
                $url = drupal_get_path_alias('node/' . $nid);
                itg_akamai_clear_url($url);
              }
              // delete video.
              db_delete('itg_story_body_videos')
                  ->condition('id', $story_body_video->id)
                  ->execute();
            }
          }
        }
      }
    }
  }


  //  Here node dekete and unpublish
  if (!empty($unpublish_replace_id)) {
    $query = db_select('itg_solr_video_info', 'drd');
    $query->fields('drd', array('fid', 'nid', 'solr_video_id', 'id', 'property', 'content_type'));
    $query->condition('solr_video_id', $unpublish_replace_id, 'IN');
    $video_data = $query->execute()->fetchAll();
    if (!empty($video_data)) {
      $node_by_video = array();
      foreach ($video_data as $data_delete) {
        $node_by_videop['fid'][$data_delete->nid][] = $data_delete->fid;
        $node_by_videop['video_id'][$data_delete->nid][] = $data_delete->solr_video_id;
        if ($data_delete->content_type == 'video_gallery') {
          $node_by_videop['nid'][$data_delete->nid][] = $data_delete->nid;
          $node_by_videop['content_type'][$data_delete->nid] = $data_delete->content_type;
        }
      }

      foreach ($node_by_videop['fid'] as $nkey => $fids) {
        foreach ($fids as $nky => $vide_fid) {
          try {

            $deleted = db_delete('file_managed')
                ->condition('fid', $vide_fid)
                ->execute();
            $deleted = db_delete('itg_solr_video_info')
                ->condition('fid', $vide_fid, ' = ')
                ->execute();
          }
          catch (Exception $e) {
            watchdog_exception('file manage delete', $e);
          }
        }
      }
      foreach ($node_by_videop['nid'] as $key => $nid) {
        $query = db_select('itg_solr_video_info', 'drd');
        $query->fields('drd', array('fid'));
        $query->condition('nid', $nid, 'IN');
        $query->condition('content_type', 'video_gallery', '=');
        $video_data = $query->execute()->fetchAll();
        if (count($video_data) <= 0) {
          $node_data = node_load($nid[0]);
          if (!empty($node_data)) {
            $node_data->status = 0;
            node_save($node_data);
          }
        }
      }
    }
  }
}

/*
 * This function use for itg_delete_solr_video node delete
 */

function itg_videogallery_delele_node_reuse_video($vide_id) {
  $result = db_select('node', 'n')
      ->fields('n', array('nid'))
      ->condition('title', $vide_id, ' = ')
      ->execute()
      ->fetchAssoc();
  if (!empty($result['nid'])) {
    node_delete($result['nid']);
  }
}

/**
 * This function use for removed or replaced video from other content
 * 
 */
function itg_videogallery_remove_video_with_child() {
  $video_data = "";
  global $user;
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('fid', 'nid', 'solr_video_id', 'id', 'property','video_repo_type'));
  $query->condition('is_delete', '1', ' = ');
  $video_data = $query->execute()->fetchAll();
  foreach ($video_data as $data_delete) {

    if ($data_delete->fid != "") {
      //Getting all fids of this video id
      $query = db_select('itg_solr_video_info', 'drd');
      $query->fields('drd', array('fid'));
      $query->condition('solr_video_id', $data_delete->solr_video_id, ' = ');
      $video_data1 = $query->execute()->fetchAll();
      foreach ($video_data1 as $viddata) {

        try {
          $deleted = db_delete('file_managed')
              ->condition('fid', $viddata->fid)
              ->execute();
        }
        catch (Exception $e) {
          watchdog_exception('file manage delete', $e);
        }
      }
      if ($data_delete->property == VIDEO_PROPERTY) {
// $is_video_exist = itg_videogallery_get_video_info_video_id($data_delete->solr_video_id);
        $query = db_update('dailymotion_response_details');
        $query->fields(array('dailymotion_published' => 0, 'is_replace' => 1));
        $query->condition('video_id', $data_delete->solr_video_id, ' = ');
        $query->execute();
        itg_videogallery_update_video_info_solr($data_delete->solr_video_id);
        if($data_delete->video_repo_type != 'INTERNAL') {
        itg_videogallery_video_private_public($data_delete->solr_video_id, FALSE);
        }
      }

// delete from itg_solr_video_info table
      $deleted = db_delete('itg_solr_video_info')
          ->condition('solr_video_id', $data_delete->solr_video_id, ' = ')
          ->condition('property', VIDEO_PROPERTY, ' = ')
          ->execute();
    }
  }
}


/**
 * function use for insert solr video in file_manage for fid
 * @global object $user
 * 
 */
function itg_videogallery_solr_video_insert_in_for_fid() {
  global $user;
  $videos_data = $_POST['checkvalue'];
  $return_fid = array();

  if (!empty($videos_data)) {
    foreach ($videos_data as $video_info) {
      $expode_video_info = explode('#', $video_info);
      $videourl = 'public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/' . rand(111,9999) . '/' . time() . '/' . $expode_video_info[0] . '.mp4';
      $fid = db_insert('file_managed')
          ->fields(array(
            'uid' => $user->uid,
            'filename' => $expode_video_info[2],
            'uri' => $videourl,
            'filemime' => 'video/mp4',
            'filesize' => $expode_video_info[1],
            'status' => 1,
            'timestamp' => REQUEST_TIME,
          ))
          ->execute();
      $file = file_load($fid);
      file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
      $is_used = 0;
      if (isset($expode_video_info[7]) && !empty($expode_video_info[7])) {
        $is_used = 1;
      }
      if($expode_video_info[8] == "") {
        $expode_video_info[8] = 'DM';
      }
      $fid = db_insert('itg_solr_video_info')
          ->fields(array(
            'fid' => $file->fid,
            'solr_video_id' => $expode_video_info[0],
            'solr_video_duration' => $expode_video_info[4],
            'solr_video_size' => $expode_video_info[1],
            'property' => $expode_video_info[5],
            'content_type' => $expode_video_info[6],
            'video_repo_type' => $expode_video_info[8],
            'video_xml_data' => $expode_video_info[9],
            'is_alredy_used' => $is_used,
            'solr_video_thumb' => $expode_video_info[3],
          ))
          ->execute();
      $return_fid[] = $file->fid;
    }
//}
  }
  exit(json_encode($return_fid));
}

/*
 * This callback use for delete video from local and daily motion
 */

function delete_daily_motion_video_callback() {
  $video_id = arg(1);
  $query = db_delete('dailymotion_response_details');
  $query->condition('video_id', $video_id);
  if ($query->execute()) {
    $video_info = itg_videogallery_get_video_solrcontent($video_id);
    if (!empty($video_info[0]->nid)) {

      itg_node_exclude($video_info[0]->nid);

      node_delete($video_info[0]->nid);
    }
// insert delete video in content type
    global $user;
    $node = new stdClass();
    $node->title = $video_id;
    $node->type = "itg_delete_solr_video";
    node_object_prepare($node); //Invokes hook_prepare() and hook_node_prepare().
    $node->language = LANGUAGE_NONE;
    $node->uid = $user->uid;
    $node->field_video_is_delete[LANGUAGE_NONE][0]['value'] = 1;
    $node->status = 1; //(1 or 0): Published or not
    $node->promote = 0; //(1 or 0): Promoted to front page
    $node->comment = 0; // 0 = Comments disabled, 1 = read only, 2 = read/write
    $getnode = itg_videogallery_get_node_by_title($video_id);
    if (!empty($getnode)) {
      $node->nid = $getnode[0]->nid;
    }
    node_save($node);
    drupal_set_message(t('Video has been deleted successfully'));
    drupal_goto('daily-motion-video-dashboard');
  }
}

/**
 * function use delete delete solr index.
 * @param type $nid
 * @return boolean
 */
function itg_node_exclude($nid) {
  if (!empty($nid)) {
    $node = node_load($nid);
    $env_id = apachesolr_default_environment();
// Get field value (respecting the fild language).
    $node_wrapper = entity_metadata_wrapper('node', $node);
// Delete node from Index, in case it was indexed before.
    apachesolr_remove_entity($env_id, 'node', $nid);
// Return TRUE to exclude node from indexing.
    return TRUE;


    return FALSE;
  }
}

/**
 * Custom form defination for Daily motion dashboard.
 * @param array $form
 * @param array $form_state
 */
function daily_motion_video_dashboard($form, &$form_state) {

  $form['fieldset'] = array(
    '#type' => 'fieldset',
    '#title' => 'Daily Motion Video Dashboard',
  );
  $form['fieldset']['video_title'] = array(
    '#type' => 'textfield',
    '#title' => 'Title',
    '#attributes' => array(
      'placeholder' => t('Title'),
    ),
    '#default_value' => isset($_GET['video_title']) ? $_GET['video_title'] : '',
  );
  $form['fieldset']['channel'] = array(
    '#type' => 'select',
    '#title' => 'Channel',
    '#options' => array('' => '-All-', 'ftp' => 'FTP', 'LOCAL' => 'LOCAL', 'S3' => 'S3', 'OCTOPUS' => 'OCTOPUS','INTERNAL' => 'ITG Internal'),
    '#default_value' => isset($_GET['channel']) ? $_GET['channel'] : '',
  );

  $form['fieldset']['from_time'] = array(
    '#type' => 'date_popup',
    '#title' => t("From"),
    '#date_format' => 'd/m/Y H:i',
    '#attributes' => array('autocomplete' => 'off', 'readonly' => 'readonly', 'placeholder' => 'From Date'),
    '#default_value' => isset($_GET['from_time']) ? $_GET['from_time'] : format_date(REQUEST_TIME, 'custom', 'd/m/Y H:i'),
    '#date_timezone' => date_default_timezone(),
  );
// Facebook video schdule time.
  $form['fieldset']['to_time'] = array(
    '#type' => 'date_popup',
    '#title' => t("To"),
    '#date_format' => 'd/m/Y H:i',
    '#attributes' => array('autocomplete' => 'off', 'readonly' => 'readonly', 'placeholder' => 'To Date'),
    '#default_value' => isset($_GET['to_time']) ? $_GET['to_time'] : format_date(REQUEST_TIME, 'custom', 'd/m/Y H:i'),
    '#date_timezone' => date_default_timezone(),
  );
  $form['fieldset']['video_id'] = array(
    '#type' => 'textfield',
    '#title' => 'Video ID',
    '#attributes' => array(
      'placeholder' => t('Video ID'),
    ),
    '#default_value' => isset($_GET['video_id']) ? $_GET['video_id'] : '',
  );

  $form['fieldset']['filtertype'] = array(
    '#type' => 'select',
    '#title' => 'Status',
    '#options' => array('' => '-Select-', '1' => 'Published', '0' => 'Unpublished'),
    '#submit' => array('ge_custom_search_report_search_submit_dis'),
    '#default_value' => isset($_GET['filtertype']) ? $_GET['filtertype'] : '',
  );

  $form['fieldset']['display_button'] = array(
    '#type' => 'submit',
    '#value' => t('Search'),
    '#submit' => array('daily_motion_video_dashboard_submit'),
  );
  $form['filters']['buttons']['reset'] = array(
    '#type' => 'submit',
    '#value' => t('Reset'),
    '#limit_validation_errors' => TRUE,
    '#submit' => array('itg_videogallery_daily_motion_video_reset'));


  $form['markup'] = array(
    '#markup' => daily_motion_video_dashboard_rows(),
  );

  return $form;
}

/**
 * 
 * @param type $form
 * @param type $form_state
 * @param type $form_id
 */
function daily_motion_video_dashboard_validate($form, &$form_state, $form_id) {
  $flag = 0;
  if (!empty($form_state['values']['from_time']['date']) && empty($form_state['values']['from_time']['time'])) {

    $array_error['from_time[time]'] = t("Please Enter From Time.");
    $flag = 1;
  }
  if (!empty($form_state['values']['to_time']['date']) && empty($form_state['values']['to_time']['time'])) {
    $array_error['to_time[time]'] = t("Please Enter To Time.");
    $flag = 1;
  }
  if ($flag == 1) {
    drupal_get_messages('error');
    foreach ($array_error as $key => $msgs) {
      form_set_error(check_plain($key), check_plain($msgs));
    }
  }
}

/**
 * this function use for reset dailymotion dashboard filter
 * @param type $form
 * @param type $form_state
 */
function itg_videogallery_daily_motion_video_reset($form, $form_state) {
  $form_state['rebuild'] = FALSE;
  drupal_goto('daily-motion-video-dashboard');
}

/*
 * Submit handler for ITG dailymotion dashboard
 */

function daily_motion_video_dashboard_submit($form, &$form_state) {

  $video_id = $form_state['values']['video_id'];
  $filtertype = $form_state['values']['filtertype'];
  $video_title = $form_state['values']['video_title'];
  $channel = $form_state['values']['channel'];
  $video_title = $form_state['values']['video_title'];
  $channel = $form_state['values']['channel'];
  $totime = $form_state['values']['to_time'];
  $fromtime = $form_state['values']['from_time'];
  drupal_goto('daily-motion-video-dashboard', array('query' => array(
      'video_title' => $video_title,
      'channel' => $channel,
      'filtertype' => $filtertype,
      'video_id' => $video_id,
      'from_time' => $fromtime,
      'to_time' => $totime,
  )));
}

/**
 * This method returns the number of rows
 */
function daily_motion_video_dashboard_rows() {
  global $base_url;
  drupal_add_js(drupal_get_path('module', 'itg_videogallery') . '/js/itg_videogallery_dashbord.js', array('weight' => 1, 'scope' => 'footer'));
  $filtertype = isset($_GET['filtertype']) ? $_GET['filtertype'] : '';
  $video_id = isset($_GET['video_id']) ? $_GET['video_id'] : '';
  $video_title = isset($_GET['video_title']) ? $_GET['video_title'] : '';
  $channel = isset($_GET['channel']) ? $_GET['channel'] : '';
  $to_time = isset($_GET['to_time']) ? $_GET['to_time'] : '';
  $from_time = isset($_GET['from_time']) ? $_GET['from_time'] : '';
  $to_time = strtotime($to_time);
  $from_time = strtotime($from_time);
  $data = array();
  $html = '';
  $rows = array();
  $header = array(
    t('Sn no.'),
    t('Title'),
    t('Channel'),
    t('Uploaded Time'),
    t('Video Id'),
    t('Video Status'),
    t('Status'),
    t('Action'),
  );

  $query = db_select('dailymotion_response_details', 'n');
  $query->fields('n');
  if (isset($filtertype) && $filtertype != "") {
    $query->condition('n.dailymotion_published', $filtertype, '=');
  }
  if (isset($video_id) && !empty($video_id)) {
    $query->condition('n.video_id', $video_id, '=');
  }

  if (isset($video_title) && !empty($video_title)) {

    $query->condition('n.title', '%' . db_like($video_title) . '%', 'LIKE');
  }
  if (isset($channel) && !empty($channel)) {

    $query->condition('n.type', $channel, '=');
  }
  if (isset($from_time) && !empty($from_time)) {

    $query->condition('n.upload_time', $from_time, '>=');
  }
  if (isset($to_time) && !empty($to_time)) {

    $query->condition('n.upload_time', $to_time, '<=');
  }
  $pagelimit = 20;
//print strtr((string) $query, $query->arguments());die;
  $query = $query->extend('PagerDefault')->limit($pagelimit);
  $query->orderBy('n.eid', 'DESC');
  $result = $query->execute();
  $num_of_results = $result->rowCount();
  $sn = 1;
  if (isset($_GET['page']) && !empty($_GET['page'])) {
    $sn = $pagelimit * $_GET['page'] + 1;
  }
  while ($record = $result->fetchObject()) {
    if ($record->dailymotion_published == 1) {
      $status_flag = '<span class="used-video">Used</span>';
      $delete_link = '';
    }
    else {
      if ($record->encoding_progress == '100') {
        $status_flag = '<span class="ready-to-use-video">Ready To Use</span>';
        if (strtoupper($record->type) != 'LOCAL') {
          $delete_link = "<a  class='dalymotion-video-delete' href='" . $base_url . "/delete_daily_motion_video/" . $record->video_id . "' > Delete </a>";
        }
      }
      if ($record->encoding_progress != '100' && $record->publishing_progress != '100') {
      if($record->video_type == 'INTERNAL') {
       $status_flag = '<span class="under-precess">Completed</span>';

      }else {
        $status_flag = '<span class="under-precess">Processing (' . $record->publishing_progress . ')%</span>';

      }
        if (strtoupper($record->type) != 'LOCAL') {
          $delete_link = "<a  class='dalymotion-video-delete' href='" . $base_url . "/delete_daily_motion_video/" . $record->video_id . "' > Delete </a>";
        }
      }
      if ($record->encoding_progress != '100' && $record->publishing_progress == '100') {

        $status_flag = '<span class="under-precess">Ready to Use</span>';

        if (strtoupper($record->type) != 'LOCAL') {
          $delete_link = "<a  class='dalymotion-video-delete' href='" . $base_url . "/delete_daily_motion_video/" . $record->video_id . "' > Delete </a>";
        }
      }

      if ($record->encoding_progress == '100' && $record->publishing_progress == '100') {
        if ($record->is_draft) {
          $status_flag = '<span class="under-precess">Draft</span>';
          $delete_link = "";
        }
        else {
          $status_flag = '<span class="under-precess">Completed</span>';
          if ($record->dailymotion_published == 0) {
            $delete_link = "<a  class='dalymotion-video-delete' href='" . $base_url . "/delete_daily_motion_video/" . $record->video_id . "' > Delete </a>";
          }
        }
      }
    }
    if ($record->is_draft == 1) {
      $status_flag = '<span class="under-precess">Draft</span>';
      $delete_link = "";
    }
    if ($record->node_is_save_draft == 1) {
      $status_flag = '<span class="under-precess">Draft</span>';
      $delete_link = "";
    }
    if ($record->dailymotion_published == 1) {
      $video_status = 'Published';
    }
    else {
      $video_status = 'Unpublished';
    }

    $page_no = $_GET['page'];
    $rows[] = array(
      $sn++,
      $record->name,
      strtoupper($record->type),
      date('d-M-Y H:i:s', $record->upload_time),
      $record->video_id,
      $video_status,
      $status_flag,
      $delete_link
    );
  }
  $total = count($rows);
  $html .= theme('table', array('header' => $header, 'rows' => $rows));
  //$html .= theme('pager');
  $html .= theme('pager');
  return $html;
}

/*
 * Submit handler for ITG video  Repo
 */

function itg_videogallery_ftp_template() {

  $field_id = $_GET['input_filed'];
  $file_field_name = $_GET['file_filed_name'];

  $settings = array();
  $settings['base_url'] = $base_url;
  $settings['video_field_id'] = $field_id;
  $settings['video_field_file'] = $file_field_name;
  drupal_add_js(array('itg_dailymotion' => array('settings' => $settings)), array('type' => 'setting'));
  drupal_add_js(drupal_get_path('module', 'itg_videogallery') . '/js/itg_dailymotion.js', array('weig
ht' => 1));
  return theme('itg_dailymotion_ftp_template');
}

/**
 * Implements hook_permission.
 */
function itg_videogallery_permission() {
  return array(
    'authorized user dailymotion credin' => array(
      'title' => t('Dailymotion credintial permission'),
      'description' => t('Dailymotion credintial configuration permission'),
    ),
    'authorized user ftp credin' => array(
      'title' => t('Dailymotion FTP config permission'),
      'description' => t('Dailymotion FTP configuration permission'),
    ),
    'daily motion video dashboard perm' => array(
      'title' => t('Daily motion video dashboard permission'),
      'description' => t('Daily motion video dashboard permission'),
    ),
  );
}

/**
 * This function use for get file daily motion file details.
 */
function itg_videogallery_get_file_details() {
  $getids = $_POST['checkvalue'];
  global $base_url;
  $responce = "";
  foreach ($getids as $key => $file_value) {
    $video_id = explode('#', $file_value);
    $videoid = $video_id[0];
    if($video_id[8] != 'INTERNAL') {
    $api = itg_videogallery_dailymotion_api();
    $thumb_url = $api->get(
        '/video/' . $video_id[0], array('fields' => array('embed_url'))
    );
    }
    db_insert('itg_solr_video_info')
        ->fields(array(
          'fid' => 0,
          'solr_video_id' => $video_id[0],
          'solr_video_duration' => $video_id[4],
          'solr_video_size' => $video_id[1],
          'property' => $video_id[5],
          'content_type' => 'CK_Editor',
          'is_alredy_used' => 1,
          'video_repo_type' => $video_id[8],
           'video_xml_data' => $video_id[9],
          'solr_video_thumb' => $video_id[3],
        ))
        ->execute();
    if($video_id[8] != 'INTERNAL') {
    if ($thumb_url['embed_url']) {
      $video_id = end(explode('/', $thumb_url['embed_url']));
      $query = db_update('itg_solr_video_info')
          ->fields(array('video_embedded_url' => $video_id));
      $query->condition('solr_video_id', $video_id[0]);
      $query->execute();
    }
  }
    $responce .=' <iframe frameborder="0" scrolling="no" class="video_data" id="video_frame_' . $videoid . '" frameborder="0" src="' . FRONT_URL_VIDEO . '/embeded-video/' . $videoid . '" allowfullscreen></iframe>';

  }
  exit($responce);
}

/**
 * This function use for get file daily motion file details.
 */
function itg_videogallery_dm_embed() {
  $video_id = arg(1);
  $data_video_info = itg_videogallery_info_by_video_id_form_itg_solr_video($video_id);
  if($data_video_info[0]->video_repo_type == 'INTERNAL') {
  print  theme('itg_videogallery_internal_video_play', array('video_data' => $data_video_info[0]->video_xml_data, 'width'=>600 , 'height'=>400 ));
  }else {
  $api = itg_videogallery_dailymotion_api();
  $thumb_url = $api->get(
      '/video/' . $video_id, array('fields' => array('embed_url'))
  );
  $embed_id = "";
  if ($thumb_url['embed_url']) {
    $embed_id = end(explode('/', $thumb_url['embed_url']));
  }
  return theme('itg_videogallery_dm_embed', array('video_id' => $embed_id));
  }
}


/**
 * This function use for get file daily motion file details.
 */
function itg_videogallery_dailymotion_video_play() {
  $video_id = $_POST['videoid'];
  $width = 760;
  $height = '90%';
  if(isset($_POST['width']) && !empty($_POST['width'])) {
   $width = $_POST['width'];
  }
   if(isset($_POST['height']) && !empty($_POST['height'])) {
   $height = $_POST['height'];
  }
  $data_video_info = itg_videogallery_get_all_video_info_by_video_id($_POST['videoid']);
  
  if($data_video_info[0]->video_type == 'INTERNAL' || $_POST['getvideo_repo'] == 'INTERNAL') {
    $data_from_solr = itg_videogallery_getsolr_data_for_internal_video($_POST['videoid']);

  print  theme('itg_videogallery_internal_video_play', array('video_data' => $data_from_solr[0], 'width'=>$width , 'height'=>400 ));
  } else {
  $api = itg_videogallery_dailymotion_api();
  $thumb_url = $api->get(
      '/video/' . $video_id, array('fields' => array('embed_url'))
  );
  $embed_id = "";
  if ($thumb_url['embed_url']) {
    $embed_id = end(explode('/', $thumb_url['embed_url']));
  }
  
  print  theme('itg_videogallery_dailymotion_video_play', array('video_id' => $embed_id, 'width'=>$width , 'height'=>$height ));
 }
}


/**
 * This function use for get file daily motion file details.
 */
function itg_videogallery_internal_video_play() {
  $video_data = $_POST['videodata'];
  $data_from_solr = itg_videogallery_getsolr_data_for_internal_video($video_data);
  print  theme('itg_videogallery_internal_video_play', array('video_data' => $data_from_solr[0], 'width'=>$width , 'height'=>$height ));
}

/**
 * Implement itg_videogallery_getsolr_data_for_internal_video
 * @param string $video_id
 */
function itg_videogallery_getsolr_data_for_internal_video($video_id) {
  if (function_exists('apachesolr_server_status')) {
    $ping = apachesolr_server_status(variable_get('solr_server_url'));
  }
  if ($ping) {
    $solr = apachesolr_get_solr();
    if (function_exists('itg_apache_solr_get_site_hash')) {
      $hash = itg_apache_solr_get_site_hash();
    }
    $all_video_ids = array();
    $hashvalue = implode(' OR ', array_keys($hash));
    $str = 'hash:(' . $hashvalue . ')';
    $query = apachesolr_drupal_query("custom");
    $query->addParam('rows', '1'); // How many rows of result to display default it is 10.
    $query->addParam('qf', 'sm_field_video_id'); // Only search in title
//The bundle which you want to search
    $query->replaceParam("fq", '(' . $str . ')');
    $query->addFilter("bundle", "itg_solr_video");
    $query->addFilter("sm_field_video_id", $video_id);
    $query->setSolrsort('sort_label', 'desc');
    $resp_search = $query->search();
    $all_data = $resp_search->response->docs;
    if (!empty($all_data)) {
      return $all_data[0]->sm_field_all_xml_content;
    }
  }
}

/**
 * This function use for get file daily motion video to play.
 */
function itg_videogallery_getvideoplayer_migrated() {
  $image= $_GET['video_image'];
  $video_url = $_GET['video_url'];
  $getvideousedon = $_GET['getvideousedon'];
  $nid = $_GET['nid'];
   print theme('migrated_video_player', array("url" =>$video_url, 'nid' => $nid, 'image' => $image, 'used_on'=>$getvideousedon));
}


/**
 * This function use for get file daily motion video to play.
 */
function itg_videogallery_getvideoplayer() {
  $fid= $_GET['fid'];
  $getvideousedon= $_GET['getvideousedon'];
  $tabindex = $_GET['tabindex'];
  $video_title = $_GET['video_title'];
  $video_data = itg_videogallery_get_video_info_by_fid($fid);
  if($video_data[0]->video_repo_type == 'INTERNAL') {
   print theme('internal_video_player' , array("data" => $fid , 'used_on' =>$getvideousedon,'title' => $video_title)); 
  }else {
  print theme('itg_videogallery_getvideoplayer' , array('video_data' => $video_data , 'tabindex' => $tabindex));
  }
}



/**
 * Implement function get dailymotion video id by fid
 * @param int $fid
 * @return type string
 */
function itg_videogallery_get_video_all($fid) {
  $query = db_select('dailymotion_response_details', 'dm')
      ->fields('dm', array('is_draft'))
      ->condition('fid', $fid, '=');
  $result = $query->execute()->fetchField();
  return $result;
}

/**
 * Implement function get dailymotion video id by fid
 * @param int $fid
 * @return type string
 */
function itg_videogallery_get_video($fid) {
  $query = db_select('dailymotion_response_details', 'dm')
      ->fields('dm', array('video_id'))
      ->condition('fid', $fid, '=');
  $result = $query->execute()->fetchField();
  return $result;
}

/**
 * Implements hook_node_access().
 * {@inheritdoc}
 */
function itg_videogallery_node_access($node, $op, $account) {
  if (!empty($account) && !empty($node)) {
    if ($account->uid == 0 && !empty($node->type) && $node->type == 'videogallery') {//shravan
      $current_time = time();
      $video_schedule_date = "";
      $video_expire_date = "";
      if (!empty($node->field_story_schedule_date_time[LANGUAGE_NONE][0]['value'])) {
        $video_schedule_date = strtotime($node->field_story_schedule_date_time[LANGUAGE_NONE][0]['value']);
      }
      if (!empty($node->field_story_expiry_date[LANGUAGE_NONE][0]['value'])) {
        $video_expire_date = strtotime($node->field_story_expiry_date[LANGUAGE_NONE][0]['value']);
      }
      if (($current_time > $video_schedule_date) && ($current_time < $video_expire_date) && ($node->type == 'videogallery' && $op == 'view')) {
        return NODE_ACCESS_ALLOW;
      }
      elseif (($current_time > $video_expire_date) && ($node->type == 'videogallery') && ($op == 'view')) {
        return NODE_ACCESS_DENY;
      }
    }
  }
  return NODE_ACCESS_IGNORE;
}

/**
 * Implements hook_node_validate().
 * {@inheritdoc}
 */
function itg_videogallery_node_validate($node, $form, &$form_state) {

// Code for redirection url validation
  if ($node->type == 'videogallery') {
// Code for category validation.
    if (empty($node->field_story_category[LANGUAGE_NONE][0]['tid'])) {
      form_set_error('edit-field-story-category-und-hierarchical-select-selects-0', t("Section field is required."));
    }
  }
}

/**
 * Implements function return playlist id
 * @param string $tname
 * @return array
 */
function itg_videogallery_get_playlist_id($tname) {
  $query = db_select('dailymotion_playlist_details', 'dpt');
  $query->fields('dpt', array('pid', 'playlist_name'));
  $query->condition('dpt.playlist_name', $tname, '=');
  $result = $query->execute()->fetchAll();
  return $result;
}

/**
 * Implements function for get old playlist for remove video
 * @param int $nid
 * @return array
 */
function itg_videogallery_get_old_playlist($nid) {
  $query = db_select('field_data_field_dailymotion_playlist', 'fdp');
  $query->fields('fdp', array('field_dailymotion_playlist_tid', 'entity_id'));
  $query->join('taxonomy_term_data', 'ttd', 'fdp.field_dailymotion_playlist_tid = ttd.tid');
  $query->fields('ttd', array('name', 'tid'));
  $query->condition('fdp.bundle', 'videogallery', '=');
  $query->condition('fdp.entity_id', $nid, '=');
  $result = $query->execute();
  foreach ($result as $value) {
    $output[$value->field_dailymotion_playlist_tid] = $value->name;
  }
  return $output;
}

/**
 * This function use for unpublish cideo content delete video
 */
function itg_videogallery_unpublish_content_delete_video($fid) {
  $query = db_update('itg_solr_video_info')
      ->fields(array('is_delete' => 1));
  $query->condition('fid', $fid);
  $query->condition('content_type', 'video_gallery', '=');
  $query->execute();

  $deleted = db_delete('file_managed')
      ->condition('fid', $fid)
      ->execute();
  global $user;
  $query = db_select('itg_solr_video_info', 'drd')
      ->fields('drd', array('solr_video_id', 'property'));
  $query->condition('fid', $fid);
  $result = $query->execute()->fetchAll();
  if ($result[0]->property == VIDEO_PROPERTY) {
    $num_updated = db_update('dailymotion_response_details') // Table name no longer needs {}
        ->fields(array(
          'dailymotion_published' => 0,
          'is_replace' => 0,
          'is_draft' => 0,
        ))
        ->condition('video_id', $result[0]->solr_video_id, '=')
        ->execute();
    itg_videogallery_update_video_info_solr($result[0]->solr_video_id);
  }
}

/**
 * Implements hook_node_presave()
 * {@inheritdoc}
 */
function itg_videogallery_node_presave($node) {

//set custom path alias  
  if (itg_workflow_stop_node_update_batch_for_widgets()) {
    return;
  }
  if ($node->type == 'videogallery' && !empty($node->field_dailymotion_playlist[LANGUAGE_NONE])) {
    foreach ($node->field_dailymotion_playlist[LANGUAGE_NONE] as $playlist_val) {
      $playlist[$playlist_val['tid']] = $playlist_val['name'];
    }

    $node->field_story_source_id = $playlist;
    $_SESSION['old_playlist'] = itg_videogallery_get_old_playlist($node->nid);
  }

// condition for source type field
  if ($node->type == 'videogallery' && empty($node->field_story_source_type[LANGUAGE_NONE][0]['value'])) {
    $node->field_story_source_type[LANGUAGE_NONE][0]['value'] = 'videogallery';
  }
}

/**
 * Implements function for get term name by tid
 * @param int $tid
 * @return string
 */
function itg_videogallery_get_tname($tid) {
  $query = db_select('taxonomy_term_data', 'ttd');
  $query->fields('ttd', array('name'));
  $query->condition('tid', $tid, '=');
  $result = $query->execute()->fetchField();
  return $result;
}

/**
 * Implements hook_cronapi().
 * {@inheritdoc}
 */
function itg_videogallery_cronapi($op, $job = NULL) {

  $items['video_thumb_assign'] = array(
    'description' => 'Thumbnail image assign to node from dailymotion.',
    'callback' => 'itg_videogallery_thumb_assign',
  );
//  $items['draft-video-publish-after-local-video-readytouse'] = array(
//    'description' => 'Cron use for make publish node after check video status ready to play.',
//    'callback' => 'itg_videogallery_publish_node_after_video_ready_by_dm',
//  );
  $items['ftp_file_save'] = array(
    'description' => 'Ftp file save in file managed table.',
    'callback' => 'itg_videogallery_ftp_file_insert',
  );
  $items['thumb_url_dailymotion'] = array(
    'description' => 'Video Thumbnail Url save in custom dailymotion response table',
    'callback' => 'itg_videogallery_thumb_url',
  );

// This is the callback for uploading FTP video to Daily motion server in unpublished mode

  $items['itg_videogallery_ftp_file_insert_cron'] = array(
    'description' => 'This is the callback for uploading FTP video to Daily motion server in unpublished mode',
    'callback' => 'itg_videogallery_ftp_file_insert_cron',
  );
  $items['itg-videogallery-s3-file-to-dm'] = array(
    'description' => 'This is the callback for uploading S3 video to Daily motion server in unpublished mode',
    'callback' => 'itg_videogallery_s3_file_to_dm',
  );
  $items['itg-videogallery-dm-to-s3'] = array(
    'description' => 'This is the callback for store dm file to s3',
    'callback' => 'itg_videogallery_dm_to_s3',
  );
  $items['itg-videogallery-move-ftp-videos'] = array(
    'description' => 'This is the callback for move DM used video',
    'callback' => 'itg_videogallery_move_ftp_videos',
  );

  $items['save-video-bitrates'] = array(
    'description' => 'This is use for store video birates urls',
    'callback' => 'itg_videogallery_video_bitrate',
  );


  $items['video-update-embed-video-id'] = array(
    'description' => 'This crone use for Update video id embeded.',
    'callback' => 'itg_videogallery_video_update_embeded_url',
  );


  return $items;
}

/**
 * Implements cron function for get thumburl in dailymotion custom table
 */
function itg_videogallery_thumb_url() {
  itg_videogallery_remove_video_id_parent_site_delete_or_unpublish();
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd');
  $db_or = db_or();
  $db_or->condition('encoding_progress', '100', '!=');
  $db_or->condition('drd.publishing_progress', '100', '!=');
  $db_or->isNull('drd.dailymotion_thumb_url');
  $db_or->isNull('drd.publishing_progress');
  $db_or->isNull('drd.encoding_progress');
  $query->condition($db_or);
  $query->condition('drd.video_type', 'DM', '=');
  $result = $query->execute()->fetchAll();
  $api = itg_videogallery_dailymotion_api();
  foreach ($result as $val) {
    try {
      if ($val->encoding_progress != "100" || $val->dailymotion_thumb_url == "" || $val->publishing_progress != "100") {
        $thumb_url = $api->get(
            '/video/' . $val->video_id, array('fields' => array('thumbnail_720_url', 'duration', 'encoding_progress', 'publishing_progress'))
        );

        $duration = '';
        if ($thumb_url['duration'] < 3600) {
          $duration = gmdate("i:s", $thumb_url['duration']);
        }
        else {
          $duration = gmdate("H:i:s", $thumb_url['duration']);
        }

        $image_url = $thumb_url['thumbnail_720_url'];
        db_update('dailymotion_response_details')
            ->fields(array(
              'dailymotion_thumb_url' => $image_url,
              'encoding_progress' => $thumb_url['encoding_progress'],
              'publishing_progress' => $thumb_url['publishing_progress'],
              'video_duration' => $duration
            ))
            ->condition('eid', $val->eid, '=')
            ->execute();
      }
    }
    catch (Exception $e) {
      
    }
  }
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd');
  $query->condition('publishing_progress', '100', '=');
  $query->condition('video_type', 'DM', '=');
  $result_new = $query->execute()->fetchAll();
  $api = itg_videogallery_dailymotion_api();
  foreach ($result_new as $val) {
    if ($val->is_draft != 1) {
      $video_status_used = $val->dailymotion_published;
      $video_is_draft = 0;
     }else {
      $video_status_used = 0;
      $video_is_draft = 1;
     }
      global $user;
      $node = new stdClass();
      $node->title = $val->title;
      $node->type = "itg_solr_video";
      node_object_prepare($node); //Invokes hook_prepare() and hook_node_prepare().
      $node->language = LANGUAGE_NONE;
      $node->field_video_id[LANGUAGE_NONE][0]['value'] = $val->video_id;
      $node->field_property [LANGUAGE_NONE][0]['value'] = VIDEO_PROPERTY;
      $node->field_video_duration [LANGUAGE_NONE][0]['value'] = $val->video_duration;
      $node->field_video_used [LANGUAGE_NONE][0]['value'] = $video_status_used;
      $node->field_video_thumb_url[LANGUAGE_NONE][0]['value'] = $val->dailymotion_thumb_url;
      $node->field_video_size[LANGUAGE_NONE][0]['value'] = $val->video_size;
      $node->field_is_replace[LANGUAGE_NONE][0]['value'] = $val->is_replace;
      $node->field_video_type[LANGUAGE_NONE][0]['value'] = $val->video_type;
      $node->field_video_is_draft[LANGUAGE_NONE][0]['value'] = $video_is_draft;
      $node->uid = 1;
      $node->field_video_date_time[LANGUAGE_NONE][0]['value'] = date('Y-m-d H:i:s', $val->upload_time);
      $node->field_video_time[LANGUAGE_NONE][0]['value'] = date('Y-m-d H:i:s', $val->upload_time);
      $node->status = 1; //(1 or 0): Published or not
      $node->promote = 0; //(1 or 0): Promoted to front page
      $node->comment = 0; // 0 = Comments disabled, 1 = read only, 2 = read/write
      $video_exist_innode = itg_videogallery_get_video_solrcontent($val->video_id);
      if (!empty($video_exist_innode)) {
        $node->nid = $video_exist_innode[0]->nid;
        node_save($node);
      }
      node_save($node);
    
  }
  itg_videogallery_publish_node_after_video_ready_by_dm();
  itg_videogallery_remove_video_with_child();
// Here deleted video
// This crone use for remove video if parent site remove this video from video article
// This crone use for if node is publish.
  itg_videogallery_video_draft_node_check();
//on use for make publish node after check video status ready to play
}

/* * solr action on node updaet and insert
 * 
 * 
 */

function itg_videogallery_update_video_info_solr($videoid) {
  global $user;
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd');
  $query->condition('video_id', $videoid, '=');
  $result_new = $query->execute()->fetchAll();
  foreach ($result_new as $val) {
     if ($val->is_draft != 1) {
      $video_status_used = $val->dailymotion_published;
      $video_is_draft = 0;
     }else {
      $video_status_used = 0;
      $video_is_draft = 1;
     }
    
      $node = new stdClass();
      $node->title = $val->title;
      $node->type = "itg_solr_video";
      node_object_prepare($node); //Invokes hook_prepare() and hook_node_prepare().
      $node->language = LANGUAGE_NONE;
      $node->field_video_id[LANGUAGE_NONE][0]['value'] = $val->video_id;
      $node->field_property [LANGUAGE_NONE][0]['value'] = VIDEO_PROPERTY;
      $node->field_video_duration [LANGUAGE_NONE][0]['value'] = $val->video_duration;
      $node->field_video_used [LANGUAGE_NONE][0]['value'] = $video_status_used;
      $node->field_video_thumb_url[LANGUAGE_NONE][0]['value'] = $val->dailymotion_thumb_url;
      $node->field_video_size[LANGUAGE_NONE][0]['value'] = $val->video_size;
      $node->field_is_replace[LANGUAGE_NONE][0]['value'] = $val->is_replace;
      $node->uid = 1;
      $node->field_video_is_draft[LANGUAGE_NONE][0]['value'] = $video_is_draft;
      $node->field_video_date_time[LANGUAGE_NONE][0]['value'] = date('Y-m-d H:i:s', $val->upload_time);
      $node->field_video_time[LANGUAGE_NONE][0]['value'] = date('Y-m-d H:i:s', $val->upload_time);
      $node->field_video_type[LANGUAGE_NONE][0]['value'] = $val->video_type;
      $node->status = 1; //(1 or 0): Published or not
      $node->promote = 0; //(1 or 0): Promoted to front page
      $node->comment = 0; // 0 = Comments disabled, 1 = read only, 2 = read/write
      $video_exist_innode = itg_videogallery_get_video_solrcontent($val->video_id);
      if (!empty($video_exist_innode)) {
        $node->nid = $video_exist_innode[0]->nid;
        node_save($node);
      }
      // need to chane with solr
      node_save($node);
    
  }
}

/**
 * This function check video id insert in solr video content
 */
function itg_videogallery_get_video_solrcontent($video_id = NULL) {

  $query = db_select('node', 'n');
  $query->fields('n', array('nid'));
  $query->Join('field_data_field_video_id', 'fvd', 'n.nid = fvd.entity_id');
  $query->condition('fvd.field_video_id_value', $video_id, '=');
  $result = $query->execute()->fetchAll();
  return $result;
}

/**
 * This function check video id insert in solr video content
 */
function itg_videogallery_get_node_by_title($title = NULL) {
  $query = db_select('node', 'n');
  $query->fields('n', array('nid'));
  $query->condition('title', $title, '=');
  $result = $query->execute()->fetchAll();
  return $result;
}

/**
 * Implement function for remove files
 */
function itg_videogallery_remove_video() {
  $files = glob('sites/default/files/' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/*');
  foreach ($files as $file) {
    if (is_file($file))
      unlink($file);
  }
}

/**
 * Implement function make  node publish after check video status ready to play.
 */
function itg_videogallery_publish_node_after_video_ready_by_dm() {

  $node_video_id = array();
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd', array('nid'));
  $query->addExpression('GROUP_CONCAT(video_id)', 'video_ids');
  $query->condition('drd.is_draft', '1', '=');
  $query->condition('drd.nid', 'null', '!=');
  $query->groupBy('nid');
  $result = $query->execute()->fetchAll();
  $video_ids = array();
  foreach ($result as $key => $video_id) {
    $node_flag = 0;
    $exception_flag = 0;
    $all_vid = explode(',', $video_id->video_ids);
    foreach ($all_vid as $keyof => $dmvid_id) {
      $api = itg_videogallery_dailymotion_api();
      try {
        if ($dmvid_id) {
          $dm_data = $api->get(
              '/video/' . $dmvid_id, array('fields' => array('thumbnail_720_url', 'duration', 'encoding_progress', 'publishing_progress'))
          );
          if ($dm_data['encoding_progress'] == 100 || $dm_data['publishing_progress'] == 100) {
            $image_url = $dm_data['thumbnail_720_url'];
            $query = db_update('dailymotion_response_details');
            $query->fields(array('dailymotion_published' => 1, 'dailymotion_thumb_url' => $image_url, 'encoding_progress' => $dm_data['encoding_progress'], 'publishing_progress' => $dm_data['publishing_progress']));
            $query->condition('video_id', $dmvid_id, '=');
            $query->execute();
            $num_updated = db_update('itg_solr_video_info') // Table name no longer needs {}
                ->fields(array(
                  'solr_video_thumb' => $image_url
                ))
                ->condition('solr_video_id', $dmvid_id, '=')
                ->execute();
          }
          else {
            $node_flag = 1;
          }
        }
      }
      catch (Exception $e) {
        $exception_flag = 1;
        $video_ids[] = $dmvid_id;
      }
    }
    $node_ids = $video_id->nid;
    if ($exception_flag == 1) {
      if (!empty($video_ids)) {
        $query = db_select('dailymotion_response_details', 'drd');
        $query->fields('drd', array('nid'));
        $query->condition('drd.is_notify', '0', '=');
        $query->condition('video_id', $video_ids, 'IN');
        $result = $query->execute()->fetchAll();
        if (!empty($result)) {
          itg_videogallery_send_video_exception_notification($node_ids, $video_ids);
        }
      }
    }

    if ($node_flag == 0) {
      $node = node_load($video_id->nid);
      if ($node->field_op_flag[LANGUAGE_NONE][0]['value'] != 'draft') {
        foreach ($all_vid as $keyof => $dmvid_id) {
          $query = db_update('dailymotion_response_details');
          $query->fields(array('is_draft' => 0 , 'node_is_save_draft' => 0));
          $query->condition('video_id', $dmvid_id, '=');
          $query->execute();
          itg_videogallery_update_video_info_solr($dmvid_id);
        }
        if ($node->field_video_status_flag[LANGUAGE_NONE][0]['value'] != 'low_level') {
          if ($node->status == 0) {
            $node->status = 1;
          }
        }
        if ($node->workbench_moderation['current']->state == 'draft') {
          //$node->status_cron = 'cron_run';
          $node->revision = 0;
        }

        if ($node->field_video_status_flag[LANGUAGE_NONE][0]['value'] == 'low_level') {

          workbench_moderation_moderate($node, 'needs_review');
        }
        else {

          workbench_moderation_moderate($node, 'published');
        }
        node_save($node);
      }
    }
  }
}

function itg_videogallery_send_video_exception_notification($nid, $video_ids) {
  global $base_url;
  $node = node_load($nid);
  $node_url = $base_url . '/node/' . $node->nid . '/edit';
  $to_mail = $to;
  $getuser_info = user_load($node->uid);
  $name = ucfirst($getuser_info->field_first_name[LANGUAGE_NONE][0]['value']) . ' ' . ucfirst($getuser_info->field_last_name[LANGUAGE_NONE][0]['value']);
  if (isset($getuser_info->status) && $getuser_info->status == 1) {
    $email = $getuser_info->email;
  }
  $subject = 'A new ' . $content_type . ' has been unpublished, please find details below.';
  $mail_content = '<div style="max-width: 502px; margin: 0 auto; font-family: sans-serif; color: #000;">
                      <table style="border-collapse: collapse; border: 1px solid #ececec;"> 
                          <tr>
                              <td style="background-color:#ececec;">
                                  <img src="template_logo.png" alt="Indiatoday" title="Indiatoday" />
                              </td>
                          </tr>
                          <tr>
                              <td style="padding: 10px 20px;">
                                  <h2 style="font-size: 18px; margin: 20px 0 30px;">Draft Video Notification :</h2>
                                  <strong style="font-size: 16px;">Dear ' . $name . ',</strong>
                                  <p style="font-size: 16px; color: #595959; margin: 20px 0;"> ' . mb_strimwidth(strip_tags($node->title), 0, 55, "..") . '<strong style="color: #000;">title.</strong></p>
                                  <p style="font-size: 16px; color: #595959; margin: 20px 0;">Geting Some Error from dailymotion while publishing.</p>
                                  <p style="font-size: 16px; color: #595959; margin: 20px 0;"><a href="' . $node_url . '"><span class="btn">Click Here</span> </a>To view this node</p>
                                 <p style="font-size: 16px; color: #595959; margin: 20px 0;"><strong style="color: #000;">Thanks,</strong><br>India Today Team</p>
                              </td>
                          </tr>
                          <tr>
                              <td style="background-color: #000; font-size: 11px; color: #7c7c7c; padding: 10px; text-align: center; font-weight: bold;">COPYRIGHT &copy; 2017 LIVING MEDIA INDIA LIMITED. ALL RIGHT RESERVED.</td>
                          </tr>
                      </table>
                  </div>';

  $mail_content = preg_replace("/\[([^\[\]]++|(?R))*+\]/", "", $mail_node_author);
  $content = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
              <html xmlns:v="urn:schemas-microsoft-com:vml">
                <head><title></title></head>
                <body style="margin:0; padding:0;">';
  $content .= $mail_content;
  $content .= '</body>';
  $content .= '</html>';
  $params = array(
    'body' => $content,
    'subject' => $subject,
  );
  $mail = drupal_mail('itg_workflow', 'send_mail_to_task', $email, language_default(), $params, 'no-reply@kelltontech.com', TRUE);
  if ($mail['result']) {
    $query = db_update('dailymotion_response_details');
    $query->fields(array('is_notify' => '1'));
    $query->condition('video_id', $video_ids, 'IN');
    $query->execute();
  }
}

/**
 * Implement cron function for add video thumb from dailymotion
 */
function itg_videogallery_thumb_assign() {
  $filedir = ITG_IMAGE_FOLDER . 'video/' . date('Ym');
  if (!file_exists(file_default_scheme() . '://' . $filedir)) {
    mkdir(file_default_scheme() . '://' . $filedir, 0777, TRUE);
  }
  chmod(file_default_scheme() . '://' . $filedir, 0777, TRUE);
  $mainresult = array();
  $query = db_select('field_data_field_videogallery_video_upload', 'up_video');
  $query->fields('up_video', array('entity_id'));
  $query->join('dailymotion_response_details', 'drd', 'drd.fid = up_video.field_videogallery_video_upload_fid');
  $query->join('field_data_field_video_upload', 'fvd', 'fvd.field_video_upload_value = up_video.entity_id');
  $query->fields('fvd', array('entity_id'));
  $query->fields('drd', array('fid', 'video_id', 'dailymotion_thumb_url'));
  $query->fields('up_video', array('entity_id'));
  $query->orderBy('entity_id', 'desc');
  $query->distinct('fvd.entity_id');
  $result = $query->execute()->fetchAll();
  foreach ($result as $data_reslut) {
    $mainresult[$data_reslut->fvd_entity_id] = $data_reslut;
  }

  if (isset($mainresult) && !empty($mainresult)) {

    $api = itg_videogallery_dailymotion_api();
    foreach ($mainresult as $val) {

      $thumb_url = $api->get(
          '/video/' . $val->video_id, array('fields' => array('thumbnail_720_url', 'duration'))
      );

      $node = node_load($val->fvd_entity_id);
      if ($thumb_url['duration'] > 0) {
        $duration = '';
        if ($thumb_url['duration'] < 3600) {
          $duration = gmdate("i:s", $thumb_url['duration']);
        }
        else {
          $duration = gmdate("H:i:s", $thumb_url['duration']);
        }
        $node->field_video_duration[LANGUAGE_NONE][0]['value'] = $duration;
        field_attach_update('node', $node);
      }

// assign image in field after resize
      if ($node->field_story_extra_large_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_large_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_medium_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_small_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_extra_small_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_extra_large_image[LANGUAGE_NONE][0]['fid'] == "" || $node->field_story_large_image[LANGUAGE_NONE][0]['fid'] == "" || $node->field_story_medium_image[LANGUAGE_NONE][0]['fid'] == "" || $node->field_story_small_image[LANGUAGE_NONE][0]['fid'] == "" || $node->field_story_extra_small_image[LANGUAGE_NONE][0]['fid'] == "") {
        $image_url = $thumb_url['thumbnail_720_url'];
        $imagedata = file_get_contents($image_url);
        $image_url = 'itg' . time() . end(explode('/', $image_url));
        $image_extension = end(explode('.', $image_url));
        $file_data_temp = file_save_data($imagedata, file_default_scheme() . '://' . $image_url);

// This code for resize all images 
        if ($node->field_story_extra_large_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_extra_large_image[LANGUAGE_NONE][0]['fid'] == "") {
          $file_image = file_load($file_data_temp->fid);
          $image = image_load($file_image->uri);
          $filepath = file_default_scheme() . '://' . $filedir;
          $scaled = image_scale_and_crop($image, EXTRA_LARGE_IMAGE_WIDTH, EXTRA_LARGE_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $node->field_story_extra_large_image[LANGUAGE_NONE][0]['fid'] = $file->fid;
          field_attach_update('node', $node);
        }
        if ($node->field_story_large_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_large_image[LANGUAGE_NONE][0]['fid'] == "") {
          $file_image = file_load($file_data_temp->fid);
          $image = image_load($file_image->uri);
          $filepath = file_default_scheme() . '://' . $filedir;
          $scaled = image_scale_and_crop($image, LARGE_IMAGE_WIDTH, LARGE_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $node->field_story_large_image[LANGUAGE_NONE][0]['fid'] = $file->fid;
          field_attach_update('node', $node);
        }
        if ($node->field_story_medium_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_medium_image[LANGUAGE_NONE][0]['fid'] == "") {
          $file_image = file_load($file_data_temp->fid);
          $image = image_load($file_image->uri);
          $filepath = file_default_scheme() . '://' . $filedir;
          $scaled = image_scale_and_crop($image, MEDIUM_IMAGE_WIDTH, MEDIUM_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $node->field_story_medium_image[LANGUAGE_NONE][0]['fid'] = $file->fid;
          field_attach_update('node', $node);
        }

        if ($node->field_story_small_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_small_image[LANGUAGE_NONE][0]['fid'] == "") {
          $file_image = file_load($file_data_temp->fid);
          $image = image_load($file_image->uri);
          $filepath = file_default_scheme() . '://' . $filedir;
          $scaled = image_scale_and_crop($image, SMALL_IMAGE_WIDTH, SMALL_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $node->field_story_small_image[LANGUAGE_NONE][0]['fid'] = $file->fid;
          field_attach_update('node', $node);
        }
        if ($node->field_story_extra_small_image[LANGUAGE_NONE][0]['fid'] == 0 || $node->field_story_extra_small_image[LANGUAGE_NONE][0]['fid'] == "") {
          $file_image = file_load($file_data_temp->fid);
          $image = image_load($file_image->uri);
          $filepath = file_default_scheme() . '://' . $filedir;
          $scaled = image_scale_and_crop($image, EXTRA_SMALL_IMAGE_WIDTH, EXTRA_SMALL_IMAGE_HEIGHT);
          $image_name = $image_name . time();
          $sav = image_save($image, $filepath . '/' . $image_name . '.' . $image_extension);
          $uri = $filepath . '/' . $image_name . '.' . $image_extension;
          $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
          $file = new StdClass;
          $file->uid = $user->uid;
          $file->filename = basename($uri);
          $file->uri = $uri;
          $file->filemime = file_get_mimetype($uri);
          $file->filesize = @filesize($uri);
          $file->timestamp = REQUEST_TIME;
          $file->is_new = TRUE;
          $file->status = FILE_STATUS_PERMANENT;
          $file = file_save($file);
          file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          $node->field_story_extra_small_image[LANGUAGE_NONE][0]['fid'] = $file->fid;
          field_attach_update('node', $node);
        }
      }
    }
  }
}

/**
 * This function use to get filed collection of video data
 */
function get_video_filed_collection_by_its_id($entity_fid) {
  $query = db_select('field_data_field_videogallery_video_upload', 'fvd');
  $query->fields('fvd', array('field_videogallery_video_upload_fid', 'field_videogallery_video_upload_description'));
  $query->leftJoin('field_data_field_include_ads', 'ads_inc', 'ads_inc.entity_id = fvd.entity_id');
  $query->leftJoin('`field_data_field_video_private', 'private_vid', 'private_vid.entity_id = fvd.entity_id');
  $query->leftJoin('field_data_field_videogallery_description', 'desc_inc', 'desc_inc.entity_id = fvd.entity_id');
  $query->fields('ads_inc', array('field_include_ads_value'));
  $query->fields('private_vid', array('field_video_private_value'));
  $query->fields('desc_inc', array('field_videogallery_description_value'));
  $query->condition('fvd.entity_id', $entity_fid);
  $result_video = $query->execute()->fetchAll();

  return $result_video;
}

/**
 * This is temp function use for move Dailymotion send video to ftv Archive
 */
function itg_videogallery_move_ftp_videos() {
  global $user;
  module_load_include('inc', 'itg_videogallery', 'includes/itg_videogallery_aws_s3');
  $api = itg_videogallery_dailymotion_api();
  $totime = strtotime('-1 days', time());
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd');
  $query->condition('upload_time', $totime, '>=');
  $result = $query->execute()->fetchall();
  $connection_id = itg_videogallery_ftp_video_list();
  ftp_pasv($connection_id, TRUE);
  $ftp_video_folder = variable_get('ftp_upload_video_folder', '');
  $ftp_move_archive = variable_get('ftp_move_archive', '');
  foreach ($result as $ke => $vid) {

    if ($vid->type == 'ftp') {
      $datefolder = date('Y-m', $vid->upload_time);
      $file_name = '/' . FOLDER_FTP_ROOT . '/' . $ftp_video_folder . '/' . $vid->name;
      $file_name_to_folder = '/' . FOLDER_FTP_ROOT . '/' . $ftp_move_archive . '/' . $datefolder . '/';
      $file_name_to_folder_file = '/' . FOLDER_FTP_ROOT . '/' . $ftp_move_archive . '/' . $datefolder . '/' . $vid->name;
      $ftp_exist = ftp_chdir($connection_id, $file_name_to_folder);

      if (!$ftp_exist) {
        ftp_mkdir($connection_id, $file_name_to_folder);
      }
      if (ftp_rename($connection_id, $file_name, $file_name_to_folder_file)) {
//ftp_delete($connection_id, $file_name);
      }
    }

    if ($vid->type == 'S3') {
      $datefolder = date('Y-m', $vid->upload_time);

      $pav = itg_video_copy_onfile_to_anoter($vid->name, $datefolder);
    }
  }
}

/**
 * This function use for get bitrates info,
 * 
 */
function itg_videogallery_url_with_bitates() {
  $bitrates = array();
  $bitrates['framesize']['stream_h264_l1_url'] = '176x144';
  $bitrates['framesize']['stream_h264_l2_url'] = '176x144';
  $bitrates['framesize']['stream_h264_ld_url'] = '320x240';
  $bitrates['framesize']['stream_h264_url'] = '512x384';
  $bitrates['framesize']['stream_h264_hq_url'] = '848x480';
  $bitrates['framesize']['stream_h264_hd_url'] = '1280x720';
  $bitrates['framesize']['stream_h264_hd1080_url'] = '1920x1080';
  $bitrates['framesize']['stream_h264_qhd_url'] = '2560x1440';
  $bitrates['framesize']['stream_h264_uhd_url'] = '3840x2160';

  $bitrates['bitrate']['stream_h264_l1_url'] = '60';
  $bitrates['bitrate']['stream_h264_l2_url'] = '106';
  $bitrates['bitrate']['stream_h264_ld_url'] = '256';
  $bitrates['bitrate']['stream_h264_url'] = '460';
  $bitrates['bitrate']['stream_h264_hq_url'] = '845';
  $bitrates['bitrate']['stream_h264_hd_url'] = '2100';
  $bitrates['bitrate']['stream_h264_hd1080_url'] = '6200';
  $bitrates['bitrate']['stream_h264_qhd_url'] = '10400';
  $bitrates['bitrate']['stream_h264_uhd_url'] = '16500';
  return $bitrates;
}

/**
 * This is temp function use for test dailymotion video resploce no we will 
 */
function itg_videogallery_video_bitrate() {
  $api = itg_videogallery_dailymotion_api();
  $totime = strtotime('-1 days', time());
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd', array('video_id', 'encoding_progress', 'name', 'video_duration'));
  $query->condition('encoding_progress', '100', '=');
  $query->condition('video_type', 'DM', '=');
  $query->condition('upload_time', $totime, '>=');
  $result = $query->execute()->fetchall();
  $bitrates_info = itg_videogallery_url_with_bitates();

  foreach ($result as $ke => $vid) {
    itg_videogallery_update_embedcode_url($vid->video_id);
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "http://www.dailymotion.com/json/video/" . $vid->video_id . "?fields=stream_h264_hd1080_url,stream_h264_hd_url,stream_h264_hq_url,stream_h264_ld_url,stream_h264_url");
    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9');
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, FALSE);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
    $content = curl_exec($ch);
    $decode_json = json_decode($content);
    curl_close($ch);
    if (!empty($content)) {
      foreach ($decode_json as $keys => $json_url) {
        if ($json_url != "") {
          $query = db_select('itg_video_bitrates_data', 'ivbd');
          $query->fields('ivbd');
          $query->condition('video_id', $vid->video_id);
          $query->condition('bitates_field', $keys);
          $result = $query->execute()->fetchall();
          if (!empty($result)) {
            if ($result[0]->is_download != 1) {
              db_update('itg_video_bitrates_data')
                  ->fields(array(
                    'video_id' => $vid->video_id,
                    'bitate_url' => $json_url,
                    'duration' => $vid->video_duration,
                    'framesize' => $bitrates_info['framesize'][$keys],
                    'bitrate' => $bitrates_info['bitrate'][$keys],
                    'video_name' => $vid->name,
                    'bitates_field' => $keys,
                    'is_download' => 0,
                  ))->condition('id', $result[0]->id)
                  ->execute();
            }
          }
          else {
            db_insert('itg_video_bitrates_data')
                ->fields(array(
                  'video_id' => $vid->video_id,
                  'bitate_url' => $json_url,
                  'framesize' => $bitrates_info['framesize'][$keys],
                  'bitrate' => $bitrates_info['bitrate'][$keys],
                  'bitates_field' => $keys,
                  'duration' => $vid->video_duration,
                  'video_name' => $vid->name,
                  'is_download' => 0,
                ))
                ->execute();
          }
        }
      }
    }


    curl_setopt($ch, CURLOPT_URL, "http://www.dailymotion.com/json/video/" . $vid->video_id . "?fields=stream_h264_l1_url,stream_h264_l2_url,stream_h264_qhd_url,stream_h264_uhd_url");
    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9');
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, FALSE);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
    $content = curl_exec($ch);

    $decode_json = json_decode($content);
    curl_close($ch);
    if (!empty($content)) {
      foreach ($decode_json as $keys => $json_url) {
        if ($json_url != "") {
          $query = db_select('itg_video_bitrates_data', 'ivbd');
          $query->fields('ivbd');
          $query->condition('video_id', $vid->video_id);
          $query->condition('bitates_field', $keys);
          $result = $query->execute()->fetchall();
          if (!empty($result)) {
            if ($result[0]->is_download != 1) {
              db_update('itg_video_bitrates_data')
                  ->fields(array(
                    'video_id' => $vid->video_id,
                    'bitate_url' => $json_url,
                    'duration' => $vid->video_duration,
                    'framesize' => $bitrates_info['framesize'][$keys],
                    'bitrate' => $bitrates_info['bitrate'][$keys],
                    'video_name' => $vid->name,
                    'bitates_field' => $keys,
                    'is_download' => 0,
                  ))->condition('id', $result[0]->id)
                  ->execute();
            }
          }
          else {
            db_insert('itg_video_bitrates_data')
                ->fields(array(
                  'video_id' => $vid->video_id,
                  'bitate_url' => $json_url,
                  'framesize' => $bitrates_info['framesize'][$keys],
                  'bitrate' => $bitrates_info['bitrate'][$keys],
                  'bitates_field' => $keys,
                  'duration' => $vid->video_duration,
                  'video_name' => $vid->name,
                  'is_download' => 0,
                ))
                ->execute();
          }
        }
      }
    }
  }
}

/**
 * This is temp function use for test dailymotion video resploce no we will 
 */
function itg_videogallery_video_update_embeded_url() {
  $api = itg_videogallery_dailymotion_api();
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('solr_video_id', 'video_embedded_url'));
  $result = $query->execute()->fetchall();
  foreach ($result as $vid) {
    if ($vid->video_embedded_url != "") {
      itg_videogallery_update_embedcode_url($vid->solr_video_id);
    }
  }
}

/**
 * This is temp function use for test dailymotion video resploce no we will 
 */
function itg_videogallery_video_update_embeded_url_by_fid($fid) {
  $api = itg_videogallery_dailymotion_api();
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('solr_video_id', 'video_embedded_url'));
  $query->condition('fid', $fid);
  $result = $query->execute()->fetchall();
  foreach ($result as $vid) {
    if ($vid->video_embedded_url != "") {
      itg_videogallery_update_embedcode_url($vid->solr_video_id);
    }
  }
}

/**
 * This is temp function use for test dailymotion video resploce no we will 
 */
function itg_videogallery_video_draft_node_check() {
  $api = itg_videogallery_dailymotion_api();
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('id', 'nid'));
  $query->condition('is_node_draft', 1);
  $query->groupBy('nid');
  $result = $query->execute()->fetchall();
  foreach ($result as $vid) {
    $check_node_status = itg_videogallery_get_node_status($vid->nid);
    if ($check_node_status == 1) {
      $query = db_update('itg_solr_video_info')
          ->fields(array('is_node_draft' => 0));
      $query->condition('nid', $vid->nid);
      $query->execute();
    }
  }
}

/**
 * This function use for get node status
 */
function itg_videogallery_get_node_status($nid) {
  $query = db_select('node', 'n')
      ->fields('n', array('status'))
      ->condition('n.nid', $nid)
      ->execute();
  $result = $query->fetchObject();
  $is_published = $result ? $result->status : FALSE;
  return $is_published;
}

/**
 * This function use for get field colloction data by nid
 * 
 */
function get_video_in_fieldcollection_by_nid($nid) {
  $query = db_select('field_data_field_video_upload', 'up_video');
  $query->join('field_data_field_videogallery_video_upload', 'fvu', 'up_video.field_video_upload_value = fvu.entity_id');
  $query->leftJoin('dailymotion_response_details', 'drd', 'drd.fid = fvu.field_videogallery_video_upload_fid');
  $query->Join('itg_solr_video_info', 'isvi', 'isvi.fid = fvu.field_videogallery_video_upload_fid');
  $query->leftJoin('field_data_field_include_ads', 'ads_inc', 'ads_inc.entity_id = fvu.entity_id');
  $query->leftJoin('field_data_field_include_ads', 'ads_inc', 'ads_inc.entity_id = fvu.entity_id');
  $query->leftJoin('field_data_field_video_thumbnail', 'thumb_img', 'thumb_img.entity_id = fvu.entity_id');
  $query->leftJoin('field_data_field_video_title', 'desc_inc', 'desc_inc.entity_id = fvu.entity_id');
  $query->fields('drd', array('video_id', 'dailymotion_thumb_url', 'is_draft'));
  $query->fields('isvi', array('fid', 'solr_video_id', 'solr_video_thumb', 'video_embedded_url', 'property','video_repo_type','video_xml_data'));
  $query->fields('up_video', array('entity_id'));
  $query->fields('ads_inc', array('field_include_ads_value'));
  $query->fields('thumb_img', array('field_video_thumbnail_fid' , 'field_video_thumbnail_alt', 'field_video_thumbnail_title'));
  $query->fields('desc_inc', array('field_video_title_value'));
  $query->condition('up_video.entity_id', $nid);
  $query->groupBy('isvi.solr_video_id');
  $query->orderBy('up_video.delta', 'ASC');
  $result = $query->execute()->fetchAll();
  return $result;
}

/**
 * This function use for get field colloction data by nid
 * 
 */
function get_video_in_fieldcollection_by_nid_mirtaed($nid) {
  $query = db_select('field_data_field_video_upload', 'up_video');
  $query->join('field_data_field_migrated_video_url', 'fvu', 'up_video.field_video_upload_value = fvu.entity_id');
  $query->leftJoin('field_data_field_include_ads', 'ads_inc', 'ads_inc.entity_id = fvu.entity_id');
  $query->leftJoin('field_data_field_videogallery_description', 'desc_inc', 'desc_inc.entity_id = fvu.entity_id');
  $query->fields('up_video', array('entity_id'));
  $query->fields('fvu', array('field_migrated_video_url_value'));
  $query->fields('ads_inc', array('field_include_ads_value'));
  $query->fields('desc_inc', array('field_videogallery_description_value'));
  $query->condition('up_video.entity_id', $nid);
  $query->orderBy('field_video_upload_value', 'ASC');
  $result = $query->execute()->fetchAll();
  return $result;
}


/**
 * This function use for get field colloction data by nid
 * 
 */
function get_video_kicker_by_nid($nid) {
  $query = db_select('field_data_field_video_kicker', 'itg_video_kicker');
  $query->fields('itg_video_kicker', array('field_video_kicker_value'));
  $query->condition('itg_video_kicker.entity_id', $nid);
  $result = $query->execute()->fetchAll();
  return $result;
}

/**
 * Implements function for get videoid by file id
 * @param int $fid
 */
function itg_videogallery_get_videoid($fid) {
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd', array('video_id'));
  $query->condition('fid', $fid, '=');
  $result = $query->execute()->fetchField();
  return $result;
}

/**
 * Implements function for get videoid by file id
 * @param int $fid
 */
function itg_videogallery_get_video_info_video_id($video_id) {
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd', array('fid'));
  $query->condition('video_id', $video_id, '=');
  $result = $query->execute()->fetchField();
  return $result;
}

/**
 * Implements function for get videoid by file id
 * @param int $fid
 */
function itg_videogallery_info_by_video_id_form_itg_solr_video($video_id) {
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd');
  $query->condition('solr_video_id', $video_id, '=')->range(0, 1);
  $result = $query->execute()->fetchAll();
  return $result;
}
/**
 * Implements itg_videogallery_get_all_video_info_by_video_id
 * @param string $video_id
 * @param array $result
 */
function itg_videogallery_get_all_video_info_by_video_id($video_id) {
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd');
  $query->condition('video_id', $video_id, '=');
  $result = $query->execute()->fetchAll();
  return $result;
}

/**
 * Implements function for get videoid by file id
 * @param int $fid
 */
function itg_videogallery_get_videoid_new_private($fid) {
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('video_embedded_url'));
  $query->condition('fid', $fid, '=');
  $result = $query->execute()->fetchField();
  return $result;
}

/**
 * Implements function for get videoid by file id
 * @param int $fid
 */
function itg_videogallery_get_videoid_new($fid) {
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('solr_video_id'));
  $query->condition('fid', $fid, '=');
  $result = $query->execute()->fetchField();
  return $result;
}

/**
 * Implements function for get options for FTP file list
 * @return array
 */
function itg_videogallery_ftp_file_insert() {
  $file_path = drupal_realpath('public://');
  $connection_id = itg_videogallery_ftp_video_list();
  ftp_pasv($connection_id, TRUE);
  $ftp_video_folder = variable_get('ftp_upload_video_folder', '');
  $ftp_files = ftp_nlist($connection_id, "/" . FOLDER_FTP_ROOT . "/" . $ftp_video_folder . "/");

  ftp_close($connection_id);
  foreach ($ftp_files as $files) {
    $file_array = explode('/' . FOLDER_FTP_ROOT . '/' . $ftp_video_folder . '/', $files);
    $path_info = pathinfo($file_array[1]);
    $extension = $path_info['extension'];
    if (isset($extension) && $extension == 'mp4') {
      itg_video_check_exist_file_browse($file_array[1]);
    }
  }
}

/**
 * Implements function for get all files from directory
 * @param string $dir
 * @param array $results
 *
 * @return array
 */
function itg_videogallery_dir_content($dir, &$results = array()) {
  $files = scandir($dir);
  foreach ($files as $key => $value) {
    $path = realpath($dir . DIRECTORY_SEPARATOR . $value);
    if (!is_dir($path)) {
      $results[] = $path;
    }
    elseif ($value != "." && $value != "..") {
      get_dir_content($path, $results);
      $results[] = $path;
    }
  }

  return $results;
}

/**
 * Implements function check exist filename
 * @param array $form
 * @param array $form_state
 * @return string
 */
function itg_video_check_exist_file_browse($filename) {
  global $user;
  $connection_id = itg_videogallery_ftp_video_list();
  $ftp_video_folder = variable_get('ftp_upload_video_folder', '');
  ftp_pasv($connection_id, TRUE);
  $ftp_files = ftp_nlist($connection_id, "/" . FOLDER_FTP_ROOT . "/" . $ftp_video_folder . "/");
  $results = itg_videogallery_getfile_details($filename);
  if ($results == '' && empty($results)) {
    $file_size = ftp_size($connection_id, '/' . FOLDER_FTP_ROOT . '/' . $ftp_video_folder . '/' . $filename);
    if ($res != -1) {
      $path_info = pathinfo($filename);
      $extension = $path_info['extension'];
      if (isset($extension) && $extension == 'mp4') {
        $uri = 'public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/' . $filename;
        $fid = db_insert('file_managed')
            ->fields(array(
              'uid' => $user->uid,
              'filename' => $filename,
              'uri' => $uri,
              'filemime' => file_get_mimetype($uri),
              'filesize' => $file_size,
              'status' => 1,
              'timestamp' => REQUEST_TIME,
            ))
            ->execute();
        $file = file_load($fid);
        file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
// Entry for FTP Video
        db_insert('itg_dailymotion_ftp_video')
            ->fields(array(
              'fid' => $fid,
            ))
            ->execute();
      }
    }
  }
  ftp_close($connection_id);
  return $results;
}

/**
 * Implements function for get FTP exist file
 * @param string $filename
 * @return array
 */
function itg_videogallery_getfile_details($filename) {
  $uri = 'public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/' . $filename;
  $query = db_select('file_managed', 'fm');
  $query->condition('filename', $filename, '=');
  $query->condition('uri', $uri, '=');
  $query->fields('fm');
  $query->orderBy('fm.fid', 'DESC');
  $query->range(0, 1);
  $results = $query->execute()->fetchAssoc();
  return $results;
}

/**
 * Implements function for get check ftp video
 * @param int $fid
 * @return array
 */
function itg_videogallery_check_ftp_video($fid) {
  $query = db_select('itg_dailymotion_ftp_video', 'ftp');
  $query->fields('ftp', array('fid'));
  $query->condition('fid', $fid, '=');
  $result = $query->execute()->fetchField();
  return $result;
}

/**
 * Implements function for ftp connection.
 */
function itg_videogallery_ftp_video_list() {
  $ftp_server = variable_get('dailymotion_ftp_host', '');
  $ftp_user_name = variable_get('dailymotion_ftp_username', '');
  $ftp_user_pass = variable_get('dailymotion_ftp_password', '');
  $conn_id = ftp_connect($ftp_server);
  $login_result = ftp_login($conn_id, $ftp_user_name, $ftp_user_pass);
  if ((!$conn_id) || (!$login_result)) {
    watchdog("WATCHDOG_INFO_video", "FTP connection has failed");
  }
  return $conn_id;
}

/**
 * Implement function for tid from layout_tpl_manager
 */
function itg_videogallery_ftp_video_post($sid, $template, $widget_name) {
  $query = db_select('itg_layout_tpl', 'ilt');
  $query->join('itg_layout_manager', 'ilm', 'ilt.id = ilm.layout_id');
  $query->join('taxonomy_term_data', 'ttd', 'ttd.tid = ilm.filter_url');
  $query->fields('ilm', array('filter_url'));
  $query->fields('ttd', array('name'));
  $query->condition('ilm.widget_name', $widget_name, '=');
  $query->condition('ilt.template_name', $template, '=');
  $query->condition('ilt.section_name', $sid, '=');
  $query->condition('ilt.status', 1, '=');
  $result = $query->execute()->fetchAll();
  return $result;
}

/**
 * {@inheritdoc}
 */
/*
function itg_videogallery_node_view($node, $view_mode, $langcode) {
  $os = array("search_index", "amp");
 
  if ($node->type == 'videogallery' && !in_array($view_mode, $os)) {
// Category view on landing page
    drupal_add_js("jQuery('#block-itg-videogallery-videogallery-menu-video-block ul li').live('click', function(){
   var section_id = jQuery(this).val();
   jQuery('#block-itg-videogallery-videogallery-menu-video-block ul li a').removeClass('active');
   jQuery('#edit-field-story-category-tid').val(section_id); 
   jQuery('#edit-field-story-category-tid').trigger('change');
   jQuery(this).find('a').addClass('active');
  });", array('type' => 'inline', 'scope' => 'footer'));
    if (!empty($_GET['category'])) {

      drupal_add_js("jQuery(document).ready(function(){
        jQuery('#block-itg-videogallery-videogallery-menu-video-block ul li').each(function() {
        if(jQuery(this).val() == " . $_GET['category'] . "){
         jQuery(this).find('a').addClass('active');
         }
       });
       });", array('type' => 'inline', 'scope' => 'footer'));
     }
      // This is for hiding a specific RHS1 block for video
        drupal_add_js("jQuery(document).ready(function(){
           jQuery('.region-sidebar-second').find(\"[id^='block-itg-ads-ads-medium-rectangl-rhs1-300x250']\").remove();
           });", array('type' => 'inline', 'scope' => 'footer')); 

// Views render on video template
    if (itg_videogallery_get_categoryparent(@$_GET['category']) == TRUE && empty($_GET['sid'])) {
      $view_output = views_embed_view('video_list_of_category', 'block_3', $_GET['category']);
    }
//elseif ((itg_videogallery_get_categoryparent(@$_GET['category']) == FALSE || itg_videogallery_get_categoryparent($_GET['category']) == TRUE) && isset($_GET['category']) && isset($_GET['sid'])) {
    elseif (isset($_GET['category']) && isset($_GET['sid'])) {
      $view_output = views_embed_view('video_list_of_category', 'block');
    }
    elseif (empty($_GET['sid'])) {
      if (isset($_GET['category']) && itg_videogallery_get_categoryparent($_GET['category']) != TRUE) {
        $view_output = views_embed_view('video_list_of_category', 'block_3', $_GET['category']);
      }
      elseif (empty($_GET['category'])) {
        $tid = itg_videogallery_get_tid_nid(arg(1));
        $view_output = views_embed_view('video_list_of_category', 'block_3', $tid);
      }
    }
    $node->view_output = $view_output;
  }
}
*/

/**
 *Implement hook_node_view().
 * {@inheritdoc}
 */
function itg_videogallery_node_view($node, $view_mode, $langcode) {
  if ($node->type == 'videogallery' && !empty(variable_get('photo_block_refresh'))) {
    $settings = array();
    $settings['video_nid'] = $node->nid;
    drupal_add_js(array('itg_videogallery' => array('settings' => $settings)), array('type' => 'setting'));
    drupal_add_js(drupal_get_path('module', 'itg_videogallery') . '/js/itg_videogallery_watchlater_refresh.js', array('scope' => 'footer'));
  }
}

/**
 * Implements hook_views_query_alter()
 * {@inheritdoc}
 */
function itg_videogallery_views_query_alter(&$view, &$query) {
  if ($view->name == 'video_landing_header' && $view->current_display == 'block_1') {
    if (isset($_GET['category']) && is_numeric($_GET['category'])) {
      $parent = taxonomy_get_parents($_GET['category']);
      $key = key($parent);
//$parent_name = $parent[$key]->name;
      if (!empty($parent[$key]->name) && $parent[$key]->name == 'program' && empty($_GET['sid']) && empty($_GET['category'])) {
        $query->where[0]['conditions'][0]['value'][':field_data_field_story_category_field_story_category_tid'] = NULL;
      }
    }
  }
// Handle filter for videogallery views
  if ($view->name == 'videogallery_management' && $view->current_display == 'page_1') {
    if (isset($_GET['field_story_source_type_value']) && $_GET['field_story_source_type_value'] == 'migrated') {
      $query->add_where(1, 'field_data_field_story_source_type.field_story_source_type_value', 'migrated', '=');
    }
    if (isset($_GET['field_story_source_type_value']) && $_GET['field_story_source_type_value'] == 'videogallery') {
      $query->add_where(1, 'field_data_field_story_source_type.field_story_source_type_value', 'migrated', '!=');
    }
  }

// Handle filter for photogallery views
  if ($view->name == 'photo_gallery_management' && $view->current_display == 'page_1') {
    if (isset($_GET['field_story_source_type_value']) && $_GET['field_story_source_type_value'] == 'migrated') {
      $query->add_where(1, 'field_data_field_story_source_type.field_story_source_type_value', 'migrated', '=');
    }
    if (isset($_GET['field_story_source_type_value']) && $_GET['field_story_source_type_value'] == 'photogallery') {
      $query->add_where(1, 'field_data_field_story_source_type.field_story_source_type_value', 'migrated', '!=');
    }
  }

// video loading issue resolve
  if ($view->name == "video_list_of_category" && $view->current_display == 'block') {
    if (!empty($query->where[1]['conditions'][2]['value']) && isset($query->where[1]['conditions'][2])) {
      unset($query->where[0]);
    }
  }
  if ($view->name == "video_list_of_category" && $view->current_display == 'block_1') {
      if (!empty($query->where[1]['conditions'][2]['value']) && isset($query->where[1]['conditions'][2])) {
        unset($query->where[0]);
      }
  }
}

/**
 * Implements function for check tid parent program
 * @param type int
 * @return boolean
 */
function itg_videogallery_get_categoryparent($tid) {
  $parent = taxonomy_get_parents($tid);
  $parent_tid = key($parent);
  $program_tid = variable_get('program_category_id_for_programmes');
//$key = key($parent);
// $parent_name = $parent[$key]->name;
  if ($program_tid == $parent_tid) {
    return TRUE;
  }
  else {
    return FALSE;
  }
}

/**
 * Implements function for check tid parent program
 * @param type int
 * @return boolean
 */
function itg_videogallery_get_term($nid) {
  $return = array();
  $query = db_select('field_data_field_story_category', 'iwo');
  $query->condition('iwo.entity_id', $nid)
      ->fields('iwo', array('field_story_category_tid'));
  $result = $query->execute();
  foreach ($result as $key => $value) {
    $return[] = $value->field_story_category_tid;
  }
  return $return;
}

/**
 * Implements function for get tid by nid
 * @param int $nid
 * @return int
 */
function itg_videogallery_get_tid_nid($nid) {
  $node = node_load($nid);
  return $node->field_story_category[LANGUAGE_NONE][0]['tid'];
}

/**
 * Implement function for get term name
 * @param int $tid
 */
function itg_videogallery_get_term_name($tid) {
  $query = db_select('taxonomy_term_data', 'ttd');
  $query->fields('ttd', array('name'));
  $query->condition('ttd.tid', $tid, '=');
  $result = $query->execute()->fetchField();
  return strtoupper($result);
}

/**
 * Implements hook_field_attach_form().
 * {@inheritdoc}
 */
function itg_videogallery_field_attach_form($entity_type, $entity, &$form, &$form_state, $langcode) {
  $options = array('language' => field_valid_language($langcode));
// Merge default options.
  $default_options = array(
    'default' => FALSE,
    'deleted' => FALSE,
    'language' => NULL,
  );
  $options += $default_options;
  list($a, $b, $bundle) = entity_extract_ids($entity_type, $entity);

  $instances = _field_invoke_get_instances($entity_type, $bundle, $options);
// Iterate through the instances.
  $return = array();
  foreach ($instances as $instance) {
    $field = field_info_field_by_id($instance['field_id']);
    $field_name = $field['field_name'];
//If we are looking at our field type and specific widget type, and we are multiple entries
    if (($field['cardinality'] == FIELD_CARDINALITY_UNLIMITED) && ($field['type'] == "field_collection")) {
      if ($field['bundles']['node'][0] == "videogallery") {
//  drupal_add_js(drupal_get_path('module', 'itg_videogallery') . '/js/upload.js', array('weight' => 2));
// Check just in case the button is here, and add another #submit function
        if (isset($form[$field['field_name']]['und']['add_more'])) {
// add a simple select list, this defaults to numb 3
          $form[$field['field_name']]['add_more_number'] = array(
            '#type' => 'select',
            '#options' => drupal_map_assoc(range(0, 20)),
            '#default_value' => 1,
            '#attributes' => array('style' => 'display:none;'),
          );

          $form[$field['field_name']]['file_entity_holder_nums'] = array(
            '#type' => 'textfield',
            '#default_value' => '',
            '#attributes' => array('style' => 'display:none;'),
          );


          $form[$field['field_name']]['und']['add_more']['#submit'][] = 'itg_videogallery_field_add_more_submit';
        }
      }
    }
  }
}

/**
 * Implements hook_form_submit().
 * @global object $user
 * @param array $form
 * @param array $form_state
 */
function itg_videogallery_field_add_more_submit($form, &$form_state) {
  global $user;

  $button = $form_state['triggering_element'];
// Go one level up in the form, to the widgets container.
  $element = drupal_array_get_nested_value($form, array_slice($button['#array_parents'], 0, -1));
  $field_name = $element['#field_name'];
  $langcode = $element['#language'];
  $parents = $element['#field_parents'];

// Alter the number of widgets to show. items_count = 0 means 1.
  $field_state = field_form_get_state($parents, $field_name, $langcode, $form_state);
//get the number from the select
  $numbtoadd = $form[$field_name]['add_more_number']['#value'];
  $file_entity_holder_nums = $form[$field_name]['file_entity_holder_nums']['#value'];

  if ($numbtoadd) {
    $field_state['items_count'] += $numbtoadd - 1;
    field_form_set_state($parents, $field_name, $langcode, $form_state, $field_state);
    $form_state['rebuild'] = TRUE;
  }
  $node = drupal_rebuild_form('videogallery_node_form', $form_state, $old_form = NULL);
  $fids = array();
  $mydir = 'public://' . LOCAL_VIDEO_DIR . '/' . date('Ym');
  file_prepare_directory($mydir, FILE_CREATE_DIRECTORY);
  foreach ($node['upload']['#value'] as $audio) {
    $scheme = variable_get('file_default_scheme', 'public') . '://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/';
    $source = $audio['tmppath'];
    $uri = itg_audio_check_exist_file($audio['name']);
    $newuri = explode('//' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/', $uri);
    $directory = '';
    $destination = file_stream_wrapper_uri_normalize($scheme . $directory . $newuri[1]);
    $destination = file_unmanaged_move($source, $destination);
    $wrapper = file_stream_wrapper_get_instance_by_uri($uri);
    $file = new StdClass;
    $file->uid = $user->uid;
    $file->filename = $audio['name'];
    $file->uri = $uri;
    $file->filemime = file_get_mimetype($uri);
    $file->filesize = @filesize($uri);
    $file->timestamp = REQUEST_TIME;
    $file->is_new = TRUE;
    $file->status = 0;
    $fids[] = file_save($file);
  }
  $key_val = 0;
  foreach ($fids as $file_id) {
    $file_ids[$key_val]['fid'] = $file_id->fid;
    $file_ids[$key_val]['filename'] = $file_id->filename;
    $key_val++;
  }
  $i = 0;
  $videogallery_popup_data_fids_array = array();
  if (isset($file_entity_holder_nums) && !empty($file_entity_holder_nums)) {
    $videogallery_popup_data_fids_array = explode(',', $file_entity_holder_nums);
  }

  if (isset($videogallery_popup_data_fids_array) && count($videogallery_popup_data_fids_array) > 0) {

    foreach ($form_state['field']['field_video_upload']['und']['entity'] as $key => $filed_collection) {
      if (!isset($filed_collection->field_videogallery_video_upload['und'])) {
        $form_state['field']['field_video_upload']['und']['entity'][$key]->field_videogallery_video_upload['und'][0]['fid'] = $videogallery_popup_data_fids_array[$i];
        $form_state['field']['field_video_upload']['und']['entity'][$key]->field_video_title['und'][0]['value'] = $_POST['title'];

        $i++;
      }
    }
  }
}

/**
 * Creating a form for uploading single video using FTP popup.
 * @param array $form
 * @param array $form_state
 */
function videogallery_new_fileupload_form($form, &$form_state) {

  $form['videogallery_new_file'] = array(
    '#type' => 'managed_file',
    '#title' => 'Browse file',
    '#description' => t('Allowed extensions: MP4'),
    '#process' => array('file_managed_file_process', 'itg_video_file_managed_file_process'),
    '#upload_location' => 'public://indiatoday/videos/local_upload_video/' . date('Ym') . '/',
    '#upload_validators' => array('file_validate_name' => array(),
      'file_validate_extensions' => array('mp4'),
      'file_validate_size' => array(MAX_FILE_SIZE * 1024 * 1024),
    ),
  );


  return $form;
}

/**
 * This function use for rename the local browse video
 * @param file obj $file
 */
function file_validate_name(stdClass $file) {
  $errors = array();
//generate file name 
  $new_filename = $file->filename;
  $new_filename = preg_replace('/\s+/', '_', $new_filename);
  $file->filename = $new_filename;

//changing file location 
  $destination_dir = "public://" . LOCAL_VIDEO_DIR . '/' . date('Ym') . "/";

//check if file exists. if exists rename it append incremental number  until the filename is unique

  $file->destination = file_destination($destination_dir . $file->filename, FILE_EXISTS_RENAME);

// If file_destination() returns FALSE then $replace == FILE_EXISTS_ERROR and
// there's an existing file so we need to bail.
  if ($file->destination === FALSE) {
    $errors[] = t('The file %source could not be uploaded because a file by that name already exists in the destination %directory.', array('%source' => $file->source, '%directory' => $destination_dir));
  }

  return $errors;
}

/**
 * This function use for allow file extension .
 */
function itg_video_file_managed_file_process($element) {
  $element['upload']['#attributes']['accept'] = '.mp4';
  return $element;
}

/**
 * itg_videogallery_dailymotion_check_alredy_send() .
 */
function itg_videogallery_dailymotion_check_alredy_send($id) {
  $query = db_select('dailymotion_response_details', 'drd');
  $query->fields('drd');
  $query->condition('title', $id, '=');
  $query->condition('type', 'S3', '=');
  $result_new = $query->execute()->fetchAll();
  return $result_new;
}

/**
 * This method is used to add the video for daily motion from FTP
 * @return array
 */
function itg_videogallery_dailymotion_send_video($real_path) {

  $api = itg_videogallery_dailymotion_api();

  $url = $real_path;
  $file_name = basename($real_path);
  $chek_alredy_insert = itg_videogallery_dailymotion_check_alredy_send($file_name);
  if (empty($chek_alredy_insert)) {

    try {

      $ftp_file = explode('public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/', $real_path);
      $uri = 'public://dailymotion-ftp/' . $realfilename;
      $url = $real_path;

      $result = $api->post(
          '/me/videos', array(
        'url' => $url,
        'title' => $file_name,
        'channel' => 'tv',
        'private' => 'true',
        'published' => TRUE,
          )
      );
      $dur = $api->get(
          '/video/' . $result['id'], array('fields' => array('duration', 'embed_url', 'encoding_progress', 'publishing_progress'))
      );
      //$result['id'] = end(explode('/', $dur['embed_url']));
      $playlist_id = variable_get('dailymotion_playlist_id');
//  $resp = $api->post('/playlist/'.$playlist_id.'/videos/' . $result['id']);
      $result['duration'] = $dur['duration'];
      $result['name'] = $file_name;

      $result['encoding_progress'] = $dur['encoding_progress'];
      $result['publishing_progress'] = $dur['publishing_progress'];

      $a = new Dailymotion();
      $a->logout();
    }
    catch (Exception $e) {
      if ($e->getMessage() == "This `client_id' doesn't exist.") {
        if (isset($_GET['destination'])) {
          unset($_GET['destination']);
        }
        drupal_set_message(t('API Key is wrong.'), 'error');
      }
      elseif ($e->getMessage() == "Invalid `client_secret'") {
        if (isset($_GET['destination'])) {
          unset($_GET['destination']);
        }
        drupal_set_message(t('Secret Key is wrong.'), 'error');
      }
      elseif ($e->getCode() == 6) {
        if (isset($_GET['destination'])) {
          unset($_GET['destination']);
        }
        drupal_set_message(t('There is some issue with internet connection.'), 'error');
      }
      elseif ($e->getCode() == 400) {
        if (isset($_GET['destination'])) {
          unset($_GET['destination']);
        }
        drupal_get_messages();
        drupal_set_message(t('Do not use space in FTP filename. Please remove and again upload file without space in file name.'), 'error');
      }
      else {
        drupal_set_message($e->getMessage(), 'error');
      }
    }
  }

  return $result;
}

/**
 * Implements function for get options for Local FTP file list and used
 * @return array
 */
function itg_videogallery_dm_to_s3() {
  module_load_include('inc', 'itg_videogallery', 'includes/itg_videogallery_aws_s3');
  global $user;

  $query = db_select('itg_video_bitrates_data', 'ivbd');
  $query->fields('ivbd');
  $query->condition('is_download', '0', '=');
  $result = $query->execute()->fetchall();
  foreach ($result as $key => $value) {
    if (!empty($value->bitate_url)) {
      $video_urlsdata = $value->video_id . '_' . $value->bitrate . '.mp4';
      $senddata = itg_video_send_dm_to_s3($value->bitate_url, $video_urlsdata);
      if (!empty($senddata)) {
        $node = new stdClass();
        $node->title = $value->video_name;
        $node->type = "itg_bitrates_video";
        node_object_prepare($node); //Invokes hook_prepare() and hook_node_prepare().
        $node->language = LANGUAGE_NONE;
        $node->field_bitrate_video_id[LANGUAGE_NONE][0]['value'] = $value->video_id;
        $node->field_video_url [LANGUAGE_NONE][0]['value'] = $senddata;
        $node->field_video_bitrate [LANGUAGE_NONE][0]['value'] = $value->bitrate;
        $node->field_resolution [LANGUAGE_NONE][0]['value'] = $value->framesize;
        $node->field_bitrate_video_duration [LANGUAGE_NONE][0]['value'] = $value->duration;
        $node->uid = $user->uid;
        $node->status = 1; //(1 or 0): Published or not
        $node->promote = 0; //(1 or 0): Promoted to front page
        node_save($node);
        $query = db_update('itg_video_bitrates_data');
        $query->fields(array('is_download' => 1));
        $query->condition('id', $value->id, '=');
        $query->execute();
      }
    }
  }

// Use the high-level iterators (returns ALL of your objects).
}

/**
 * Implements function for get options for Local FTP file list and used
 * @return array
 */
function itg_videogallery_s3_file_to_dm() {
  global $user;
  module_load_include('inc', 'itg_videogallery', 'includes/itg_videogallery_aws_s3');
  $data_video = itg_video_get_s3_video();

  foreach ($data_video['video'] as $key => $s3_video_url) {


    $response = itg_videogallery_dailymotion_send_video($s3_video_url);

// Perform playlist and tags when new video create.
    if (!empty($response)) {
      $response_result['video_id'] = $response['id'];
      $response_result['fid'] = 0;

      try {

        $nid = db_insert('dailymotion_response_details')
            ->fields(array(
              'title' => $response['title'],
              'channel' => $response['channel'],
              'fid' => $response['fid'],
              'video_type' => 'DM',
              'tags' => ' ',
              'video_id' => $response['id'],
              'nid' => 0,
              'video_size' => $data_video['size'][$key],
              'encoding_progress' => $response['encoding_progress'],
              'publishing_progress' => $response['publishing_progress'],
              'upload_time' => REQUEST_TIME,
              'video_duration' => $response['duration'],
              'dailymotion_published' => 0,
              'type' => 'S3',
              'name' => $response['name'],
            ))
            ->execute();

// data insert into node
      }
      catch (Exception $e) {
        die($e->getMessage());
      }
// Code start for Adding  video in daily motion 
    }
  }
// Use the high-level iterators (returns ALL of your objects).
}

/**
 * Implements function for get options for Local FTP file list and used
 * @return array
 */
function itg_videogallery_ftp_file_insert_cron() {

  global $user;
  $file_path = drupal_realpath('public://');
  $connection_id = itg_videogallery_ftp_video_list();
  ftp_pasv($connection_id, TRUE);
  $ftp_video_folder = variable_get('ftp_upload_video_folder', '');
  $ftp_filess = ftp_nlist($connection_id, "/" . FOLDER_FTP_ROOT . "/" . $ftp_video_folder . "/");

  foreach ($ftp_filess as $files_n) {

    $file_data_array = explode('/' . FOLDER_FTP_ROOT . '/' . $ftp_video_folder . '/', $files_n);
    $path_info_data = pathinfo($file_data_array[1]);
    $filename = $path_info_data['filename'];
    $extension = $path_info_data['extension'];
    $exist_space = preg_match('/\s/', $filename);
    if ($exist_space) {
      $newfile = str_replace(' ', '_', $filename);
      ftp_rename($connection_id, $files_n, '/' . FOLDER_FTP_ROOT . '/' . $ftp_video_folder . '/' . $newfile . '.' . $extension);
    }
  }

  $ftp_files = ftp_nlist($connection_id, "/" . FOLDER_FTP_ROOT . "/" . $ftp_video_folder . "/");
  foreach ($ftp_files as $files) {
    $file_array = explode('/' . FOLDER_FTP_ROOT . '/' . $ftp_video_folder . '/', $files);

    $path_info = pathinfo($file_array[1]);
    $extension = $path_info['extension'];
    $filename = $path_info['filename'];
    if (isset($extension) && $extension == 'mp4') {
      $file_size = ftp_size($connection_id, $files);
      $url_to_check = FTP_URL_VIDEO . $file_array[1];
      $fileresize = ftp_size($connection_id, $files);


      if ($fileresize == $file_size) {
        $existfile = check_file_already_exist_or_not_by_ftp($file_array[1]);
        if (empty($existfile)) {

          $realfilename = check_file_already_exist_or_not($file_array[1]);

// Adding managed file
          $uri = 'public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/' . $realfilename;
          try {

            $fid = db_insert('file_managed')
                ->fields(array(
                  'uid' => $user->uid,
                  'filename' => $realfilename,
                  'uri' => $uri,
                  'filemime' => file_get_mimetype($uri),
                  'filesize' => $file_size,
                  'status' => 1,
                  'timestamp' => REQUEST_TIME,
                ))
                ->execute();
            $file = file_load($fid);
            file_usage_add($file, 'itg_videogallery', 'file', $file->fid);
          }
          catch (Exception $e) {
//die($e->getMessage());
          }

          $file_details = file_load($fid);
          $real_path = drupal_realpath($file_details->uri);
          $response = itg_videogallery_dailymotion_add_video($real_path, $file_array[1], $realfilename, $fid);
// Perform playlist and tags when new video create.

          if (!empty($response)) {
            $response_result['video_id'] = $response['id'];
            $response_result['fid'] = $response['fid'];
            try {

              $nid = db_insert('dailymotion_response_details')
                  ->fields(array(
                    'title' => $response['title'],
                    'channel' => $response['channel'], 
                    'video_type' => 'DM',
                    'fid' => $response['fid'],
                    'tags' => ' ',
                    'video_id' => $response['id'],
                    'nid' => 0,
                    'video_size' => $file_size,
                    'encoding_progress' => $response['encoding_progress'],
                    'publishing_progress' => $response['publishing_progress'],
                    'upload_time' => REQUEST_TIME,
                    'video_duration' => $response['duration'],
                    'dailymotion_published' => 0,
                    'type' => 'ftp',
                    'name' => $file_array[1],
                  ))
                  ->execute();
              $title = $_POST['title'];
// data insert into node
            }
            catch (Exception $e) {
              die($e->getMessage());
            }
// Code start for Adding  video in daily motion 
          }
        }
      }
    }
  }

  ftp_close($connection_id);
}

/**
 * This method is used to add the video for daily motion from FTP
 * @return array
 */
function itg_videogallery_dailymotion_add_video($real_path, $name, $realfilename, $fid) {

  $api = itg_videogallery_dailymotion_api();
  try {

    $ftp_file = explode('public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/', $real_path);
    $uri = 'public://dailymotion-ftp/' . $realfilename;
    $url = FTP_URL_VIDEO . $name;

    $result = $api->post(
        '/me/videos', array(
      'url' => $url,
      'title' => $realfilename,
      'channel' => 'tv',
      'private' => 'true',
      'published' => TRUE,
        )
    );

    $dur = $api->get(
        '/video/' . $result['id'], array('fields' => array('duration', 'encoding_progress', 'publishing_progress'))
    );
    //$result['id'] = end(explode('/', $dur['embed_url']));
    $playlist_id = variable_get('dailymotion_playlist_id');
//$resp = $api->post('/playlist/' . $playlist_id . '/videos/' . $result['id']);
    $result['duration'] = $dur['duration'];
    $result['encoding_progress'] = $dur['encoding_progress'];
    $result['publishing_progress'] = $dur['publishing_progress'];

    $a = new Dailymotion();
    $a->logout();
    $result['fid'] = $fid;
    $result['tags'] = $tags_value;
  }
  catch (Exception $e) {
    if ($e->getMessage() == "This `client_id' doesn't exist.") {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_set_message(t('API Key is wrong.'), 'error');
    }
    elseif ($e->getMessage() == "Invalid `client_secret'") {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_set_message(t('Secret Key is wrong.'), 'error');
    }
    elseif ($e->getCode() == 6) {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_set_message(t('There is some issue with internet connection.'), 'error');
    }
    elseif ($e->getCode() == 400) {
      if (isset($_GET['destination'])) {
        unset($_GET['destination']);
      }
      drupal_get_messages();
      drupal_set_message(t('Do not use space in FTP filename. Please remove and again upload file without space in file name.'), 'error');
    }
    else {
      drupal_set_message($e->getMessage(), 'error');
    }
  }

  return $result;
}

/**
 * Checking whether file is already exist or not
 * @return string
 */
function check_file_already_exist_or_not_by_ftp($filename) {
  $query = db_select('dailymotion_response_details', 'drd');
  $query->condition('name', $filename, '=');
  $query->fields('drd');
  $query->range(0, 1);
  $results = $query->execute()->fetchAll();
  return$results[0];
}

/**
 * Checking whether file is already exist or not
 * @return string
 */
function check_file_already_exist_or_not($filename) {

  $query = db_select('file_managed', 'fm');
  $query->condition('filename', $filename, '=');
  $query->fields('fm');
  $query->orderBy('fm.fid', 'DESC');
  $query->range(0, 1);
  $results = $query->execute()->fetchAll();
  if (!isset($results[0])) {
    return $filename;
  }
  else {
    $result = explode('public://' . LOCAL_VIDEO_DIR . '/' . date('Ym') . '/', $results[0]->uri);
    $path_info = pathinfo($results[0]->filename);
    $extension = $path_info['extension'];
    $file_name = $path_info['filename'];
    $result_num = explode($file_name . '_', $result[1]);
    $num_file_id = explode('.' . $extension, $result_num[1]);
    if (is_numeric($num_file_id[0]) && isset($num_file_id[0])) {
      $value = $num_file_id[0] + time();
      $value = '_' . $value;
    }
    else {
      $value = '_' . time();
    }
    $file_info = pathinfo($filename);
    $res = $file_info['filename'] . $value . '.' . $extension;
    return $res;
  }
}

/**
 * This function use for get video info from  itg_solr_video_info table by fid
 */
function itg_videogallery_get_video_info_by_fid($fid) {
   $video_data = "";
   $query = db_select('itg_solr_video_info', 'isvi');
   $query->leftJoin('dailymotion_response_details', 'drd', 'isvi.solr_video_id = drd.video_id');
   $query->fields('isvi');
   $query->fields('drd', array('is_draft'));
   $query->condition('isvi.fid', $fid, '=');
   $video_data = $query->execute()->fetchAll();
   return $video_data;
}

/**
 *  This function use for get video info from  itg_solr_video_info table by fid
 */
function itg_videogallery_get_video_xml_data_by_fid($fid) {
   $video_data = "";
   $query = db_select('itg_solr_video_info', 'isvi');
   $query->fields('isvi');
   $query->condition('isvi.fid', $fid, '=');
   $video_data = $query->execute()->fetchAll();
   return $video_data;
}

/**
 * Function use for get all used video 
 */
function itg_videogallery_get_all_publish_video_of_video_content() {
  $video_data = "";
  $all_video_id = array();
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('solr_video_id'));
  $query->isNotNull('nid')->condition('content_type', 'video_gallery', '=');
  $video_data = $query->execute()->fetchAll();
  foreach ($video_data as $vid_data) {
    $all_video_id[] = $vid_data->solr_video_id;
  }
  return $all_video_id;
}

/**
 * Function use for get all draft video 
 */
function itg_videogallery_get_all_draft_video_of_video_content() {
  $video_data = "";
  $all_video_id = array();
  $query = db_select('itg_solr_video_info', 'drd');
  $query->fields('drd', array('solr_video_id'));
  $query->isNotNull('nid')->condition('content_type', 'video_gallery', '=');
  $query->condition('is_node_draft', '1', '=');
  $video_data = $query->execute()->fetchAll();
  foreach ($video_data as $vid_data) {
    $all_video_id[] = $vid_data->solr_video_id;
  }
  return $all_video_id;
}


/**
 * This function use for get video bitrate url
 * 
 */
function itg_videogallery_get_video_bitrate_by_url($url, $nid, $used_on, $external = NULL) {
  $return_array = array();
  $query = db_select('itg_video_transcoding', 'ivt');
  $query->fields('ivt');
  $query->condition('nid', $nid, ' = ');
  $query->condition('video_url', $url, ' = ');
  $query->condition('bitrate_status', 1, ' = ');
  $query->orderby('bitrate_ordering', 'ASC');
  $video_data1 = $query->execute()->fetchAll();
  $parts = parse_url($url);
  $getbucket_setting = itg_videogallery_get_video_setting_by_bucket_name($parts['host']);
  if (!empty($getbucket_setting)) {
    $return_array['file_url'] = $getbucket_setting[0]->field_progressive_domain_value . '/' . $parts['path'];
  }
  else {
    $return_array['file_url'] = $url;
  }
  foreach ($video_data1 as $key => $vid) {
    $bitrate[] = $vid->bitrate;
  }

  if (!empty($getbucket_setting[0]->field_hls_domain_value)) {
    $bitrate_url = itg_videogallery_make_bitrate_url_migtate($parts['path'], $bitrate, $getbucket_setting[0]->field_hls_domain_value);
    $return_array['bitrate_url'] = $bitrate_url;
  }
  else {
    $return_array['bitrate_url'] = "";
  }
  $dfp_data = itg_videogallery_get_dfp_tags($video_data1[0]->website, $video_data1[0]->transcoding_source);

  if (!empty($dfp_data) && !empty($dfp_data[0]->dfp_tags)) {
    if ($external == 1) {
      $retrun_array['dfp_tags'] = $dfp_data[0]->dfp_tags_external;
    }
    else {
      $retrun_array['dfp_tags'] = $dfp_data[0]->dfp_tags_internal;
    }
  }
  else {
    $return_array['dfp_tags'] = JWPLAYER_DFP_TAG;
  }

  if (!empty($dfp_data)) {
    if ($used_on == 'embed' && !empty($dfp_data[0]->ga_tag_extarnal)) {
      $return_array['ga_code'] = $dfp_data[0]->ga_tag_extarnal;
    }
    else {
      $return_array['ga_code'] = ITG_GA_CODE;
    }
    if ($used_on != 'embed' && !empty($dfp_data[0]->ga_tag_internal)) {
      $return_array['ga_code'] = $dfp_data[0]->ga_tag_internal;
    }
    else {
      $return_array['ga_code'] = ITG_GA_CODE;
    }
  }
  return $return_array;
}

/**
 * This function use for make video bitrate url:
 */
function itg_videogallery_make_bitrate_url_migtate($video_url, $bitrates, $hls) {
  $withoutExt = substr($video_url, 0, (strrpos($video_url, ".")));

  if (count($bitrates) == 1) {
    $with_hls_url = $hls . '/i' . $withoutExt;
    $returnstring = $with_hls_url . ',,.mp4.csmil/master.m3u8';
  }
  else {
    $with_hls_url = substr($withoutExt, 0, strrpos($withoutExt, "_"));
    $with_hls_url = $hls . '/i' . $with_hls_url . '_';
    $returnstring = $with_hls_url . ',' . implode(',', $bitrates) . ',.mp4.csmil/master.m3u8';
  }
  return $returnstring;
}

/**
 * Implements itg_videogallery_make_url_for_jwpalyer
 * @parm array $video_data
 */
function itg_videogallery_make_parm_for_jwpalyer($video_data, $used_on, $external) {
  global $base_url;
  $retrun_array = array();
  if (!empty($video_data)) {
    $bucket_output = $video_data['out']['properties']['bucket_output'];
    $getbucket_setting = itg_videogallery_get_video_setting_by_bucket_name($bucket_output);
    $get_all_bitrate = array_column($video_data['out']['videos']['video'], 'bitrate');
    asort($get_all_bitrate);
    $get_play_video_info = itg_videogallery_get_play_video_in_video_info($video_data['out']['videos']['video']);
    $retrun_array['file_url'] = $getbucket_setting[0]->field_progressive_domain_value . '/' . $get_play_video_info['output_path'];
    $bitrate_url = itg_videogallery_make_bitrate_url($video_data['in']['input_path'], $get_all_bitrate, $getbucket_setting[0]->field_hls_domain_value);
    $retrun_array['bitrate_url'] = $bitrate_url;
    $retrun_array['player_image'] = $base_url . "/" . drupal_get_path('theme', 'itg') . '/images/itg_image370x208.jpg';
  }
  $dfp_data = itg_videogallery_get_dfp_tags($video_data['in']['website'], $video_data['in']['client']);
  if (!empty($dfp_data) && !empty($dfp_data[0]->dfp_tags)) {

    if ($used_on == 'embed') {
      if ($external == 1) {
        $retrun_array['dfp_tags'] = $dfp_data[0]->dfp_tags_external;
      }
      else {
        $retrun_array['dfp_tags'] = $dfp_data[0]->dfp_tags_internal;
      }
    }
    else {
      $retrun_array['dfp_tags'] = $dfp_data[0]->dfp_tags;
    }
  }
  else {
    $retrun_array['dfp_tags'] = JWPLAYER_DFP_TAG;
  }

  if (!empty($dfp_data)) {
    if ($used_on == 'embed' && !empty($dfp_data[0]->ga_tag_extarnal)) {
      $retrun_array['ga_code'] = $dfp_data[0]->ga_tag_extarnal;
    }
    else {
      $retrun_array['ga_code'] = ITG_GA_CODE;
    }
    if ($used_on != 'embed' && !empty($dfp_data[0]->ga_tag_internal)) {
      $retrun_array['ga_code'] = $dfp_data[0]->ga_tag_internal;
    }
    else {
      $retrun_array['ga_code'] = ITG_GA_CODE;
    }
  }

  return $retrun_array;
}

/**
 * 
 */
function itg_videogallery_get_dfp_tags($website , $client) {
  $query = db_select('itg_dfp_tags_setting', 'idts');
  $query->fields('idts');
  $query->condition('wesbite', strtolower($website), '=');
  $query->condition('client', strtolower($client), '=');
  $video_data = $query->execute()->fetchAll();
  return $video_data;
}

/**
 * This function use for make video bitrate url:
 */
function itg_videogallery_make_bitrate_url($video_url, $bitrates,$hls) {
  $withoutExt = substr($video_url, 0 , (strrpos($video_url, ".")));
  $find = array("/processing/");
  $replace = array("/video/");
  $withoutExt = (str_replace($find,$replace,$withoutExt));
  $with_hls_url = $hls.'/i'.'/'.$withoutExt.'_';
  $returnstring = $with_hls_url . ',' . implode(',', $bitrates) . ',.mp4.csmil/master.m3u8';
  return $returnstring;
}
/**
 * Implements itg_videogallery_make_url_for_jwpalyer
 * @parm array $video_data
 */

function itg_videogallery_get_play_video_in_video_info($video_data) {
  if(is_array($video_data) && !empty($video_data)) {
    $return_data = $video_data[0];
    foreach ($video_data as $key=> $data) {
      if($data['bitrate'] == 512) {
        $return_data = $data;
      }
    }
  }
  return $return_data;
}

/*
 * This function use for itg_delete_solr_video node delete
 */

function itg_videogallery_get_video_setting_by_bucket_name($bucket_name) {
   $query = db_select('node', 'n');
   $query->join('field_data_field_hls_domain', 'fdfhd', 'fdfhd.entity_id = n.nid');
   $query->join('field_data_field_progressive_domain', 'fdfpd', 'fdfpd.entity_id = n.nid');
   $query->fields('fdfhd', array('field_hls_domain_value'));
   $query->fields('fdfpd', array('field_progressive_domain_value'));
   $query->condition('title', $bucket_name, ' = ');
   $query->condition('type', 'video_setting_by_bucket_name', ' = ');
   $video_data = $query->execute()->fetchAll();
 
  return $video_data;
}

/**
 * Function for show related content in block
 * @return boolean|string
 */
function get_header_tab_related_video_block_content() {
  global $base_url;
  $arg = arg();
  if ($arg[1] == null)
    return false;
  $related_content = itg_get_related_content($arg[1]);

  if (!empty($related_content)) {
    if (function_exists('itg_get_related_story_id')) {
      $related_result = itg_get_related_story_id($related_content);
    }
    $related_video .= "<div id='related-video-tab'><ul class='video-list'>";
    foreach ($related_result as $site_hash_key) {
      $current_entity_id = $site_hash_key;
      $related_data = itg_get_related_story_content($current_entity_id);
      $display_title = get_related_display_title($arg[1], $current_entity_id);
      if (!empty($display_title)) {
        $display_title = $display_title;
      }
      else {
        $display_title = $related_data->label;
      }
      $related_title = html_entity_decode(htmlentities($display_title)); //mb_strimwidth($display_title, 0, 80, "..");
      if (empty($related_data->sm_field_custom_story_small_large_url[0])) {
        $related_image_url = $base_url . '/sites/all/themes/itg/images/itg_image170x127.jpg';
      }
      else {
        $related_image_url = $related_data->sm_field_custom_story_small_large_url[0];
      }
      $related_video_duration = $related_data->sm_field_video_duration[0];
      $img_alt = strip_tags($related_title);
      $url = $base_url ."/" . drupal_get_path_alias('node/' . $current_entity_id);
      $related_image = '<img class="related-default" alt="' . $img_alt . '" title="" src="' . $related_image_url . '">';
      if (!empty($related_title)) {
        $related_video .= "<li class='related_content_tabs'><figure><a href='$related_data->url' target='_blank' title='$related_title' class='pic'>" . $related_image . "<figcaption><i class='fa fa-play-circle'></i> " . $related_video_duration . "</figcaption>";
        $related_video .= "</figure></a><p class='title'>" . l($related_title, $url, array("attributes" => array("target" => "_blank", "title" => $related_title))) . "</p></li>";
      }
    }
    $related_video .= "</ul></div>";
    return $related_video;
  }
  else {
    return false;
  }
}

/**
 * Function to show Other video gallery from node primary category
 * @return array or empty
 */
function _get_other_videos_from_primary_category() {
  if (arg(0) == 'node' && is_numeric(arg(1)) && !arg(2)) {
    $tid = get_tid_using_nid_custom(arg(1));
    return views_embed_view('video_list_of_category', 'block_4', $tid);
  }
  else {
    return '';
  }
}

/**
 * Get Primary category Tid using nid without node load
 * @param int $nid
 * @return int
 */
function get_tid_using_nid_custom($nid) {
  if (isset($nid)) {
    $query = db_select('field_data_field_primary_category', 'ttd');
    $query->fields('ttd', array('field_primary_category_value'));
    $query->condition('ttd.entity_id', $nid, '=');
    $result = $query->execute()->fetchField();
    return $result;
  }
  return 0;
}

/**
 * function for video assign to widget
 * @param $nid
 * @param array $video_widget
 * @param $cat_id
 * @param $previous_video_assign
 */
function itg_video_assign_to_widget($nid, array $video_widget, $cat_id, $previous_video_assign) {
  if (!empty($video_widget) && count($video_widget)) {
    $result = array();
    foreach ($video_widget as $widget_name) {
      if (!empty($widget_name) && $widget_name != '_none') {
        $result[$widget_name] = $widget_name;
        $is_node_in_widget = itg_widget_check_node_in_widget($nid, $widget_name);
        if (!$is_node_in_widget) {
          itg_widget_insert_widget_data($nid, $widget_name, 0);
        }
      }
    }
    itg_widget_delete_old_data_by_limit($widget_name);
    foreach ($previous_video_assign as $row) {
      $widget_value = $row['value'];
      if ($widget_value != $result[$row['value']]) {
        if (!empty($widget_value)) {
          itg_widget_delete_data_from_widget($widget_value, $nid);
        }
      }
    }
  }
}
