<?php
/**
 * @file
 * The ITG Front End Common module.
 *
 * Contains functionality for Front end.
 *
 */
/**
 * Implements hook_block_info().
 * @return array
 */
function itg_front_end_common_block_info() {
  $blocks['taboola_block'] = array(
    'info' => t('Taboola Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['vukkul_block'] = array(
    'info' => t('vukkul Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  
  $blocks['related_video_block'] = array(
    'info' => t('Related video Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  
  $blocks['related_photo_block'] = array(
    'info' => t('Related photo Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implements hook_block_view()
 * {@inheritdoc}
 */
function itg_front_end_common_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'taboola_block':
      $block['content'] = _taboola_block_content();
      break;

    case 'vukkul_block':
      $block['content'] = _vukkul_block_content();
      break;
    
    case 'related_video_block':
      $block['content'] = _related_video_block_content();
      break;
    
    case 'related_photo_block':
      $block['content'] = _related_photo_block_content();
      break;
  }

  return $block;
}

/**
 * Implements taboola block content
 */
function _taboola_block_content() {
$output = '<div class="taboola">
        <script type="text/javascript">
window._taboola = window._taboola || [];
_taboola.push({article:"auto"});
!function (e, f, u) {
e.async = 1;
e.src = u;
f.parentNode.insertBefore(e, f);
}(document.createElement("script"), document.getElementsByTagName("script")[0], "http://cdn.taboola.com/libtrc/indiatoday-indiatoday/loader.js");
</script>
<div class="divclear"></div>
<div class="nocontent">
    <div id="taboola-below-main-column"></div>
    <script type="text/javascript">
      window._taboola = window._taboola || [];
      _taboola.push({mode: "thumbs-2r", container: "taboola-below-main-column", placement: "below-main-column"});
    </script>
    <div id="taboola-text-2-columns"></div>
    <script type="text/javascript">
      window._taboola = window._taboola || [];
      _taboola.push({mode: "hybrid-text-links-2c", container: "taboola-text-2-columns", placement: "text-2-columns", target_type: "mix"});
    </script>
    <script type="text/javascript">
      window._taboola = window._taboola || [];
      _taboola.push({flush: true});
    </script>
</div>
</div>
';
return $output;
}

/**
 * Implements vukkul block content
 */
function _vukkul_block_content() {

  $page_id = arg(1);
  $node = node_load($page_id);
  $byline_id = $node->field_story_reporter[LANGUAGE_NONE][0]['target_id'];
  if (function_exists(itg_common_get_node_title)) {
    $reporter_node = itg_common_get_node_title($byline_id);
  }
  $n_title = $node->title . " - India Today";
  foreach ($node->field_story_itg_tags['und'] as $tags) {
    $term = taxonomy_term_load($tags['tid']);
    $t_name = $term->name;
    $comma_sep_tag[] = $t_name;
  }
  $tag = implode(',', $comma_sep_tag);
  $unique_id = $node->type . '_' . $node->nid;
  $author = base64_encode($reporter_node);
  drupal_add_js('http://vuukle.com/js/vuukle.js', external);
  $output = '<script type="text/javascript">

               var UNIQUE_ARTICLE_ID = "' . $unique_id . '";

               var SECTION_TAGS =  "' . $tag . '";

               var ARTICLE_TITLE = "' . $n_title . '";

               var GA_CODE = "UA-795349-17";

               var VUUKLE_API_KEY = "dc34b5cc-453d-468a-96ae-075a66cd9eb7";

               var TRANSLITERATE_LANGUAGE_CODE = ""; //"en" for English, "hi" for hindi

               var VUUKLE_COL_CODE = "d00b26";

               var ARTICLE_AUTHORS = "' . $author . '";

               create_vuukle_platform(VUUKLE_API_KEY, UNIQUE_ARTICLE_ID, "0", SECTION_TAGS, ARTICLE_TITLE, TRANSLITERATE_LANGUAGE_CODE , "1", "", GA_CODE, VUUKLE_COL_CODE, ARTICLE_AUTHORS);

               </script>';
  return $output;
}

/**
 * Implements taboola view
 */
function taboola_view() {

  $block = module_invoke('itg_front_end_common', 'block_view', 'taboola_block');
  print render($block['content']);
}


/**
 * Implements vukkul view
 */
function vukkul_view() {

  $block = module_invoke('itg_front_end_common', 'block_view', 'vukkul_block');
  print render($block['content']);
}


/**
 * Implements hook_node_view().
 * {@inheritdoc}
 */
function itg_front_end_common_node_view($node, $view_mode, $langcode) {

  if ($node->type == 'breaking_news' && !empty($node->nid) && $node->op != 'Preview') {
    drupal_add_js(drupal_get_path('module', 'itg_front_end_common') . '/js/itg_front_end_common.js', array('weight' => 2));
    drupal_add_css('http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/themes/dot-luv/jquery-ui.css', array('type' => 'external'));
    drupal_add_js('http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js', external);
    drupal_add_js('http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js', external);
  }
}


/**
 * Custom function to fetch related content.
 * @param int $nid
 */
function itg_get_related_content($nid) {

  $query = db_select('field_data_field_common_related_content', 'tt');
  $query->fields('tt', array('field_common_related_content_value'));
  $query->condition('tt.entity_id', $nid, '=');
  $related_result = $query->execute()->fetchField();
  return $related_result;
}

/**
 * Implements Related video block content
 */
function _related_video_block_content() {
  $related_content = itg_get_related_content(arg(1));
  if (!empty($related_content)) {
    $video_output = '<h3><span>Related content</span></h3>
            <div id="related-video">';
    $related_content = explode(',', $related_content);
    foreach ($related_content as $fn_result) {
      $related_content = explode('_', $fn_result);
      $final_related [] = $related_content[1];
    }
    $final_related = implode(' OR ', $final_related);
    $video_output.= views_embed_view('related_photo_video_content', 'page', $final_related);
    '</div>';

    return $video_output;
  }
}

/**
 * Implements Related photo block content
 */
function _related_photo_block_content() {
  $related_content = itg_get_related_content(arg(1));
  if (!empty($related_content)) {
    $photo_output = '<h3><span>Related content</span></h3>
            <div id="related-photo">';
    $related_content = explode(',', $related_content);
    foreach ($related_content as $fn_result) {
      $related_content = explode('_', $fn_result);
      $final_related [] = $related_content[1];
    }
    $final_related = implode(' OR ', $final_related);
    $photo_output.= views_embed_view('related_photo_video_content', 'page_1', $final_related);
    '</div>';

    return $photo_output;
  }
}
