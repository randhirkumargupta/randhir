<?php

/**
 * @file
 * ITG workflow module.
 *
 * Provides customizations and functions for workflow.
 *
 */





/**
 * Implemets hook_form_alter().
 */
function itg_workflow_form_alter(&$form, &$form_state, $form_id) {
  global $user, $base_url; 
  
  switch ($form_id) {
    case 'story_node_form':
      $form['#after_build'][] = 'itg_workflow_after_build';
      //$form['actions']['submit']['#submit'][] = 'itg_workflow_form_custom_callback';
    break;      
  }
}


// after build for story form
function itg_workflow_after_build($form, &$form_state) {
  global $user;  
  
  if (array_key_exists(SECTION_EDITOR, $user->roles) || array_key_exists(COPY_EDITOR, $user->roles) || array_key_exists(EDITOR, $user->roles)) {
    
    if (!isset($form['#node']->workbench_moderation['current'])) {
      $state_class = ' published';
      $submit_name = 'Publish';
      $form['actions']['submit']['#value'] = 'Save as Draft';
      drupal_add_js('jQuery(document).ready(function() {
              jQuery(".form-item-workbench-moderation-state-new").hide();                    
            });', array('type' => 'inline', 'scope' => 'footer'));
    }else if (isset($form['#node']->workbench_moderation['current'])) {
      if ($form['#node']->workbench_moderation['current']->state == 'draft') {
        $state_class = ' published';
        $submit_name = 'Publish';
        $form['actions']['submit']['#value'] = 'Save as Draft';
          drupal_add_js('jQuery(document).ready(function() {
            jQuery(".form-item-workbench-moderation-state-new").hide();                    
          });', array('type' => 'inline', 'scope' => 'footer'));
      } else if ($form['#node']->workbench_moderation['current']->state == 'published' || $form['#node']->workbench_moderation['current']->state == 'approved') {        
          drupal_add_js('jQuery(document).ready(function() {
            jQuery(".form-item-workbench-moderation-state-new").hide();                    
          });', array('type' => 'inline', 'scope' => 'footer'));
      } else if ($form['#node']->workbench_moderation['current']->state == 'needs_review') {
            $submit_name = '';
            //$submit_name = 'Publish';
            $state_class = ' published';
            unset($form['revision_information']['workbench_moderation_state_new']['#options']['approved']);
            
          }      
    }
  } else if (array_key_exists(AUTHOR_GUEST, $user->roles) || array_key_exists(INTERN, $user->roles) || array_key_exists(SUBEDITOR_SR_SUB, $user->roles)) {
      if (!isset($form['#node']->workbench_moderation['current'])) {
        $submit_name = 'Submit for Review';
        $state_class = ' needs_review';
        $form['actions']['submit']['#value'] = 'Save as Draft';
        drupal_add_js('jQuery(document).ready(function() {
              jQuery(".form-item-workbench-moderation-state-new").hide();                    
            });', array('type' => 'inline', 'scope' => 'footer'));
      } else if (isset($form['#node']->workbench_moderation['current']) && ($form['#node']->workbench_moderation['current']->state == 'draft' || $form['#node']->workbench_moderation['current']->state == 'needs_review' || $form['#node']->workbench_moderation['current']->state == 'needs_modification')) {
          if ($form['#node']->workbench_moderation['current']->state == 'needs_review') {
            $submit_name = '';
          } else if ($form['#node']->workbench_moderation['current']->state == 'needs_modification') {
            $submit_name = 'Submit for Review';
            $state_class = ' needs_review';
            $form['actions']['submit']['#value'] = 'Save as Draft';
            drupal_add_js('jQuery(document).ready(function() {
              jQuery("#edit-workbench-moderation-state-new").val("needs_modification");
              jQuery(".form-item-workbench-moderation-state-new").hide();
            });', array('type' => 'inline', 'scope' => 'footer'));
          } else if ($form['#node']->workbench_moderation['current']->state == 'published') {
              $submit_name = '';
              drupal_add_js('jQuery(document).ready(function() {
              jQuery(".form-item-workbench-moderation-state-new").hide();                    
            });', array('type' => 'inline', 'scope' => 'footer'));
          } else if ($form['#node']->workbench_moderation['current']->state == 'draft') {
              $submit_name = 'Submit for Review';
              $state_class = ' needs_review';
              $form['actions']['submit']['#value'] = 'Save as Draft';
              drupal_add_js('jQuery(document).ready(function() {
              jQuery(".form-item-workbench-moderation-state-new").hide();                    
            });', array('type' => 'inline', 'scope' => 'footer'));
          } else {
            
          }          
      }
  }

  if (!empty($submit_name)) {    
    $form['actions']['submit_link'] = array(
        '#markup' => l(t($submit_name), 'javascript:void(0)', array('attributes' => array('class' => 'button'.$state_class, 'id' => 'story_submit_link'))),
        '#weight' => 20,
      );
  }
  // work flow end
  global $user, $base_url;
    
  $settings = array();
  $settings['base_url'] = $base_url;
  $settings['uid'] = $user->uid;

  drupal_add_js(array('itg_story' => array('settings' => $settings)), array('type' => 'setting'));
  drupal_add_js(drupal_get_path('module', 'itg_story') . '/js/itg_workflow.js', array('weight' => 1));
  return $form;
}


/**
 * Implements hook_node_presave.
 */
function itg_workflow_node_presave($node) {
  //p($node);
  if ($node->type == 'story') {
   if ($node->workbench_moderation['current']->state == 'published' && $node->status == 1) {
    $node->workbench_moderation_state_new = 'published';
   } else if ($node->workbench_moderation_state_new == 'published') {
     $publish_date = strtotime($node->field_story_expiry_date[LANGUAGE_NONE][0]['value']);
     $current_date = time();
      if ($publish_date <= $current_date) {
        $node->workbench_moderation_state_new == 'published';
      } else {
          $node->workbench_moderation_state_new == 'approved';
      }
     
   }
  }
}