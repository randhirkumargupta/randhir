<?php

/**
 * Implementation of hook_form_alter().
 * @param array $form
 * @param array reference $form_state
 * @param type $form_id
 * @return array $form
 */
function itg_mobile_services_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case 'clients_creation_node_form':

      unset($form['title']);
      unset($form['#metatags']);

      $form['actions']['cancel'] = array(
        '#markup' => l(t('Cancel'), 'clients-listing', array(
          'attributes' => array(
            'class' => 'button'
          )
        )),
        '#weight' => 21,
        '#value' => t('Cancel')
      );

      if (isset($form['field_email_address'])) {
        $form['field_email_address']['#element_validate'][] = 'itg_mobile_clients_validator';
      }

      if (isset($form['field_contact_tech_email_address'])) {
        $form['field_contact_tech_email_address']['#element_validate'][] = 'itg_mobile_clients_validator';
      }

      if (empty($_GET['destination'])) {
        $_GET['destination'] = 'clients-listing';
      }

      break;
    case 'service_creation_node_form':
      unset($form['#metatags']);
      $form['actions']['cancel'] = array(
        '#markup' => l(t('Cancel'), 'service-listing', array(
          'attributes' => array(
            'class' => 'button'
          )
        )),
        '#weight' => 21,
        '#value' => t('Cancel')
      );

      $form['field_service_regional']['#states'] = array(
        'visible' => array(
          ':input[name="field_service_type[und]"]' => array('checked' => TRUE),
        ),
      );

      $form['field_service_fetch_link']['#states'] = array(
        'visible' => array(
          ':input[name="field_content_sharing_mode[und]"]' => array('value' => '1'),
        ),
        'required' => array(
          ':input[name="field_content_sharing_mode[und]"]' => array('value' => '1'),
        ),
      );

      $form['field_email_address']['#states'] = array(
        'visible' => array(
          ':input[name="field_content_sharing_mode[und]"]' => array('value' => '3'),
        ),
        'required' => array(
          ':input[name="field_content_sharing_mode[und]"]' => array('value' => '3'),
        ),
      );

      if (empty($_GET['destination'])) {
        $_GET['destination'] = 'service-listing';
      }
      break;

    case 'client_service_association_node_form':
      unset($form['#metatags']);
      $_SESSION['current_path'] = arg();
      $form['actions']['cancel'] = array(
        '#markup' => l(t('Cancel'), 'service-association-listing', array(
          'attributes' => array(
            'class' => 'button'
          )
        )),
        '#weight' => 21,
        '#value' => t('Cancel')
      );

      $form['field_service_title']['#prefix'] = '<div id="service_title_replace_wrapper">';
      $form['field_service_title']['#suffix'] = '</div>';

      $form['field_service_char_limit']['#prefix'] = '<div id="char_limit_replace_wrapper">';
      $form['field_service_char_limit']['#suffix'] = '</div>';

      $form['field_service_association_title'][LANGUAGE_NONE]['#ajax'] = array(
        'callback' => 'itg_mobile_services_custom_callback',
        'method' => 'replace', // the data would replace the field
        'effect' => 'fade',
        'event' => 'change', // On change of the selection this action would take place
      );

      $form['field_client_selection'][LANGUAGE_NONE]['#ajax'] = array(
        'callback' => 'itg_mobile_content_selection_callback',
        'event' => 'blur', // On change of the selection this action would take place
      );

      unset($form['title']);
      $form['#validate'][] = 'itg_mobile_client_association_validator';
      $form['actions']['submit']['#submit'][] = 'itg_mobile_client_association_submit';
      $form['#after_build'][] = 'itg_service_association_after_build';
      if (empty($_GET['destination'])) {
        $_GET['destination'] = 'service-association-listing';
      }

      break;
    case 'create_content_node_form':
      // unset($form['title']);
      unset($form['#metatags']);
      $form['#prefix'] = '<div id="client_error_wrapper">';
      $form['#suffix'] = '</div>';

      $form['title']['#prefix'] = '<div id="client_entity_wrapper">';
      $form['title']['#suffix'] = '</div>';

      $form['field_service_association_title'][LANGUAGE_NONE]['#ajax'] = array(
        'callback' => 'itg_mobile_content_custom_callback',
        'wrapper' => 'client_entity_wrapper',
        'effect' => 'fade',
        'event' => 'change', // On change of the selection this action would take place
      );

      $form['#validate'][] = 'itg_mobile_association_validator';
      $form['#after_build'][] = 'itg_service_content_after_build';
      drupal_add_js("jQuery(document).ready(function(){ jQuery('#edit-field-story-expert-description').hide(); jQuery('#edit-field-story-large-image').hide();jQuery('#edit-field-service-audio').hide();jQuery('#edit-field-service-video').hide();});", 'inline');

      break;
  }
  return $form;
}

/**
 * Custom submit callback for genrate token.
 * @param type $form
 * @param type $form_state
 */
function itg_mobile_client_association_submit($form, &$form_state) {
  $node_nid = $form['nid']['#value'];
  $association_nid = $form_state['values']['field_service_association_title'][LANGUAGE_NONE][0]['target_id'];

  $field_client_selection = $form_state['values']['field_client_selection'][LANGUAGE_NONE];
  $client_name = '';
  foreach ($field_client_selection as $key => $value) {

    // $client_id = $value['target_id'];
    // sh1(client_id + service_id + timestamp + randam 6-digit )
    // $token = $client_id + $association_nid + 
  }
}

/**
 * Implements custom _form_validate() for taxonomy_form_term().
 */
function itg_mobile_client_association_validator($form, &$form_state) {

  $node_nid = $form['nid']['#value'];
  $association_nid = $form_state['values']['field_service_association_title'][LANGUAGE_NONE][0]['target_id'];

  $field_client_selection = $form_state['values']['field_client_selection'][LANGUAGE_NONE];
  $client_name = '';
  foreach ($field_client_selection as $key => $value) {

    $target_id = $value['target_id'];

    $query = db_select('node', 'node')->fields('node', array('nid'));
    $query->leftJoin('field_data_field_client_selection', 'cs', "node.nid = cs.entity_id AND cs.entity_type = 'node' AND cs.deleted = '0'");
    $query->leftJoin('field_data_field_service_association_title', 'sat', "node.nid = sat.entity_id AND sat.entity_type = 'node' AND sat.deleted = '0'");
    $query->condition('node.status', 1, '=');
    $query->condition('cs.field_client_selection_target_id', $target_id, '=');
    $query->condition('sat.field_service_association_title_target_id', $association_nid, '=');
    if (!empty($node_nid)) {
      $query->condition('node.nid', $node_nid, '<>');
    }

    $query->condition('node.type', array('client_service_association'), 'IN');
    $query->range(0, 1);

    $result = $query->execute();
    $record = $result->fetchAssoc();

    $nid = ($record['nid']) ? $record['nid'] : '';

    if ($nid) {
      $node = node_load($nid);
      $client_selection = field_get_items('node', $node, 'field_client_selection');
      foreach ($client_selection as $client_val) {
        // watchdog("target_id", '<pre>' . print_r($client_val['target_id'], true) . '</pre>');
        $tid = ($client_val['target_id']) ? $client_val['target_id'] : '';
        if ($tid) {
          $term = taxonomy_term_load($tid);

          $client_name .= $term->name . ", ";
        }
      }
      $client_name = rtrim($client_name, ',');

      if ($client_name) {
        form_set_error('field_client_selection', $client_name . 'is already associated this service');
      }
    }
  }
}

/**
 * Implements custom _form_validate() for taxonomy_form_term().
 */
function itg_mobile_association_validator($form, &$form_state) {

  $target_id = trim($form_state['values']['field_service_association_title'][LANGUAGE_NONE][0]['target_id']);
  if ($target_id) {
    $contact_text = ($form_state['values']['field_story_expert_description'][LANGUAGE_NONE][0]['value']) ? trim($form_state['values']['field_story_expert_description'][LANGUAGE_NONE][0]['value']) : '';
    $contact_image = ($form_state['values']['field_story_large_image'][LANGUAGE_NONE][0]['fid']) ? trim($form_state['values']['field_story_large_image'][LANGUAGE_NONE][0]['fid']) : '';
    $contact_audio = ($form_state['values']['field_service_audio'][LANGUAGE_NONE][0]['fid']) ? trim($form_state['values']['field_service_audio'][LANGUAGE_NONE][0]['fid']) : '';
    $contact_video = ($form_state['values']['field_service_video'][LANGUAGE_NONE][0]['fid']) ? trim($form_state['values']['field_service_video'][LANGUAGE_NONE][0]['fid']) : '';

    $result = get_service_association($target_id);
    $record = $result->fetchAssoc();
    $entity_id = ($record['entity_id']) ? $record['entity_id'] : '';
    if ($entity_id) {

      $node = node_load($entity_id);
      // watchdog("mobile_15", '<pre>' . print_r( $entity_id, true) . '</pre>'); 
      $service_content_type = field_get_items('node', $node, 'field_service_content_type');
      drupal_add_js("jQuery(document).ready(function(){ jQuery('#edit-field-story-expert-description').hide(); jQuery('#edit-field-story-large-image').hide();jQuery('#edit-field-service-audio').hide();jQuery('#edit-field-service-video').hide();});", 'inline');
      foreach ($service_content_type as $key => $value) {

        $content_type = field_view_value('node', $node, 'field_service_content_type', $service_content_type[$key], array());
        $content_result = render($content_type);
        $content_type_val = str_replace(' ', '', trim(strtolower($content_result)));

        if ($content_type_val == 'text') {
          form_set_error('field_story_expert_description', t('Content Text Required.'));
          drupal_add_js("jQuery(document).ready(function(){ jQuery('#edit-field-story-expert-description').show(); });", 'inline');
        }
        elseif ($content_type_val == 'image') {
          form_set_error('field_story_large_image', t('Content Image Required.'));
          drupal_add_js("jQuery(document).ready(function(){ jQuery('#edit-field-story-large-image').show();});", 'inline');
        }
        elseif ($content_type_val == 'video') {
          form_set_error('field_service_video', t('Content Video Required.'));
          drupal_add_js("jQuery(document).ready(function(){ jQuery('#edit-field-story-expert-description').hide(); jQuery('#edit-field-story-large-image').hide();jQuery('#edit-field-service-audio').hide();});", 'inline');
        }
        elseif ($content_type_val == 'audio') {
          form_set_error('field_service_audio', t('Content Audio Required.'));
          drupal_add_js("jQuery(document).ready(function(){ jQuery('#edit-field-story-expert-description').hide(); jQuery('#edit-field-story-large-image').hide();jQuery('#edit-field-service-video').hide();});", 'inline');
        }
        elseif ($content_type_val == 'wap(image,text,videoandaudio)') {
          form_set_error('field_story_expert_description', t('Content Text Required.'));
          form_set_error('field_story_large_image', t('Content Image Required.'));
          form_set_error('field_service_video', t('Content Video Required.'));
          form_set_error('field_service_audio', t('Content Audio Required.'));
          drupal_add_js("jQuery(document).ready(function(){ jQuery('#edit-field-story-expert-description').show(); jQuery('#edit-field-story-large-image').show();jQuery('#edit-field-service-audio').show();jQuery('#edit-field-service-video').show();});", 'inline');
        }
      }
    }
  }
}

/**
 * Validate custom handler.
 * @param array $form
 * @param array reference $form_state
 */
function itg_mobile_clients_validator($form, &$form_state) {

  $valid_email = $form_state['values']['field_email_address'][LANGUAGE_NONE][0]['value'];
  $valid_tech_email_address = $form_state['values']['field_contact_tech_email_address'][LANGUAGE_NONE][0]['value'];
  if (!empty($valid_email) && !valid_email_address($valid_email)) {
    form_set_error('field_email_address', 'Sorry. Your Business email address,' . $valid_email . ', is not valid.');
  }

  if (!empty($valid_tech_email_address) && !valid_email_address($valid_tech_email_address)) {
    form_set_error('field_contact_tech_email_address', 'Sorry. Your Technical email address,' . $valid_email . ', is not valid.');
  }
}

/**
 * after_build itg_service_association_after_build
 * @param array $form
 * @param array reference $form_state
 * @return array $form
 */
function itg_service_association_after_build($form, &$form_state) {
  $form['field_service_title'][LANGUAGE_NONE][0]['value']['#attributes']['readonly'] = 'readonly';
  $form['field_service_char_limit'][LANGUAGE_NONE][0]['value']['#attributes']['readonly'] = 'readonly';
  return $form;
}

/**
 * after_build itg_service_content_after_build
 * @param array $form
 * @param array reference $form_state
 * @return array $form
 */
function itg_service_content_after_build($form, &$form_state) {
  $form['title']['#attributes']['readonly'] = 'readonly';
  return $form;
}

/**
 * ajax service callback
 * @param array $form
 * @param array reference $form_state
 * @return array $form
 */
function itg_mobile_content_custom_callback(&$form, &$form_state) {
  //$form_state['rebuild'] = true;  // not helping
  $commands = array();
  $commands[] = ajax_command_invoke('#edit-field-story-expert-description', 'hide');
  $commands[] = ajax_command_invoke('#edit-field-story-large-image', 'hide');
  $commands[] = ajax_command_invoke('#edit-field-service-video', 'hide');
  $commands[] = ajax_command_invoke('#edit-field-service-audio', 'hide');
  $association_nid = $form_state['values']['field_service_association_title'][LANGUAGE_NONE][0]['target_id'];

  if ($association_nid) {
    //  watchdog("association_nid", '<pre>' . print_r( $association_nid, true) . '</pre>');

    $result = get_service_association($association_nid);

    $name = '';
    $entity_id = '';
    while ($record = $result->fetchAssoc()) {
      $entity_id = $record['entity_id'];
      $name .= $record['name'] . ",";
    }

    //  watchdog("mobile_arun", '<pre>' . print_r( $entity_id, true) . '</pre>');
    if (empty($entity_id)) {
      $form['title']['#description'] = 'service not associated.';
      $commands[] = ajax_command_replace("#client_entity_wrapper", render($form['title']));
      $page = array('#type' => 'ajax', '#commands' => $commands);
      ajax_deliver($page);
    }
    else {
      $client_name = rtrim($name, ',');
      $node = node_load($entity_id);

      $service_content_type = field_get_items('node', $node, 'field_service_content_type');

      foreach ($service_content_type as $key => $value) {
        $content_type = field_view_value('node', $node, 'field_service_content_type', $service_content_type[$key], array());
        $content_result = render($content_type);
        $content_type_val = str_replace(' ', '', trim(strtolower($content_result)));
        if ($content_type_val == 'text') {
          $commands[] = ajax_command_invoke('#edit-field-story-expert-description', 'show');
        }
        elseif ($content_type_val == 'image') {
          $commands[] = ajax_command_invoke('#edit-field-story-large-image', 'show');
        }
        elseif ($content_type_val == 'video') {
          $commands[] = ajax_command_invoke('#edit-field-service-video', 'show');
        }
        elseif ($content_type_val == 'audio') {
          $commands[] = ajax_command_invoke('#edit-field-service-audio', 'show');
        }
        elseif ($content_type_val == 'wap(image,text,videoandaudio)') {
          $commands[] = ajax_command_invoke('#edit-field-story-expert-description', 'show');
          $commands[] = ajax_command_invoke('#edit-field-story-large-image', 'show');
          $commands[] = ajax_command_invoke('#edit-field-service-video', 'show');
          $commands[] = ajax_command_invoke('#edit-field-service-audio', 'show');
        }
      }
      $form['title']['#description'] = '';
      $form['title']['#value'] = $client_name;
      //watchdog("mobile_6", '<pre>' . print_r( $form['title'], true) . '</pre>'); 
      //field_story_expert_description
      $commands[] = ajax_command_replace("#client_entity_wrapper", render($form['title']));
      $page = array('#type' => 'ajax', '#commands' => $commands);
      ajax_deliver($page);
    }
  }
}

/**
 * ajax service callback
 * @param array $form
 * @param array reference $form_state
 * @return array $form
 */
function itg_mobile_content_selection_callback(&$form, &$form_state) {

  $node_nid = $form['nid']['#value'];
  $association_nid = $form_state['values']['field_service_association_title'][LANGUAGE_NONE][0]['target_id'];
  $field_client_selection = $form_state['values']['field_client_selection'][LANGUAGE_NONE];
  $client_name = '';
  foreach ($field_client_selection as $key => $value) {

    $target_id = $value['target_id'];

    $query = db_select('node', 'node')->fields('node', array('nid'));
    $query->leftJoin('field_data_field_client_selection', 'cs', "node.nid = cs.entity_id AND cs.entity_type = 'node' AND cs.deleted = '0'");
    $query->leftJoin('field_data_field_service_association_title', 'sat', "node.nid = sat.entity_id AND sat.entity_type = 'node' AND sat.deleted = '0'");
    $query->condition('node.status', 1, '=');
    $query->condition('cs.field_client_selection_target_id', $target_id, '=');
    $query->condition('sat.field_service_association_title_target_id', $association_nid, '=');
    if (!empty($node_nid)) {
      $query->condition('node.nid', $node_nid, '<>');
    }

    $query->condition('node.type', array('client_service_association'), 'IN');
    $query->range(0, 1);

    $result = $query->execute();
    $record = $result->fetchAssoc();

    $nid = ($record['nid']) ? $record['nid'] : '';

    if ($nid) {
      $node = node_load($nid);
      $client_selection = field_get_items('node', $node, 'field_client_selection');
      foreach ($client_selection as $client_val) {
        // watchdog("target_id", '<pre>' . print_r($client_val['target_id'], true) . '</pre>');
        $tid = ($client_val['target_id']) ? $client_val['target_id'] : '';
        if ($tid) {
          $term = taxonomy_term_load($tid);

          $client_name .= $term->name . ", ";
        }
      }
      $client_name = rtrim($client_name, ',');

      if ($client_name) {
        // form_set_error('field_service_association_title',  $client_name . 'arun already associated this service.');
        return array(
          '#type' => 'ajax',
          '#commands' => array(
            ajax_command_remove("#edit-field-service-association-title .error", "<span class='error'>" . $client_name . " is already associated this service</span>"),
            ajax_command_append("#edit-field-service-association-title", "<span class='error'>" . $client_name . " is already associated this service</span>")
          )
        );
      }
    }
  }
}

/**
 * ajax service callback
 * @param array $form
 * @param array reference $form_state
 * @return array $form
 */
function itg_mobile_services_custom_callback($form, &$form_state) {
  $nid = $form_state['values']['field_service_association_title'][LANGUAGE_NONE][0]['target_id'];
  $node = node_load($nid);

  $service_title = $node->field_service_title[LANGUAGE_NONE][0]['value'];
  $service_char_limit = $node->field_service_char_limit[LANGUAGE_NONE][0]['value'];

  $form['field_service_title'][LANGUAGE_NONE][0]['value']['#value'] = ($service_title) ? $service_title : '';
  $form['field_service_char_limit'][LANGUAGE_NONE][0]['value']['#value'] = ($service_char_limit) ? $service_char_limit : '';

  return array(
    '#type' => 'ajax',
    '#commands' => array(
      ajax_command_replace("#service_title_replace_wrapper", render($form['field_service_title'])),
      ajax_command_replace("#char_limit_replace_wrapper", render($form['field_service_char_limit']))
    )
  );
}

/**
 * Implements hook_field_group_build_pre_render_alter.
 * @param array reference $element
 */
function itg_mobile_services_field_group_build_pre_render_alter(&$element) {

  if (isset($element['#form_id'])) {
    if ($element['#form_id'] == 'service_creation_node_form') {
      $element['group_service_ftp']['#states'] = array(
        'visible' => array(
          ':input[name="field_content_sharing_mode[und]"]' => array('value' => '2'),
        ),
        'required' => array(
          ':input[name="field_content_sharing_mode[und]"]' => array('value' => '2'),
        ),
      );

      $element['group_service_ftp']['#id'] = 'group_service_ftp';
    }
  }
}

/**
 * Implement hook_views_pre_render
 * @param Object $view
 */
function itg_mobile_services_views_pre_render(&$view) {
  //Add "Create Client" button on listing page of Client Details
  if (isset($view->name) && $view->name == "clients_details") {
    if (isset($view->current_display) && $view->current_display == "page") {
      $header_content_client = '<span class="count">Count(' . $view->total_rows . ')&nbsp;</span>';
      $header_content_client .= l(t('Create Client'), 'node/add/clients-creation');
      $header_content_client .= '<span class="client-services">&nbsp;' . l(t('Associate Client & Services'), 'node/add/client-service-association') . '&nbsp;</span>';
    }
    elseif (isset($view->current_display) && $view->current_display == "page_1") {
      $header_content_client = '<span class="count">Count(' . $view->total_rows . ')&nbsp;</span>';
      $header_content_client .= l(t('Create Service'), 'node/add/service-creation');
    }
    elseif (isset($view->current_display) && $view->current_display == "page_2") {
      $header_content_client = '<span class="count">Count(' . $view->total_rows . ')&nbsp;</span>';
      $header_content_client .= l(t('Associate Client & Services'), 'node/add/client-service-association');
    }
    elseif (isset($view->current_display) && $view->current_display == "page_3") {
      $header_content_client = '<span class="count">Count(' . $view->total_rows . ')&nbsp;</span>';
      $header_content_client .= l(t('Create Content'), 'node/add/create-content');
    }

    if (isset($header_content_client)) {
      $view->attachment_before = $header_content_client;
    }
  }
}

/**
 * Implementation of hook_form_views_exposed_form_alter().
 * @param array $form
 * @param array reference $form_state
 */
function itg_mobile_services_form_views_exposed_form_alter(&$form, &$form_state) {

  switch ($form['#id']) {
    case 'views-exposed-form-clients-details-page':
      $form['field_client_title_tid']['#attributes'] = array(
        'placeholder' => t('Title')
      );
      break;
    case 'views-exposed-form-clients-details-page-1':
      $form['title']['#attributes'] = array(
        'placeholder' => t('Title')
      );
  }
}

/**
 * custom get_service_association
 * @param int $target_id
 * @return array $query
 */
function get_service_association($target_id) {
  if (empty($target_id)) {
    return '';
  }
  $query = db_select('node', 'node')
      ->fields('service_asso', array('nid', 'vid', 'title'))
      ->fields('cs', array('entity_id', 'revision_id'))
      ->fields('td', array('name', 'tid'));

  $query->leftJoin('field_data_field_client_selection', 'cs', "node.nid = cs.entity_id AND cs.entity_type = 'node' AND cs.deleted = '0'");
  $query->join('taxonomy_term_data', 'td', "cs.field_client_selection_target_id = td.tid");
  $query->leftJoin('field_data_field_service_association_title', 'sat', "node.nid = sat.entity_id AND (sat.entity_type = 'node' AND sat.deleted = '0')");
  $query->Join('node', 'service_asso', "sat.field_service_association_title_target_id = service_asso.nid");
  $query->condition('service_asso.status', 1, '=');
  $query->condition('service_asso.nid', $target_id, '=');
  $query->condition('node.type', array('client_service_association'), 'IN');
  $query->range(0, 10);
  //dpq($query); // Display the query. 
  return $query->execute();
}
