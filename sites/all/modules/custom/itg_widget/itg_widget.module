<?php

/**
 * @file
 * itg_widget.module
 *
 * Provides customizations and functions for Widgets.
 *
 */
module_load_include('inc', 'nodequeue_generate', 'nodequeue.actions');
// All views pre render funtion.
module_load_include('inc', 'itg_widget', 'includes/itg_widget_view_pre_render');
// All Order reoder function on widget page.
module_load_include('inc', 'itg_widget', 'includes/itg_widget_order_re_order');
// All Code for action (Bulk Operation).
module_load_include('inc', 'itg_widget', 'includes/itg_widget_actions_bulk_operation');

module_load_include('inc', 'itg_widget', 'includes/itg_widget.helper');

module_load_include('inc', 'itg_widget', 'includes/itg_widget_personalization');

/**
 * {@inheritdoc}
 */
function itg_widget_init() {
// Js for move funtionality.
// This is use in case of nodequeue in case of custom table we calls a callback funtion.
  drupal_add_js(drupal_get_path('module', 'itg_widget') . '/js/itg_widget.js', 'file');
}

/**
 * {@inheritdoc}
 */
function itg_widget_menu() {
  $items = array();
  $items['remove_from_widgets/%/%/%/%'] = array(
      'page callback' => 'remove_from_widgets',
      'page arguments' => array(1, 2, 3, 4),
      'access arguments' => array('administer nodequeue'),
  );
  $items['remove_from_widgets_section/%/%/%/%/%/%'] = array(
      'page callback' => 'remove_from_widgets_with_section',
      'page arguments' => array(1, 2, 3, 4, 5, 6),
      'access arguments' => array('administer nodequeue'),
  );
  $items['move-widget-node/%/%/%/%'] = array(
      'page callback' => 'move_node_from_widget',
      'page arguments' => array(1, 2, 3, 4),
      'access arguments' => array('administer nodequeue'),
  );

  $items['remove-so-sorry-extra-data/%'] = array(
      'page callback' => 'remove_extra_field_value_for_so_sorry',
      'page arguments' => array(1),
      'access arguments' => array('administer nodequeue'),
  );

  $items['add-so-sorry-extra-data/%/%'] = array(
      'page callback' => 'add_extra_field_value_for_so_sorry',
      'page arguments' => array(1, 2),
      'access arguments' => array('administer nodequeue'),
  );

  $items['move-dont-miss-widget-node/%/%/%/%'] = array(
      'page callback' => 'move_node_from_dont_miss_widget',
      'page arguments' => array(1, 2, 3, 4),
      'access arguments' => array('administer nodequeue'),
  );
  $items['anchor-list/autocomplete'] = array(
      'page callback' => 'itg_widget_anchor_autocomplete_name',
      'access arguments' => array('access content'),
  );
  $items['anchor-list-nid/autocomplete'] = array(
      'page callback' => 'itg_widget_anchor_autocomplete_id',
      'access arguments' => array('access content'),
  );
  $items['node-list-title/autocomplete'] = array(
      'page callback' => 'itg_widget_all_content_title',
      'access arguments' => array('access content'),
  );
  $items['node-list-nid/autocomplete'] = array(
      'page callback' => 'itg_widget_all_content_nid',
      'access arguments' => array('access content'),
  );
  $items['so-sorry-content-title/autocomplete'] = array(
      'page callback' => 'itg_widget_so_sorry_content_title',
      'access arguments' => array('access content'),
  );
  $items['so-sorry-content-nid/autocomplete'] = array(
      'page callback' => 'itg_widget_so_sorry_content_nid',
      'access arguments' => array('access content'),
  );
  $items['remove-extra-data'] = array(
      'page callback' => 'remove_extra_data',
      'access arguments' => array('access administrator'),
  );
  $items['setids'] = array(
      'page callback' => 'itg_widget_setids', // load the croper according to size!.
      'type' => MENU_CALLBACK,
      'access arguments' => array('access content'),
  );

  $items['test_function_callback'] = array(
      'page callback' => 'get_personalization_front_data', // load the croper according to size!.
      'type' => MENU_CALLBACK,
      'access arguments' => array('access content'),
  );

  $items['issue_filter_widget'] = array(
      'page callback' => 'itg_widget_issuewidget_filter_form', // load the croper according to size!.
      'type' => MENU_CALLBACK,
      'access arguments' => array('access content'),
  );

  $items['admin/settings/custom-variables'] = array(
      'title' => 'Custom variables',
      'description' => 'Custom variables settings page',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('itg_widgets_custom_variables'),
      'access arguments' => array('access administrator'),
      'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * This function is used to create settings.
 * 
 * {@inheritdoc}
 */
function itg_widgets_custom_variables() {
  $form = array();
  $form['program_category_id_for_programmes'] = array(
      '#type' => 'textfield',
      '#title' => t('Enter Program Category Id'),
      '#default_value' => variable_get('program_category_id_for_programmes'),
      '#required' => TRUE,
      '#size' => 20,
      '#maxlength' => 20,
  );
  $form['so_sorry_category_id_for_widget'] = array(
      '#type' => 'textfield',
      '#title' => t('Enter So Sorry Category Id'),
      '#default_value' => variable_get('so_sorry_category_id_for_widget'),
      '#required' => TRUE,
      '#size' => 20,
      '#maxlength' => 20,
  );
  return system_settings_form($form);
}

/**
 * Funtion used to add or delete widgit ids into session for Selected content id should be display on top.
 * 
 */
function itg_widget_setids() {
  $datatoset = array();
  $datatoset = $_SESSION[$_POST['formid']];

  if (is_array($_POST['checkid'])) {
    foreach ($_POST['checkid'] as $ids) {
      if ($_POST['type'] == 'ADD') {
        $datatoset[] = $ids;
      }
      else if ($_POST['type'] == 'REMOVE') {
        if (($key = array_search($ids, $datatoset)) !== false) {

          unset($datatoset[$key]);
        }
      }
    }
  }
  else {

    if (empty($datatoset)) {
      $datatoset[] = $_POST['checkid'];
    }
    if ($_POST['type'] == 'ADD') {
      array_push($datatoset, $_POST['checkid']);
    }
    else if ($_POST['type'] == 'REMOVE') {

      if (($key = array_search($_POST['checkid'], $datatoset)) !== false) {
        unset($datatoset[$key]);
      }
    }
  }
  $datatoset = array_unique($datatoset);
  $_SESSION[$_POST['formid']] = $datatoset;
}

function remove_extra_data() {
  $widget = array(
//      'widget_anchors_listing',
//      'home_page_feature_widget',
//      'story_widget',
//      'section_wise_content_ordering_list',
//      'section_wise_draggable_content_order',
//      'big_story_format_widget',
//      'dont_miss_content_widget',
//      'section_wise_widget',
//      'we_may_suggest_widget',
//      'section_wise_content_ordering',
//      'widget_anchors_listing',
//      'category_wise_content_list',
//     'photo_carousel_widget',
  );
  foreach ($widget as $view_name) {
    $num_deleted = db_delete('draggableviews_structure')
            ->condition('view_name', $view_name)
            ->execute();

    $num_deleted = db_delete('itg_widget_order')
            ->condition('widget', $view_name)
            ->execute();
  }
}

/**
 * Funtion used to delete node combination form itg_widget_order table.
 * 
 * @param string $widget_name
 * @param string $content_type
 * @param int $cat_tid
 * @param int $nid
 */
function move_node_from_dont_miss_widget($widget_name, $content_type, $cat_tid, $nid) {
  if (!empty($widget_name) && !empty($nid)) {
    $num = db_delete('itg_widget_order')
            ->condition('nid', $nid)
            ->condition('widget', $widget_name)
            ->execute();
    if ($num) {
      drupal_set_message(t("Node has been moved"));
      drupal_goto($_SERVER['HTTP_REFERER']);
    }
    else {
      drupal_set_message(t("Node id or widget name not found"));
      drupal_goto($_SERVER['HTTP_REFERER']);
    }
  }
}

/**
 * Function used to delete node combination form itg_widget_order table.
 * 
 * @param string $widget_name
 * @param string $content_type
 * @param int $cat_tid
 * @param int $nid
 */
function move_node_from_widget($widget_name, $content_type, $cat_tid, $nid) {
  if (!empty($widget_name) && !empty($cat_tid) && !empty($nid)) {
    $num = db_delete('itg_widget_order')
            ->condition('nid', $nid)
//->condition('content_type', $content_type)
            ->condition('cat_id', $cat_tid)
            ->condition('widget', $widget_name)
            ->execute();
    if ($num) {
      drupal_set_message(t("Node has been moved"));
      drupal_goto($_SERVER['HTTP_REFERER']);
    }
  }
}

/**
 * Function is used to remove extra field value croospond to nid.
 * 
 * @param int $nid
 */
function remove_extra_field_value_for_so_sorry($nid) {
  $num_updated = db_update('itg_widget_order')
          ->fields(array('extra' => " "))
          ->condition('nid', $nid)
          ->condition('widget', 'so_sorry_widget')
          ->execute();
//drupal_set_message(t("Node has been moved"));
  drupal_goto($_SERVER['HTTP_REFERER']);
}

/**
 * Function is used to add extra field value croospond to nid.
 * 
 * @param int $nid
 * @param string $extra
 */
function add_extra_field_value_for_so_sorry($nid, $extra) {
// Handling only single nid can be either feature or remix;
  $so_sorry_extra_nodes = db_select('itg_widget_order', 'iwo')
                  ->condition('iwo.extra', $extra)
                  ->fields('iwo', array('nid'))
                  ->execute()->fetchAll(PDO::FETCH_ASSOC);

  foreach ($so_sorry_extra_nodes as $key => $nids) {
    db_update('itg_widget_order')
            ->fields(array('extra' => " "))
            ->condition('nid', $nids['nid'])
            ->condition('widget', 'so_sorry_widget')
            ->execute();
  }

  db_update('itg_widget_order')
          ->fields(array('extra' => $extra))
          ->condition('nid', $nid)
          ->condition('widget', 'so_sorry_widget')
          ->execute();

  drupal_goto($_SERVER['HTTP_REFERER']);
}

/**
 * Function used for delete node from draggableviews_structure and nodequeue
 * @param int $nid
 * @param int $qid
 * @param string $view_name
 * @param string $page_name
 */
function remove_from_widgets_with_section($nid, $qid, $view_name, $page_name, $section_tid, $type) {
  $draggable_delete = draggable_view_node_delete_section($view_name, $page_name, $nid, $section_tid, $type);
  if ($draggable_delete) {
    nodequeue_subqueue_remove_node($qid, $nid);
    echo "deleted";
  }
  else {
    echo "not-deleted";
  }
}

/**
 * Function used to delete form draggableviews_structure table
 * @param string $view_name
 * @param string $page_name
 * @param int $nid
 * @return int
 */
function draggable_view_node_delete_section($view_name, $page_name, $nid, $section_tid, $type) {
  if (!empty($view_name) && !empty($page_name) && !empty($nid) && !empty($section_tid) && !empty($type)) {
    $args = '{"field_story_category_tid":"' . $section_tid . '","type":"' . $type . '"}';
    $num_deleted = db_delete('draggableviews_structure')
            ->condition('view_name', $view_name)
            ->condition('view_display', $page_name)
            ->condition('entity_id', $nid)
            ->condition('args', $args)
            ->execute();
    return $num_deleted;
  }
}

/**
 * Function used for delete node from draggableviews_structure and nodequeue
 * @param int $nid
 * @param int $qid
 * @param string $view_name
 * @param string $page_name
 */
function remove_from_widgets($nid, $qid, $view_name, $page_name) {
  $draggable_delete = draggable_view_node_delete($view_name, $page_name, $nid);
  nodequeue_subqueue_remove_node($qid, $nid);
  if ($draggable_delete) {
//nodequeue_subqueue_remove_node($qid, $nid);
    print "deleted";
  }
  else {
    print "notdeleted";
  }
  drupal_set_message(t("Node has been moved"));
  drupal_goto($_SERVER['HTTP_REFERER']);
}

/**
 * Function used to delete form draggableviews_structure table
 * @param string $view_name
 * @param string $page_name
 * @param int $nid
 * @return int
 */
function draggable_view_node_delete($view_name, $page_name, $nid) {
  if (!empty($view_name) && !empty($page_name) && !empty($nid)) {
    $num_deleted = db_delete('draggableviews_structure')
            ->condition('view_name', $view_name)
            ->condition('view_display', $page_name)
            ->condition('entity_id', $nid)
            ->execute();
    return $num_deleted;
  }
}

/**
 * {@inheritdoc}
 */
function itg_widget_block_info() {
  $blocks['top_stories_ordering'] = array(
      'info' => t('Widget: Top Stories Ordering'),
  );
  $blocks['trending_videos_widget'] = array(
      'info' => t('Widget: Trending videos widgets'),
  );
  $blocks['top_takes_videos_widget'] = array(
      'info' => t('Widget: Top Takes videos widgets'),
  );
  $blocks['home_page_feature'] = array(
      'info' => t('Widget: Home Page Feature'),
  );
  $blocks['we_may_suggest'] = array(
      'info' => t('Widget: We May Suggest'),
  );
  $blocks['section_wise_order'] = array(
      'info' => t('Widget: Section wise ordering form custom table'),
  );
  $blocks['rhs_section_wise_order'] = array(
      'info' => t('Widget: RHS Section wise content ordering from custom table'),
  );
  $blocks['big_story_format'] = array(
      'info' => t('Widget: Big story form custom table'),
  );
  $blocks['most_popular'] = array(
      'info' => t('Widget: Most popular form custom table'),
  );

  $blocks['featured_photo_carousel'] = array(
      'info' => t('Widget: Featured Photo Carousel - Flexslider'),
  );

  $blocks['featured_photo_carousel_r'] = array(
      'info' => t('Widget: Featured Photo Carousel - Rolling Slider'),
  );

  $blocks['featured_video_carousel'] = array(
      'info' => t('Widget: Featured Video Carousel - Flexslider'),
  );

  $blocks['featured_video_carousel_r'] = array(
      'info' => t('Widget: Featured Video Carousel - Rolling Slider'),
  );

  $blocks['dont_miss'] = array(
      'info' => t('Widget: Dont Miss form custom table'),
  );
  $blocks['watch_right_now_videos_widget'] = array(
      'info' => t('Widget: Watch right now videos'),
  );
  $blocks['anchor_langing_page_menu'] = array(
      'info' => t('Anchor landing page menu'),
  );
  $blocks['personlization'] = array(
      'info' => t('Persionlization front end'),
  );
  $blocks['home_page_poll_widget_block'] = array(
      'info' => t('Home Page Poll Widget'),
      'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * {@inheritdoc}
 */
function itg_widget_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    // Big Story Content.
    case 'big_story_format':
      module_load_include('inc', 'itg_widget', 'includes/itg_widget_big_story');
      //$block['subject'] = t('');
      $info['widget'] = 'big_story_format_widget';
      $data = itg_widget_big_story_block_data($info);
      $block['content'] = theme("widget_big_story_format", array("data" => $data));
      break;
    // section ordering reordering widget case
    case 'section_wise_order':
      module_load_include('inc', 'itg_widget', 'includes/section-wise-order-from-custom-table');
      // value is hardcoded need to be change for dyanamic functionality
      $info['section'] = '240'; // tid of section
      $info['content_type'] = ''; // content type machine name
      // view name which is stored in draggableviews_structure table
      $info['view_name'] = 'views_form_section_wise_content_ordering_list_page';
      //$block['subject'] = t('Section wise ordering from custom table');
      $data = itg_widget_section_wise_ordering_from_custom_table($info);
      $block['content'] = theme("section_wise_ordering", array("data" => $data));
      break;
    case 'rhs_section_wise_order':
      module_load_include('inc', 'itg_widget', 'includes/section-wise-order-from-custom-table');
      // value is hardcoded need to be change for dyanamic functionality
      $info['section'] = '437'; // tid of section
      $info['content_type'] = ''; // content type machine name
      // view name which is stored in draggableviews_structure table
      $info['view_name'] = 'views_form_section_wise_content_ordering_list_page';
      //$block['subject'] = t('Section wise ordering from custom table');
      $data = itg_widget_section_wise_ordering_for_rhs_from_custom_table($info);
      $block['content'] = theme("rhs_section_wise_ordering", array("data" => $data));
      break;
    case 'we_may_suggest':
      module_load_include('inc', 'itg_widget', 'includes/we-may-suggest');
      $info['section'] = '301'; // tid of section
      $info['content_type'] = 'story'; // content type machine name
      $info['view_name'] = 'we_may_suggest_widget';
      $data = itg_widget_we_may_suggest_ordering_from_custom_table($info);
      $block['content'] = theme("we_may_suggest", array("data" => $data));
      break;
    // Top story ordering reordering widget case
    case 'top_stories_ordering':
      module_load_include('inc', 'itg_widget', 'includes/section-odering');
      $info['view_name'] = 'story_widget'; // view name
      $info['page'] = 'page_2'; // page name
      $info['nodequeue'] = 'top_stories';
      $data = itg_widget_top_stories_ordering_data($info);
      $block['content'] = theme("top_stories_ordering", array("data" => $data));
      break;
    // Top story ordering reordering widget case
    case 'most_popular':
      module_load_include('inc', 'itg_widget', 'includes/itg_widget_most_popular');
      $info['view_name'] = 'story_widget'; // view name
      $info['page'] = 'most_popular_widget'; // page name
      $info['nodequeue'] = 'most_popular';
      $data = itg_widget_most_popular_ordering_data($info);
      $block['content'] = theme("most_popular_widget", array("data" => $data));
      break;
    // Top story ordering reordering widget case
    case 'dont_miss':
      module_load_include('inc', 'itg_widget', 'includes/itg_widget_dont_miss');
      $info['widget_name'] = 'dont_miss_content_widget';
      $data = itg_widget_dont_miss_ordering_data($info);
      $block['content'] = theme("dont_miss_widget", array("data" => $data));
      break;
    // Trending videos ordering reordering widget case
    case 'trending_videos_widget':
      module_load_include('inc', 'itg_widget', 'includes/itg_widget_trending_videos_widget');
      $info['view_name'] = 'story_widget'; // view name
      $info['page'] = 'trending_videos_widget'; // page name
      $info['nodequeue'] = 'trending_videos';
      $data = itg_widget_trending_videos_widget_ordering_data($info);
      $block['content'] = theme("trending_videos_widget", array("data" => $data));
      break;
    // Watch Right Now ordering reordering widget case
    case 'watch_right_now_videos_widget':
      module_load_include('inc', 'itg_widget', 'includes/itg_widget_watch_right_now_videos_widget');
      $info['view_name'] = 'story_widget'; // view name
      $info['page'] = 'watch_right_now_widget'; // page name
      $info['nodequeue'] = 'watch_right_now';
      $data = itg_widget_watch_right_now_videos_widget_ordering_data($info);
      $block['content'] = theme("itg_widget_watch_right_now_videos_widget", array("data" => $data));
      break;
    // Top takes videos ordering reordering widget case
    case 'top_takes_videos_widget':
      module_load_include('inc', 'itg_widget', 'includes/itg_widget_top_takes_videos_widget');
      $info['view_name'] = 'story_widget'; // view name
      $info['page'] = 'top_takes_video_widget'; // page name
      $info['nodequeue'] = 'top_takes_videos';
      $data = itg_widget_top_takes_videos_widget_ordering_data($info);
      $block['content'] = theme("top_takes_videos_widget", array("data" => $data));
      break;
    // home page feature ordering reordering widget case
    case 'home_page_feature':
      module_load_include('inc', 'itg_widget', 'includes/home-page-feature');
      $info['view_name'] = 'home_page_feature_widget'; // view name
      $info['page'] = 'page_2'; // page name
      $info['nodequeue'] = 'home_page_feature';
      $data = itg_widget_home_page_feature_data($info);
      $block['content'] = theme("home_page_feature", array("data" => $data));
      break;
    // featured photo carousel reordering widget case
    case 'featured_photo_carousel':
      drupal_add_library('flexslider', 'flexslider');
      libraries_load('flexslider');
      module_load_include('inc', 'itg_widget', 'includes/featured_photo_carousel');

      drupal_add_js('jQuery(window).load(function() {
            jQuery(".flexslider").flexslider({
            animation: "slide",
            prevText: "",
            nextText: "",
            });
            });', array('type' => 'inline', 'scope' => 'footer', 'weight' => 5)
      );

      drupal_add_css('.flex-caption {
              width: 96%;
              padding: 2%;
              left: 0;
              bottom: 0;
              background: rgba(0,0,0,.5);
              color: #fff;
              text-shadow: 0 -1px 0 rgba(0,0,0,.3);
              font-size: 14px;
              line-height: 18px;
            }', 'inline');


      $info['view_name'] = 'photo_carousel_widget'; // view name
      $info['page'] = 'photo_carousel'; // page name
      $info['nodequeue'] = 'photo_carousel';
      $data = itg_widget_featured_photo_carousel_data($info, 'flexslider');
      $block['content'] = theme("featured_photo_carousel", array("data" => $data));
      break;

    case 'featured_photo_carousel_r':
      global $base_url;

      drupal_add_js($base_url . '/sites/all/themes/itg/js/itg-photo-slider.js', array('type' => 'external', 'scope' => 'footer', 'weight' => 5));

      drupal_add_js("jQuery(document).ready(function () {
            jQuery('.carousel').carousel({
              frontWidth: 645,
              frontHeight: 365,
              carouselWidth: 1170,
              carouselHeight: 450,
              buttonNav: 'none'
            });
          });", array('type' => 'inline', 'scope' => 'footer', 'weight' => 5)
      );

      /* drupal_add_js($base_url . '/sites/all/libraries/rollingslider/script/jquery.rollingslider.js', array('type' => 'external', 'scope' => 'footer', 'weight' => 5)
        );
        drupal_add_css($base_url . '/sites/all/libraries/rollingslider/style/index.css', array('type' => 'external', 'scope' => 'footer', 'weight' => 5)
        );
        drupal_add_js("jQuery('#featuredphoto').RollingSlider({
        showArea:'#example',
        prev:'#jprev',
        next:'#jnext',
        moveSpeed:300,
        autoPlay:false
        });", array('type' => 'inline', 'scope' => 'footer', 'weight' => 5)
        );
        drupal_add_js('misc/jquery.js'); */
      module_load_include('inc', 'itg_widget', 'includes/featured_photo_carousel');
      $info['view_name'] = 'photo_carousel_widget'; // view name
      $info['page'] = 'photo_carousel'; // page name
      $data = itg_widget_featured_photo_carousel_data($info, 'rolling');
      $block['content'] = theme("featured_photo_carousel_rollingslider", array("data" => $data));
      break;

    case 'featured_video_carousel':
      drupal_add_library('flexslider', 'flexslider');
      libraries_load('flexslider');
      module_load_include('inc', 'itg_widget', 'includes/featured_video_carousel');

      drupal_add_js('jQuery(window).load(function() {
            jQuery(".flexslider-video").flexslider({
            animation: "slide"
            });
            });', array('type' => 'inline', 'scope' => 'footer', 'weight' => 5)
      );

      drupal_add_css('.flex-caption {
              width: 96%;
              padding: 2%;
              left: 0;
              bottom: 0;
              background: rgba(0,0,0,.5);
              color: #fff;
              text-shadow: 0 -1px 0 rgba(0,0,0,.3);
              font-size: 14px;
              line-height: 18px;
            }', 'inline');


      $info['view_name'] = 'photo_carousel_widget'; // view name
      $info['page'] = 'video_carousel'; // page name
      $info['nodequeue'] = 'video_carousel';
      $data = itg_widget_featured_video_carousel_data($info, 'flexslider');
      $block['content'] = theme("featured_video_carousel", array("data" => $data));
      break;

    case 'featured_video_carousel_r':
      global $base_url;

      drupal_add_js($base_url . '/sites/all/themes/itg/js/itg-photo-slider.js', array('type' => 'external', 'scope' => 'footer', 'weight' => 5));

      drupal_add_js("jQuery(document).ready(function () {
            jQuery('.carousel').carousel({
              frontWidth: 645,
              frontHeight: 365,
              carouselWidth: 1170,
              carouselHeight: 450,
              buttonNav: 'none'
            });
          });", array('type' => 'inline', 'scope' => 'footer', 'weight' => 5)
      );
      /* drupal_add_js($base_url . '/sites/all/libraries/rollingslider/script/jquery.rollingslider.js', array('type' => 'external', 'scope' => 'footer', 'weight' => 5)
        );
        drupal_add_css($base_url . '/sites/all/libraries/rollingslider/style/index.css', array('type' => 'external', 'scope' => 'footer', 'weight' => 5)
        );

        drupal_add_js("jQuery('#featuredvideo').RollingSlider({
        showArea:'#example',
        prev:'#jprev',
        next:'#jnext',
        moveSpeed:500,
        autoPlay:false
        });", array('type' => 'inline', 'scope' => 'footer', 'weight' => 5)
        );
        drupal_add_js('misc/jquery.js'); */
      module_load_include('inc', 'itg_widget', 'includes/featured_video_carousel');
      $info['view_name'] = 'photo_carousel_widget'; // view name
      $info['page'] = 'video_carousel'; // page name
      $data = itg_widget_featured_video_carousel_data($info, 'rolling');
      $block['content'] = theme("featured_video_carousel_rollingslider", array("data" => $data));
      break;
    // Top takes videos ordering reordering widget case
    case 'anchor_langing_page_menu':
      $block['content'] = theme("anchor_langing_page_menu", array("data" => $data));
      break;
    case 'personlization':
      module_load_include('inc', 'itg_widget', 'includes/fitg_widget_personalization');
      $data = get_personlization_front_block_data();
      $block['content'] = theme("personlization_front_end", array("data" => $data));
    case 'home_page_poll_widget_block':
      $selected_poll_widget = get_homepage_current_poll_widget('poll', 'poll_widget');
      $block['content'] = itg_poll_home_page_polls_select($selected_poll_widget);
      break;
  }
  return $block;
}

/**
 * {@inheritdoc}
 */
function itg_widget_form_alter(&$form, &$form_state, $form_id) {
  $setting = array();
  $queue_flag = "";
  $view_name = isset($form_state['view']->name) ? $form_state['view']->name : "";
  $current_display = isset($form_state['view']->current_display) ? $form_state['view']->current_display : "";
  /* Load all nodes queues */
  $queues = nodequeue_load_queues(nodequeue_get_all_qids());
  switch ($view_name) {
    // top story
    case 'story_widget':
      if ($current_display == 'most_popular') {
        //  watchdog("Widget", "Nodequeue bulk operation settings has been found for : Most Popular");
        $queue_flag = 5; // most popular
      }
      elseif ($current_display == 'trending_videos') {
        //  watchdog("Widget", "Nodequeue bulk operation settings has been found for : Trending video");
        $queue_flag = 4; // top story widget qid
      }
      elseif ($current_display == 'top_takes_video') {
        //  watchdog("Widget", "Nodequeue bulk operation settings has been found for : Trending video");
        $queue_flag = $queue_flag = get_nodequeue_load_queue_by_name('top_takes_videos'); // top story widget qid
      }
      elseif ($current_display == 'watch_right_now') {
        //  watchdog("Widget", "Nodequeue bulk operation settings has been found for : Trending video");
        $queue_flag = $queue_flag = get_nodequeue_load_queue_by_name('watch_right_now'); // top story widget qid
      }
      else {
        $queue_flag = 1; // trending_videos widget qid
      }
      break;
    // home page feature
    case 'home_page_feature_widget':
      // watchdog("Widget", "Nodequeue bulk operation settings has been found for : home page feature");
      $queue_flag = 2; // home page feature qid
      break;
    // We may suggest
    case 'we_may_suggest':
      // watchdog("Widget", "Nodequeue bulk operation settings has been found for : we may suggest");
      $queue_flag = 3; // home page feature qid
      break;
    case 'widget_anchors_listing':
      // watchdog("Widget", "Nodequeue bulk operation settings has been found for : we may suggest");
      $queue_flag = $queue_flag = get_nodequeue_load_queue_by_name('widget_anchor'); // anchor widget nodequeue
      break;

    case 'photo_carousel_widget':
      if ($current_display == 'photo_carousel_list') {
        //watchdog("Widget", "Nodequeue bulk operation settings has been found for : Photo Carousel video");
        $queue_flag = get_nodequeue_load_queue_by_name('photo_carousel');
        ; // photo carousel list widget qid
      }
      if ($current_display == 'video_carousel_list') {
        //watchdog("Widget", "Nodequeue bulk operation settings has been found for : Video Carousel video");
        $queue_flag = get_nodequeue_load_queue_by_name('video_carousel'); // video carousel list widget qid
      }

      break;
  }
  if (!empty($queues[$queue_flag])) {
    $setting['name'] = $queues[$queue_flag]->name;
    $setting['qid'] = $queues[$queue_flag]->qid;
    $setting['title'] = $queues[$queue_flag]->title;
    // add js for setting
    drupal_add_js(drupal_get_path('module', 'itg_widget') . '/js/itg_widget.main.js', 'file');
    // pass setting to js for bulk operation
    drupal_add_js(array('itg_widget' => array('data' => $setting)), 'setting');
  }
  // Alter form for confirm message during bulk operation.
  // Below forms are thoese which are not doing action for nodequeue.
  // Nodequeue from are being altered form itg_widget.main.js.
  $form_id_array_to_alter = array(
      'views_form_section_wise_draggable_content_order_big_story_format',
      'views_form_section_wise_draggable_content_order_dont_miss_content',
      'views_form_section_wise_draggable_content_order_we_may_suggest_widget',
      'views_form_section_wise_draggable_content_order_page',
  );


  if (in_array($form_id, $form_id_array_to_alter)) {
    $form['actions']['submit']['#value'] = t('Confirm');
  }


  foreach (forms_uses_checked_content_id() as $forms) {
    //$form['submit']['#validate'][] = 'session_dependent_custom_form_validation';
  }
  // Assign deafult values in case of checkbox are checked.
  $form = get_sessions_of_ticked_nodes($form);
}

/**
 * {@inheritdoc}
 */
function session_dependent_custom_form_validation(&$form, &$form_state) {
  if (empty($_SESSION[$form['#form_id']])) {
    form_set_error("Please select at least one item.");
  }
  else {
    return true;
  }
}

/**
 * {@inheritdoc}
 */
function itg_widget_views_bulk_operations_form_alter(&$form, &$form_state, $vbo) {
  // Form id which will use session value.
  // Session value is set by ajax.
  // Extra funtionality to display nodeid with cross.
  $form_to_used_session_checked = forms_uses_checked_content_id();

  if (in_array($form['#form_id'], $form_to_used_session_checked)) {
    // $form_state['selection'] value is set by bulk operation submit.
    // Only selected nodes are come in $form_state['selection'] array.
    // Here we are forcely changing the array.
    // for big story we are using single selection so skip for big story.
    $form_state['selection'] = $_SESSION[$form['#form_id']];
    $form_state['values']['views_bulk_operations'] = $form_state['selection'];
    $form['actions']['submit']['#submit'][] = "itg_widget_custom_session_destory";
  }

  // Add a node id contianer just below the bulk operation.
  if (isset($form['select']['action::nodequeue_add_action'])) {
    $form['select']['action::nodequeue_add_action']['#suffix'] = '<div class="nodes_id_container"></div>';
  }

  if (isset($form['select']['action::itg_widget_categories_wise_node_group'])) {
    $form['select']['action::itg_widget_categories_wise_node_group']['#suffix'] = '<div class="nodes_id_container"></div>';
  }
}

/**
 * Function custom submit for destorying the session for current form id.
 * 
 * @param array $form
 * @param array $form_state
 * @return array
 */
function itg_widget_custom_session_destory($form, &$form_state) {
  $_SESSION[$form['#form_id']] = array();
  unset($_SESSION[$form['#form_id']]);
  return array(
      'form_values' => $form_state['values'],
  );
}

/**
 * Function returns array of all the formid which use checked unchecked
 * Session dependency.
 * 
 * @return array
 */
function forms_uses_checked_content_id() {
  return array(
      'views_form_story_widget_page_1',
      'views_form_widget_anchors_listing_anchors_listing_page',
      'views_form_section_wise_draggable_content_order_dont_miss_content',
      'views_form_home_page_feature_widget_page_1',
      'views_form_section_wise_draggable_content_order_we_may_suggest_widget',
      'views_form_story_widget_most_popular',
      'views_form_section_wise_draggable_content_order_page',
      'views_form_story_widget_trending_videos',
      'views_form_story_widget_top_takes_video',
      'views_form_story_widget_watch_right_now',
      'views_form_photo_carousel_widget_photo_carousel_list',
      'views_form_photo_carousel_widget_video_carousel_list',
      'views_form_so_sorry_so_sorry_videos',
  );
}

/**
 * Funtion is used for get the session values
 * Which is set for only checkbox on widget search content page.
 * 
 * @param array $form
 * @return array
 */
function get_sessions_of_ticked_nodes(&$form) {
  foreach ($form['views_bulk_operations'] as $key => $form_node_data) {
    if (in_array($form_node_data['#return_value'], $_SESSION[$form['#form_id']])) {
      $form['views_bulk_operations'][$key]['#attributes']['class'][] = 'custom-selected';
      $form['views_bulk_operations'][$key]['#default_value'] = $form_node_data['#return_value'];
    }
  }
  drupal_add_js('jQuery(window).load(function() {
            var sessionids="' . implode($_SESSION[$form['#form_id']], ',') . '";
                if(sessionids!="")
                {
                sessionids=sessionids.split(",");
                }
                jQuery.each(sessionids, function( index, value ) {
                 jQuery(".fieldset-wrapper").append("<span id=spn_"+value+" class=content-ids>"+value+"<a class=removeid cid="+value+" href=javascript:void(0)>X</a></span>");});

            });', array('type' => 'inline', 'scope' => 'footer', 'weight' => 5)
  );
  return $form;
}

/**
 * {@inheritdoc}
 */
function itg_widget_theme() {
  $themes = array(
      'section_wise_ordering' => array(
          'template' => 'templates/section-ordering-data',
      ),
      'rhs_section_wise_ordering' => array(
          'template' => 'templates/rhs-section-ordering-data',
      ),
      'top_stories_ordering' => array(
          'template' => 'templates/top-stories-ordering-data',
      ),
      'home_page_feature' => array(
          'template' => 'templates/home-page-feature',
      ),
      'we_may_suggest' => array(
          'template' => 'templates/we-may-suggest',
      ),
      'widget_big_story_format' => array(
          'template' => 'templates/big-story-format',
      ),
      'trending_videos_widget' => array(
          'template' => 'templates/trending-videos-widget',
      ),
      'most_popular_widget' => array(
          'template' => 'templates/most-popular-widget',
      ),
      'featured_photo_carousel' => array(
          'template' => 'templates/featured-photo-carousel',
      ),
      'featured_photo_carousel_rollingslider' => array(
          'template' => 'templates/featured-photo-carousel-rollingslider',
      ),
      'featured_video_carousel' => array(
          'template' => 'templates/featured-video-carousel',
      ),
      'featured_video_carousel_rollingslider' => array(
          'template' => 'templates/featured-video-carousel-rollingslider',
      ),
      'dont_miss_widget' => array(
          'template' => 'templates/dont-miss-widget',
      ),
      'top_takes_videos_widget' => array(
          'template' => 'templates/top-takes-videos-widget',
      ),
      'itg_widget_watch_right_now_videos_widget' => array(
          'template' => 'templates/watch-right-now-videos-widget',
      ),
      'anchor_langing_page_menu' => array(
          'template' => 'templates/anchor-landing-page-menu',
      ),
      'personlization_front_end' => array(
          'template' => 'templates/personlization-front-end',
      ),
  );
  return $themes;
}

/**
 * {@inheritdoc}
 */
function get_required_data_from_entity_id($entity_id) {
  return entity_load('node', array($entity_id));
}

/**
 * {@inheritdoc}
 */
function itg_widget_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  switch ($form['#id']) {
    case 'views-exposed-form-home-page-feature-widget-page-1':
      $form['title']['#attributes']['placeholder'] = t('Content Title');
      $form['nid']['#attributes']['placeholder'] = t('Content ID');
      $autocomplete_path = autocomplete_for_widgets($_GET['type']);
      $form['title']['#autocomplete_path'] = $autocomplete_path['title'];
      $form['nid']['#autocomplete_path'] = $autocomplete_path['nid'];
      break;
    case 'views-exposed-form-section-wise-draggable-content-order-we-may-suggest-widget':
      $form['title']['#attributes']['placeholder'] = t('Content Title');
      $form['nid']['#attributes']['placeholder'] = t('Content ID');
      $autocomplete_path = autocomplete_for_widgets($_GET['type'], TRUE, 'story');
      $form['title']['#autocomplete_path'] = $autocomplete_path['title'];
      $form['nid']['#autocomplete_path'] = $autocomplete_path['nid'];
      break;
    case 'views-exposed-form-story-widget-most-popular':
    case 'views-exposed-form-story-widget-page-1':
      $form['title']['#attributes']['placeholder'] = t('Story Title');
      $form['title']['#autocomplete_path'] = 'content-title-list/story/autocomplete';
      $form['nid']['#attributes']['placeholder'] = t('Story ID');
      $form['nid']['#autocomplete_path'] = 'content-nid-list/story/autocomplete';
      break;
    case 'views-exposed-form-photo-carousel-widget-photo-carousel-list':
      $form['title']['#attributes']['placeholder'] = t('Photo Gallery Title');
      $form['title']['#autocomplete_path'] = 'content-title-list/photogallery/autocomplete';
      $form['nid']['#attributes']['placeholder'] = t('Photo Gallery ID');
      $form['nid']['#autocomplete_path'] = 'content-nid-list/photogallery/autocomplete';
      break;
    case 'views-exposed-form-photo-carousel-widget-video-carousel-list':
      $form['title']['#attributes']['placeholder'] = t('Video Gallery Title');
      $form['title']['#autocomplete_path'] = 'content-title-list/videogallery/autocomplete';
      $form['nid']['#attributes']['placeholder'] = t('Video Gallery ID');
      $form['nid']['#autocomplete_path'] = 'content-nid-list/videogallery/autocomplete';
      break;
    case 'views-exposed-form-story-widget-trending-videos':
    case 'views-exposed-form-story-widget-top-takes-video':
    case 'views-exposed-form-story-widget-watch-right-now':
      $form['title']['#attributes']['placeholder'] = t('Video Title');
      $form['nid']['#attributes']['placeholder'] = t('Video ID');
      $form['nid']['#autocomplete_path'] = 'content-nid-list/videogallery/autocomplete';
      $form['title']['#autocomplete_path'] = 'content-title-list/videogallery/autocomplete';
      break;
    case 'views-exposed-form-so-sorry-so-sorry-videos':
      $cat_setting = trim(variable_get('so_sorry_category_id_for_widget'));
      if (strlen($cat_setting) <= 0) {
        $setting_link = l("Click Here", "admin/settings/custom-variables");
        drupal_set_message("Setting not found for autocomplete. Please $setting_link", "error");
      }
      $form['title']['#attributes']['placeholder'] = t('Video Title');
      $form['nid']['#attributes']['placeholder'] = t('Video ID');
      $form['title']['#autocomplete_path'] = 'so-sorry-content-title/autocomplete';
      $form['nid']['#autocomplete_path'] = 'so-sorry-content-nid/autocomplete';
      break;
    case 'views-exposed-form-section-wise-draggable-content-order-big-story-format':
      $form['title']['#attributes']['placeholder'] = t('Content Title');
      $form['nid']['#attributes']['placeholder'] = t('Content ID');
      $autocomplete_path = autocomplete_for_widgets($_GET['type'], TRUE);
      $form['title']['#autocomplete_path'] = $autocomplete_path['title'];
      $form['nid']['#autocomplete_path'] = $autocomplete_path['nid'];
      break;
    case 'views-exposed-form-section-wise-draggable-content-order-dont-miss-content':
      $form['title']['#attributes']['placeholder'] = t('Content Title');
      $form['nid']['#attributes']['placeholder'] = t('Content ID');
      $autocomplete_path = autocomplete_for_widgets($_GET['type']);
      $form['title']['#autocomplete_path'] = $autocomplete_path['title'];
      $form['nid']['#autocomplete_path'] = $autocomplete_path['nid'];
      break;
    case 'views-exposed-form-widget-anchors-listing-anchors-listing-page':
      $form['title']['#attributes']['placeholder'] = t('Anchor name');
      $form['title']['#autocomplete_path'] = 'anchor-list/autocomplete';
      $form['nid']['#attributes']['placeholder'] = t('Anchor ID');
      $form['nid']['#autocomplete_path'] = 'anchor-list-nid/autocomplete';
      break;
    case 'views-exposed-form-section-wise-draggable-content-order-page':
      $form['title']['#attributes']['placeholder'] = t('Content Title');
      $form['nid']['#attributes']['placeholder'] = t('Content ID');
      $autocomplete_path = autocomplete_for_widgets($_GET['type']);
      $form['title']['#autocomplete_path'] = $autocomplete_path['title'];
      $form['nid']['#autocomplete_path'] = $autocomplete_path['nid'];
      $form['#validate'][] = 'custom_section_wise_validate';
      break;
    case 'views-exposed-form-section-wise-content-ordering-list-page':
      $form['#validate'][] = 'custom_section_wise_validate';
      break;
  }

  if (isset($form['#info']['filter-shs_term_node_tid_depth']) && !empty($form['#info']['filter-shs_term_node_tid_depth'])) {
    $form['#info']['filter-shs_term_node_tid_depth']['label'] = 'Section';
  }
}

/**
 * {@inheritdoc}
 */
function custom_section_wise_validate($form, &$form_state) {
  if ($form_state['values']['category_tid'] == 'All' && isset($_GET['category_tid'])) {
    form_set_error('category_tid', 'Category is required');
  }
}

/**
 * Function proivides autocomplete URL to widgets.
 * 
 * @param string $type
 * @param boolean $isCondition
 * @param string $custom_type
 * @return string
 */
function autocomplete_for_widgets($type, $isCondition = FALSE, $custom_type = 'breaking_news') {
  $autocomplete = array();
  if (isset($type) && $type != 'All') {
    $autocomplete['title'] = "content-title-list/$type/autocomplete";
    $autocomplete['nid'] = "content-nid-list/$type/autocomplete";
  }
  else {
    // Handle case for big story
    if (!$isCondition) {
      $autocomplete['title'] = "node-list-title/autocomplete";
      $autocomplete['nid'] = "node-list-nid/autocomplete";
    }
    else {
      $autocomplete['title'] = "content-title-list/$custom_type/autocomplete";
      $autocomplete['nid'] = "content-nid-list/$custom_type/autocomplete";
    }
  }
  return $autocomplete;
}

/**
 * Function used to get widget name
 * 
 * {@inheritdoc}
 */
function _get_widget_name($view_name, $page_name) {
  $widget = "";
  // TODO: Use switch-case

  if (($view_name == 'views_form_section_wise_draggable_content_order_page' || $view_name == 'views_form_section_wise_content_ordering_list_page') && $page_name == 'page') {
    $widget = 'section_wise_widget';
  }
  else if ($page_name == 'we_may_suggest_widget') {
    $widget = 'we_may_suggest_widget';
  }
  else if ($page_name == 'most_popular_widget') {
    $widget = 'we_may_suggest_widget';
  }
  else if ($page_name == 'big_story_format') {
    $widget = 'big_story_format_widget';
  }
  else if ($page_name == 'photo_carousel_list') {
    $widget = 'photo_carousel_list_widget';
  }
  else if ($page_name == 'video_carousel_list') {
    $widget = 'video_carousel_list_widget';
  }
  else if ($page_name == 'dont_miss_content') {
    $widget = 'dont_miss_content_widget';
  }
  return $widget;
}

/**
 * Implements hook_views_api().
 *
 * This tells drupal that there is Views integration file named
 * itg_social_media.views.inc.
 *
 * {@inheritdoc}
 */
function itg_widget_views_api() {
  return array(
      'api' => 3,
      'path' => drupal_get_path('module', 'itg_widget') . '/includes/views',
  );
}

/**
 * Implementation of hook_views_query_alter
 * {@inheritdoc}
 */
function itg_widget_views_query_alter(&$view, &$query) {
  global $user;
  if ($view->name == 'section_wise_draggable_content_order' && $view->current_display == 'big_story_format' && $_GET['type'] == 'story') {
    unset($query->table_queue['field_data_field_type']);
    unset($query->tables['node']['field_data_field_type']);
    unset($query->where[1]['conditions'][2]);
  }
  if ($view->name == 'programmes' && ($view->current_display == 'page' || $view->current_display == 'rhs_programmes')) {
    $program_cat_value = variable_get('program_category_id_for_programmes');
    if (strlen($program_cat_value) <= 0) {
      // Link should display only adminstrator.
      if (in_array('administrator', $user->roles)) {
        $link = l("click here", 'admin/settings/custom-variables');
      }
      drupal_set_message("Program category setting not found $link", "error");
    }
    $program_where_condition = array(
        'field' => 'taxonomy_term_hierarchy.parent',
        'value' => $program_cat_value,
        'operator' => '=',
    );
    array_push($query->where[1]['conditions'], $program_where_condition);
  }

  if ($view->name == 'so_sorry' && $view->current_display == 'so_sorry_page') {

    // Handling the query if other videos are clicked but those are not feature.
    // But they are in itg_widget_order table as well as widget value is equal to so_sorry_widget
    $arg = arg();
    if (isset($arg[1])) {
      unset($query->where[1]['conditions'][1]);
    }
  }
}

/**
 * Function for returning node queue id by node queue machine name.
 *
 * @param string $form
 */
function get_nodequeue_load_queue_by_name($qname) {
  try {
    $node_queue_object = nodequeue_load_queue_by_name($qname);
    return isset($node_queue_object->qid) ? $node_queue_object->qid : null;
  } catch (Exception $e) {
    watchdog('Node Queue Error/Warning', 'There is some error while accessing node queue');
  }
}

/**
 * Callback function for anchor name autocomplete.
 * 
 * @param string $string keyword for auto suggest.
 * @return json Autocomplete callback for category manager view
 */
function itg_widget_anchor_autocomplete_name($string) {
  $itg_query = db_select('node', 'n');
  $itg_query->leftJoin('field_data_field_celebrity_pro_occupation', 'occuptoin', 'occuptoin.entity_id=n.nid');
  $itg_query->condition('occuptoin.field_celebrity_pro_occupation_tid', '399');
  $itg_query->condition('n.title', '%' . $string . '%', 'LIKE')
          ->fields('n', array('title'));
  $itg_result = $itg_query->execute();
  $result = array();
  foreach ($itg_result as $value) {
    $result[$value->title] = $value->title;
  }
  return drupal_json_output($result);
}

/**
 * Callback function for anchor name autocomplete.
 * 
 * @param string $string keyword for auto suggest.
 * @return json Autocomplete callback for category manager view
 */
function itg_widget_anchor_autocomplete_id($string) {
  $itg_query = db_select('node', 'n');
  $itg_query->leftJoin('field_data_field_celebrity_pro_occupation', 'occuptoin', 'occuptoin.entity_id=n.nid');
  $itg_query->condition('occuptoin.field_celebrity_pro_occupation_tid', '399');
  $itg_query->condition('n.nid', '%' . $string . '%', 'LIKE')
          ->fields('n', array('nid'));
  $itg_result = $itg_query->execute();
  $result = array();
  foreach ($itg_result as $value) {
    $result[$value->nid] = $value->nid;
  }
  return drupal_json_output($result);
}

/**
 * Hook is used to add unique class to only widgets view wrapper.
 * 
 * Implementation of hook_preprocess_views_view
 * {@inheritdoc}
 */
function itg_widget_preprocess_views_view(&$vars) {
  $view_name = $vars['view']->name;
  $widget_views = array(
      'widget_anchors_listing',
      'home_page_feature_widget',
      'story_widget',
      'section_wise_content_ordering_list',
      'section_wise_draggable_content_order',
      'photo_carousel_widget',
      'so_sorry',
  );
  if (in_array($view_name, $widget_views)) {
    $vars['classes_array'][] = 'widgets-view';
  }
}

/**
 * Function for theme suggestion.
 * 
 * {@inheritdoc}
 */
function itg_widget_preprocess_node(&$vars) {
  if ($vars['type'] == 'reporter' && ($vars['field_celebrity_pro_occupation'][0]['taxonomy_term']->name == 'Anchor')) {

    drupal_add_js(
            "jQuery(document).ready(function(){
              jQuery('.read-more , .full-content').click(function(){
                jQuery('.less-content').toggle();
                jQuery('.full-content').toggle();
              });
            })", 'inline'
    );
    $vars['theme_hook_suggestions'][] = 'node__reporter__anchor';
  }
}

/**
 * Get data from nodequeue, if data doesn't exist in draggable view
 * 
 * @param string $nodequeue_name
 * @return array
 */
function itg_widget_nodes_from_nodequeue($nodequeue_name, $is_dont_expire = FALSE, $min_range, $max_range) {
  $today = date('Y-m-d 00:00:00');
  $nodequeue_id = get_nodequeue_load_queue_by_name($nodequeue_name);
  $nq_query = db_select('nodequeue_nodes', 'nq');
  $nq_query->leftJoin('node', 'n', 'n.nid=nq.nid');
  if (!$is_dont_expire) {
    $nq_query->leftJoin('field_data_field_story_expiry_date', 'fsed', 'fsed.entity_id=n.nid');
    $nq_query->condition('fsed.field_story_expiry_date_value', $today, '>=');
  }
  $nq_query->condition('nq.qid', $nodequeue_id);
  $nq_query->condition('n.status', '1');
  $nq_query->addField('nq', 'nid', 'entity_id');
  $nq_query->orderBy('n.nid', 'DESC');
  $nq_query->range($min_range, $max_range);
  return $nq_query->execute()->fetchAll(PDO::FETCH_ASSOC);
}

/**
 * Implements function for anchor landing menu
 */
function itg_widget_anchor_landing_menu($nid) {
  // Query to get category in which anchor is associated.
  $cat_query = db_select('field_data_field_video_anchor', 'video_anchor');
  $cat_query->leftJoin('field_data_field_story_category', 'cat', 'video_anchor.entity_id = cat.entity_id');
  $cat_query->leftJoin('taxonomy_term_data', 'ttd', 'ttd.tid=cat.field_story_category_tid');
  $cat_query->fields('cat', array('field_story_category_tid'));
  $cat_query->distinct('cat.field_story_category_tid');
  $cat_query->fields('ttd', array('name'));
  $cat_query->condition('video_anchor.field_video_anchor_target_id', $nid, '=');
  $cat_query->condition('cat.bundle', 'videogallery', '=');
  $categories_of_anchor = $cat_query->execute();
  foreach ($categories_of_anchor as $cate) {
    $result[$cate->field_story_category_tid] = $cate->name;
  }
  return $result;
}

/**
 * {@inheritdoc}
 */
function itg_widget_node_view($node, $view_mode, $langcode) {
  if ($node->type == 'reporter' && drupal_is_front_page() == FALSE) {
    $cat_array = itg_widget_anchor_landing_menu(arg(1));
    $first_key = key($cat_array);
    // Category view on landing page
    drupal_add_js("jQuery('.anchor-detail-menu .tab-buttons span').click(function(){
               var section_id = jQuery(this).attr('value');
               jQuery('.anchor-detail-menu .tab-buttons span a').removeClass('active');
               jQuery('#edit-field-story-category-tid').val(section_id); 
               jQuery('#edit-field-story-category-tid').trigger('change');
               jQuery(this).find('a').addClass('active');
           });", array('type' => 'inline', 'scope' => 'footer'));
    drupal_add_js("jQuery(document).ready(function(){
               jQuery('#edit-field-story-category-tid').val(" . $first_key . "); 
               jQuery('#edit-field-story-category-tid').trigger('change');
               jQuery('.anchor-detail-menu .tab-buttons span').each(function() {
                  if(jQuery(this).attr('value') == " . $first_key . "){
                      jQuery(this).addClass('active');
                    }
              });
           });", array('type' => 'inline', 'scope' => 'footer'));
  }
}

/**
 * Comman function for all the widgets for getting the widgets nodeids
 * 
 * @param string $view_name
 * @param string $page
 * @param string $expire_date
 * @param int $range_min
 * @param int $range_max
 * @return array
 */
function draggable_views_nodes_for_widgets($view_name, $page, $expire_date, $range_min = 0, $range_max) {
  if (!empty($view_name) && !empty($page) && !empty($expire_date) && !empty($range_max) && !empty($range_max)) {
    $query = db_select('draggableviews_structure', 'dv_s');
    $query->leftJoin('node', 'n', 'n.nid=dv_s.entity_id');
    if ($expire_date != "NOT") {
      $query->leftJoin('field_data_field_story_expiry_date', 'fsed', 'fsed.entity_id=n.nid');
      $query->fields('fsed', array('field_story_expiry_date_value'));
    }
    $query->fields('dv_s', array('entity_id'));
    $query->condition('dv_s.view_name', $view_name);
    $query->condition('dv_s.view_display', $page);
    $query->condition('n.status', '1');
    if ($expire_date != "NOT") {
      $query->condition('fsed.field_story_expiry_date_value', $expire_date, '>=');
    }
    $query->orderBy('dv_s.weight', 'ASC');
    $query->groupBy('dv_s.entity_id');
    $query->range($range_min, $range_max);
    return $query->execute()->fetchAll(PDO::FETCH_ASSOC);
  }
}

/**
 * Function returns data for cutom tables widgets.
 * 
 * @param string $widget_name
 * @param int $range_max
 * @param int $range_min
 * @return array
 */
function get_view_nodes_form_custom_table_for_widgets($widget_name, $range_max, $range_min = 0) {
  $query = db_select('itg_widget_order', 'iwo');
  $query->leftJoin('node', 'n', 'n.nid=iwo.nid');
  $query->condition('iwo.widget', $widget_name)
          ->condition('n.status', 1)
          ->orderBy('iwo.weight', 'ASC')
          ->range($range_min, $range_max)
          ->fields('iwo', array('nid', 'extra', 'weight'));
  $result = $query->execute()->fetchAll(PDO::FETCH_ASSOC);
  $weight = 0;
  foreach ($result as $data) {
    $weight +=$data['weight'];
  }

  if ($weight > 0) {
    return $result;
  }
  else {
    // Query for renctaly careated node if weight is not saved
    $query = db_select('itg_widget_order', 'iwo');
    $query->leftJoin('node', 'n', 'n.nid=iwo.nid');
    $query->condition('iwo.widget', $widget_name)
            ->condition('n.status', 1)
            ->orderBy('n.nid', 'DESC')
            ->range($range_min, $range_max)
            ->fields('iwo', array('nid', 'extra', 'weight'));
    $result = $query->execute()->fetchAll(PDO::FETCH_ASSOC);
    return $result;
  }
}

/**
 * {@inheritdoc}
 */
function itg_widget_block_view_alter(&$data, $block) {
  $item = menu_get_item();
  if ($block->delta == 'programmes-rhs_programmes') {
    $page_argument = $item['page_arguments'];
    if ($page_argument[0]->field_celebrity_pro_occupation['und'][0]['taxonomy_term']->name != 'Anchor' && arg(0) == 'node') {
      $data['content'] = array();
    }
  }
}

/**
 * Callback function for widget title autocomplete.
 * 
 * @param string $string keyword for auto suggest.
 * @return json Autocomplete callback for category manager view
 */
function itg_widget_all_content_title($title) {
  if (strlen(trim($title)) > 0) {
    $options = array();
    $title = strtolower(trim($title));
    $query = db_select('node', 'n');
    $query->fields('n', array('title'));
    $query->condition('n. title', '%' . $title . '%', 'LIKE');
    $query->condition('n.type', array('story', 'videogallery', 'photogallery'), 'IN');
    $query->condition('n.status', 1);
    $query->range(0, 20);
    $result = $query->execute();

    while ($record = $result->fetchAssoc()) {
      $options[$record['title']] = $record['title'];
    }

    drupal_json_output($options);
  }
}

/**
 * Callback function for widget title autocomplete.
 * 
 * @param string $string keyword for auto suggest.
 * @return json Autocomplete callback for category manager view
 */
function itg_widget_so_sorry_content_title($title) {
  if (strlen(trim($title)) > 0) {
    $options = array();
    $so_sorry_cat = variable_get('so_sorry_category_id_for_widget');
    $title = strtolower(trim($title));
    $query = db_select('node', 'n');
    $query->leftJoin('field_data_field_story_category', 'cat', 'cat.entity_id=n.nid');
    $query->fields('n', array('title'));
    $query->condition('cat.field_story_category_tid', $so_sorry_cat);
    $query->condition('n. title', '%' . $title . '%', 'LIKE');
    $query->condition('n.type', array('story', 'videogallery', 'photogallery'), 'IN');
    $query->condition('n.status', 1);
    $query->range(0, 20);
    $result = $query->execute();

    while ($record = $result->fetchAssoc()) {
      $options[$record['title']] = $record['title'];
    }

    drupal_json_output($options);
  }
}

/**
 * Callback function for widget title autocomplete.
 * 
 * @param string $string keyword for auto suggest.
 * @return json Autocomplete callback for category manager view
 */
function itg_widget_all_content_nid($title) {
  if (strlen(trim($title)) > 0) {
    $options = array();
    $title = strtolower(trim($title));
    $query = db_select('node', 'n');
    $query->fields('n', array('nid'));
    $query->condition('n. nid', '%' . $title . '%', 'LIKE');
    $query->condition('n.type', array('story', 'videogallery', 'photogallery'), 'IN');
    $query->condition('n.status', 1);
    $query->range(0, 20);
    $result = $query->execute();

    while ($record = $result->fetchAssoc()) {
      $options[$record['nid']] = $record['nid'];
    }

    drupal_json_output($options);
  }
}

/**
 * Callback function for widget title autocomplete.
 * 
 * @param string $string keyword for auto suggest.
 * @return json Autocomplete callback for category manager view
 */
function itg_widget_so_sorry_content_nid($title) {
  if (strlen(trim($title)) > 0) {
    $options = array();
    $so_sorry_cat = variable_get('so_sorry_category_id_for_widget');
    $title = strtolower(trim($title));
    $query = db_select('node', 'n');
    $query->leftJoin('field_data_field_story_category', 'cat', 'cat.entity_id=n.nid');
    $query->fields('n', array('nid'));
    $query->condition('cat.field_story_category_tid', $so_sorry_cat);
    $query->condition('n. nid', '%' . $title . '%', 'LIKE');
    $query->condition('n.type', array('story', 'videogallery', 'photogallery'), 'IN');
    $query->condition('n.status', 1);
    $query->range(0, 20);
    $result = $query->execute();

    while ($record = $result->fetchAssoc()) {
      $options[$record['nid']] = $record['nid'];
    }

    drupal_json_output($options);
  }
}

/*
 * This will return selected poll for widget
 */

function get_homepage_current_poll_widget($content_type, $widget_name) {
  $nodes_already = db_select('itg_widget_order', 'iwo')
                  ->condition('iwo.content_type', $content_type)
                  ->condition('iwo.widget', $widget_name)
                  ->fields('iwo', array('nid'))
                  ->execute()->fetch();
  return $nodes_already->nid;
}

/**
 * This mentod will return a poll widget for against poll nid, used in home page widget 
 * @param type $nid
 */
function itg_poll_home_page_polls_select($nid) {

  $node = node_load($nid);
  $poll_banner_image = '';
  if (isset($node->field_poll_banner[$node->language][0]['uri']) && !empty($node->field_poll_banner[$node->language][0]['uri'])) {
    $poll_banner_image = theme('image_style', array('style_name' => 'home_page_poll_images_style', 'path' => $node->field_poll_banner[$node->language][0]['uri']));
  }
  else {
    $poll_banner_image = '';
  }

  $poll_image_exist_class = '';

  foreach ($node->field_poll_answer['und'] as $row) {
    $item_id[] = $row['value']; // fieldcollection id
  }
  // instant or after complete

  $fieldcollect = entity_load('field_collection_item', $item_id);
  if (is_array($fieldcollect) && count($fieldcollect) > 0) {
    $temp_ent = array_shift(array_slice($fieldcollect, 0, 1));
    $poll_answer_image = isset($temp_ent->field_poll_answer_image[LANGUAGE_NONE]) ? $temp_ent->field_poll_answer_image[LANGUAGE_NONE][0]['fid'] : '';
    if (isset($poll_answer_image) && $poll_answer_image > 0) {
      $poll_image_exist_class = 'poll-option-image';
    }
    else {
      $poll_image_exist_class = '';
    }
  }


  $polls_info['poll_banner_image'] = $poll_banner_image;
  $polls_info['nid'] = $nid;
  $polls_info['title'] = $node->title;
  $polls_info['updated'] = t('Updated: ') . date('M d Y H:i', $node->changed);
  $polls_info['poll_image_exist_class'] = $poll_image_exist_class;

  return theme('itg_poll_homepage_forms', array('data' => $polls_info));
}

/**
 * Implements hook_form().
 * {@inheritdoc}
 * @param array $form
 * @param array $form_state
 */
function itg_widget_issuewidget_filter_form($form, $form_state) {
  $options = array();
  $options[''] = 'Select';
  $query = db_select('node', 'n');
  $query->fields('n', array('title'));
  $query->condition('n.type', array('issue'), '=');
  $query->condition('n.status', 1);
  $result = $query->execute();
  while ($record = $result->fetchAssoc()) {
    $options[date('Y-m-d', strtotime($record['title']))] = date('d/m/Y', strtotime($record['title']));
  }

  $form['content_title'] = array(
      '#title' => t('Content Title'),
      '#type' => 'select',
      '#default_value' => $_GET['field_story_issue_date_value']['value']['date'],
      '#options' => $options,
  );
  $form['items_per_page'] = array(
      '#title' => t('Items per page '),
      '#type' => 'select',
      '#default_value' => ($_GET['items_per_page']) ? $_GET['items_per_page'] : 20,
      '#options' => array(5 => 5, 10 => 10, 20 => 20, 40 => 40, 60 => 60),
  );
  $form['alt_button'] = array(
      '#type' => 'submit',
      '#value' => t('Apply'),
  );
  $form['filters']['buttons']['reset'] = array('#type' => 'submit', '#value' => t('Reset'), '#submit' => array('itg_widget_issuewidget_filter_reset'),);




  return $form;
}

/**
 * This mentod will go to issue widget filter url
 * 
 * @param array $form
 * @param array $form_state
 */
function itg_widget_issuewidget_filter_form_submit($form, $form_state) {

  $query = array('field_story_issue_date_value[value][date]' => $form_state['values']['content_title'], 'items_per_page' => $form_state['values']['items_per_page']);
  drupal_goto('issue-base-magazin-widget', array('query' => $query));
}

/**
 * This mentod will go to issue widget list page after rest
 * 
 * @param array $form
 * @param array $form_state
 */
function itg_widget_issuewidget_filter_reset($form, $form_state) {

  drupal_goto('issue-base-magazin-widget');
}

/**
 * Implements hook_form().
 * {@inheritdoc}
 * @param array $form
 * @param array $form_state
 */
function itg_widget_issuewidgetlist_filter_form($form, $form_state) {
  $options = array();
  $options[''] = 'Select';
  $query = db_select('node', 'n');
  $query->fields('n', array('title'));
  $query->condition('n.type', array('issue'), '=');
  $query->condition('n.status', 1);
  $result = $query->execute();
  while ($record = $result->fetchAssoc()) {
    $options[date('Y-m-d', strtotime($record['title']))] = date('d/m/Y', strtotime($record['title']));
  }

  $form['content_title'] = array(
      '#title' => t('Content Title'),
      '#type' => 'select',
      '#default_value' => $_GET['field_story_issue_date_value']['value']['date'],
      '#options' => $options,
  );
  $form['items_per_page'] = array(
      '#title' => t('Items per page '),
      '#type' => 'select',
      '#default_value' => ($_GET['items_per_page']) ? $_GET['items_per_page'] : 20,
      '#options' => array(5 => 5, 10 => 10, 20 => 20, 40 => 40, 60 => 60),
  );
  $form['alt_button'] = array(
      '#type' => 'submit',
      '#value' => t('Apply'),
  );
  $form['filters']['buttons']['reset'] = array('#type' => 'submit', '#value' => t('Reset'), '#submit' => array('itg_widget_issuewidgetlist_filter_reset'),);




  return $form;
}

/**
 * This mentod will go to added issue widget list filter url
 * 
 * @param array $form
 * @param array $form_state
 */
function itg_widget_issuewidgetlist_filter_form_submit($form, $form_state) {

  $query = array('field_story_issue_date_value[value][date]' => $form_state['values']['content_title'], 'items_per_page' => $form_state['values']['items_per_page']);
  drupal_goto('issue-magazin-widget-list', array('query' => $query));
}

/**
 * This mentod will go to added issue widget list page after rest
 * 
 * @param array $form
 * @param array $form_state
 */
function itg_widget_issuewidgetlist_filter_reset($form, $form_state) {

  drupal_goto('issue-magazin-widget-list');
}
