<?php

/**
 * @file
 * itg_widget.module
 *
 * Provides customizations and functions for Widgets.
 *
 */
module_load_include('inc', 'nodequeue_generate', 'nodequeue.actions');

/**
 * {@inheritdoc}
 */
function itg_widget_init() {
    
}

/**
 * {@inheritdoc}
 */
function itg_widget_menu() {
    $items = array();
    $items['remove_from_widgets/%/%/%/%'] = array(
        'page callback' => 'remove_from_widgets',
        'page arguments' => array(1, 2, 3, 4),
        'access arguments' => array('administer nodequeue'),
    );
    $items['remove_from_widgets_section/%/%/%/%/%/%'] = array(
        'page callback' => 'remove_from_widgets_with_section',
        'page arguments' => array(1, 2, 3, 4, 5, 6),
        'access arguments' => array('administer nodequeue'),
    );
    $items['move-widget-node/%/%/%/%'] = array(
        'page callback' => 'move_node_from_widget',
        'page arguments' => array(1, 2, 3, 4),
        'access arguments' => array('administer nodequeue'),
    );
    return $items;
}

/**
 * Funtion used to delete node combination form itg_widget_order table.
 * 
 * @param string $widget_name
 * @param string $content_type
 * @param int $cat_tid
 * @param int $nid
 */
function move_node_from_widget($widget_name, $content_type, $cat_tid, $nid) {
    if (!empty($widget_name) && !empty($content_type) && !empty($cat_tid) && !empty($nid)) {
        $num = db_delete('itg_widget_order')
                ->condition('nid', $nid)
                ->condition('content_type', $content_type)
                ->condition('cat_id', $cat_tid)
                ->condition('widget', $widget_name)
                ->execute();
        if ($num) {
            drupal_set_message("Node has been moved");
            drupal_goto($_SERVER['HTTP_REFERER']);
        }
    }
}

/**
 * Function used for delete node from draggableviews_structure and nodequeue
 * @param int $nid
 * @param int $qid
 * @param string $view_name
 * @param string $page_name
 */
function remove_from_widgets_with_section($nid, $qid, $view_name, $page_name, $section_tid, $type) {
    $draggable_delete = draggable_view_node_delete_section($view_name, $page_name, $nid, $section_tid, $type);
    if ($draggable_delete) {
        nodequeue_subqueue_remove_node($qid, $nid);
        print "deleted";
    }
    else {
        print "notdeleted";
    }
}

/**
 * Function used to delete form draggableviews_structure table
 * @param string $view_name
 * @param string $page_name
 * @param int $nid
 * @return int
 */
function draggable_view_node_delete_section($view_name, $page_name, $nid, $section_tid, $type) {
    if (!empty($view_name) && !empty($page_name) && !empty($nid) && !empty($section_tid) && !empty($type)) {
        $args = '{"field_story_category_tid":"' . $section_tid . '","type":"' . $type . '"}';
        $num_deleted = db_delete('draggableviews_structure')
                ->condition('view_name', $view_name)
                ->condition('view_display', $page_name)
                ->condition('entity_id', $nid)
                ->condition('args', $args)
                ->execute();
        return $num_deleted;
    }
}

/**
 * Function used for delete node from draggableviews_structure and nodequeue
 * @param int $nid
 * @param int $qid
 * @param string $view_name
 * @param string $page_name
 */
function remove_from_widgets($nid, $qid, $view_name, $page_name) {
    $draggable_delete = draggable_view_node_delete($view_name, $page_name, $nid);
    if ($draggable_delete) {
        nodequeue_subqueue_remove_node($qid, $nid);
        print "deleted";
    }
    else {
        print "notdeleted";
    }
}

/**
 * Function used to delete form draggableviews_structure table
 * @param string $view_name
 * @param string $page_name
 * @param int $nid
 * @return int
 */
function draggable_view_node_delete($view_name, $page_name, $nid) {
    if (!empty($view_name) && !empty($page_name) && !empty($nid)) {
        $num_deleted = db_delete('draggableviews_structure')
                ->condition('view_name', $view_name)
                ->condition('view_display', $page_name)
                ->condition('entity_id', $nid)
                ->execute();
        return $num_deleted;
    }
}

/**
 * {@inheritdoc}
 */
function itg_widget_block_info() {
    $blocks['section_ordering'] = array(
        'info' => t('Widget: Section Ordering'),
    );
    $blocks['top_stories_ordering'] = array(
        'info' => t('Widget: Top Stories Ordering'),
    );
    $blocks['home_page_feature'] = array(
        'info' => t('Widget: Home Page Feature'),
    );
    $blocks['we_may_suggest'] = array(
        'info' => t('Widget: We May Suggest'),
    );
    $blocks['section_wise_order'] = array(
        'info' => t('Widget: Section wise ordering form custom table'),
    );
    return $blocks;
}

/**
 * {@inheritdoc}
 */
function itg_widget_block_view($delta = '') {
    $block = array();
    switch ($delta) {
        // section ordering reordering widget case
        case 'section_wise_order':
            module_load_include('inc', 'itg_widget', 'includes/section-wise-order-from-custom-table');
            // value is hardcoded need to be change for dyanamic functionality
            $info['section'] = '301'; // tid of section
            $info['content_type'] = 'story'; // content type machine name
            // view name which is stored in draggableviews_structure table
            $info['view_name'] = 'views_form_section_wise_content_ordering_list_page';
            $block['subject'] = t('Section wise ordering from custom table');
            $data = itg_widget_section_wise_ordering_from_custom_table($info);
            $block['content'] = theme("section_wise_ordering", array("data" => $data));
            break;
        // section ordering reordering widget case
        case 'section_ordering':
            module_load_include('inc', 'itg_widget', 'includes/section-odering');
            // value is hardcoded need to be change for dyanamic functionality
            $info['section'] = '301'; // tid of section
            $info['content_type'] = 'story'; // content type machine name
            // view name which is stored in draggableviews_structure table
            $info['view_name'] = 'section_wise_content_ordering';
            $block['subject'] = t('Section Ordering');
            $data = itg_widget_section_ordering_data($info);
            $block['content'] = theme("section_ordering", array("data" => $data));
            break;
        case 'we_may_suggest':
            module_load_include('inc', 'itg_widget', 'includes/we-may-suggest');
            $info['section'] = '240'; // tid of section
            $info['content_type'] = 'story'; // content type machine name
            $info['view_name'] = 'we_may_suggest';
            $block['subject'] = t('We may suggest');
            $data = itg_widget_we_may_suggest_data($info);
            $block['content'] = theme("we_may_suggest", array("data" => $data));
            break;
        // Top story ordering reordering widget case
        case 'top_stories_ordering':
            module_load_include('inc', 'itg_widget', 'includes/section-odering');
            $info['view_name'] = 'story_widget'; // view name
            $info['page'] = 'page_2'; // page name
            $data = itg_widget_top_stories_ordering_data($info);
            $block['content'] = theme("top_stories_ordering", array("data" => $data));
            break;
        // home page feature ordering reordering widget case
        case 'home_page_feature':
            module_load_include('inc', 'itg_widget', 'includes/home-page-feature');
            $info['view_name'] = 'home_page_feature_widget'; // view name
            $info['page'] = 'page_2'; // page name
            $data = itg_widget_home_page_feature_data($info);
            $block['content'] = theme("home_page_feature", array("data" => $data));
            break;
    }
    return $block;
}

/**
 * {@inheritdoc}
 */
function itg_widget_form_alter(&$form, &$form_state, $form_id) {
    $setting = array();
    $queue_flag = "";
    $view_name = isset($form_state['view']->name) ? $form_state['view']->name : "";
    /* Load all nodes queues */
    $queues = nodequeue_load_queues(nodequeue_get_all_qids());
    switch ($view_name) {
        // top story
        case 'story_widget':
            watchdog("Widget", "Nodequeue bulk operation settings has been found for : top story");
            $queue_flag = 1; // top story widget qid
            break;
        // home page feature
        case 'home_page_feature_widget':
            watchdog("Widget", "Nodequeue bulk operation settings has been found for : home page feature");
            $queue_flag = 2; // home page feature qid
            break;
        // We may suggest
        case 'we_may_suggest':
            watchdog("Widget", "Nodequeue bulk operation settings has been found for : we may suggest");
            $queue_flag = 3; // home page feature qid
            break;
    }
    if (!empty($queues[$queue_flag])) {
        watchdog("Widget", "setting sent to js");
        // name of nodequeue
        $setting['name'] = $queues[$queue_flag]->name;
        // qid of nodeduque
        $setting['qid'] = $queues[$queue_flag]->qid;
        // title of nodequeue
        $setting['title'] = $queues[$queue_flag]->title;
        // add js for setting
        drupal_add_js(drupal_get_path('module', 'itg_widget') . '/js/itg_widget.main.js', 'file');
        // pass setting to js for bulk operation
        drupal_add_js(array('itg_widget' => array('data' => $setting)), 'setting');
    }
}

/**
 * {@inheritdoc}
 */
function itg_widget_views_bulk_operations_form_alter(&$form, &$form_state, $vbo) {
    
}

/**
 * {@inheritdoc}
 */
function itg_widget_views_pre_render(&$view) {
    if ($view->name == "story_widget" && $view->current_display == 'page_2') {
        $header_content = '<span class="count">Count (' . $view->total_rows . ') </span>';
        $header_content .= l(t('Search Content'), 'story-list-widget', array('query' => array('destination' => arg(0))));
        $view->attachment_before = $header_content;
    }
    elseif ($view->name == "story_widget" && $view->current_display == 'page_1') {
        $header_content = '<span class="count">Count (' . $view->total_rows . ') </span>';
        $header_content .= l(t('Back To Top Stories'), 'story-list-widget-listing');
        $view->attachment_before = $header_content;
    }
    elseif ($view->name == "home_page_feature_widget" && $view->current_display == 'page_2') {
        $header_content = '<span class="count">Count (' . $view->total_rows . ') </span>';
        $header_content .= l(t('Search Content'), 'home-page-feature-widget-listing', array('query' => array('destination' => arg(0))));
        $view->attachment_before = $header_content;
    }
    elseif ($view->name == "home_page_feature_widget" && $view->current_display == 'page_1') {
        $header_content = '<span class="count">Count (' . $view->total_rows . ') </span>';
        $header_content .= l(t('Back to home page feature'), 'home-page-feature-widget');
        $view->attachment_before = $header_content;
    }
    elseif ($view->name == "we_may_suggest" && $view->current_display == 'page_2') {
        $header_content = '<span class="count">Count (' . $view->total_rows . ') </span>';
        $header_content .= l(t('Search Content'), 'we-may-suggest-widget', array('query' => array('destination' => arg(0))));
        $view->attachment_before = $header_content;
    }
    elseif ($view->name == "section_wise_draggable_content_order" && $view->current_display == 'page') {
        $header_content = '<span class="count">Count (' . $view->total_rows . ') </span>';
        $header_content .= l(t('Back to Section Ordering Widget'), 'section-wise-content-ordering-list', array('query' => array('destination' => arg(0))));
        $view->attachment_before = $header_content;
    }
    elseif ($view->name == "section_wise_content_ordering_list" && $view->current_display == 'page') {
        $header_content = '<span class="count">Count (' . $view->total_rows . ') </span>';
        $header_content .= l(t('Search Content'), 'section-wise-draggable-content-order');
        $view->attachment_before = $header_content;
    }
}

/**
 * {@inheritdoc}
 */
function itg_widget_theme() {
    $themes = array(
        'section_wise_ordering' => array(
            'template' => 'templates/section-wise-ordering',
        ),
        'section_ordering' => array(
            'template' => 'templates/section-ordering-data',
        ),
        'top_stories_ordering' => array(
            'template' => 'templates/top-stories-ordering-data',
        ),
        'home_page_feature' => array(
            'template' => 'templates/home-page-feature',
        ),
        'we_may_suggest' => array(
            'template' => 'templates/we-may-suggest',
        ),
    );
    return $themes;
}

/**
 * {@inheritdoc}
 */
function get_required_data_from_entity_id($entity_id) {
    return entity_load('node', array($entity_id));
}

/**
 * {@inheritdoc}
 */
function itg_widget_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
    switch ($form['#id']) {
        case 'views-exposed-form-home-page-feature-widget-page-1':
            $form['title']['#attributes'] = array(
                'placeholder' => t('Title')
            );
            $form['nid']['#attributes'] = array(
                'placeholder' => t('ID')
            );
            break;
        case 'views-exposed-form-story-widget-page-1':
            $form['title']['#attributes'] = array(
                'placeholder' => t('Story Title')
            );
            $form['nid']['#attributes'] = array(
                'placeholder' => t('Story ID')
            );
            break;
    }
}

/**
 * {@inheritdoc}
 */
function itg_widget_action_info() {
    return array(
        'itg_widget_categories_wise_node_group' => array(
            'type' => 'entity',
            'label' => t('Add nodes by category wise'),
            //'behavior' => array('changes_property'),
            'configurable' => TRUE,
            'vbo_configurable' => FALSE,
            'triggers' => array('any'),
        ),
    );
}

/**
 * {@inheritdoc}
 */
function itg_widget_categories_wise_node_group_form($form, &$form_state) {
    $form = array();
    $view_name = $form_state['build_info']['args'][0]->name;
    $widget = _get_widget_name("views_form_" . $view_name . "_page");
    $form['widget_name'] = array(
        '#type' => 'select',
        '#title' => t("Widget ($widget)"),
        '#options' => array("$widget" => "widget"),
        '#weight' => -1,
    );
    return $form;
}

/**
 * {@inheritdoc}
 */
function itg_widget_categories_wise_node_group_submit($form, &$form_state) {
    $view_name = $form['#form_id'];
    $widget = _get_widget_name($view_name);
    $vals = array();
    $node_to_be_insert = array();
    // Unique combination using below four.
    $widget_name = $form_state['input']['widget_name'];
    // Get selected nodes ids
    $selected_node_data = $form_state['selection'];
    $cat_id = $_GET['category_tid'];
    $content_type = $_GET['type'];
    // Logic to skip nodes which are already in itg_widget_order table
    $nodes_already = db_select('itg_widget_order', 'iwo')
            ->condition('iwo.content_type', $content_type)
            ->condition('iwo.widget', $widget_name)
            ->condition('iwo.cat_id', $cat_id)
            ->fields('iwo', array('nid'))
            ->execute();
    foreach ($nodes_already as $val) {
        $vals[] = $val->nid;
    }
    // Remove nodes which are already in itg_widget_order table with combination of content type , widget name , cat_id , nid.
    foreach ($selected_node_data as $key => $node_data) {
        if (in_array($node_data, $vals)) {
            unset($selected_node_data[$key]);
        }
    }

    if (count($selected_node_data)) {
        foreach ($selected_node_data as $node) {
            $nid = db_insert('itg_widget_order')
                    ->fields(array(
                        'nid' => $node,
                        'widget' => $widget,
                        'content_type' => $content_type,
                        'cat_id' => $cat_id,
                        'weight' => 0,
                    ))
                    ->execute();
        }
        drupal_set_message("Nodes has been saved");
    }
    else {
        drupal_set_message("Selected nodes allready in ordering section");
    }
}

/**
 * Function used to get widget name
 * 
 * {@inheritdoc}
 */
function _get_widget_name($view_name) {
    $widget = "";
    if ($view_name == 'views_form_section_wise_draggable_content_order_page' || $view_name == 'views_form_section_wise_content_ordering_list_page') {
        $widget = 'section_wise_widget';
    }
    return $widget;
}

/**
 * Implements hook_views_api().
 *
 * This tells drupal that there is Views integration file named
 * itg_social_media.views.inc.
 *
 * {@inheritdoc}
 */
function itg_widget_views_api() {
    return array(
        'api' => 3,
        'path' => drupal_get_path('module', 'itg_widget') . '/includes/views',
    );
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * {@inheritdoc}
 */
function itg_widget_form_views_form_section_wise_content_ordering_list_page_alter(&$form, &$form_state, $form_id) {
    $form['actions']['submit']['#submit'][] = "update_itg_widget_order_table_data";
}

/**
 * Function for save new order in custom table itg_widget_order
 * 
 * @param array $form
 * @param array $form_state
 */
function update_itg_widget_order_table_data($form, &$form_state) {
    // Below view_name will use to get widget name.
    $view_name = $form['form_id']['#value'];
    $widget = _get_widget_name($view_name);
    // Take draggable view input value after submit the form.
    $draggable_view_data = $form_state['input']['draggableviews'];
    // Content type from url.
    $content_type = $_GET['type'];
    // Category tid from url.
    $cat_id = $_GET['category_tid'];
    // If user dont make changes in draggable view then all the weights remain zero.
    // So check is required here. If al weight are 0 then do not execute query w.r.t. into itg_widget_order table.
    $weight_track_flag = FALSE;
    foreach ($draggable_view_data as $key => $node_data) {
        if ($node_data['weight'] > 0) {
            // Found changes in draggable view content
            $weight_track_flag = TRUE;
        }
    }
    // IF we got there is changes made in draggable view order.
    if ($weight_track_flag) {
        watchdog("widget", "Change made in order");
        // Frist delete all the data from itg_widget_order table of combination
        foreach ($draggable_view_data as $key => $node_data) {
            if (!empty($node_data['id']) && !empty($content_type) && !empty($widget) && !empty($cat_id)) {
                $num_deleted = db_delete('itg_widget_order')
                        ->condition('nid', $node_data['id'])
                        ->condition('content_type', $content_type)
                        ->condition('widget', $widget)
                        ->condition('cat_id', $cat_id)
                        ->execute();
                if ($num_deleted) {
                    watchdog("widget", "Delete action has been performed");
                }
            }
        }

        // Now insert new entry in itg_widget_order table of combination
        foreach ($draggable_view_data as $key => $node_data) {
            if (!empty($node_data['id']) && !empty($content_type) && !empty($widget) && !empty($cat_id)) {
                $is_inserted = db_insert('itg_widget_order')
                        ->fields(array(
                            'nid' => $node_data['id'],
                            'widget' => $widget,
                            'content_type' => $content_type,
                            'cat_id' => $cat_id,
                            'weight' => $node_data['weight'],
                        ))
                        ->execute();
                if ($is_inserted) {
                    watchdog("widget", "Insert action has been performed");
                    drupal_set_message("Ordering has been saved.");
                }
            }
        }
    }
    // If there is not chnages found in draggable view order then simply give an message.
    else {
        drupal_set_message("This ordering is already saved.");
    }
}
