<?php

/**
 * @file
 * ITG Widget.
 *
 * Provides customizations and functions for Widgets.
 *
 */
module_load_include('inc', 'nodequeue_generate', 'nodequeue.actions');

/**
 * Hook_init
 */
function itg_widget_init() {
    
}

/**
 * Hook_block_info
 * @return array
 */
function itg_widget_block_info() {
    $blocks['section_ordering'] = array(
        'info' => t('Section Ordering'),
    );
    $blocks['top_stories_ordering'] = array(
        'info' => t('Top Stories ordering'),
    );
    return $blocks;
}

/**
 * Hook_block_view
 * @param string $delta
 * @return array
 */
function itg_widget_block_view($delta = '') {
    module_load_include('inc', 'itg_widget', 'includes/section-odering');
    $block = array();
    switch ($delta) {
        case 'section_ordering':
            $info['section'] = '145'; #tid of section
            $info['content_type'] = 'story'; #content type machine name
            #view name which is stored in draggableviews_structure table
            $info['view_name'] = 'section_wise_content_ordering';
            $block['subject'] = t('Section Ordering');
            $data = itg_widget_section_ordering_data($info);
            $block['content'] = theme("section_ordering", array("data" => $data));
            break;
        case 'top_stories_ordering':
            $info['view_name'] = 'story_widget'; #view name
            $info['page'] = 'page_2'; #page name
            $data = itg_widget_top_stories_ordering_data($info);
            $block['content'] = theme("top_stories_ordering", array("data" => $data));
            break;
    }
    return $block;
}

/**
 * hook_from_alter
 * @param array $form
 * @param array $form_state
 * @param string $form_id
 */
function itg_widget_form_alter(&$form, &$form_state, $form_id) {
    /* Load all nodes queues */
    $queues = nodequeue_load_queues(nodequeue_get_all_qids());
    $setting = 0;
    foreach ($queues as $queue) {
        switch ($queue->name) {
            case 'top_stories':
                $setting = 1;
                break;
        }
    }
    drupal_add_js(drupal_get_path('module', 'itg_widget') . '/js/itg_widget.main.js', 'file');
    drupal_add_js(array('itg_widget' => array('data' => $setting)), 'setting');
}

/**
 * hook_bulk_operations_form_alter
 * @param array $form
 * @param array $form_state
 * @param array $vbo
 */
function itg_widget_views_bulk_operations_form_alter(&$form, &$form_state, $vbo) {
    if ($form_state['step'] == 'views_form_views_form' && $form_state['input']['form_id'] == 'views_form_story_widget_page_1') {
        $setting = 1; // top stories
        drupal_add_js(array('itg_widget' => array('data' => $setting)), 'setting');
    }
}

/**
 * Implements views header link 
 * @param type $view Description
 */
function itg_widget_views_pre_render(&$view) {
    if ($view->name == "story_widget" && $view->current_display == 'page_2') {
        $header_content = '<span class="count">Count (' . $view->total_rows . ') </span>';
        $header_content .= l(t('Search Content'), 'story-list-widget', array('query' => array('destination' => arg(0))));
        $view->attachment_before = $header_content;
    }
}

/**
 * Hook_theme
 * @return array themes
 */
function itg_widget_theme() {
    $themes = array(
        'section_ordering' => array(
            'template' => 'templates/section-ordering-data',
        ),
        'top_stories_ordering' => array(
            'template' => 'templates/top-stories-ordering-data',
        ),
    );
    return $themes;
}
