<?php

/**
 * @file
 * The ITG Best Colleges module.
 *
 * Contains functionality for best college.
 */

/**
 * Implements hook_menu().
 * {@inheritdoc}
 */
function itg_bestcolleges_menu() {
  $items['bestcolleges/ranks/%'] = array(
    'page callback' => 'itg_bestcolleges_deatils',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['bestcolleges/%/emerging/%'] = array(
    'page callback' => 'itg_bestcollege_emerging',
    'page arguments' => array(1, 2, 3),
    'access callback' => TRUE,
  );
  $items['bestcolleges/%/stream-comparecollege/%/%'] = array(
    'page callback' => 'itg_bestcollege_streamcompare',
    'page arguments' => array(1, 2, 3, 4),
    'access callback' => TRUE,
  );
  $items['bestcolleges/%/%/year-comparecollege/%'] = array(
    'page callback' => 'itg_bestcollege_yearcompare',
    'page arguments' => array(1, 2, 3, 4),
    'access callback' => TRUE,
  );
  $items['bestcolleges/%/readyrecnor-directory-list/%'] = array(
    'page callback' => 'itg_readyrecnor_directory_list',
    'page arguments' => array(1, 2, 3),
    'access callback' => TRUE,
  );
  $items['bestcolleges/%/zone-wise-list/%'] = array(
    'page callback' => 'itg_zone_wise_list',
    'page arguments' => array(1, 2, 3),
    'access callback' => TRUE,
  );
  $items['bestcolleges/%/campus-wise-list'] = array(
    'page callback' => 'itg_campus_wise_list',
    'page arguments' => array(1, 2),
    'access callback' => TRUE,
  );
  $items['bestcolleges/%/%/citywise-list/%'] = array(
    'page callback' => 'itg_city_wise_list',
    'page arguments' => array(1, 2, 3, 4),
    'access callback' => TRUE,
  );
  return $items;
}

/**
 * Returns custom content to Drupal
 * @return type
 */
function itg_bestcolleges_deatils() {
  drupal_add_js('http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js', array('type' => 'external'));
  return theme('itg_bestcolleges_template');
}

/**
 * Implements hook_menu().
 * {@inheritdoc}
 */
function itg_bestcolleges_theme($existing, $type, $theme, $path) {
  $themes = array(
    'itg_bestcolleges_template' => array(
      'template' => 'itg-bestcolleges-template',
      'path' => drupal_get_path('module', 'itg_bestcolleges') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'itg_bestcollege_streamwise' => array(
      'variable' => array('data' => NULL),
      'template' => 'itg-bestcollege-streamwise',
      'path' => drupal_get_path('module', 'itg_bestcolleges') . '/templates',
    ),
    'itg_bestcollege_yearwise' => array(
      'variable' => array('data' => NULL),
      'template' => 'itg-bestcollege-yearwise',
      'path' => drupal_get_path('module', 'itg_bestcolleges') . '/templates',
    ),
    'itg_readyrecnor_directory' => array(
      'variable' => array('data' => NULL),
      'template' => 'itg-readyrecnor-directory-listing',
      'path' => drupal_get_path('module', 'itg_bestcolleges') . '/templates',
    ),
    'itg_zone_wise_list' => array(
      'variable' => array('data' => NULL),
      'template' => 'itg-zone-wise-list',
      'path' => drupal_get_path('module', 'itg_bestcolleges') . '/templates',
    ),
    'itg_campus_wise_list' => array(
      'variable' => array('data' => NULL),
      'template' => 'itg-campus-wise-list',
      'path' => drupal_get_path('module', 'itg_bestcolleges') . '/templates',
    ),
    'itg_city_wise_list' => array(
      'variable' => array('data' => NULL),
      'template' => 'itg-city-wise-list',
      'path' => drupal_get_path('module', 'itg_bestcolleges') . '/templates',
    ),
    'bestcollege_rhssearch' => array(
      'arguments' => array('form' => NULL),
      'template' => 'bestcollege-rhssearch-form-block',
      'path' => drupal_get_path('module', 'itg_bestcolleges') . '/templates',
    ),
  );
  return $themes;
}

/**
 * Implement hook_views_pre_render
 * @param object $view
 * {@inheritdoc}
 */
function itg_bestcolleges_views_pre_render(&$view) {
  if (isset($view->name) && $view->name == "best_college_image_slider") {
    if (isset($view->current_display) && $view->current_display == "page_1") {
      $header_content_client = '<span class="count">Count(' . $view->total_rows . ')&nbsp;</span>';
      $header_content_client .= l(t('Create Bestcolleges'), 'node/add/bestcolleges', array('query' => array('destination' => 'best-college-list')));
    }
    if (isset($header_content_client)) {
      $view->attachment_before = $header_content_client;
    }
  }
}

/**
 * Implementation of hook_form_views_exposed_form_alter().
 * {@inheritdoc}
 */
function itg_bestcolleges_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  switch ($form['#id']) {
    case 'views-exposed-form-best-college-image-slider-page-1':
      $form['title']['#attributes'] = array(
        'placeholder' => t('College Name')
      );
      $form['title']['#autocomplete_path'] = 'content-title-list/bestcolleges/autocomplete';
      break;
  }
}

/**
 * Implements hook_block_info().
 * @return array $blocks
 */
function itg_bestcolleges_block_info() {
  $blocks['bestcollege_rhssearch'] = array(
    'info' => t('Best College RHS Search Form'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['bestcollege_rhsstatic'] = array(
    'info' => t('Best College RHS Static Widget'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  return $blocks;
}

/**
 * Implements hook_block_view()
 * @return array $blocks
 */
function itg_bestcolleges_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'bestcollege_rhssearch':
      module_load_include('inc', 'itg_bestcolleges', 'includes/itg_bestcolleges');
      $clgsearch_form = drupal_get_form('bestcollege_rhssearch_form');
      $data['clgsearch_form'] = drupal_render($clgsearch_form);
      $block['content'] = theme('bestcollege_rhssearch', array('data' => $data));
      break;
    case 'bestcollege_rhsstatic':
      $year = arg(1);
      //module_load_include('inc', 'itg_bestcolleges', 'includes/itg_bestcolleges');
      $data = bestcollege_getStaticWidgetData($year);
      $block['title'] = t('LAST 19 YEARS BEST COLLEGE SURVEYS');
      $block['content'] = $data;
      break;
  }
  return $block;
}

/**
 * Function used to show Emerging Best Colleges List:
 * @param int $year
 * @param string $type
 * @param string $stream
 * @return string
 */
function itg_bestcollege_emerging($year, $type, $stream) {
  drupal_set_title(t('EMERGING COLLEGES RANKING: BEST ' . drupal_strtoupper($stream) . ' COLLEGES'));
  $result_data = itg_bestcollege_getData($type, $year, $stream);
  $data = array();
  foreach ($result_data as $result_data_key => $result_data_val) {
    $clgname_city = $result_data_val->collegename . ', ' . $result_data_val->city;
    $data[] = array($result_data_val->overall_rank, $clgname_city, $result_data_val->reputation, $result_data_val->academic_input, $result_data_val->studentcare, $result_data_val->infrastructure, $result_data_val->placement, $result_data_val->preceptual_rank, $result_data_val->factual_rank);
  }
  $header = array(t('Rank'), t('NAME OF THE COLLEGE'), t('Reputation'), t('Academic Input'), t('Student Care'), t('Infra'), t('Placement'), t('Perceptual Rank'), t('Factual Rank'));
  $output = theme('table', array(
    'header' => $header,
    'rows' => $data,
    'attributes' => array(
      'class' => array('table')
    )
      )
  );
  return $output;
}

/**
 * Function used to show Colleges List on behalf of Stream.
 * @param int $year
 * @param string $type
 * @param string $stream1
 * @param string $stream2
 * @return string
 */
function itg_bestcollege_streamcompare($year, $type, $stream1, $stream2) {
  drupal_set_title(t($year . ' ' . drupal_strtoupper($stream1) . ' Vs ' . drupal_strtoupper($stream2)));
  $result_data = array();
  $result_data_stream1 = itg_bestcollege_getData($type, $year, $stream1);
  $result_data_stream2 = itg_bestcollege_getData($type, $year, $stream2);

  $data = array();
  foreach ($result_data_stream1 as $result_data_stream1_key => $result_data_stream1_val) {
    $clgname_city = $result_data_stream1_val->collegename . ', ' . $result_data_stream1_val->city;
    $data[$stream1][] = array('rank' => $result_data_stream1_val->rank, 'college_name' => $clgname_city);
  }
  foreach ($result_data_stream2 as $result_data_stream2_key => $result_data_stream2_val) {
    $clgname_city2 = $result_data_stream2_val->collegename . ', ' . $result_data_stream2_val->city;
    $data[$stream2][] = array('rank' => $result_data_stream2_val->rank, 'college_name' => $clgname_city2);
  }
  $output = theme('itg_bestcollege_streamwise', array('data' => $data));
  return $output;
}

/**
 * Function used to show Colleges List on behalf of Year.
 * @param int $frmyear
 * @param int $toyear
 * @param string $type
 * @param string $stream
 * @return string
 */
function itg_bestcollege_yearcompare($frmyear, $toyear, $type, $stream) {
  drupal_set_title(t(drupal_ucfirst($stream) . ' ' . $frmyear . ' Vs ' . $toyear));
  $result_data = array();
  $result_data_yr1 = itg_bestcollege_getData($type, $frmyear, $stream);
  $result_data_yr2 = itg_bestcollege_getData($type, $toyear, $stream);
  
  $data = array();
  foreach ($result_data_yr1 as $result_data_yr1_key => $result_data_yr1_val) {
    $clgname_city = $result_data_yr1_val->collegename . ', ' . $result_data_yr1_val->city;
    $data[$frmyear][] = array('rank' => $result_data_yr1_val->rank, 'college_name' => $clgname_city);
  }
  foreach ($result_data_yr2 as $result_data_yr2_key => $result_data_yr2_val) {
    $clgname_city2 = $result_data_yr2_val->collegename . ', ' . $result_data_yr2_val->city;
    $data[$toyear][] = array('rank' => $result_data_yr2_val->rank, 'college_name' => $clgname_city2);
  }
  $output = theme('itg_bestcollege_yearwise', array('data' => $data));
  return $output;
}

/**
 * Function used to show Readyrecnor directory list Colleges List:
 * @param int $year
 * @param string $type
 * @param string $stream
 * @return string
 */
function itg_readyrecnor_directory_list($year, $type, $stream) {
  drupal_set_title(t('DIRECTORY OF BEST COLLEGES ' . $year.': '.drupal_strtoupper($stream)));
  $result_data = itg_bestcollege_getData($type, $year, $stream);
  $data = array();
  foreach ($result_data as $result_data_key => $result_data_val) {
    $data[$stream][] = array($result_data_val->rank, $result_data_val->collegename, $result_data_val->address, $result_data_val->phone, $result_data_val->websiteurl, $result_data_val->established, $result_data_val->seats, $result_data_val->cutoff);
  }
  return theme('itg_readyrecnor_directory', array('data' => $data));
}

/**
 * Function used to show Best Colleges List on behalf of zone:
 * @param int $year
 * @param string $type
 * @param string $stream
 * @return string
 */
function itg_zone_wise_list($year, $type, $stream) {
  drupal_set_title(t('ZONEWISE RANKING: BEST ' . drupal_strtoupper($stream).' COLLEGES'));
  $result_data = itg_bestcollege_getData($type, $year, $stream);
  $data = array();
  foreach ($result_data as $result_data_key => $result_data_val) {
    $data[$stream][] = array($result_data_val->rank, $result_data_val->city, $result_data_val->collegename);
  }
  return theme('itg_zone_wise_list', array('data' => $data));
}

/**
 * Function used to show Best Colleges List on behalf of zone:
 * @param int $year
 * @param string $type
 * @param string $stream
 * @return string
 */
function itg_campus_wise_list($year, $type, $stream) {
  drupal_set_title(t('CAMPUSWISE RANKING: BEST GOVT. & PRIVATE COLLEGES'));
  $result_data_eng = itg_bestcollege_getData($type, $year, 'eng');
  $result_data_law = itg_bestcollege_getData($type, $year, 'law');
  $result_data_medical = itg_bestcollege_getData($type, $year, 'medical');
  
  $data = array();
  foreach ($result_data_eng as $result_data_eng_key => $result_data_eng_val) {
    $data['eng'][] = array($result_data_eng_val->rank, $result_data_eng_val->collegename, $result_data_eng_val->city, $result_data_eng_val->stream);
  }
  foreach ($result_data_law as $result_data_law_key => $result_data_law_val) {
    $data['law'][] = array($result_data_law_val->rank, $result_data_law_val->collegename, $result_data_law_val->city, $result_data_law_val->stream);
  }
  foreach ($result_data_medical as $result_data_medical_key => $result_data_medical_val) {
    $data['medical'][] = array($result_data_medical_val->rank, $result_data_medical_val->collegename, $result_data_medical_val->city, $result_data_medical_val->stream);
  }
  return theme('itg_campus_wise_list', array('data' => $data));
}

/**
 * Function used to show Readyrecnor directory list Colleges List:
 * @param int $year
 * @param string $type
 * @param string $stream
 * @return string
 */
function itg_city_wise_list($year, $stream, $type, $city) {
  drupal_set_title(t('CITYWISE RANKING: BEST '.drupal_strtoupper($stream).' COLLEGES'));
  $result_data = itg_bestcollege_getData($type, $year, $stream, $city);
  $data = array();
  foreach ($result_data as $result_data_key => $result_data_val) {
    $data[$city][] = array($result_data_val->rank, $result_data_val->collegename);
  }
  return theme('itg_city_wise_list', array('data' => $data));
}

/**
 * Common function to get data of Best colleges:
 * @param String $type
 * @param int $byear
 * @param string $bstream
 * @return string
 */
function itg_bestcollege_getData($type, $byear, $bstream, $city = NULL) {
  $itg_result = array();
  // Need to change below query once bestcollege migrate:
  if ($type == 'emerging') {
    $itg_query = db_select('bestcolleges_master', 'n');
    $itg_query->join('bestcolleges_emergingranking', 'bce', 'n.collegeid = bce.collegeid');
    $itg_query->fields('bce', array('id', 'year', 'overall_rank', 'stream', 'reputation', 'academic_input', 'studentcare', 'infrastructure', 'placement', 'preceptual_rank', 'factual_rank'));
    $itg_query->fields('n', array('collegename', 'city'))
        ->condition('bce.year', $byear, '=')
        ->condition('bce.stream', $bstream, '=')
        ->condition('bce.published', 1)
        ->orderBy('bce.overall_rank', 'ASC');
    $itg_result = $itg_query->execute()->fetchAll();
    return $itg_result;
  }
  if ($type == 'stream-comparecollege' || $type == 'year-comparecollege') {
    $itg_query = db_select('bestcolleges_master', 'n');
    $itg_query->join('bestcolleges_ranking', 'bcr', 'n.collegeid = bcr.collegeid');
    $itg_query->fields('bcr', array('id', 'year', 'rank', 'stream'));
    $itg_query->fields('n', array('collegename', 'city'))
        ->condition('bcr.year', $byear, '=')
        ->condition('bcr.stream', $bstream, '=')
        ->condition('bcr.published', 1)
        ->condition('bcr.rank', 0, '!=')
        ->orderBy('bcr.rank', 'ASC');
    $itg_result = $itg_query->execute()->fetchAll();
    return $itg_result;
  }
  if ($type == 'readyrecnor-directory-list') {
    // Query to find result of on behalf of stream & year:
    $itg_query = db_select('bestcolleges_readyrecnor_directory_list', 'brd');
    $itg_query->fields('brd', array('rank', 'collegename', 'address', 'phone', 'websiteurl', 'established', 'seats', 'cutoff'))
        ->condition('brd.year', $byear, '=')
        ->condition('brd.stream', $bstream, '=')
        ->condition('brd.published', 1)
        ->condition('brd.rank', 0, '!=')
        ->orderBy('brd.rank', 'ASC');
    $itg_result = $itg_query->execute()->fetchAll();
    return $itg_result;
  }
  if ($type == 'zone-wise-list') {
    // Query to find result of best colleges with zone on behalf of stream & year:
    $itg_query = db_select('bestcolleges_zonecampuswiseranking', 'bcz');
    $itg_query->fields('bcz', array('rank', 'city', 'collegename'))
        ->condition('bcz.year', $byear, '=')
        ->condition('bcz.stream', $bstream, '=')
        ->condition('bcz.city', array('North', 'South', 'East', 'West'), 'IN')
        ->condition('bcz.published', 1)
        ->condition('bcz.rank', 0, '!=')
        ->orderBy('bcz.city', 'ASC');
    $itg_result = $itg_query->execute()->fetchAll();
    return $itg_result;
  }
  if ($type == 'campus-wise-list') {
    $tech_stream = array();
    if ($bstream == 'eng') {
      $tech_stream = array('Govt Eng College', 'Pvt Eng College');
    }
    elseif ($bstream == 'law') {
      $tech_stream = array('Govt Law College', 'Pvt Law College');
    }
    elseif ($bstream == 'medical') {
      $tech_stream = array('Govt Medical College', 'Pvt Medical College');
    }
    // Query to find result of Pvt & Govt colleges with zone on behalf of stream & year:
    $itg_query = db_select('bestcolleges_zonecampuswiseranking', 'bcz');
    $itg_query->fields('bcz', array('rank', 'collegename', 'city', 'stream'))
        ->condition('bcz.year', $byear, '=')
        ->condition('bcz.stream', $tech_stream, 'IN')
        ->condition('bcz.published', 1)
        ->condition('bcz.rank', 0, '!=')
        ->orderBy('bcz.stream', 'ASC');
    $itg_result = $itg_query->execute()->fetchAll();
    return $itg_result;
  }
  if ($type == 'citywise-list') {
    // Query to find result of best colleges with zone on behalf of stream, year & city:
    $itg_query = db_select('bestcolleges_citywiseranking', 'bcr');
    $itg_query->fields('bcr', array('rank', 'collegename'))
        ->condition('bcr.year', $byear, '=')
        ->condition('bcr.stream', $bstream, '=')
        ->condition('bcr.city', $city, '=')
        ->condition('bcr.published', 1)
        ->condition('bcr.rank', 0, '!=')
        ->orderBy('bcr.rank', 'ASC');
    $itg_result = $itg_query->execute()->fetchAll();
    return $itg_result;
  }
}

/**
 * Common function to get stream from year:
 * @param String $type
 * @param int $byear
 * @param string $bstream
 * @return string
 */
function itg_bestcollege_getStreamYear($type, $byear) {
  $results = array();
  $data = array();
  // Need to change below query once bestcollege migrate:
  if ($type == 'emerging') {
    $query = db_select('bestcolleges_master', 'n');
    $query->join('bestcolleges_emergingranking', 'bce', 'n.collegeid = bce.collegeid');
    $query->distinct();
    $query->fields('bce', array('stream'))
        ->condition('bce.published', 1)
        ->orderBy('bce.stream', 'ASC');
    $results = $query->execute()->fetchAll();
    
    foreach($results as $results_key => $results_val) {
      $data[drupal_strtolower($results_val->stream)] = $results_val->stream;
    }
    return $data;
  }
  if ($type == 'year-comparecollege') {
    // Query to find year
    $query = db_select('bestcolleges_master', 'n');
    $query->join('bestcolleges_ranking', 'bcr', 'n.collegeid = bcr.collegeid');
    $query->distinct();
    $query->fields('bcr', array('year'))
        ->condition('bcr.published', 1)
        ->condition('bcr.rank', 0, '!=')
        ->orderBy('bcr.year', 'DESC');
    $results = $query->execute()->fetchAll();
    foreach($results as $results_key => $results_val) {
      $data['year'][drupal_strtolower($results_val->year)] = $results_val->year;
    }
    // Query to find stream
    $query1 = db_select('bestcolleges_master', 'n');
    $query1->join('bestcolleges_ranking', 'bcr', 'n.collegeid = bcr.collegeid');
    $query1->distinct();
    $query1->fields('bcr', array('stream'))
        ->condition('bcr.published', 1)
        ->condition('bcr.rank', 0, '!=')
        ->orderBy('bcr.stream', 'ASC');
    $results1 = $query1->execute()->fetchAll();
    foreach($results1 as $results1_key => $results1_val) {
      $data['stream'][drupal_strtolower($results1_val->stream)] = $results1_val->stream;
    }
    return $data;
  }
  if ($type == 'readyrecnor-directory-list') {
    // Query to find result of on behalf of stream & year:
    $query = db_select('bestcolleges_readyrecnor_directory_list', 'brd');
    $query->distinct();
    $query->fields('brd', array('stream'))
        ->condition('brd.year', $byear, '=')
        ->condition('brd.published', 1)
        ->condition('brd.rank', 0, '!=')
        ->orderBy('brd.stream', 'ASC');
    $results = $query->execute()->fetchAll();
    foreach($results as $results_key => $results_val) {
      $data[drupal_strtolower($results_val->stream)] = $results_val->stream;
    }
    return $data;
  }
}

/*
 * Get HTML Widget data for bestcolleges detail page on behalf of its title.
 * @param int year
 * @return string
 */
function bestcollege_getStaticWidgetData($year) {
  //RHS2016
    $keyword = 'RHS'.$year;
    $query = db_select('node', 'n');
    $query->fields('n', array('nid'))
        ->condition('n.status', 1)
        ->condition('n.title', '%'.$keyword.'%', 'LIKE')
        ->condition('n.type', 'custom_html_widgets');
    $results = $query->execute()->fetchAll();
    $best_html = node_load($results[0]->nid)->body[LANGUAGE_NONE][0]['value'];
    return $best_html;
}