<?php

/**
 * @file
 * The ITG Event Registration module.
 *
 * Contains functionality for event registration.
 *
 */

/**
 * Implementation of hook_permission
 * @return array
 */
function itg_event_registration_permission() {
  return array(
    'event registered users' => array(
      'title' => t('View Event Registered User List'),
    )
  );
}

/**
 * Implementation of hook_menu
 *
 * @return array
 *   an array $item with all menu callbacks
 */
function itg_event_registration_menu() {

  $items = array();

  $items['event-registration'] = array(
    'title' => 'Event Registration',
    'page callback' => 'itg_event_reg_form',
    'access callback' => TRUE,
    //'type' => MENU_CALLBACK,
    //'file' => 'includes/itg_event_registration.inc',
  );

  $items['event-registration/users-list/%'] = array(
    'title' => 'Registered Users List',
    'page callback' => 'itg_event_registration_users_list',
    'access callback' => 'user_access',
    'access arguments' => array('event registered users'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/itg_event_registration.inc',
  );
  return $items;
}

function itg_event_reg_form() {
  return '';
}

/**
 * Implementation of hook_theme
 *
 * @return array
 *   an array with templates information and other array variables
 */
function itg_event_registration_theme() {
  $theme = array(
      'event_registration_tab_form_display_block' => array(
          'template' => 'event-registration-form-tab',
          'path' => drupal_get_path('module', 'itg_event_registration') . '/templates',
          'variables' => array('data' => NULL),
      ),
      'event_registration_closed' => array(
          'template' => 'event-registration-closed',
          'path' => drupal_get_path('module', 'itg_event_registration') . '/templates',
          'variables' => array('node' => NULL),
      ),
      'event_registration_not_started' => array(
          'template' => 'event-registration-not-started',
          'path' => drupal_get_path('module', 'itg_event_registration') . '/templates',
          'variables' => array('node' => NULL),
      ),
      'event_registration_tickets_not_available' => array(
          'template' => 'event-registration-tickets-not-available',
          'path' => drupal_get_path('module', 'itg_event_registration') . '/templates',
          'variables' => array('node' => NULL),
      ),
  );
  return $theme;
}

/**
 * Implementation of hook_form_alter
 * {@inheritdoc}
 */
function itg_event_registration_form_alter(&$form, &$form_state, $form_id) {

  if ($form_id == 'event_registration_node_form') {
    
    $form['field_no_of_members']= array(
        '#prefix' => '<div class= "event-member-container">',
        '#title' => 'No. Of Memebers',
        '#type' => 'item',
        '#markup' => '<div class = "event-no-of-memeber"><span class="event-form-remove">-</span><input type="text" name="no_of_mem" class="event-form-number" /><span class="event-form-add">+</span></div>',
        '</suffix>'=> '</div>'
    );
    
    $current_event_nid = itg_event_registration_get_event_nid();
    $max_delta = $form['field_erf_registration_fee'][LANGUAGE_NONE]['#max_delta'] + 1;
    $node = node_load($current_event_nid);
    $no_of_tickets = $node->field_no_of_tickets[LANGUAGE_NONE][0]['value'];

    $total_registered_users = itg_event_registration_get_total_registration($current_event_nid);
    $tickets_available = $no_of_tickets - $total_registered_users;
    $group_tickets_available = $tickets_available - 1;

    if ($group_tickets_available > 0) {
      $_SESSION['total_ava_ticket'] = $group_tickets_available;
    }

    if ($tickets_available == 1) {
      drupal_add_js('jQuery(document).ready(function() {                  
          jQuery("#field-erf-registration-fee-values").hide();
          jQuery("#edit-field-erf-type").append("<p><strong>No more tickets available for this event.</strong></p>");
          jQuery("p").css("padding-left", "200px");
     });', array('type' => 'inline', 'scope' => 'footer'));

      unset($form['field_erf_registration_fee']['und']['add_more']);
    }

    //Hide add more button, if ticket are not available
    if (isset($max_delta) && $max_delta >= $_SESSION['total_ava_ticket']) {
      unset($form['field_erf_registration_fee']['und']['add_more']);
    }
 
   unset($form['field_erf_registration_fee']['und'][0]['field_erf_ticket_type']['und']['#options']['_none']);
//    $ticket_type_options = array(1=>'Student', 2=>'Young Professional', 3=>'Senior Citizen',4=>'Business Professional');
//    $form['field_erf_registration_fee']['und'][0]['field_erf_ticket_type']['und']['#options'] = $ticket_type_options;

    
    // Hide metatags and priview button
    unset($form['#metatags']);
    unset($form['actions']['preview']);
    
    // Rename submit button from "Save" to "Submit"
    $form['actions']['submit']['#value'] = 'Submit';

    if (isset($current_event_nid)) {
      $event_node = node_load($current_event_nid);
      $registration_type = $event_node->field_event_type[LANGUAGE_NONE][0]['value'];

      if ($registration_type == 'free') {
        // Hide fee field & payment drop-down field and display a message, if registration is free.
        unset($form['field_erf_total_fee']);
        $form['field_erf_payment_gateway']['#access'] = FALSE;
      } else {
        
        $count_people = 0;
        foreach ($form['#node']->field_erf_registration_fee[LANGUAGE_NONE] as $registered_people) {
          if (!empty($registered_people['field_first_name'])) {
            $count_people = $count_people + 1;
          }
        }
      }
      $total_fee = ceil($total_fee);
    }

    $total_fee = $total_fee ? $total_fee : '0.00';
    $form['field_erf_total_fee'][LANGUAGE_NONE][0]['value']['#value'] = $total_fee;
    $form['field_erf_total_fee']['#disabled'] = TRUE;

    // Assign event id into source id field
    $form['field_story_source_id'][LANGUAGE_NONE][0]['value']['#default_value'] = $current_event_nid;
    $form['field_story_source_id']['#access'] = TRUE;

    // After build and validate function 
    $form['#after_build'][] = 'itg_event_registration_form_after_build';
    $form['#validate'][] = 'itg_event_registration_form_validate';

    // Call custom summit callback
    $form['actions']['submit']['#submit'][] = 'itg_event_registration_form_custom_submit_callback';
  }
}

/**
 * Custom validate for event registration form
 * @param array $form
 * @param array $form_state
 */
function itg_event_registration_form_validate($form, &$form_state){
  foreach($form_state['values']['field_email_address'][LANGUAGE_NONE] as $key => $email){
    if (is_numeric($key)) {
      if (!valid_email_address($email['value'])) {
        form_set_error('field_email_address][' . LANGUAGE_NONE . '][' . $key ,  t('Please enter a valid email id.'));
      }
    }
  }
}

/**
 * After build function for Event Registration
 * {@inheritdoc}
 */
function itg_event_registration_form_after_build($form, &$form_state) {
  global $user, $base_url;
  $current_event_nid = itg_event_registration_get_event_nid();
  
  // Array used in event_registration.js
  $settings = array();
  $settings['base_url'] = $base_url;
  $settings['uid'] = $user->uid;
  $settings['nid'] = $current_event_nid;

  drupal_add_js(array('itg_event_registration' => array('settings' => $settings)), array('type' => 'setting'));

  // Add JS for Event Registration
  drupal_add_js(drupal_get_path('module', 'itg_event_registration') . '/js/itg_event_registration.js', array('weight' => 1));

   $form['event_registration_title'] = array(
        '#type' => 'item',
        '#markup' => '<div class="event-registration-title"><h2>REGISTRATION</h2></div>',
        '#weight' => -100,
      );
   
  // If limited tickets are available
  $event_node = node_load($current_event_nid);
  $no_of_tickets = $event_node->field_no_of_tickets[LANGUAGE_NONE][0]['value'];

  $total_registered_users = itg_event_registration_get_total_registration($current_event_nid);
  $tickets_available = $no_of_tickets - $total_registered_users;

  return $form;
}

/**
 * Custom function on submit of Event Registration form
 * @param array $form
 * @param array $form_state
 */
function itg_event_registration_form_custom_submit_callback($form, &$form_state) {

  // Unset drupal redirection and add custom redirection URL
  if (isset($_GET['destination'])) {
    unset($_GET['destination']);
  }

  // Set custom message on creation of event registration form.
  if (isset($_SESSION['messages'])) {
    unset($_SESSION['messages']);
  }

  $current_event_nid = itg_event_registration_get_event_nid();

  // Set Redirection after completion of event registration form
  if (!empty($current_event_nid)) {
    $form_state['redirect'] = array('event-registration', array('query' => array('event_id' => $current_event_nid)));
  }
  else {
    $form_state['redirect'] = 'event-registration';
  }
  $event_name = itg_common_get_node_title($current_event_nid);
  drupal_set_message(t('Congratulations! You have successfully registered yourself for the event <strong>@eventname</strong>.', array('@eventname' => $event_name)));
}

/**
 * Implementation of hook_views_pre_render
 *
 * @param object $view
 */
function itg_event_registration_views_pre_render(&$view) {
  // Add count on listing page of event registered user
  if ($view->name == "manage_event_registration") {
    $header_content_event = '<span class="count">Count(' . $view->total_rows . ')&nbsp;</span>';
    $view->attachment_before = $header_content_event;
  }
}

/**
 * Implementation of hook_form_views_exposed_form_alter
 * {@inheritdoc}
 */
function itg_event_registration_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  if ($form['#id'] == 'views-exposed-form-manage-event-registration-page') {
    $form['title']['#autocomplete_path'] = 'content-title-list/event_registration/autocomplete';
    $form['title']['#attributes'] = array('placeholder' => t('Title'));
  }
}

/**
 * Implementation of hook_node_validate
 * {@inheritdoc}
 */
function itg_event_registration_node_validate($node) {

  if ($node->type == 'event_registration') {

    foreach ($node->field_erf_registration_fee[LANGUAGE_NONE] as $regdata) {
      if (!preg_match("/^[a-zA-Z ]*$/", $regdata['field_erf_name'][LANGUAGE_NONE][0]['value'])) {
          form_set_error('field_erf_name', t('Name <strong>@name</strong> must be alphabetic.', array('@name' => $regdata['field_erf_name'][LANGUAGE_NONE][0]['value'])));
      }
      if (!preg_match("/^[0-9]{10}$/", $regdata['field_erf_mobile'][LANGUAGE_NONE][0]['value']) && $regdata['field_erf_mobile'][LANGUAGE_NONE][0]['value'] != 'A') {
          form_set_error('field_erf_mobile', t('Mobile number <strong>@mobile</strong> must be 10 digit numeric value.', array('@mobile' => $regdata['field_erf_mobile'][LANGUAGE_NONE][0]['value'])));
      }
      if (substr($regdata['field_erf_mobile'][LANGUAGE_NONE][0]['value'], 0, -8) == '000' && $regdata['field_erf_mobile'][LANGUAGE_NONE][0]['value'] != 'A') {
          form_set_error('field_erf_mobile', t('Mobile number <strong>@mobile</strong> is not a valid mobile number.', array('@mobile' => $regdata['field_erf_mobile'][LANGUAGE_NONE][0]['value'])));
      }
      if (!empty($regdata['field_email_address'][LANGUAGE_NONE][0]['value']) && !valid_email_address($regdata['field_email_address'][LANGUAGE_NONE][0]['value'])) {
          form_set_error('field_email_address', t('Email <strong>@email</strong> is not a valid email.', array('@email' => $regdata['field_email_address'][LANGUAGE_NONE][0]['value'])));
      }
      if (!empty($regdata['field_erf_postal_code'][LANGUAGE_NONE][0]['value']) && $regdata['field_erf_postal_code'][LANGUAGE_NONE][0]['value'] == '000000') {
          form_set_error('field_erf_postal_code', t('Pincode <strong>@pincode</strong> is not a valid pincode.', array('@pincode' => $regdata['field_erf_postal_code'][LANGUAGE_NONE][0]['value'])));
      }
    }
  }
}

/**
 * Get total no. of registered user for an event by a parent user.
 * @param int $nid
 * @return string
 */
function itg_event_registration_get_registered_user($nid) {
  $node = node_load($nid);
  $count_people = count($node->field_erf_registration_fee[LANGUAGE_NONE]);
  $text = 'List Users(' . $count_people . ')';
  return $text;
}

/**
 * Get ID type value
 * @param string $val
 * @return string
 */
function itg_event_registration_get_id_type($val) {
  switch ($val) {
    case 'aadhar_card':
      $id_type = 'Aadhar Card';
      break;
    case 'driving_licence':
      $id_type = 'Driving Licence';
      break;
    case 'pan':
      $id_type = 'PAN Card';
      break;
    case 'passport':
      $id_type = 'Passport';
      break;
    case 'voter_id':
      $id_type = 'Voter Id Card';
      break;
    default:
      break;
  }
  return $id_type;
}

/**
 * Registration details of a event
 * @param int $nid
 * @return int
 */
function itg_event_registration_registered_user_detail($nid) {

  if (isset($nid)) {
    $total_registration_users = itg_event_registration_get_total_registration($nid);
    $total_registration_for_event = $total_registration_users ? $total_registration_users : 0;
  }

  $text = 'List Users(' . $total_registration_for_event . ')';
  $path = 'event-registration/users-list/' . $nid;

  if ($total_registration_for_event < 1) {
    return 0;
  }
  else {
    //return l($text, $path, array('attributes' => array('target' => '_blank')));
    return $text;
  }
}

/**
 * Get total no. of registered users for a event
 * @param int $nid
 * @return int $total_registration_users
 */
function itg_event_registration_get_total_registration($nid) {

  $registration_main_users = itg_common_check_record_existance($nid, 'field_data_field_story_source_id', 'field_story_source_id_value');

  // Count group users registration for an event
  $main_user_nid_arr = itg_common_select_field_value('entity_id', 'field_data_field_story_source_id', 'field_story_source_id_value', $nid);
  $registration_group_users = 0;

  foreach ($main_user_nid_arr as $main_user_nid) {
    $registration_group_users = $registration_group_users + itg_common_check_record_existance($main_user_nid, 'field_data_field_erf_registration_fee', 'entity_id');
  }
  // Total count for an event
  $total_registration_users = $registration_main_users + $registration_group_users;
  return (int)$total_registration_users;
}

/**
 * Get event nid using host
 * @global string $base_url
 * @return int
 */
function itg_event_registration_get_event_nid() {
  global $base_url;
  $host_detail = itg_event_backend_get_redirect_record('redirect', $base_url);
  $host_node_arr = explode('/', $host_detail['source']);
  return $host_node_arr[1];
}

/**
 * Call templete file for registration status message
 * @param string $message_type
 * @return type
 */
function itg_event_registration_get_status_message($node, $message_type) {
  return theme('event_registration_'.$message_type, array('node' => $node));
}

/**
 * Get Event Registration form
 * @global string $base_url
 * @return string
 */
function itg_event_registration_get_form() {
  global $base_url;
  
  module_load_include('inc', 'node', 'node.pages');
  $form = node_add('event_registration');
  
  $host_detail = itg_event_backend_get_redirect_record('redirect', $base_url);
  $host_node_arr = explode('/', $host_detail['source']);
  $host_node = node_load($host_node_arr[1]);
  $form['#cache'] = TRUE;
  if(!empty($host_node->field_story_expert_description[LANGUAGE_NONE])){
  $form['cutomtext'] = array(
      '#type' => 'item',
      '#markup' => '<div class="event-registration-main-container"><div><b>Terms and Conditions:</b></div><div class="tc-txt"> '.$host_node->field_story_expert_description[LANGUAGE_NONE][0]['value'].'  </span></div></div>',
      '#weight' => 100,
  );
  }
  return $form;
}
