<?php

/**
 * @file
 * ITG Recipe module.
 *
 * Provides customizations and functions for Recipe.
 * 
 */

/**
 * Implementation of hook_node_presave().
 * @param Array $node
 */
function itg_recipe_node_presave($node) {

  if ($node->type == 'recipe') {
    $node->title = trim($node->title);
  }
  if ($node->type == 'recipe') {
    if ($node->field_recipe_content_type[LANGUAGE_NONE][0]['value'] == 'Text') {
      $node->field_recipe_audio = '';
      $node->field_recipe_video = '';
    }
    elseif ($node->field_recipe_content_type[LANGUAGE_NONE][0]['value'] == 'Audio') {
      $node->field_recipe_description = '';
      $node->field_recipe_video = '';
    }
    elseif ($node->field_recipe_content_type[LANGUAGE_NONE][0]['value'] == 'Video') {
      $node->field_recipe_description = '';
      $node->field_recipe_audio = '';
    }
  }
}

/**
 * Implemets hook_form_alter().
 * @global stdObject $$user
 * @param Array $form
 * @param Array $form_state
 * @param string $form_id
 */
function itg_recipe_form_alter(&$form, &$form_state, $form_id) {
  global $user, $base_url;  
  switch ($form_id) {
    case 'recipe_node_form':
      // Social Media Integration field show hide
      itg_recipe_smi_hideshow($form);
      $form['#attached']['js'] = array(
        drupal_get_path('module', 'itg_recipe') . '/js/jquery.validate.min.js',
      );
      if (!empty($_REQUEST['destination'])) {
        $destination = $_REQUEST['destination'];
      }
      else {
        $destination = 'recipe-management';
      }

      $form['actions']['cancel'] = array(
        '#markup' => l(t('Cancel'), $destination, array('attributes' => array('class' => 'button'))),
        '#weight' => 20,
      );
      $form['#after_build'][] = 'itg_recipe_after_build';
      $form['actions']['submit']['#submit'][] = 'itg_recipe_form_custom_callback';
      //$form['#validate'][] = 'itg_recipe_fields_validate';
      break;
    case 'cooking_tips_node_form':
      $form['actions']['cancel'] = array(
        '#markup' => l(t('Cancel'), 'manage-cooking-tips', array('attributes' => array('class' => 'button'))),
        '#weight' => 20,
      );
      $form['#after_build'][] = 'itg_cooking_tips_after_build';
      $form['actions']['submit']['#submit'][] = 'itg_cooking_tips_form_custom_callback';
      break;
    case 'food_news_node_form':
      $form['actions']['cancel'] = array(
        '#markup' => l(t('Cancel'), 'manage-food-news', array('attributes' => array('class' => 'button'))),
        '#weight' => 20,
      );
      $form['#after_build'][] = 'itg_food_news_after_build';
      $form['actions']['submit']['#submit'][] = 'itg_food_news_form_custom_callback';
      break;
    case 'story_node_form':
      itg_recipe_smi_hideshow($form);
      break;
    
    case 'photogallery_node_form':
      itg_recipe_smi_hideshow($form);
  
  }
}

/**
 * Social Media Integration fields show hide logic
 * @global stdObject $user
 * @param type $form
 */
function itg_recipe_smi_hideshow(&$form) {
  global $user;
  // Code for Comment Question field hide and show
  $form['field_story_facebook_narrative']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_social_media_integ[und][facebook]"]' => array('checked' => TRUE),
    )
  );

  // Code for facebook image field hide and show
  $form['field_story_facebook_image']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_social_media_integ[und][facebook]"]' => array('checked' => TRUE),
    )
  );
  
  // Make facebook posted by field hidden
  $form['field_story_posted_by_facebook']['und'][0]['value']['#type'] = 'hidden';
  
  // Set default value to posted by facebook value.
  $form['field_story_posted_by_facebook']['und'][0]['value']['#default_value'] = $user->mail;
  
  // Make posted by field visible when someone check facebook checkbox
  $form['field_story_posted_by_facebook']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_social_media_integ[und][facebook]"]' => array('checked' => TRUE),
    )
  );
  
  // Code for facebook time 
  $form['field_story_time_facebook']['#type'] = 'hidden';
  $form['field_story_time_facebook']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_social_media_integ[und][facebook]"]' => array('checked' => TRUE),
    )
  );

  // code for tweet field show and hide 
  $form['field_story_tweet']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_social_media_integ[und][twitter]"]' => array('checked' => TRUE),
    ),
  );

  // code for tweeter image field hide and show
  $form['field_story_tweet_image']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_social_media_integ[und][twitter]"]' => array('checked' => TRUE),
    )
  );
  
  // Code for posted by twitter and time field
  $form['field_story_posted_by_twitter']['und'][0]['value']['#default_value'] = $user->mail;
  $form['field_story_posted_by_twitter']['und'][0]['value']['#type'] = 'hidden';
  $form['field_story_posted_by_twitter']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_social_media_integ[und][twitter]"]' => array('checked' => TRUE),
    ),
  );
  $form['field_story_time_twitter']['#type'] = 'hidden';
  $form['field_story_time_twitter']['#states'] = array(
    'visible' => array(
      ':input[name="field_story_social_media_integ[und][twitter]"]' => array('checked' => TRUE),
    ),
  );

  // Code for instagram fields show hide
  $form['field_story_posted_by_instagram']['und'][0]['value']['#type'] = 'hidden';
  $form['field_story_posted_by_twitter']['und'][0]['value']['#default_value'] = $user->mail;
  $form['field_story_time_instagram']['#type'] = 'hidden';
}

/**
 * After submit Cooking Tips
 * @param Array $form
 * @param Array $form_state
 */
function itg_cooking_tips_form_custom_callback($form, &$form_state) {

  if (isset($_SESSION['messages']['status'])) {
    unset($_SESSION['messages']['status']);
  }
  if (arg(2) == 'edit') {
    $op = 'updated';
  }
  else {
    $op = 'created';
  }
 $cooking_tips_title = $form_state['node']->title;
  drupal_set_message(t('Cooking Tips <b>' . $cooking_tips_title . '</b> has been ' . $op .'.'));
  $_GET['destination'] = 'manage-cooking-tips';
}

/**
 * After build for Cooking Tips form.
 * @param Array $form
 * @param Array $form_state
 */
function itg_cooking_tips_after_build($form, &$form_state) {

  global $user, $base_url;
  unset($form['metatags']['intro_text']['#markup']);
  unset($form['metatags']['#description']);
  //$form['field_recipe_description']['und'][0]['value']['#title'] = t('Description / Procedure').'<span class="form-required" title="This field is required."> *</span>';  
  $settings = array();
  $settings['base_url'] = $base_url;
  $settings['uid'] = $user->uid;

  drupal_add_js(array('itg_recipe' => array('settings' => $settings)), array('type' => 'setting'));
  drupal_add_js(drupal_get_path('module', 'itg_recipe') . '/js/itg_recipe.js', array('weight' => 1));
  return $form;
}

/**
 * After submit Cooking Tips
 * @param Array $form
 * @param Array $form_state
 */
function itg_food_news_form_custom_callback($form, &$form_state) {

  if (isset($_SESSION['messages']['status'])) {
    unset($_SESSION['messages']['status']);
  }
  if (arg(2) == 'edit') {
    $op = 'updated';
  }
  else {
    $op = 'created';
  }
  $food_title = $form_state['node']->title;
  drupal_set_message(t('Food News <b>' . $food_title . '</b> has been ' . $op .'.'));
  $_GET['destination'] = 'manage-food-news';
}

/**
 * After build for Cooking Tips form.
 * @param Array $form
 * @param Array $form_state
 */
function itg_food_news_after_build($form, &$form_state) {

  global $user, $base_url;
  unset($form['metatags']['intro_text']['#markup']);
  unset($form['metatags']['#description']);
  //$form['field_recipe_description']['und'][0]['value']['#title'] = t('Description / Procedure').'<span class="form-required" title="This field is required."> *</span>';  
  $settings = array();
  $settings['base_url'] = $base_url;
  $settings['uid'] = $user->uid;

  drupal_add_js(array('itg_recipe' => array('settings' => $settings)), array('type' => 'setting'));
  drupal_add_js(drupal_get_path('module', 'itg_recipe') . '/js/itg_recipe.js', array('weight' => 1));
  return $form;
}
/**
 * After submit recipe
 * @param Array $form
 * @param Array $form_state
 */
function itg_recipe_form_custom_callback($form, &$form_state) {

  if (isset($_SESSION['messages'])) {
    unset($_SESSION['messages']);
  }
  if (arg(2) == 'edit') {
    $op = 'updated';
  }
  else {
    $op = 'created';
  }$recipe_title = $form_state['node']->title;
  drupal_set_message(t('Recipe <b>' . $recipe_title . '</b> has been ' . $op . '.'));
  //$_GET['destination'] = $_REQUEST['destination'];
  if (!empty($_REQUEST['destination'])) {
    $destination = $_REQUEST['destination'];
  }
  else {
    $destination = 'recipe-management';
  }
  // redirect page
  $_GET['destination'] = $destination;
}

/**
 * After build for Recipe form.
 * @param Array $form
 * @param Array $form_state
 */
function itg_recipe_after_build($form, &$form_state) {

  global $user, $base_url;
  unset($form['metatags']['intro_text']['#markup']);
  unset($form['metatags']['#description']);
  //$form['field_recipe_description']['und'][0]['value']['#title'] = t('Description / Procedure').'<span class="form-required" title="This field is required."> *</span>';  
  $settings = array();
  $settings['base_url'] = $base_url;
  $settings['uid'] = $user->uid;

  drupal_add_js(array('itg_recipe' => array('settings' => $settings)), array('type' => 'setting'));
  drupal_add_js(drupal_get_path('module', 'itg_recipe') . '/js/itg_recipe.js', array('weight' => 1));
  return $form;
}

/**
 * Implement hook_views_pre_render
 * @param Object $view
 */
function itg_recipe_views_pre_render(&$view) {
  //Add "Create recipe" button on listing page of recipe
  if ($view->name == "recipe_management") {
    $header_content_recipe = '<span class="count">Count('.$view->total_rows.')&nbsp;</span>';
    $header_content_recipe .= '<span class="manage_recipe_view_menu">' . l(t('Recipes'), 'recipe-management') . '&nbsp;</span>';
    $header_content_recipe .= '<span class="manage_cooking_tips_view_menu">' . l(t('Cooking Tips'), 'manage-cooking-tips') . '&nbsp;</span>';
    $header_content_recipe .= '<span class="create_cooking_tips">' . l(t('Create Cooking Tips'), 'node/add/cooking-tips') . '&nbsp;</span>';
    $header_content_recipe .= '<span class="manage_cooking_tips_view_menu">' . l(t('Food News'), 'manage-food-news') . '&nbsp;</span>';
    $header_content_recipe .= '<span class="create_cooking_tips">' . l(t('Create Food News'), 'node/add/food-news') . '&nbsp;</span>';
    $header_content_recipe .= l(t('Create Recipe'), 'node/add/recipe');
    $view->attachment_before = $header_content_recipe;
  }
  if ($view->name == "manage_cooking_tips") {
    $header_content_recipe .= '<span class="count">Count('.$view->total_rows.')&nbsp;</span>';
    $view->attachment_before = $header_content_recipe;
  }
  if ($view->name == "manage_food_news") {
    $header_content_recipe .= '<span class="count">Count('.$view->total_rows.')&nbsp;</span>';
    $view->attachment_before = $header_content_recipe;
  }
}

/**
 * Implement hook_theme
 * @param array $existing
 * @param module $type
 * @param array $theme
 * @param string $path
 * @return array
 */
function itg_recipe_theme($existing, $type, $theme, $path) {
  $themes = array(
    'recipe_node_form' => array(
      'arguments' => array('form' => NULL),
      'template' => 'recipe-node-form',
      'path' => drupal_get_path('module', 'itg_recipe') . '/templates',
      'render element' => 'form',
    ),
    'recipe_tab_form_display_block' => array(
      'template' => 'recipe-form-tab-template',
      'path' => drupal_get_path('module', 'itg_recipe') . '/templates',
      'variables' => array('data' => NULL),
    ),
    'cooking_tips_node_form' => array(
      'arguments' => array('form' => NULL),
      'template' => 'cooking-tips-node-form',
      'path' => drupal_get_path('module', 'itg_recipe') . '/templates',
      'render element' => 'form',
    ),
    'food_news_node_form' => array(
      'arguments' => array('form' => NULL),
      'template' => 'food-news-node-form',
      'path' => drupal_get_path('module', 'itg_recipe') . '/templates',
      'render element' => 'form',
    ),
  );
  return $themes;
}

/**
 * Implements hook_block_info().
 */
function itg_recipe_block_info() {
  $blocks['recipe_tab_form_block'] = array(
    'info' => t('Recipe Form Tab Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 * @global array $user
 * @param array $delta
 */
function itg_recipe_block_view($delta = '') {
  global $user;
  $block = array();
  $data = '';
  switch ($delta) {
    case 'recipe_tab_form_block':
      $block['content'] = theme('recipe_tab_form_display_block', array('data' => $data));
      break;
  }
  return $block;
}

/**
 * Implement hook_form_views_exposed_form_alter
 * @param Array $form
 * @param Array $form_state
 */
function itg_recipe_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {

  if ($form["#id"] == 'views-exposed-form-recipe-management-page') {
    $form['title']['#autocomplete_path'] = 'content-title-list/recipe/autocomplete';
    $form['title']['#attributes'] = array('placeholder' => t('Title'));
  }
  if ($form["#id"] == 'views-exposed-form-recipe-management-page-1') {
    $form['title']['#autocomplete_path'] = 'content-title-list/cooking_tips/autocomplete';
    $form['title']['#attributes'] = array('placeholder' => t('Title'));
  }
  if ($form["#id"] == 'views-exposed-form-recipe-management-page-2') {
    $form['title']['#autocomplete_path'] = 'content-title-list/food_news/autocomplete';
    $form['title']['#attributes'] = array('placeholder' => t('Title'));
  }
}
