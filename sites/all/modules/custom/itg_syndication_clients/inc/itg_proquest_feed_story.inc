<?php

/**
 * @file
 * The ITG Syndication clients for Proquest
 */
function itg_proquest_feed_story_syndication() {
  $sections = getproquest_feed_story_client_array();
  foreach ($sections as $section_id => $file_name) {
    itg_genrate_proquest_feed_story_syndication($section_id, $file_name);
  }
}

/**
 * menu callback for bsb story syndication
 */
function itg_genrate_proquest_feed_story_syndication($section_id = NULL, $file_name) {
  if (!empty($section_id)) {
    $section_name = get_term_name_by_tid($section_id);

    $type = array('story');
    $query = db_select('node', 'n');
    $query->leftJoin('field_data_body', 'dbody', 'dbody.entity_id=n.nid');
    $query->join('taxonomy_index', 'ti', 'ti.nid=n.nid');
    $query->leftJoin('field_data_field_itg_content_publish_date', 'npd', 'npd.entity_id=n.nid');
    $query->leftJoin('field_data_field_story_kicker_text', 'synopsis', 'synopsis.entity_id=n.nid');

    $query->condition('ti.tid', $section_id, '=');
    $query->fields('n', array('nid', 'title', 'created', 'changed'));
    $query->fields('dbody', array('body_value'));
    $query->fields('npd', array('field_itg_content_publish_date_value'));
    $query->fields('synopsis', array('field_story_kicker_text_value'));

    $query->condition('n.status', 1);
    $query->condition('n.type', $type, 'IN');
    $query->orderBy('n.created', 'DESC');
    $query->groupBy('n.nid')->range(0, 10);
    $result = $query->execute()->fetchAll(PDO::FETCH_ASSOC);

    $xml = genrate_proquest_feed_story_syndication_xml($result, $section_name);
    $xml_path = 'public://rss-feeds/ver1.0/proquest/42ecea07/it/stories/';
    $file_path = $xml_path . $file_name;
    $fp = fopen($file_path, "w");
    fwrite($fp, $xml);
    fclose($fp);
  }
}

function genrate_proquest_feed_story_syndication_xml($result = NULL, $category) {
  $xml = '';
  if (!empty($result)) {
    global $base_url;
    $xml = '<root>';
    foreach ($result as $key => $value) {
      $nid = $value['nid'];
      $publish_date = date("D, j M Y H:i:sP", strtotime($value['field_itg_content_publish_date_value']));
      $place = get_content_city($value['nid']);
      $keyword = get_content_tags($value['nid'], TRUE);
      $byline = get_byline_name_by_nid($nid);
      $url = $base_url . "/" . drupal_get_path_alias('node/' . $value['nid']);
      $body = remove_extra_tag_in_body($value["body_value"]);
      $kicker_text = preg_replace('/&(?!#?[a-z0-9]+;)/', ' ', html_entity_decode($value['field_story_kicker_text_value']));
      $article_type = slugify(preg_replace('/&(?!#?[a-z0-9]+;)/', ' ', html_entity_decode($category)));
      $xml .= '<article>';
      $xml .= '<magazine>India Today</magazine>';
      $xml .= '<articletype>' . $article_type . '</articletype>';
      $xml .= '<edition>' . $publish_date . '</edition>';
      $xml .= '<page></page>';
      $xml .= '<frequency></frequency>';
      $xml .= '<author></author>';
      $xml .= '<byline>' . $byline . '</byline>';
      $xml .= '<volumenumber></volumenumber>';
      $xml .= '<intellectualpropertyowner>Living Media India Limited</intellectualpropertyowner>';
      $xml .= '<headline><![CDATA[' . $value['title'] . ']]></headline>';
      $xml .= '<secondaryheadline><![CDATA[' . $kicker_text . ']]></secondaryheadline>';
      $xml .= '<bodytext><![CDATA[' . $body . ']]></bodytext>';
      $xml .= '</article>';
    }
    $xml .= '</root>';
  }
  return $xml;
}
