<?php
module_load_include('inc', 'itg_tv_schedule', 'include/tv_schedule_listing.inc');       

/*
 * Implementation of hook_permission()
 */
function itg_tv_schedule_permission() {
    return array(
      'administer my module' => array(
        'title' => t('Administer my module'),
        'description' => t('Permission for TV Schedule upload.'),
      ),
    );
}

/*
 * Implementation of hook_menu()
 */
function itg_tv_schedule_menu() {
    $items = array();

    $items['tv'] = array(
      'title' => 'Upload Tv Schedule',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('itg_tv_schedule_form'),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    );

    $items['tv-show'] = array(
      'title' => 'Tv Show Schedule',
      'page callback' => 'tv_schedule_listing',
      'page arguments' => array('itg_tv_schedule_search_form'),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
      'file' => 'include/tv_schedule_listing.inc',
    );

    return $items;
}

/*
 * Implementation of hook_form()
 */
function itg_tv_schedule_form($form, &$form_state) {

    $form['file'] = array(
      '#type' => 'managed_file',
      '#title' => t('Tv Schedule Upload'),
      '#description' => t('Allowed extensions: csv'),
      '#upload_location' => 'public://',
      '#upload_validators' => array(
        'file_validate_extensions' => array('csv'),
      ),
    );

    $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Submit'),
    );

    return $form;
}

function itg_tv_schedule_search_form($form, &$form_state) {

    $form['title'] = array(
      '#type' => 'textfield',
      '#size' => 60,
      '#maxlength' => 128,
    );
    
    $form['selected'] = array(
       '#type' => 'select',
       '#options' => array(
         0 => t('IST'),
         1 => t('PST'),
         2 => t('GMT')
       ),
       '#default_value' => 0,
       
   );
    
    $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Submit'),
    );

    return $form;
}

/**
 * Custom method for data uploading in database.
 */
function itg_tv_schedule_uploadmongo($file_id) {

    $f_id = $file_id;
    $itg_query = db_select('file_managed', 'f');
    $itg_query->condition('fid', $f_id, '=')
        ->fields('f', array('uri'));
    $itg_result = $itg_query->execute()->fetchField();
    $filename = substr($itg_result, 9);
    $filepath = "/var/www/html/itgcms/sites/default/files/";
    $fileaddress = $filepath . $filename;
    //p($fileaddress);



    $file = fopen($fileaddress, "r");
//connection with database
    $con = new Mongo();
    if ($con) {
// Select Database
        $db = $con->csvhandling;
// create collection
        $db->createCollection("itgcms_demos");
// Select Collection
        $people = $db->itgcms_demos;
        $upload_date = date("Y/m/d");
    }

    $i = 1;
    while (($data = fgetcsv($file)) !== FALSE) {
        if ($i > 1) {
            //monday corresponding value insertion
            if ($data[1]) {
                $qry = array("time" => $data[0], "day" => "MON", "program" => $data[1], "upload date" => $upload_date);
                $result = $people->insert($qry);
            }

            //tuesday corresponding value insertion
            if ($data[2]) {
                $qry = array("time" => $data[0], "day" => "TUE", "program" => $data[2], "upload date" => $upload_date);
                $result = $people->insert($qry);
            }

            //wednesday corresponding value insertion
            if ($data[3]) {
                $qry = array("time" => $data[0], "day" => "WED", "program" => $data[3], "upload date" => $upload_date);
                $result = $people->insert($qry);
            }


            //thursday corresponding value insertion
            if ($data[4]) {
                $qry = array("time" => $data[0], "day" => "THU", "program" => $data[4], "upload date" => $upload_date);
                $result = $people->insert($qry);
            }

            //friday corresponding value insertion
            if ($data[5]) {
                $qry = array("time" => $data[0], "day" => "FRI", "program" => $data[5], "upload date" => $upload_date);
                $result = $people->insert($qry);
            }

            //saturday corresponding value insertion
            if ($data[6]) {
                $qry = array("time" => $data[0], "day" => "SAT", "program" => $data[6], "upload date" => $upload_date);
                $result = $people->insert($qry);
            }

            //sunday corresponding value insertion
            if ($data[7]) {
                $qry = array("time" => $data[0], "day" => "SUN", "program" => $data[7], "upload date" => $upload_date);
                $result = $people->insert($qry);
            }
        }
        $i++;
    }

    fclose($file);
}

/**
 * Custom submit callback for saving csv file.
 */
function itg_tv_schedule_form_submit($form, &$form_state) {
    global $user;
    $file_id = $form_state['input']['file']['fid'];
    $file = file_load($form_state['values']['file']);
    $file->status = FILE_STATUS_PERMANENT;
    file_save($file);
    file_usage_add($file, 'user', 'user', $user->uid);
    drupal_set_message(t('The file has been submitted and saved, filename: @filename.', array('@filename' => $file->filename)));
    itg_tv_schedule_uploadmongo($file_id);
}

/**
 * Custom submit callback for searching popup.
 */
function itg_tv_schedule_search_form_submit($form, &$form_state) {
    
    $options = array('query' => array('title' => $form_state['input']['title']));
    drupal_goto('tv-show/' . arg(1), $options);
}

/**
 * Implements hook_theme().
 */
function itg_tv_schedule_theme() {
    return array(
      'itg_tv_schedule' => array(
        'variables' => array('output' => NULL),
        'variables' => array('search' => NULL),
        'path' => drupal_get_path('module', 'itg_tv_schedule') . '/templates',
        'template' => 'itg-tv-schedule',
      ),);
}
