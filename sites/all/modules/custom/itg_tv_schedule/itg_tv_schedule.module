<?php

module_load_include('inc', 'itg_tv_schedule', 'include/tv_schedule_listing.inc');

/**
 * Implementation of hook_permission()
 */
function itg_tv_schedule_permission() {
  return array(
    'itg_tv_schedule_form' => array(
      'title' => t('Administer my module'),
      'description' => t('Permission for TV Schedule upload.'),
    ),
  );
}

/**
 * Implementation of hook_menu()
 */
function itg_tv_schedule_menu() {
  $items = array();
  $items['tv'] = array(
    'title' => 'Upload Tv Schedule',
    'page callback' => 'itg_tv_schedule_channel_listing',
    'access arguments' => array('itg_tv_schedule_form'),
    'type' => MENU_CALLBACK,
  );
  $items['tv/%'] = array(
    'title' => 'Upload Tv Schedule',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('itg_tv_schedule_form'),
    'access arguments' => array('itg_tv_schedule_form'),
    'type' => MENU_CALLBACK,
  );
  $items['tv-show'] = array(
    'title' => 'Tv Schedule',
    'page callback' => 'tv_schedule_listing',
    'page arguments' => array('itg_tv_schedule_search_form'),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    'file' => 'include/tv_schedule_listing.inc',
  );
  $items['itg-tv-schedule-cron'] = array(
    'title' => 'Tv Schedule Cron',
    'page callback' => 'itg_tv_schedule_cron',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    'file' => 'include/tv_schedule_listing.inc',
  );
  return $items;
}

/**
 * Implementation of Tv channel listing()
 * {@inheritdoc}
 */

function itg_tv_schedule_channel_listing(){
  $con = '<div class="tv-channek-wrapper"><ul class="channel-listing">';
  $con .= '<li><a href="/tv/indiatoday" class="indiatoday-channel" >Indiatoday Channel</a></li>';
  $con .= '<li><a href="/tv/aajtak" class="aajtak-channel" >Aajtak Channel</a></li>';
  $con .= '<li><a href="/tv/dilliaajtak" class="dilliaajtak-channel" >Dilliaajtak Channel</a></li>';
  $con .= '<li><a href="/tv/tez" class="tez-channel" >Tez Channel</a></li>';
  $con .= '</ul></div>';
  return $con;
}


/**
 * Implementation of hook_form()
 * {@inheritdoc}
 */
function itg_tv_schedule_form($form, &$form_state) {
  $check_arg = array('indiatoday', 'aajtak', 'dilliaajtak', 'tez' );
  if(!in_array(arg(1), $check_arg)){
    drupal_not_found();
  }
  if(arg(1) == 'indiatoday'){
    $form['submit_button_1'] = array(
    '#type' => 'submit',
    '#value' => t('India today'),
    '#submit' => array('download_indiatoday_csv'),
    '#prefix' => '<div class="csv-download-wrapper float-right"><span class="download-sample">Dwonload Sample:</span>',
    '#suffix' => '</div>',
    '#limit_validation_errors' => array(),
    );
  }

  if(arg(1) == 'aajtak'){
    $form['submit_button_2'] = array(
      '#type' => 'submit',
      '#value' => t('Aajtak'),
      '#submit' => array('download_aajtak_csv'),
      '#prefix' => '<div class="csv-download-wrapper float-right"><span class="download-sample">Dwonload Sample:</span>',
      '#suffix' => '</div>',
      '#limit_validation_errors' => array(),
    );
  }
  if(arg(1) == 'dilliaajtak'){
    $form['submit_button_3'] = array(
      '#type' => 'submit',
      '#value' => t('Dilli aajtak'),
      '#submit' => array('download_delliaajtak_csv'),
      '#prefix' => '<div class="csv-download-wrapper float-right"><span class="download-sample">Dwonload Sample:</span>',
      '#suffix' => '</div>',
      '#limit_validation_errors' => array(),
    );
  }
  if(arg(1) == 'tez'){
    $form['submit_button_4'] = array(
      '#type' => 'submit',
      '#value' => t('Tez'),
      '#submit' => array('download_tez_csv'),
      '#prefix' => '<div class="csv-download-wrapper float-right"><span class="download-sample">Dwonload Sample:</span>',
      '#suffix' => '</div>',
      '#limit_validation_errors' => array(),
    );
  }

  $form['file'] = array(
    '#name' => 'upload_csv',
    '#type' => 'managed_file',
    '#required' => TRUE,
    '#title' => t('Tv Schedule Upload'),
    '#description' => t('Allowed extensions: csv'),
    '#upload_location' => 'public://tv_schedule',
    '#upload_validators' => array(
      'file_validate_extensions' => array('csv'),
    ),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#prefix' => '<div class="form-actions">',
    '#suffix' => '</div>',
    '#value' => t('Submit'),
  );

  $form['submit_preview_publish'] = array(
  '#type' => 'submit',
  '#value' => t('Publish'),
  '#submit' => array('itg_publish_fun'),
  '#prefix' => '<div class="preview-publish-wrapper float-right"><a target="_blank" href="'.FRONT_URL.'/tv-schedule?action=preview"><input class="preview form-submit" type="button" id="edit-button-preview" name="preview" value="Preview"></a>',
  '#suffix' => '</div>',
  '#limit_validation_errors' => array(),
  );
  $form['#after_build'][] = 'itg_tv_schedule_after_build';

  return $form;
}


/**
 * After build for tv schedule form.
 * @param array $form
 * @param array $form_state
 * @return array
 */
function itg_tv_schedule_after_build($form, &$form_state) {
  drupal_add_js('jQuery(document).ready(function() {
    jQuery("#edit-file-upload-button").hide("");
  });', array('type' => 'inline', 'scope' => 'footer'));
  return $form;
}


/**
 * Custom submit callback for Publish.
 * {@inheritdoc}
 */

function itg_publish_fun(){
  $allowed = array('indiatoday'=>'Indiatoday_tvschedule.csv', 'aajtak'=>'aajtak_tvschedule.csv', 'dilliaajtak'=>'Dilliaajtak_tvschedule.csv', 'tez'=>'tez_tvschedule.csv');
  $db = mongodb();
  if (isset($db)) {
    $people = $db->tv_schedule;
    $people->update(
    array("status" => 0, 'filetype' =>$allowed[arg(1)]),
    array('$set' => array('status' => 1)),
    array("multiple" => true)
  );
    drupal_set_message(t('Published successfully!'));
  }
  else {
    drupal_set_message(t('Mongo DB connection failed!'));
  }
}


/**
 * Custom submit callback for downloading indiatoday, tez, aajtak, dilliaajtak csv file.
 * {@inheritdoc}
 */

function download_indiatoday_csv(){
  $filename = 'Indiatoday_tvschedule.csv';
  $filepath = file_create_url(file_default_scheme() . '://\/tv_schedule/sample/Indiatoday_tvschedule.csv');
  drupal_add_http_header('Content-disposition', 'attachment; filename=' . $filename);
  readfile($filepath);
  exit;
}

function download_aajtak_csv(){
  $filename = 'aajtak_tvschedule.csv';
  $filepath = file_create_url(file_default_scheme() . '://\/tv_schedule/sample/aajtak_tvschedule.csv');
  drupal_add_http_header('Content-disposition', 'attachment; filename=' . $filename);
  readfile($filepath);
  exit;
}

function download_delliaajtak_csv(){
  $filename = 'Dilliaajtak_tvschedule.csv';
  $filepath = file_create_url(file_default_scheme() . '://\/tv_schedule/sample/Dilliaajtak_tvschedule.csv');
  drupal_add_http_header('Content-disposition', 'attachment; filename=' . $filename);
  readfile($filepath);
  exit;
}
function download_tez_csv(){
  $filename = 'tez_tvschedule.csv';
  $filepath = file_create_url(file_default_scheme() . '://\/tv_schedule/sample/tez_tvschedule.csv');
  drupal_add_http_header('Content-disposition', 'attachment; filename=' . $filename);
  readfile($filepath);
  exit;
}

/**
 * Implementation of hook_form
 * {@inheritdoc}
 */
function itg_tv_schedule_search_form($form, &$form_state) {

  $form['title'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#attributes' => array('placeholder' => t('Search')),
    '#maxlength' => 128,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );

  return $form;
}

/**
 * Implementation of hook_form
 * {@inheritdoc}
 */
function itg_tv_schedule_date_form($form, &$form_state) {
  $arg = arg();
  if (isset($_GET['date_zone'])) {
    $date = str_replace('/', '-', $_GET['date_zone']);
  }
  else {
    $date = format_date(REQUEST_TIME, 'custom', 'Y-m-d');
  }

  if (empty($_GET['date_zone']) && $arg[1]) {
    $get_day_date = get_tv_schedule_date($arg[1], 'yes');
    $assign_date  = strtotime($get_day_date['program']);
    $date = format_date(str_replace('/', '-', $assign_date), 'custom', 'Y-m-d');
  }

  $form['date'] = array(
      '#default_value' => $date,
      '#date_format' => 'Y/m/d',
      '#date_year_range' => '-1:+0',
      '#type' => 'date_popup',
      '#datepicker_options' => array('maxDate' => 0),
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t(''),
  );

  drupal_add_js('jQuery("#edit-date-datepicker-popup-1").datepicker({dateFormat: "yy/mm/dd",
    onSelect: function(dateText, inst) {
        jQuery("#itg-tv-schedule-date-form").submit();
       }
});', array('type' => 'inline', 'scope' => 'footer'));

  return $form;
}

/**
 * Implementation of hook_form
 * {@inheritdoc}
 */
function itg_tv_schedule_time_form($form, &$form_state) {

  $form['time_zone'] = array(
    '#type' => 'select',
    '#options' => array(
      'IST' => t('IST'),
      'PST' => t('PST'),
      'GMT' => t('GMT')
    ),
    '#default_value' => (isset($_GET['time_zone']) ? $_GET['time_zone'] : 'IST'),
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );

  drupal_add_js('jQuery("#edit-time-zone").change(function() {
                     jQuery("#itg-tv-schedule-time-form").submit();
                 });', array('type' => 'inline', 'scope' => 'footer'));

  return $form;
}

/**
 * Custom method for data uploading in database.
 *
 * @param integer $file_id
 * @return bool
 */
function itg_tv_schedule_uploadmongo($file_id, $filename) {
    $i = 1;
    $flag = 0;
    $status = 0;
    $upload_date = date("Y/m/d");
    $itg_query = db_select('file_managed', 'f');
    $itg_result = $itg_query->condition('fid', $file_id, '=')
            ->fields('f', array('uri'))->execute()->fetchField();
    $file_url = file_create_url($itg_result);
    $file = fopen($file_url, "r");
    while (($data = fgetcsv($file)) !== FALSE) {
        if ($i == 1) {
            if (isItValidDate($data[1]) && isItValidDate($data[2]) && isItValidDate($data[3]) && isItValidDate($data[4]) && isItValidDate($data[5]) && isItValidDate($data[6]) && isItValidDate($data[7])) {
                $mondate = changeDateFormat($data[1]);
                $tuedate = changeDateFormat($data[2]);
                $weddate = changeDateFormat($data[3]);
                $thudate = changeDateFormat($data[4]);
                $fridate = changeDateFormat($data[5]);
                $satdate = changeDateFormat($data[6]);
                $sundate = changeDateFormat($data[7]);
                $flag = 1;
                break;
            }
        }
    }
    if ($flag == 1) {
        // execute when appropriate file uploaded
        // connection with database
        $db = mongodb();
        if (isset($db)) {
            $people = $db->tv_schedule;
            $ret = $people->remove(array('filetype' => $filename));
        }
        else {
            return FALSE;
        }


        while (($data = fgetcsv($file)) !== FALSE) {

            if ($i > 3) {
                // monday corresponding value insertion
                if ($data[1]) {
                    $query = array("time" => $data[0], "day" => "MON", "program" => $data[1], "upload date" => $upload_date, "program date" => $mondate, "filetype" => $filename, "status" => $status);
                    $people->insert($query);
                }

                //tuesday corresponding value insertion
                if ($data[2]) {
                    $query = array("time" => $data[0], "day" => "TUE", "program" => $data[2], "upload date" => $upload_date, "program date" => $tuedate, "filetype" => $filename, "status" => $status);
                    $people->insert($query);
                }

                //wednesday corresponding value insertion
                if ($data[3]) {
                    $query = array("time" => $data[0], "day" => "WED", "program" => $data[3], "upload date" => $upload_date, "program date" => $weddate, "filetype" => $filename, "status" => $status);
                    $people->insert($query);
                }

                //thursday corresponding value insertion
                if ($data[4]) {
                    $query = array("time" => $data[0], "day" => "THU", "program" => $data[4], "upload date" => $upload_date, "program date" => $thudate, "filetype" => $filename, "status" => $status);
                    $people->insert($query);
                }

                //friday corresponding value insertion
                if ($data[5]) {
                    $query = array("time" => $data[0], "day" => "FRI", "program" => $data[5], "upload date" => $upload_date, "program date" => $fridate, "filetype" => $filename, "status" => $status);
                    $people->insert($query);
                }

                //saturday corresponding value insertion
                if ($data[6]) {
                    $query = array("time" => $data[0], "day" => "SAT", "program" => $data[6], "upload date" => $upload_date, "program date" => $satdate, "filetype" => $filename, "status" => $status);
                    $people->insert($query);
                }

                //sunday corresponding value insertion
                if ($data[7]) {
                    $query = array("time" => $data[0], "day" => "SUN", "program" => $data[7], "upload date" => $upload_date, "program date" => $sundate, "filetype" => $filename, "status" => $status);
                    $people->insert($query);
                }
            }
            $i++;
        }

        fclose($file);

        return TRUE;
    }
    return FALSE;
}

/**
 * Implements hook_file_validate().
 */
function itg_tv_schedule_file_validate($file) {
  $allowed = array('indiatoday'=>'Indiatoday_tvschedule.csv', 'aajtak'=>'aajtak_tvschedule.csv', 'dilliaajtak'=>'Dilliaajtak_tvschedule.csv', 'tez'=>'tez_tvschedule.csv');
  if ($allowed[arg(1)] !== $file->filename) {
    $errors = array();
    $errors[] = 'Inappropriate csv file name, Filename must be "'.$allowed[arg(1)].'';
    return $errors;
  }
}


/**
 * Custom submit callback for saving csv file.
 * {@inheritdoc}
 */
function itg_tv_schedule_form_submit($form, &$form_state) {
    global $user;
    $file_id = $form_state['input']['file']['fid'];
    $file = file_load($form_state['values']['file']);
    $file->status = FILE_STATUS_PERMANENT;
    file_save($file);
    file_usage_add($file, 'user', 'user', $user->uid);
    //if ($file_id === '0') {
    if ($file->fid === '0') {
        drupal_set_message(t('Before submit please upload the file'));
    }
    else {
        //$value = itg_tv_schedule_uploadmongo($file_id);
        $value = itg_tv_schedule_uploadmongo($file->fid, $file->filename);
        if ($value == TRUE) {
            drupal_set_message(t('The file has been submitted successfully, Filename: @filename.', array('@filename' => $file->filename)));
        }
        else {
            drupal_set_message(t('Inappropriate csv file'));
        }
    }
}

/**
 * Custom validation for searching popup.
 * {@inheritdoc}
 */
function itg_tv_schedule_search_form_validate($form, &$form_state) {
  $options = $form_state['input']['title'];
  if (empty($options)) {
    form_set_error('title', t('Search field is empty.'));
  }
}

/**
 * Custom submit callback for searching popup.
 * {@inheritdoc}
 */
function itg_tv_schedule_search_form_submit($form, &$form_state) {
  // check if title field is blank befor submit
  if(!empty($form_state['input']['title'])) {
    $options = array('query' => array('title' => $form_state['input']['title']));

    drupal_goto('tv-show/', $options);
  }
}

/**
 * Custom submit callback for searching popup.
 * {@inheritdoc}
 */
function itg_tv_schedule_time_form_submit($form, &$form_state) {
  $options = array('query' => array('time_zone' => $form_state['input']['time_zone']));
  drupal_goto('tv-show/' . arg(1), $options);
}

/**
 * Custom submit callback for searching popup.
 * {@inheritdoc}
 */
function itg_tv_schedule_date_form_submit($form, &$form_state) {
   $options = array('query' => array('date_zone' => $form_state['input']['date']['date']));

   drupal_goto('tv-show/', $options);
}

/**
 * Implements hook_theme().
 */
function itg_tv_schedule_theme() {
  return array(
    'itg_tv_schedule' => array(
      'variables' => array('output' => NULL),
      'variables' => array('search' => NULL),
      'variables' => array('total' => NULL),
      'variables' => array('noresult' => NULL),
      'variables' => array('search_count' => NULL),
      'variables' => array('title' => NULL),
      'variables' => array('no_result' => NULL),
      'path' => drupal_get_path('module', 'itg_tv_schedule') . '/templates',
      'template' => 'itg-tv-schedule',
    ),
  );
}

/**
 * Custom method for time conversion.
 *
 * @param string $date
 * @param string $time_zone
 * @return string
 */
function time_zone_conversion($date, $time_zone) {

  $date = explode('-', $date);
  date_default_timezone_set('Asia/Kolkata');
  if (isset($date[0])) {
    $time = new DateTime($date[0]);
    $timezone = timezone_list();

    if ($time_zone == 'GMT') {
      $time->setTimezone(new DateTimeZone($timezone['GMT']));
    }
    elseif ($time_zone == 'PST') {
      $time->setTimezone(new DateTimeZone($timezone['GMT-07:00']));
    }
    else {
      return $time->format('H:i');
    }

    return $time->format('H:i');
  }
}

/**
 * Custom method for different timezones.
 *
 * @return string
 */
function timezone_list() {
  static $timezones = NULL;

  if ($timezones === NULL) {
    $timezones = [];
    $offsets = [];
    $now = new DateTime();

    foreach (DateTimeZone::listIdentifiers() as $timezone) {
      $now->setTimezone(new DateTimeZone($timezone));
      $offsets[] = $offset = $now->getOffset();
      $timezones[format_gmt_offset($offset)] = $timezone;
    }

    array_multisort($offsets, $timezones);
  }

  return $timezones;
}

/**
 * Custom method for time formatting.
 * @param integer $offset
 * @return string
 */
function format_gmt_offset($offset) {
  $hours = intval($offset / 3600);
  $minutes = abs(intval($offset % 3600 / 60));
  return 'GMT' . ($offset ? sprintf('%+03d:%02d', $hours, $minutes) : '');
}

/**
 * Custom method for date validate.
 * @param string $date
 * @return boolean
 */
function isItValidDate($date) {
  if(preg_match("/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/", $date, $matches)) {
   if(checkdate($matches[2], $matches[1], $matches[3])) {
     return true;
    }
  }
 }

/**
 * Custom method for change date format.
 * @param string $date
 * @return string
 */

 function changeDateFormat($date){
  $date = DateTime::createFromFormat('d/m/Y', $date);
  return $date->format('Y/m/d');
 }

 /**
  * Helper function to return date by day
  */
 function get_tv_schedule_date($day, $type) {
  if (function_exists('mongodb')) {
    $db = mongodb();
    if (isset($db)) {
      $people = $db->tv_schedule;
      $date = $final_id;
      if ($type == 'yes') {
        $cond = array('day' => $day);
      }
      if ($type == 'no') {
        $cond = array('program date' => $day);
      }
      $cursor = $people->find($cond);
      foreach ($cursor as $document) {
        if ($type == 'yes') {
          $data['program'] = $document['program date'];
        }
        if ($type == 'no') {
          $data['program'] = $document['day'];
        }
      }
      return $data;
    }
  }
}
