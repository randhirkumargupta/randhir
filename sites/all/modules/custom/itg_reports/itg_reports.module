<?php

/**
 * @file
 *   Display front user reports to administrator user.
 */

/**
 * Implements hook_permission().
 *
 * {@inheritdoc}.
 */
function itg_reports_permission() {
    return array(
        'view report dashboard' => array(
            'title' => t('ITG Reports')
        ),
    );
}

/**
 * Implements hook_menu().
 *
 * {@inheritdoc}.
 */
function itg_reports_menu() {
    // Menu links for cms report user dashboard.
    $items['itg-report-dashboard'] = array(
        'title' => 'User Dashboard',
        'page callback' => 'itg_report_user_dashboard',
        'access arguments' => array('view report dashboard'),
        'type' => MENU_NORMAL_ITEM,
        'file' => 'includes/itg_reports.helper.inc',
    );
    // Menu form email autocomplete.
    $items['itg-reports-mail/autocomplete'] = array(
        'page callback' => 'itg_reports_email_autocomplete',
        'access arguments' => array('view report dashboard'),
        'type' => MENU_CALLBACK,
        'file' => 'includes/itg_reports.helper.inc',
    );
    // Menu form email autocomplete.
    $items['itg-registered-user-report/%'] = array(
        'page callback' => 'itg_registered_user_report',
        'page arguments' => array(1),
        'access arguments' => array('administer nodequeue'),
        'type' => MENU_CALLBACK,
        'file' => 'includes/itg_reports.helper.inc',
    );
    
    // Menu form active users reports.
    $items['itg-active-user-report'] = array(
        'page callback' => 'drupal_get_form',
        'page arguments' => array('itg_active_user_report_form'),
        'access arguments' => array('administer nodequeue'),
        'type' => MENU_CALLBACK,
        'file' => 'includes/itg_users_reports.inc',
    );
    
    return $items;
}

/**
 * Implements hook_theme().
 * {@inheritdoc}
 */
function itg_reports_theme($existing, $type, $theme, $path) {
    $themes = array(
        'itg_reports_dashboard' => array(
            'variables' => array('data' => NULL),
            'template' => 'templates/itg-reports-dashboard',
        ),
        'itg_reports_career_graph' => array(
            'variables' => array('output' => NULL, 'actor' => NULL),
            'template' => 'templates/itg-reports-career-graph',
        ),
    );

    return $themes;
}

/**
 * Implements  hook_form_FORM_ID_alter().
 *
 * {@inheritdoc}.
 */
function itg_reports_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {

    switch ($form['#id']) {

        case 'views-exposed-form-comparative-report-cm-page':
            $form['uid']['#attributes'] = array('placeholder' => 'Search by user name');
            $form['mail']['#attributes'] = array('placeholder' => 'Search by user email');
            $form['mail']['#autocomplete_path'] = 'itg-reports-mail/autocomplete';
          break;
        case 'views-exposed-form-report-filed-content-page':
            // remove archive and unpublish on list
            $option = array();

            foreach ($form['state']['#options'] as $key => $option_val) {

                if ($key != 'un_published' && $key != 'archive') {
                    $option[$key] = $option_val;
                }
            }
            $form['node_status']['#options'] = $form['node_status']['#options'] + array("" => 'Archive');
            $form['state']['#options'] = $option;
            $form['field_story_category_tid']['#attributes'] = array('placeholder' => 'Search by section name');
            $form['uid']['#attributes'] = array('placeholder' => 'Search by user name');
            $form['mail']['#attributes'] = array('placeholder' => 'Search by user email');
            $form['node_status']['#options'][1] = t('Published');
            $form['node_status']['#options'][0] = t('Not published');
            $form['moderation'] = array(
                '#title' => t('Moderation'),
                '#type' => 'select',
                '#options' => array('all' => 'Any', 'yes' => 'Yes', 'no' => 'No'),
                '#default_value' => 'all',
            );
            $form['mail']['#autocomplete_path'] = 'itg-reports-mail/autocomplete';
            $form['date_filter']['min']['#attributes'] = array('autocomplete' => 'off', 'readonly' => 'readonly', 'placeholder' => t('Start Date'));
            unset($form['date_filter']['min']['#title']);
            $form['date_filter']['max']['#attributes'] = array('autocomplete' => 'off', 'readonly' => 'readonly', 'placeholder' => t('End Date'));
            unset($form['date_filter']['max']['#title']);
            $form['from_state']['#prefix'] = '<div style="display: none;">';
            $form['from_state']['#suffix'] = '</div>';
            $form['#after_build'][] = 'itg_reports_view_after_build';

            break;
        case 'views-exposed-form-comparative-report-cm-page':
            $form['tid']['#attributes'] = array('placeholder' => 'Search by section name');
            $form['date_filter']['min']['#attributes'] = array('autocomplete' => 'off', 'readonly' => 'readonly', 'placeholder' => t('Start Date'));
            unset($form['date_filter']['min']['#title']);
            $form['date_filter']['max']['#attributes'] = array('autocomplete' => 'off', 'readonly' => 'readonly', 'placeholder' => t('End Date'));
            unset($form['date_filter']['max']['#title']);
            $form['#after_build'][] = 'itg_reports_view_after_build';

            break;
        case 'views-exposed-form-readers-reports-page':
              $form['mail']['#attributes'] = array('placeholder' => t('Search by email'));
              $form['mail']['#autocomplete_path'] = 'itg-reports-mail/autocomplete';
              $form['field_mobile_number_value']['#attributes'] = array('placeholder' => t('Search by mobile number'));
            break;
        case 'views-exposed-form-movies-master-page':
            $form['tid']['#attributes'] = array('placeholder' => t('Search by movie name'));
            $form['field_movie_earning_value']['min']['#attributes'] = array('placeholder' => t('Start range'));
            $form['field_movie_earning_value']['max']['#attributes'] = array('placeholder' => t('End range'));
            unset($form['field_movie_earning_value']['max']['#title']);
            break;
        case 'views-exposed-form-users-reports-page':
            $form['created']['min']['#type'] = 'date_popup';
            $form['created']['min']['#date_format'] = 'd/m/Y';
            $form['created']['max']['#attributes']['placeholder'] = 'Date To';
            $form['created']['min']['#attributes']['placeholder'] = 'Date From';
            $form['created']['max']['#type'] = 'date_popup';
            $form['created']['max']['#date_format'] = 'd/m/Y';
            break;
    }
}

/**
 * Implements after build function for views exposed form.
 * {@inheritdoc}.
 */
function itg_reports_view_after_build($form, &$form_state) {
    $form['#attached']['js'] = array(
        drupal_get_path('module', 'itg_reports') . '/js/itg_reports.js',
    );

    return $form;
}

/**
 * Implements hook_block_info().
 *
 * {@inheritdoc}.
 */
function itg_reports_block_info() {
    // Career graph.
    $blocks['itg_report_career_graph'] = array(
        'info' => t('Career Graph'),
        'cache' => DRUPAL_CACHE_GLOBAL,
    );

    return $blocks;
}

/**
 * Implements hook_block_view().
 *
 * {@inheritdoc}.
 */
function itg_reports_block_view($delta = '') {
    switch ($delta) {
        case 'itg_report_career_graph':
            $output = array();
            $data = itg_report_get_graph_data();
            drupal_add_js(drupal_get_path('module', 'itg_reports') . '/js/canvasjs.min.js');
            $errors = array_filter($data);
            if (!empty($errors)) {
                foreach ($data as $key => $chart_data) {
                    $errors = array_filter($chart_data['graph']);
                    if (empty($errors)) {
                        continue;
                    }
                    $chart = array(
                        '#type' => 'chart',
                        '#chart_type' => 'line',
                        '#chart_library' => 'highcharts',
                        '#legend' => FALSE,
                    );

                    // Add missing year.
                    itg_reports_missing_year($chart_data['graph']);
                    if (!empty($chart_data['graph'])) {
                        foreach ($chart_data['graph'] as $g_data) {

                            $graph_d[$g_data[0]] = $g_data;
                        }
                    }

                    $chart['career'] = array(
                        '#type' => 'chart_data',
                        '#data' => $chart_data['graph'],
                        '#title' => t($chart_data['actor'][$key]['actor_name']),
                    );
                    $chart['xaxis'] = array(
                        '#type' => 'chart_xaxis',
                        '#title' => t('Year'),
                    );


                    $chart['yaxis'] = array(
                        '#type' => 'chart_yaxis',
                        '#title' => t('Earning'),
                    );
                    $career_graph['chart'] = $chart;

                    $output[] = $career_graph;
                    $actor_info[] = array(
                        'name' => $chart_data['actor'][0]['actor_name'],
                        'pic_uri' => $chart_data['actor'][0]['actor_pic'],
                    );
                }
            }
            $block['content'] = theme('itg_reports_career_graph', array('output' => $output, 'actor' => $actor_info));

            break;
    }

    return $block;
}

/**
 * Get graph data from database.
 * 
 * @return array
 *   Array of chart data.
 */
function itg_report_get_graph_data() {
    global $base_url;
    $arg = arg();
    $chart_data = array();
    $node = node_load($arg[1]);
    foreach ($node->field_mega_review_career_graph['und'] as $field_collection) {
        $data = array();
        $actor_data = array();
        foreach ($field_collection['entity']->field_reporter_movie_name['und'] as $key => $tids) {
            $movie_details = taxonomy_term_load($tids['tid']);
            $movie_name = $movie_details->name;
            $timestamp = $movie_details->field_reporter_movie_year['und'][0]['value'];
            $movie_year = format_date($timestamp, 'custom', 'Y');
            $actor_pic_uri = $field_collection['entity']->field_story_extra_large_image['und'][0]['uri'];
            if (empty($actor_pic_uri)) {
                $actor_pic_real_uri = file_create_url($base_url . '/' . drupal_get_path('theme', 'itg') . '/images/default_career_graph.png');
            }
            else {
                $actor_pic_real_uri = $actor_pic_uri;
            }
            $actor_data[] = array(
                'actor_name' => $field_collection['entity']->title,
                'movie_name' => $movie_name,
                'actor_pic' => $actor_pic_real_uri,
            );
            $data[] = array(
                (int) $movie_year,
                (int) $movie_details->field_movie_earning['und'][0]['value'],
                $movie_name
            );
        }
        $chart_data[] = array(
            'actor' => $actor_data,
            'graph' => $data,
        );
    }

    return $chart_data;
}

/**
 * Ad missing year to the chart data.
 *
 * @param array $chart_data
 *   Array containing year wise data of celebrity career graph.
 *
 * @return array
 *   Sorted array with missing intervals.
 */
//function itg_reports_missing_year(&$chart_data) {
//  $data = array();
//  array_multisort($chart_data);
//  $temp = NULL;
//  foreach ($chart_data as $value) {
//    if (!empty($temp) && ($temp + 1) != $value[0]) {
//      ++$temp;
//      while ($temp < $value[0]) {
//        $data[] = array(
//          $temp++,
//          NULL
//        );
//      }
//    }
//    $temp = $value[0];
//  }
//  $chart_data = array_merge($chart_data, $data);
//  array_multisort($chart_data);
//  $min_step = count($chart_data);
//  $data = array();
//  if ($min_step < 6) {
//    while ($min_step <= 6) {
//      $data[] = array(
//        $temp++,
//        NULL
//      );
//      ++$min_step;
//    }
//    $chart_data = array_merge($chart_data, $data);
//    array_multisort($chart_data);
//  }
//}
/**
 * Ad missing year to the chart data.
 *
 * @param array $chart_data
 *   Array containing year wise data of celebrity career graph.
 *
 * @return array
 *   Sorted array with missing intervals.
 */
function itg_reports_missing_year(&$chart_data) {
    $data = array();
    array_multisort($chart_data);
    $temp = NULL;
    foreach ($chart_data as $value) {
        if (!empty($temp) && ($temp + 1) != $value[0]) {
            ++$temp;
            while ($temp < $value[0]) {
                $data[] = array(
                    $temp++,
                    NULL
                );
            }
        }
        $temp = $value[0];
    }
    $chart_data = array_merge($chart_data, $data);
    array_multisort($chart_data);
    $min_step = count($chart_data);
    $data = array();
    if ($min_step < 6) {
        while ($min_step <= 6) {
            $data[] = array(
                $temp++,
                NULL
            );
            ++$min_step;
        }
        $chart_data = array_merge($chart_data, $data);
        array_multisort($chart_data);
    }
}

/**
 * This function use for entry user on social node share 
 */
function itg_report_get_node_share($nid, $count = 0) {

    $query = db_select('itg_node_share_count', 'insc')
            ->fields('insc', array('share_count'))
            ->condition('insc.nid', $nid, '=');
    $result = $query->execute()->fetchField();
    if (!empty($result) && $count < $result) {
        $count = (int) $count + (int) $result;
    }

    $pre_save = array(
        'nid' => $nid,
        'share_count' => $count
    );
  
    // iNSERT INTO DATABASE
   db_merge('itg_node_share_count')
  	->key(array(
        'nid' => $nid))
  	->fields($pre_save)
  	->execute();
    $query1 = db_select('itg_node_share_count', 'insc')
            ->fields('insc', array('share_count'))
            ->condition('insc.nid', $nid, '=');
    $result1 = $query1->execute()->fetchField();
    return $result1;
}

/**
 * Get node edit count from revision table.
 *
 * @param int $output
 *   Unique node id of the node.
 * 
 * @return int
 *   Total count of the node edit.
 */
function itg_report_node_edit_count($output) {
    $result = 0;
    try {
        $itg_query = db_select('node_revision', 'n');
        $itg_query->fields('n', array('nid'))
                ->condition('nid', $output);
        $result = $itg_query->execute()->rowCount();
    } catch (Exception $ex) {
        drupal_set_message($ex->getMessage(), 'error');
    }

    return $result;
}

/**
 * Implements hook_views_pre_render().
 *
 * {@inheritdoc}.
 */
function itg_reports_views_pre_render(&$view) {
    switch ($view->name) {
        case 'report_filed_content':
            foreach ($view->result as $rows) {
                $rows->nid = itg_report_node_edit_count($rows->nid);
            }
            $header_content = '<span class="count">Count(' . $view->total_rows . ')&nbsp;</span>';
            $view->attachment_before = $header_content;

            break;
    }
}

/**
 * Implements hook_form_alter().
 *
 * {@inheritdoc}.
 */
function itg_reports_form_alter(&$form, &$form_state, $form_id) {
    if ($form_id == 'taxonomy_form_term') {
        if (is_array($form['#term'])) {
            if (isset($form['#term']['vocabulary_machine_name']) && $form['#term']['vocabulary_machine_name'] == 'movies') {
                $form['relations']['#prefix'] = '<div style="display:none;">';
                $form['relations']['#suffix'] = '</div>';
            }
        }
        if (is_object($form['#term'])) {
            if (isset($form['#term']->vocabulary_machine_name) && $form['#term']->vocabulary_machine_name == 'movies') {
                $form['relations']['#prefix'] = '<div style="display:none;">';
                $form['relations']['#suffix'] = '</div>';
            }
        }
    }
}

/**
 * Implements hook_form_alter().
 *
 * {@inheritdoc}.
 */
function itg_reports_user_login(&$edit, $account) {
  $user_required_data = array();
  $user_required_data['uid'] = $account->uid;
  $user_required_data['name'] = $account->name;
  $user_required_data['mail'] = $account->mail;
  $user_required_data['created'] = (int) $account->created;
  $user_required_data['access'] = (int) $account->access;
  $user_required_data['login'] = (int) $account->login;
  $user_required_data['mobile'] =  $account->field_mobile_number['und'][0]['value'];
  module_load_include('inc', 'itg_reports', 'includes/itg_users_reports');
  _itg_report_save_active_user_data($user_required_data);
}
