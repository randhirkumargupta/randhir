<?php

/**
 * @file
 *
 * Purpose: ITG social media integration module.
 */
require 'vendor/autoload.php';
module_load_include('inc', 'itg_social_media', 'includes/itg_social_media.form');
module_load_include('inc', 'itg_social_media', 'includes/itg_social_media.settings');

// Define static variable for setting purpose.
define('FACEBOOK_APP_KEY', '998850543526214');
define('FACEBOOK_APP_SECRET', '899729807fcf2061364278613db4a4e7');
define('TWITTER_API_KEY', 'ZrAM49Mh50YKRxRTtLY1mP1jE');
define('TWITTER_API_SECRET', 'GBNz25BRuSYcNJiWyTtsBSCrb6mDWNxtZrK4EHm0tmjB54Zpzi');

// Local settings
//define('TWITTER_API_KEY', 'oynNx70nQQo8aWUlcYtc7BUDX');
//define('TWITTER_API_SECRET', '2RsvsZLF5hpEcFIjHvqbUNxoeqFStyB9ZEAxognUjVaBWz2r8X');

/**
 * Implement hook_permissions()
 */
function itg_social_media_permission() {
  return array(
    'administer itg_social_media edit_content settings' => array(
      'title' => t('Edit social media section'),
      'description' => t('Using this permission user can edit social media part of any node.'),
    ),
  );
}

/**
 * Implements hook_menu()
 * {@inheritdoc}
 */
function itg_social_media_menu() {
  // Facebook login screen
  $items['itg-social-media-settings'] = array(
    'title' => t('Social Media Settings'),
    'page callback' => 'itg_social_media_settings',
    'access arguments' => array('administer itg_social_media edit_content settings'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/itg_social_media.settings.inc',
  );
  // Facebook login callback
  $items['itg-social-media-settings-callback'] = array(
    'page callback' => 'itg_social_media_settings_callback',
    'access arguments' => array('administer itg_social_media edit_content settings'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/itg_social_media.settings.inc',
  );
  $items['twitter-login'] = array(
    'page callback' => 'itg_social_media_twitter_login',
    'access arguments' => array('administer itg_social_media edit_content settings'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/itg_social_media.settings.inc',
  );
  $items['twitter/oauth'] = array(
    'page callback' => 'itg_social_media_twitter_callback',
    'access arguments' => array('administer itg_social_media edit_content settings'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/itg_social_media.settings.inc',
  );

  return $items;
}

/**
 * Implements hook_form_alter()
 * {@inheritdoc}
 */
function itg_social_media_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['created']['min'])) {
    $form['created']['min'] = array(
      '#title' => t('Start Date'),
      '#type' => 'date_popup',
      '#date_format' => 'd/m/Y',
      '#date_year_range' => '-3:+3',
    );
    $form['created']['max'] = array(
      '#title' => t('End Date'),
      '#type' => 'date_popup',
      '#date_format' => 'd/m/Y',
      '#date_year_range' => '-3:+3',
    );
  }
}

/**
 * Implements hook_block_info()
 *
 * {@inheritdoc}
 */
function itg_social_media_block_info() {
  $block = array();
  $block['social_media_form'] = array(
    'info' => t('Social Media Integration'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $block;
}

/**
 * Implements hook_block_view()
 * {@inheritdoc}
 */
function itg_social_media_block_view($delta = '') {
  $block = array();
  $arg = arg();
  if (isset($arg[1])) {
    $c_type = itg_social_media_node_type(check_plain($arg[1]));
    $nid = check_plain($arg[1]);
  }
  switch ($delta) {
    case 'social_media_form':
      $block = array(
        'subject' => t('Social media Integration'),
        'content' => drupal_get_form('itg_social_media_form', $c_type, $nid),
      );

      break;
  }

  return $block;
}

/**
 * get type of the node from nid.
 *
 * @param int $nid
 * @return string
 */
function itg_social_media_node_type($nid) {
  $itg_query = db_select('node', 'n');
  $itg_query->fields('n', array('type'))
      ->condition('nid', $nid);
  $itg_result = $itg_query->execute()->fetchField();

  return $itg_result;
}

/**
 * Set file status to permanant after save.
 * @global stdObject $user
 * @param int $fid
 */
function itg_social_media_perm_file($fid) {
  $file = file_load($fid);

  return $file;
}

/**
 * Facebook video post logic
 */
function itg_social_media_facebook_post($fid, $desc, $type) {
  // Set file status to permanent
  $file = itg_social_media_perm_file($fid);
  // Get file real path
  $path = drupal_realpath($file->uri);
  // Get connection object
  $fb = itg_social_media_fb_connection();
  // Get page information
  $page_id = _facebook_get_page_info($fb);

  // Get short url
  $short_url = shorten_url($node->path['alias'], 'goo.gl');

  switch ($type) {
    case 'videos':
      $data = [
        'title' => t('Yogesh kumar'),
        'description' => t($desc),
        'source' => $fb->videoToUpload($path),
      ];

      break;

    case 'photos':
      $data = [
        'message' => t($desc),
        'source' => $fb->fileToUpload($path),
      ];

      break;
  }
  try {
    $response = $fb->post($page_id['page_id'], $data, $page_id['access_token']);
  }
  catch (Facebook\Exceptions\FacebookResponseException $e) {
    // When Graph returns an error
    drupal_set_message('Graph returned an error: ' . $e->getMessage(), 'error');
  }
  catch (Facebook\Exceptions\FacebookSDKException $e) {
    // When validation fails or other local issues
    drupal_set_message('Facebook SDK returned an error: ' . $e->getMessage(), 'error');
  }
  $graphNode = $response->getGraphNode();

  watchdog('facebook post', $graphNode['id']);
}

/**
 * Get page info 
 * @param stdObject $fb 
 */
function _facebook_get_page_info($fb) {
  $helper = $fb->getPageTabHelper();

  try {
    $accessToken = $helper->getAccessToken();
  }
  catch (Facebook\Exceptions\FacebookResponseException $e) {
    // When Graph returns an error
    drupal_set_message('Graph returned an error: ' . $e->getMessage(), 'error');
  }
  catch (Facebook\Exceptions\FacebookSDKException $e) {
    // When validation fails or other local issues
    drupal_set_message('Facebook SDK returned an error: ' . $e->getMessage(), 'error');    
  }

  if (!isset($accessToken)) {
    drupal_set_message('No OAuth data could be obtained from the signed request. User has not authorized your app yet.', 'error');
  }

  // Logged in
  drupal_set_message('Page id:'.$helper->getPageId() ,'status');
  drupal_set_message('User is admin of page:'.$helper->isAdmin() ,'status');
  drupal_set_message('Signed Request:'.$helper->getSignedRequest() ,'status');
  drupal_set_message('Access Token:'.$accessToken->getValue() ,'status');
  
  return array('page_id' => $helper->getPageId(), 'access_token' => $accessToken->getValue());
}

/**
 * Implements hook_form_submit()
 *
 * {@inheritdoc}
 */
function itg_social_media_form_submit($form, &$form_state) {
  $node = node_load($form_state['values']['nid']);
  // Facebook video section
  if (isset($form_state['values']['itg_smi']['facebook_video']) && $form_state['values']['itg_smi']['facebook_video'] === 'facebook_video') {
    $desc = $form_state['values']['itg_facebook_video_text'];
    $fid = $form_state['values']['itg_fb_video'];
    itg_social_media_facebook_post($fid, $desc, 'videos');
    // save node field
    $node->field_story_facebook_video['und'][0] = array(
      'fid' => $fid,
      'display' => 1,
      'description' => ''
    );
    $node->field_story_facebook_vdescripti['und'][0]['value'] = $desc;
  }

  // Facebook Image
  if (isset($form_state['values']['itg_smi']['facebook']) && $form_state['values']['itg_smi']['facebook'] === 'facebook') {
    $desc = $form_state['values']['itg_facebook_narrative'];
    $fid = $form_state['values']['itg_fb_img'];
    itg_social_media_facebook_post($fid, $desc, 'photos');
    $node->field_story_facebook_image['und'][0]['fid'] = $form_state['values']['itg_fb_img'];
    $node->field_story_facebook_narrative['und'][0]['value'] = $form_state['values']['itg_facebook_narrative'];
  }

  // Change field value     
  foreach ($form_state['values']['itg_smi'] as $value) {
    if ($value != '0') {
      $data[]['value'][$value] = $value;
    }
  }

  // Social Media integration field
  $node->field_story_social_media_integ['und'] = $data;

  // Facebook log
  if (isset($form_state['values']['field_story_posted_by_facebook']) && $form_state['values']['field_story_posted_by_facebook'] != '') {
    $node->field_story_posted_by_facebook['und'][0]['value'] = $form_state['values']['field_story_posted_by_facebook'];
    $node->field_story_time_facebook['und'][0]['value'] = $form_state['values']['field_story_time_facebook'];
  }

  // Twitter log
  if (isset($form_state['values']['field_story_posted_by_twitter']) && $form_state['values']['field_story_posted_by_twitter'] != '') {
    $node->field_story_posted_by_twitter['und'][0]['value'] = $form_state['values']['field_story_posted_by_twitter'];
    $node->field_story_time_twitter['und'][0]['value'] = $form_state['values']['field_story_time_twitter'];
  }

  // TWITTER IMAGE
  if (isset($form_state['values']['itg_smi']['twitter']) && $form_state['values']['itg_smi']['twitter'] === 'twitter') {
    $desc = $form_state['values']['itg_twitter_narrative'];
    $fid = $form_state['values']['itg_twitter_img'];
    $node->field_story_tweet['und'][0]['value'] = $form_state['values']['itg_twitter_narrative'];
    $node->field_story_tweet_image['und'][0]['fid'] = $form_state['values']['itg_twitter_img'];
    itg_social_media_twitter_photo_post($fid, $desc, $node);
  }

  // Twitter Video
  if (isset($form_state['values']['itg_smi']['twitter_video']) && $form_state['values']['itg_smi']['twitter_video'] === 'twitter_video') {
    $desc = $form_state['values']['field_story_twitter_video_desc'];
    $fid = $form_state['values']['itg_twit_video'];
    $node->field_story_twitter_video['und'][] = array(
      'fid' => $fid,
      'display' => 1,
      'description' => ''
    );
    $node->field_story_twitter_video_desc['und'][0]['value'] = $desc;
    itg_social_media_tvideo_post($fid, $desc, $node);
  }
  node_save($node);
}

/**
 * Twitter image post function
 * @param int $fid
 * @param string $desc
 * @param stdObject $node
 */
function itg_social_media_twitter_photo_post($fid, $desc, $node) {
  // Create connection with twitter
  $cb = itg_social_media_twitter_connection();
  // Set image status permanent
  $file = itg_social_media_perm_file($fid);
  // Get real path of the file
  $path = drupal_realpath($file->uri);
  // Get short url
  $short_url = shorten_url($node->path['alias'], 'goo.gl');
  $media_files = [$path];
  // will hold the uploaded IDs
  $media_ids = [];

  foreach ($media_files as $files) {
    // upload all media files
    $reply = $cb->media_upload([
      'media' => $files
    ]);
    // and collect their IDs
    $media_ids[] = $reply->media_id_string;
  }
  // convert media ids to string list
  $media_id = implode(',', $media_ids);

  // send Tweet with these medias
  $reply = $cb->statuses_update([
    'status' => $desc . ' ' . $short_url,
    'media_ids' => $media_id
  ]);
  watchdog('twitter image', '<pre>' . print_r($reply, true) . '</pre>');
}

/**
 * Twitter video post function
 * @param int $fid
 * @param string $desc
 * @param stdObject $node
 */
function itg_social_media_tvideo_post($fid, $desc, $node) {
  // Create connection with twitter
  $cb = itg_social_media_twitter_connection();
  // Set image status permanent
  $file = itg_social_media_perm_file($fid);
  // Get real path of the file
  $path = drupal_realpath($file->uri);
  $size_bytes = filesize($path);
  // Get short url
  $short_url = shorten_url($node->path['alias'], 'goo.gl');
  $fp = fopen($path, 'r');

  // INIT the upload
  $reply = $cb->media_upload([
    'command' => 'INIT',
    'total_bytes' => $size_bytes,
    'media_type' => 'video/mp4',
  ]);

  $media_id = $reply->media_id_string;

  // APPEND data to the upload
  $segment_id = 0;

  while (!feof($fp)) {
    // 1MB per chunk for this sample
    $chunk = fread($fp, 1048576);
    $reply = $cb->media_upload([
      'command' => 'APPEND',
      'media_id' => $media_id,
      'segment_index' => $segment_id,
      'media' => $chunk
    ]);

    $segment_id++;
  }

  fclose($fp);

  // FINALIZE the upload
  $reply = $cb->media_upload([
    'command' => 'FINALIZE',
    'media_id' => $media_id
  ]);

  if ($reply->httpstatus < 200 || $reply->httpstatus > 299) {
    die('I am dying');
  }

  // Now use the media_id in a Tweet
  $reply = $cb->statuses_update([
    'status' => 'Twitter now accepts video uploads.',
    'media_ids' => $media_id
  ]);
  watchdog('twitter video', '<pre>' . print_r($reply, true) . '</pre>');
}
