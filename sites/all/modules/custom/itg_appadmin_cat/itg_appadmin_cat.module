<?php 

/**
 * @file
 * The ITG App Admin Category Management Module.
 *
 * Contains functionality for Managing the Category for the App.
 */
// Load the hirerical select common file
module_load_include('inc', 'hierarchical_select', 'includes/common');

/**
 * Implements hook_menu().
 */
function itg_appadmin_cat_menu() {
  $items['appadmin-cat-management'] = array(
    'title' => 'Assign Categeory for App',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('app_admin_cat_manage'),
    'access arguments' => array('App Admin Cat Management'),
    'type' => MENU_CALLBACK,
  );
  
  $items['appadmin-cat/%/edit'] = array(
    'title' => 'Edit Categeory for App',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('app_admin_edit_cat',1),
    'access arguments' => array('App Admin Cat Management'),
    'type' => MENU_CALLBACK,
  );
  
  $items['appadmin-cat-listing'] = array(
    'title' => 'App Cat Listing',
    'page callback' => 'appadmin_cat_listing',
    //'page arguments' => array('app_admin_cat_manage'),
    'access arguments' => array('App Admin Cat Management'),
    'menu_name' => 'menu-app-admin',
    'type' => MENU_NORMAL_ITEM,
  );
  
  $items['appadmin-cat/%/delete'] = array(
    'title' => 'Delete Assigned Category',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('app_admin_cat_del',1),
    'access arguments' => array('App Admin Cat Management'),
    'type' => MENU_CALLBACK,
  );
  
  return $items;
}

/*
 * Create edit form to change weight and visibility
 */

function app_admin_edit_cat($form, &$form_state){

  $form = array();
  $id = arg(1);
  
 $load_cat = get_all_data($id);
 
  $cat_list = '';
  $all_tid = taxonomy_get_parents_all($load_cat->cat_tid);
             $cat_list = '';
             foreach ($all_tid as $tid_key => $tid_value){
                $cat_list .= taxonomy_name_by_id($tid_value->tid);
                $cat_list .= " >> ";
             }
    
  $form['from'] = array(
    '#type' => 'item',
    '#title' => t('Categeory'),
    '#markup' => '<strong>'.substr($cat_list,0,-4).'</strong>',
   );

  
   $show_app = array(0 => t('No'), 1 => t('Yes'));
   $show_on_app = $load_cat->show_on_app;
   
   $form['show_app'] = array(
    '#type' => 'radios',
    '#title' => t('Show In App'),
    '#default_value' => isset($show_on_app) ? $show_on_app : 0,
    '#options' => $show_app,
  );
  
  $weight = array(0,1,2,3,4,5,6,7,8,9,10); 
  
  $form['weight'] = array(
    '#type' => 'select',
    '#title' => t('Weight'),
    '#default_value' => isset($load_cat->weight) ? $load_cat->weight : 0,
    '#options' => $weight,
  ); 
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit'
  );
  
  return $form;
}

/*
 * Implement hook_form_submit()
 */
function app_admin_edit_cat_submit($form, &$form_state){
   global $user;
    $id = arg(1);
    $qry = db_update('itg_app_admin_cat')
           ->fields(array(
             'show_on_app' => $form_state['values']['show_app'],
             'weight' => $form_state['values']['weight'],
             'uid' => $user->uid,
             'changed' => REQUEST_TIME
           ))
           ->condition('id',$id)
           ->execute();
  
  if($qry){
    $load_cat = get_all_data($qry);
    $cat_name = taxonomy_name_by_id($load_cat->cat_tid);
    drupal_set_message(t('Category @cat_name has been updated for APP', array('@cat_name' => $cat_name)));
    $form_state['redirect'] = 'appadmin-cat-listing';
  }
  
}

/*
 * delete cat form callback
 */

function app_admin_cat_del($form, &$form_state){
  
  global $base_url;
  $id = arg(1);
  
  
    $cat_id = db_select('itg_app_admin_cat','ca')
            ->fields('ca',array('cat_tid'))
            ->condition('ca.id',$id)
            ->execute()->fetchField();
    $cat = taxonomy_term_load($cat_id);
    $ques = t('Are you sure you want to delete Assigned Category @cat for App',array('@cat' => $cat->name));
    
    
    return confirm_form($form, 
    $ques,
    'appadmin-cat-listing',
    t('This Action can not be undone'),
    t('Confirm'),
     t('Cancel')
  );
  
}



function app_admin_cat_del_submit($form, &$form_state){
  $id = arg(1);
  
    if (!isset($form_state['storage']['confirm'])) {
      $del_qry = db_delete('itg_app_admin_cat')
                 ->condition('id',$id)
                 ->execute();

      if($del_qry){
          drupal_set_message('App category has been unassigned successfully');
          $form_state['redirect'] = 'appadmin-cat-listing';
      }
    }else{
      drupal_goto('appadmin-cat-listing');
    }
      
}


/*
 * View Listing of Category 
 */

function appadmin_cat_listing(){
  
  $output = '';
  $header = array('Category Name','Display(in App)','weight','Actions');

  $rows = array();

  $cat_sql1 = db_select('itg_app_admin_cat','ac');
  $cat_sql1->fields('ac');
  $cat_sql1 = $cat_sql1->extend('TableSort')->extend('PagerDefault')->limit(10);
  $cat_sql = $cat_sql1->execute();

    while($data = $cat_sql->fetchObject()){
             if($data->show_on_app == '1'){
                   $display = 'Yes';
             }else {
                   $display = 'No';
             }
             
             $all_tid = taxonomy_get_parents_all($data->cat_tid);
             $cat_list = '';
             foreach ($all_tid as $tid_key => $tid_value){
                $cat_list .= taxonomy_name_by_id($tid_value->tid);
                $cat_list .= " >> ";
             }
             
             $actions = '';
             $actions .= '<a href="appadmin-cat/'.$data->id.'/edit">'
                      . '<span class="edit-link">edit</span>'
                      .'</a>  | ';
             $actions .= '<a href="appadmin-cat/'.$data->id.'/delete">'
                      . '<span class="delete-link">delete</span>'
                      . '</a>';
             
             $rows[] = array(
                    array('data' => substr($cat_list,0,-4), 'class' => 'views-field'),
                    array('data' => $display, 'class' => 'views-field'),
                    array('data' => $data->weight, 'class' => 'views-field'),
                    array('data' => $actions, 'class' => 'views-field views-field-nothing','align' => 'left'),
                );
             
   }
    $attributes = array('class' => array('views-table'));
    $output = '';
    $output .= '<div class="view"><div class="attachment attachment-before"><a href="appadmin-cat-management">Assign App Category</a></div>';
    $output .= theme('table', array('header' => $header, 'rows' => $rows,'attributes' => $attributes));
    $output .= theme('pager');
    $output .= '</div>';
   return $output;
}


/*
 * Common functin to Get Taxonomy name by term id 
 * @args: tid
 * return: string(taxonomy name)
 */

function taxonomy_name_by_id($tid){
  $term = taxonomy_term_load($tid);
  return $term->name;
}

/**
 * Implements hook_permission().
 */
function itg_appadmin_cat_permission() {

    $perm = array();
    $perm['App Admin Cat Management'] = array(
        'title' => t('App Admin Cat Management'),
    );
    return $perm;
}

/*
 * Create form to map the category for the APP
 */

function app_admin_cat_manage($form, &$form_state){

  $form = array();
  
  $form['app_categories'] =  array(
    '#title' => t('Choose categories'),
    '#type'          => 'hierarchical_select',
    '#config'        => array(
      'module' => 'hs_taxonomy',
      'params' => array(
	  'vid'                        => CATEGORY_MANAGMENT,
	  'exclude_tid'                => NULL,
	  'root_term'                  => NULL,
	  'entity_count_for_node_type' => NULL,
      ),
    ),
    //'#default_value' => $tids,
  );
  
   $show_app = array(0 => t('No'), 1 => t('Yes'));
   $show_on_app = isset($form_state['values']['show_app']) ? $form_state['values']['show_app'] : '';
   
   $form['show_app'] = array(
    '#type' => 'radios',
    '#title' => t('Show In App'),
    '#default_value' => isset($show_on_app) ? $show_on_app : 0,
    '#options' => $show_app,
  );
  
  $weight = array(0,1,2,3,4,5,6,7,8,9,10); 
  
  $form['weight'] = array(
    '#type' => 'select',
    '#title' => t('Weight'),
    //'#default_value' => isset($show_on_app) ? $show_on_app : 0,
    '#options' => $weight,
  ); 
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit'
  );
  
  return $form;
}

/*
 * Implement form_validate
 */
function app_admin_cat_manage_validate($form, &$form_state){
  
  $cat_id = $form_state['values']['app_categories'];
  
  $qry = db_select('itg_app_admin_cat','ca')
          ->fields('ca',array('id'))
          ->condition('cat_tid',$cat_id)
          ->execute()->fetchField();
      if(isset($qry) && $qry != 0){
        form_set_error('app_categories',t('This category already assigned, Please choose another'));
      }
    
  
}

/*
 * common function to get the list of Assigned cat
 * @args : id
 * return : one column data as a object 
 */

function get_all_data($id){
  
  $db_qry = db_select('itg_app_admin_cat','ca')
            ->fields('ca')
            ->condition('ca.id',$id)
            ->execute()->fetchObject();
  return $db_qry;
}

/*
 * Implement hook_form_submit()
 */
function app_admin_cat_manage_submit($form, &$form_state){
  global $user;
  
  if($form_state['values']['app_categories'] > 0 ){
    $qry = db_insert('itg_app_admin_cat')
           ->fields(array(
             'cat_tid' => $form_state['values']['app_categories'],
             'show_on_app' => $form_state['values']['show_app'],
             'weight' => $form_state['values']['weight'],
             'uid' => $user->uid,
             'created' => REQUEST_TIME,
             'changed' => REQUEST_TIME
           ))
        ->execute();
  }
  
  if($qry){
    $load_cat = get_all_data($qry);
    $cat_name = taxonomy_name_by_id($load_cat->cat_tid);
    drupal_set_message(t('Category @cat_name has been assigned for APP', array('@cat_name' => $cat_name)));
    $form_state['redirect'] = 'appadmin-cat-listing';
  }
  
}


/*
 * Implement Hook_theme
 */

function itg_appadmin_cat_theme() {
  return array(
    'admin_table_layout' => array(
      'template' => 'custom-table-format',
      'arguments' => array(),
    ),
  );
}
