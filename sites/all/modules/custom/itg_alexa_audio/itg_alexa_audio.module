<?php

/**
 * @file
 * ITG Alexa audio module.
 *
 * Module for Generate alexa audio file and feed.
 *
 */

/**
 * Implement hook_form_alter()
 * @param array $form
 * @param array $form_state
 * @param string $form_id
 */
function itg_alexa_audio_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'alexa_audio_clips_node_form') {
    $arg = arg();
    
    $form['field_audio'][LANGUAGE_NONE][0]['#default_value']['#upload_location'] = 'public://sites/indiatoday/' . date('Ymd') . '/';
   // $form['field_audio']['#upload_validators'] = 'public://sites/indiatoday/' . date('Ymd') . '/';
    
    $minute = date('i') < 30 ? '00' : 30;
   
    $upload_date = date('Y-m-d ') . date('H') . ':' . $minute;
    $form['field_event_start_date'][LANGUAGE_NONE][0]['#default_value']['value'] = $upload_date;
   //   pr($form['field_event_start_date'][LANGUAGE_NONE][0]);
    // if (is_array($arg) && $arg[2] == 'edit') {
      $curent_feed = get_last_alexa_feed();
      $exist_nid = $curent_feed[0]['nid'];  
      $node = node_load($exist_nid);
      $form['title']['#default_value'] = $node->title;
      $fid = $node->field_audio[LANGUAGE_NONE][0]['fid'];
      $vide_fid = $node->field_alexa_video[LANGUAGE_NONE][0]['fid'];
      if ($fid) {
        $file_obj = file_load($fid);
        $stream_url = file_create_url($file_obj->uri);
        $alexa_path = file_create_url("public://rss-feeds/ver1.0/alexa/7fb46df8/indiatoday/audio/it_audioclip50_time.json");
        $google_syndication_xml = file_create_url("public://rss-feeds/ver1.0/google-assistant/a1492caf/indiatoday/audio/it_audioclip_latest_news.xml");      
      }
      
      
      $form['last_audio_url'] = array(
        '#type' => 'textfield',
        '#title' => t("Last Uploaded Audio Url"),
        '#default_value' => $stream_url,
        '#weight' => 10,
        '#size' => 60,
        '#maxlength' => 256,
        '#attributes' => array('readonly' => 'readonly'),
      );
      $form['alexa_json_path'] = array(
        '#type' => 'textfield',
        '#title' => t("Alexa Json Path"),
        '#default_value' => $alexa_path,
        '#weight' => 11,
        '#size' => 60,
        '#maxlength' => 256,
        '#attributes' => array('readonly' => 'readonly'),
      );
      
      if ($vide_fid) {
        $file_video_obj = file_load($vide_fid);
        $video_url = file_create_url($file_video_obj->uri); 
        $alexa_vido_path = file_create_url("public://rss-feeds/ver1.0/alexa/7fb46df8/indiatoday/audio/it_audioclip50_time_video.json");
        $form['last_video_url'] = array(
        '#type' => 'textfield',
        '#title' => t("Last Uploaded Video Url"),
        '#default_value' => $video_url,
        '#weight' => 10,
        '#size' => 60,
        '#maxlength' => 256,
        '#attributes' => array('readonly' => 'readonly'),
      );
      $form['alexa_json_video_path'] = array(
        '#type' => 'textfield',
        '#title' => t("Alexa Json Video Path"),
        '#default_value' => $alexa_vido_path,
        '#weight' => 11,
        '#size' => 60,
        '#maxlength' => 256,
        '#attributes' => array('readonly' => 'readonly'),
      );
      }
      
      $form['google_syndication_xml'] = array(
        '#type' => 'textfield',
        '#title' => t("Google Syndicate XML Path"),
        '#default_value' => $google_syndication_xml,
        '#weight' => 12,
        '#size' => 60,
        '#maxlength' => 256,
        '#attributes' => array('readonly' => 'readonly'),
      );
  /*  } else {
      $curent_feed = get_last_alexa_feed();
      $exist_nid = $curent_feed[0]['nid'];   
      if ($exist_nid && $arg[0] != 'file' && $arg[1] != 'ajax') {
        drupal_set_message('Audio & Video data exist in our system.');
        drupal_goto('alexa-audio-clips');
      } 
    }
   */
    // $form['#validate'][] = 'itg_alexa_audio_form_custom_validator';
    $form['actions']['submit']['#submit'][] = 'itg_alexa_audio_form_custom_submit';
  }
}

/*
function itg_alexa_audio_form_custom_validator($form, &$form_state) {
  pr($form_state['values']);
  print "======<br>=======";
  p($form_state);
  
}
*/

/**
 * custom submit action for alexa_audio_clips_node_form
 * @param array $form
 * @param array $form_state
 */
function itg_alexa_audio_form_custom_submit($form, &$form_state) {
  genrate_alexa_audio_json($form_state['values']);
}

/**
 * Function to generate JSON file for alexa
 * @param array $value   
 */
function genrate_alexa_audio_json($value) {
  $audiofid = $value['field_audio']['und'][0]['fid'];
  //pr($value);
  if (!empty($audiofid)) {
    $filedir = 'sites/indiatoday/' . date('Ymd');
    $orignal_img = file_load($audiofid);
    //p($orignal_img);
    // $orignal_file_name = $orignal_img->filename;
    $new_filename = 'it_50_'.date('Ymd').'_time_it_vt_audio_'.strtotime(date('Y-m-d')).'.mp3';
    
    if (!file_exists(file_default_scheme() . '://' . $filedir)) {
      mkdir(file_default_scheme() . '://' . $filedir, 0777, TRUE);
    }
    
    $directory = file_default_scheme() . '://' . $filedir . '/it_50_'.date('Ymd') . "/";
    file_prepare_directory($directory, FILE_CREATE_DIRECTORY);
    
    //$new_destination = str_replace($orignal_img->filename, $new_filename, $orignal_img->uri);
    
    $orignal_img->filename = $new_filename;
    //$orignal_img->uri = file_default_scheme() . '://' . $filedir . '/it_50_'.date('Ymd').'_time_it_vt_audio_'.strtotime(date('Y-m-d')).'.mp3';
    $new_destination = file_default_scheme() . '://' . $filedir . '/it_50_'.date('Ymd').'_time_it_vt_audio_'.strtotime(date('Y-m-d')).'.mp3';
    $result = file_move($orignal_img, $new_destination, FILE_EXIST_ERROR);
  
    //$imagedata = $orignal_img->uri;
    //$file = file_save_data($imagedata, file_default_scheme() . '://' . $filedir . '/' . $image_name);
    // file_save_data($xml, $directory . end($path_array), FILE_EXISTS_REPLACE);
    //file_usage_add($file, 'itg_alexa_audio', 'file', $file->fid);
    
  }
  
  $title = $value['title'];
  $uid = $value['uid'];
  $date = date('Y-m-d\TH:s:i', strtotime($value['field_event_start_date']['und'][0]['value']));
  $file_obj = file_load($audiofid);
  $stream_url = file_create_url($file_obj->uri);
  $json = array(
    'uid' => 'itaudiofeed' . $uid,
    'updateDate' => $date,
    'titleText' => $title,
    'mainText' => "",
    'streamUrl' => $stream_url,
    'redirectionUrl' => FRONT_URL
  );
  $xml_path = 'public://rss-feeds/ver1.0/alexa/7fb46df8/indiatoday/audio/';
  $file_path = $xml_path . 'it_audioclip50_time.json';
  $fp = fopen($file_path, "w");
  fwrite($fp, json_encode($json));
  fclose($fp);
  // for video
  $videofid = $value['field_alexa_video']['und'][0]['fid'];
  $file_video_obj = file_load($videofid);
  $video_url = file_create_url($file_video_obj->uri);
  $json = array(
    'uid' => 'itaudiofeed' . $uid,
    'updateDate' => $date,
    'titleText' => $title,
    'mainText' => "",
    'streamUrl' => $stream_url,
    'videoUrl' => $video_url,
    'redirectionUrl' => FRONT_URL
  );
  $video_file_path = $xml_path . 'it_audioclip50_time_video.json';
  $fpv = fopen($video_file_path, "w");
  fwrite($fpv, json_encode($json));
  fclose($fpv);
  itgd_genrate_xml_audioclip_latest_news($stream_url, $value['field_event_start_date']['und'][0]['value'], 'itaudiofeed' . $uid);
}

/**
 * Function is used to get static xml
 * @param string $stream_url
 * @param string $date
 * @param string $filename
 */
function itgd_genrate_xml_audioclip_latest_news($stream_url, $date, $filename) {
  $date = date("D, d M Y H:s:i", strtotime($date));
  $c_date = date("Y");
  $xml = <<<XML
      <rss xmlns:atom="http://www.w3.org/2005/Atom" xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd" version="2.0">
<channel>
<title>India Today News Headlines</title>
<link>http://indiatoday.intoday.in</link>
<language>en-US</language>
<copyright>$c_date ITG</copyright>
<description>
India Today provides the latest news on politics, entertainment, bollywood, business and sports. Stay tuned for all the breaking news from India and around the world.
</description>
<itunes:subtitle>
India Today provides the latest news on politics, entertainment, bollywood, business and sports. Stay tuned for all the breaking news from India and around the world.
</itunes:subtitle>
<itunes:author>India Today Group</itunes:author>
<itunes:category text="News and Politics"></itunes:category>
<itunes:summary>
India Today provides the latest news on politics, entertainment, bollywood, business and sports. Stay tuned for all the breaking news from India and around the world.
</itunes:summary>
<itunes:explicit>clean</itunes:explicit>
<atom:link href="https://feeds.intoday.in/rss-feeds/ver1.0/google-assistant/a1492caf/indiatoday/audio/it_audioclip_latest_news.xml" rel="self" type="application/rss+xml"/>
<itunes:owner>
<itunes:name>India Today Group</itunes:name>
<itunes:email>syndicationsteam@intoday.com</itunes:email>
</itunes:owner>
<image>
<title>India Today News Headlines</title>
<link>http://indiatoday.intoday.in</link>
<url>
https://smedia2.intoday.in/conclave/2017-next/images/rightLogo.png
</url>
</image>
<item>
<title>India Today News Headlines</title>
<description>
India Today provides the latest news on politics, entertainment, bollywood, business and sports. Stay tuned for all the breaking news from India and around the world.
</description>
<guid isPermaLink="false">$filename</guid>
<enclosure length="2863763" type="audio/mpeg" url="$stream_url"></enclosure>
<pubDate>$date GMT</pubDate>
<itunes:duration>1:29</itunes:duration>
</item>
</channel>
</rss>
XML;
  $xml_path = 'public://rss-feeds/ver1.0/google-assistant/a1492caf/indiatoday/audio/';
  $file_path = $xml_path . 'it_audioclip_latest_news.xml';
  $fp = fopen($file_path, "w");
  fwrite($fp, $xml);
  fclose($fp);
}

/**
 * Function is for to get latest insert alexa clip
 * @return array $result
 */
function get_last_alexa_feed() {
  $query = db_select('node', 'n');
  $query->fields('n', array('nid', 'title', 'created'));
  $query->condition('n.status', 1);
  $query->condition('n.type', "alexa_audio_clips", '=');
  $query->orderBy('n.nid', 'DESC')->range(0, 1);
  $result = $query->execute()->fetchAll(PDO::FETCH_ASSOC);
  return $result;
}